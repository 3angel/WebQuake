<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Quake</title>
<link rel="shortcut icon" href="data:image/gif;base64,
R0lGODlhMAAwANUAAHNzAFBQAP//1NySALl6AJZiAHNKAFAyAP+qJf+4SP/Ujv/isf/j1FAZAP/Hsf9z
SP+Pa/+rjv+Ojra2tp6enpKSkoaGhnp6em5ubmJiYlZWVkpKSj4+PjIyMiYmJhoaGg4ODgAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAMAAwAAAG/8CQcEgsGo/IJJJDZCqfUCOn4iF6Ks6o
dkk1XrPbsBCzQW4w4nSmk0Guq+ltuX1sl+PaskZ5P4JAeENlaCEVFhYVYyF9QiAfjxscjx+AcRsdE4tC
ZRMdfR8eHh0cGxsZGqUcHaEfYmVsF0IXa5ogHqQbqBoZFxYYuqkelXlmIaOlGckZGIeHGMoZqR3DUKVE
1iEHptEHBxwaGAW+Ghzd2xsHrWEboYzfEOkd3eDPGhrdHR8HEOTq64wfSnlooC+XqV/RUKVr4KGUPzkA
D3h45AkZuAwFopXKBypdGmxC9E0E1UGeKnuRDpQc6cFjoJASQYEKRbMmq4ktH+IRidNAgf8C4X4C/WkA
Z86XMDke8PkgwoIIERxEeFDAQLoP8nTG0cex6tICUyFA8OqTosuXM/UV6NaRgNWJ3damRRpCpD4IVKsS
gFr15wN4HbWmsWugaQSxEQQ8RTzVQGC6aQ/8VTAWAgMHlSk/SMcKcsyvYw1o+KnBZ2jOZwO1VBWg9M9n
yIIuZVdOsJiWZ54ZEI1RaAbRBxDesx2GawaxZCEcfmAVI4YIFmpX64DEUSht9i6s3WBB7IXdBDAgjInE
UwgOEDBQygdiwAACcrtxaIgBfgGxyO9HGyXRg0/3BYACggazbAABARPlc4B7A8i12iMciPfAhBQWOFE5
ExlAAIBYgXD/HBnQSTRNAQQggIBbRj1ySwYPzMILARlIQhFOJHK4SlMgUqCSMD9t+J5VKqrYgVXyvDXJ
JB6QaOJ7onigHBkQSNDfByQSsKGVVdV25JZbfuXekgT0Z0EEZPTy2YYIfOkelrvtFlMDS7UJHoNWpunW
Ixdxh0WGX5roJ4NLNthNXAwWmuYAYDr2AUoaQEABOyDU6CcCCZiYwKWYNribkphWiuikP9piwQW5jAqp
hlb6OCmlmQpVAKKYgpqqlQbYcgE/4MwyDaprzppqofb5uGavvroFQgcP+CKeeAeAgKqvQlkVF174MdeN
T1VemWqtEV7gbTIYSIKqXmwC4Ca2chK1kmmP79FaVUAu6hLNB8/O+qmdXg16rapr9rjtohfcE8k3Gvin
7aw1frrWAQwthWaherXrVgcYkNrQKLsY7C+Wr74HoLRf+SisvT9SHE1DouwypFvZIlwVUxRO+LJPVhJ7
ogEUa7DKzhnT/J6/uwVwrauuDrrprODh/MzOnmBQVL01A/rjAQFUbbWXhyKsYVGNXhIEADs=">
<script type="text/javascript">
var CDAudio={known:[],Play:function(a,b){!0!==CDAudio.initialized||!0!==CDAudio.enabled||(a-=2,CDAudio.playTrack===a?null!=CDAudio.cd&&(CDAudio.cd.loop=b,!0===b&&!0===CDAudio.cd.paused&&CDAudio.cd.play()):0>a||a>=CDAudio.known.length?Con.DPrint("CDAudio.Play: Bad track number "+(a+2)+".\n"):(CDAudio.Stop(),CDAudio.playTrack=a,CDAudio.cd=new Audio(CDAudio.known[a]),CDAudio.cd.loop=b,CDAudio.cd.volume=CDAudio.cdvolume,CDAudio.cd.play()))},Stop:function(){!0!==CDAudio.initialized||!0!==CDAudio.enabled|| (null!=CDAudio.cd&&CDAudio.cd.pause(),CDAudio.playTrack=null,CDAudio.cd=null)},Pause:function(){!0!==CDAudio.initialized||!0!==CDAudio.enabled||null!=CDAudio.cd&&CDAudio.cd.pause()},Resume:function(){!0!==CDAudio.initialized||!0!==CDAudio.enabled||null!=CDAudio.cd&&CDAudio.cd.play()},CD_f:function(){if(!(!0!==CDAudio.initialized||1>=Cmd.argv.length))switch(Cmd.argv[1].toLowerCase()){case "on":CDAudio.enabled=!0;break;case "off":CDAudio.Stop();CDAudio.enabled=!1;break;case "play":CDAudio.Play(Q.atoi(Cmd.argv[2]), !1);break;case "loop":CDAudio.Play(Q.atoi(Cmd.argv[2]),!0);break;case "stop":CDAudio.Stop();break;case "pause":CDAudio.Pause();break;case "resume":CDAudio.Resume();break;case "info":Con.Print(CDAudio.known.length+" tracks\n"),null!=CDAudio.cd&&!0!==CDAudio.cd.paused&&Con.Print("Currently "+(!0===CDAudio.cd.loop?"looping":"playing")+" track "+(CDAudio.playTrack+2)+"\n"),Con.Print("Volume is "+CDAudio.cdvolume+"\n")}},Update:function(){if(!(!0!==CDAudio.initialized||!0!==CDAudio.enabled)&&S.bgmvolume.value!== CDAudio.cdvolume)0>S.bgmvolume.value?Cvar.SetValue("bgmvolume",0):1<S.bgmvolume.value&&Cvar.SetValue("bgmvolume",1),CDAudio.cdvolume=S.bgmvolume.value,null!=CDAudio.cd&&(CDAudio.cd.volume=CDAudio.cdvolume)},Init:function(){Cmd.AddCommand("cd",CDAudio.CD_f);if(null==COM.CheckParm("-nocdaudio")){var a,b,d,c=new XMLHttpRequest;for(a=1;99>=a;++a){d="/media/quake"+(9>=a?"0":"")+a+".ogg";for(b=COM.searchpaths.length-1;0<=b;--b)if(c.open("HEAD",COM.searchpaths[b].filename+d,!1),c.send(),200<=c.status&&299>= c.status){CDAudio.known[a-1]=COM.searchpaths[b].filename+d;break}if(0>b)break}0!==CDAudio.known.length&&(CDAudio.initialized=CDAudio.enabled=!0,CDAudio.Update(),Con.Print("CD Audio Initialized\n"))}}};
var Chase={Init:function(){Chase.back=Cvar.RegisterVariable("chase_back","100");Chase.up=Cvar.RegisterVariable("chase_up","16");Chase.right=Cvar.RegisterVariable("chase_right","0");Chase.active=Cvar.RegisterVariable("chase_active","0")},Update:function(){var b=[],d=[];Vec.AngleVectors(CL.state.viewangles,b,d);var c={plane:{}},a=R.refdef.vieworg;SV.RecursiveHullCheck(CL.state.worldmodel.hulls[0],0,0,1,a,[a[0]+4096*b[0],a[1]+4096*b[1],a[2]+4096*b[2]],c);c=c.endpos;c[2]-=a[2];var e=(c[0]-a[0])*b[0]+ (c[1]-a[1])*b[1]+c[2]*b[2];1>e&&(e=1);R.refdef.viewangles[0]=-180*(Math.atan(c[2]/e)/Math.PI);a[0]-=b[0]*Chase.back.value+d[0]*Chase.right.value;a[1]-=b[1]*Chase.back.value+d[1]*Chase.right.value;a[2]+=Chase.up.value}};
var CL={cshift:{contents:0,damage:1,bonus:2,powerup:3},active:{disconnected:0,connecting:1,connected:2},StopPlayback:function(){!0===CL.cls.demoplayback&&(CL.cls.demoplayback=!1,CL.cls.demofile=null,CL.cls.state=CL.active.disconnected,!0===CL.cls.timedemo&&CL.FinishTimeDemo())},WriteDemoMessage:function(){var a=CL.cls.demoofs+16+NET.message.cursize;if(CL.cls.demofile.byteLength<a){var b=new Uint8Array(CL.cls.demofile,0,CL.cls.demoofs);CL.cls.demofile=new ArrayBuffer(CL.cls.demofile.byteLength+16384); (new Uint8Array(CL.cls.demofile)).set(b)}b=new DataView(CL.cls.demofile,CL.cls.demoofs,16);b.setInt32(0,NET.message.cursize,!0);b.setFloat32(4,CL.state.viewangles[0],!0);b.setFloat32(8,CL.state.viewangles[1],!0);b.setFloat32(12,CL.state.viewangles[2],!0);(new Uint8Array(CL.cls.demofile)).set(new Uint8Array(NET.message.data,0,NET.message.cursize),CL.cls.demoofs+16);CL.cls.demoofs=a},GetMessage:function(){if(!0===CL.cls.demoplayback){if(4===CL.cls.signon)if(!0===CL.cls.timedemo){if(Host.framecount=== CL.cls.td_lastframe)return 0;CL.cls.td_lastframe=Host.framecount;Host.framecount===CL.cls.td_startframe+1&&(CL.cls.td_starttime=Host.realtime)}else if(CL.state.time<=CL.state.mtime[0])return 0;if(CL.cls.demoofs+16>=CL.cls.demosize)return CL.StopPlayback(),0;var a=new DataView(CL.cls.demofile);NET.message.cursize=a.getUint32(CL.cls.demoofs,!0);8E3<NET.message.cursize&&Sys.Error("Demo message > MAX_MSGLEN");CL.state.mviewangles[1]=CL.state.mviewangles[0];CL.state.mviewangles[0]=[a.getFloat32(CL.cls.demoofs+ 4,!0),a.getFloat32(CL.cls.demoofs+8,!0),a.getFloat32(CL.cls.demoofs+12,!0)];CL.cls.demoofs+=16;if(CL.cls.demoofs+NET.message.cursize>CL.cls.demosize)return CL.StopPlayback(),0;var a=new Uint8Array(CL.cls.demofile,CL.cls.demoofs,NET.message.cursize),b=new Uint8Array(NET.message.data,0,NET.message.cursize),c;for(c=0;c<NET.message.cursize;++c)b[c]=a[c];CL.cls.demoofs+=NET.message.cursize;return 1}for(;;){a=NET.GetMessage(CL.cls.netcon);if(1!==a&&2!==a)return a;if(1===NET.message.cursize&&(new Uint8Array(NET.message.data, 0,1))[0]===Protocol.svc.nop)Con.Print("<-- server to client keepalive\n");else break}!0===CL.cls.demorecording&&CL.WriteDemoMessage();return a},Stop_f:function(){!0!==Cmd.client&&(!0!==CL.cls.demorecording?Con.Print("Not recording a demo.\n"):(NET.message.cursize=0,MSG.WriteByte(NET.message,Protocol.svc.disconnect),CL.WriteDemoMessage(),!0!==COM.WriteFile(CL.cls.demoname,new Uint8Array(CL.cls.demofile),CL.cls.demoofs)&&Con.Print("ERROR: couldn't open.\n"),CL.cls.demofile=null,CL.cls.demorecording= !1,Con.Print("Completed demo\n")))},Record_f:function(){var a=Cmd.argv.length;if(1>=a||5<=a)Con.Print("record <demoname> [<map> [cd track]]\n");else if(-1!==Cmd.argv[1].indexOf(".."))Con.Print("Relative pathnames are not allowed.\n");else if(2===a&&CL.cls.state===CL.active.connected)Con.Print("Can not record - already connected to server\nClient demo recording must be started before connecting\n");else{4===a?(CL.cls.forcetrack=Q.atoi(Cmd.argv[3]),Con.Print("Forcing CD track to "+CL.cls.forcetrack)): CL.cls.forcetrack=-1;CL.cls.demoname=COM.DefaultExtension(Cmd.argv[1],".dem");3<=a&&Cmd.ExecuteString("map "+Cmd.argv[2]);Con.Print("recording to "+CL.cls.demoname+".\n");CL.cls.demofile=new ArrayBuffer(16384);var a=CL.cls.forcetrack.toString()+"\n",b,c=new Uint8Array(CL.cls.demofile,0,a.length);for(b=0;b<a.length;++b)c[b]=a.charCodeAt(b);CL.cls.demoofs=a.length;CL.cls.demorecording=!0}},PlayDemo_f:function(){if(!0!==Cmd.client)if(2!==Cmd.argv.length)Con.Print("playdemo <demoname> : plays a demo\n"); else{CL.Disconnect();var a=COM.DefaultExtension(Cmd.argv[1],".dem");Con.Print("Playing demo from "+a+".\n");a=COM.LoadFile(a);if(null==a)Con.Print("ERROR: couldn't open.\n"),CL.cls.demonum=-1,SCR.disabled_for_loading=!1;else{CL.cls.demofile=a;a=new Uint8Array(a);CL.cls.demosize=a.length;CL.cls.demoplayback=!0;CL.cls.state=CL.active.connected;CL.cls.forcetrack=0;var b,c,e;for(b=0;b<a.length;++b){c=a[b];if(10===c)break;45===c?e=!0:CL.cls.forcetrack=10*CL.cls.forcetrack+c-48}!0===e&&(CL.cls.forcetrack= -CL.cls.forcetrack);CL.cls.demoofs=b+1}}},FinishTimeDemo:function(){CL.cls.timedemo=!1;var a=Host.framecount-CL.cls.td_startframe-1,b=Host.realtime-CL.cls.td_starttime;0===b&&(b=1);Con.Print(a+" frames "+b.toFixed(1)+" seconds "+(a/b).toFixed(1)+" fps\n")},TimeDemo_f:function(){!0!==Cmd.client&&(2!==Cmd.argv.length?Con.Print("timedemo <demoname> : gets demo speeds\n"):(CL.PlayDemo_f(),CL.cls.timedemo=!0,CL.cls.td_startframe=Host.framecount,CL.cls.td_lastframe=-1))},kbutton:{mlook:0,klook:1,left:2, right:3,forward:4,back:5,lookup:6,lookdown:7,moveleft:8,moveright:9,strafe:10,speed:11,use:12,jump:13,attack:14,moveup:15,movedown:16,num:17},kbuttons:[],KeyDown:function(){var a=CL.kbutton[Cmd.argv[0].substring(1)];if(null!=a){var a=CL.kbuttons[a],b;b=null!=Cmd.argv[1]?Q.atoi(Cmd.argv[1]):-1;if(!(b===a.down[0]||b===a.down[1])){if(0===a.down[0])a.down[0]=b;else if(0===a.down[1])a.down[1]=b;else{Con.Print("Three keys down for a button!\n");return}0===(a.state&1)&&(a.state|=3)}}},KeyUp:function(){var a= CL.kbutton[Cmd.argv[0].substring(1)];if(null!=a){var a=CL.kbuttons[a],b;if(null!=Cmd.argv[1]){b=Q.atoi(Cmd.argv[1]);if(a.down[0]===b)a.down[0]=0;else if(a.down[1]===b)a.down[1]=0;else return;if(!(0!==a.down[0]||0!==a.down[1])&&0!==(a.state&1))a.state=a.state-1|4}else a.down[0]=a.down[1]=0,a.state=4}},MLookUp:function(){CL.KeyUp();0===(CL.kbuttons[CL.kbutton.mlook].state&1)&&0!==CL.lookspring.value&&V.StartPitchDrift()},Impulse:function(){CL.impulse=Q.atoi(Cmd.argv[1])},KeyState:function(a){a=CL.kbuttons[a]; var b=a.state&1;a.state&=1;return 0!==(a.state&2)?0!==(a.state&4)?0!==b?0.75:0.25:0!==b?0.5:0:0!==(a.state&4)?0:0!==b?1:0},AdjustAngles:function(){var a=Host.frametime;0!==(CL.kbuttons[CL.kbutton.speed].state&1)&&(a*=CL.anglespeedkey.value);var b=CL.state.viewangles;0===(CL.kbuttons[CL.kbutton.strafe].state&1)&&(b[1]+=a*CL.yawspeed.value*(CL.KeyState(CL.kbutton.left)-CL.KeyState(CL.kbutton.right)),b[1]=Vec.Anglemod(b[1]));0!==(CL.kbuttons[CL.kbutton.klook].state&1)&&(V.StopPitchDrift(),b[0]+=a*CL.pitchspeed.value* (CL.KeyState(CL.kbutton.back)-CL.KeyState(CL.kbutton.forward)));var c=CL.KeyState(CL.kbutton.lookup),e=CL.KeyState(CL.kbutton.lookdown);if(0!==c||0!==e)b[0]+=a*CL.pitchspeed.value*(e-c),V.StopPitchDrift();80<b[0]?b[0]=80:-70>b[0]&&(b[0]=-70);50<b[2]?b[2]=50:-50>b[2]&&(b[2]=-50)},BaseMove:function(){if(4===CL.cls.signon){CL.AdjustAngles();var a=CL.state.cmd;a.sidemove=CL.sidespeed.value*(CL.KeyState(CL.kbutton.moveright)-CL.KeyState(CL.kbutton.moveleft));0!==(CL.kbuttons[CL.kbutton.strafe].state&1)&& (a.sidemove+=CL.sidespeed.value*(CL.KeyState(CL.kbutton.right)-CL.KeyState(CL.kbutton.left)));a.upmove=CL.upspeed.value*(CL.KeyState(CL.kbutton.moveup)-CL.KeyState(CL.kbutton.movedown));a.forwardmove=0===(CL.kbuttons[CL.kbutton.klook].state&1)?CL.forwardspeed.value*CL.KeyState(CL.kbutton.forward)-CL.backspeed.value*CL.KeyState(CL.kbutton.back):0;0!==(CL.kbuttons[CL.kbutton.speed].state&1)&&(a.forwardmove*=CL.movespeedkey.value,a.sidemove*=CL.movespeedkey.value,a.upmove*=CL.movespeedkey.value)}}}; CL.sendmovebuf={data:new ArrayBuffer(16),cursize:0}; CL.SendMove=function(){var a=CL.sendmovebuf;a.cursize=0;MSG.WriteByte(a,Protocol.clc.move);MSG.WriteFloat(a,CL.state.mtime[0]);MSG.WriteAngle(a,CL.state.viewangles[0]);MSG.WriteAngle(a,CL.state.viewangles[1]);MSG.WriteAngle(a,CL.state.viewangles[2]);MSG.WriteShort(a,CL.state.cmd.forwardmove);MSG.WriteShort(a,CL.state.cmd.sidemove);MSG.WriteShort(a,CL.state.cmd.upmove);var b=0;0!==(CL.kbuttons[CL.kbutton.attack].state&3)&&(b+=1);CL.kbuttons[CL.kbutton.attack].state&=5;0!==(CL.kbuttons[CL.kbutton.jump].state& 3)&&(b+=2);CL.kbuttons[CL.kbutton.jump].state&=5;MSG.WriteByte(a,b);MSG.WriteByte(a,CL.impulse);CL.impulse=0;!0!==CL.cls.demoplayback&&(!(2>=++CL.state.movemessages)&&-1===NET.SendUnreliableMessage(CL.cls.netcon,a))&&(Con.Print("CL.SendMove: lost server connection\n"),CL.Disconnect())}; CL.InitInput=function(){var a,b="moveup movedown left right forward back lookup lookdown strafe moveleft moveright speed attack use jump klook".split(" ");for(a=0;a<b.length;++a)Cmd.AddCommand("+"+b[a],CL.KeyDown),Cmd.AddCommand("-"+b[a],CL.KeyUp);Cmd.AddCommand("impulse",CL.Impulse);Cmd.AddCommand("+mlook",CL.KeyDown);Cmd.AddCommand("-mlook",CL.MLookUp);for(a=0;a<CL.kbutton.num;++a)CL.kbuttons[a]={down:[0,0],state:0}};CL.cls={state:0,spawnparms:"",demonum:0,message:{data:new ArrayBuffer(8192),cursize:0}}; CL.static_entities=[];CL.visedicts=[]; CL.Rcon_f=function(){if(0===CL.rcon_password.string.length)Con.Print("You must set 'rcon_password' before\nissuing an rcon command.\n");else{var a;CL.cls.state===CL.active.connected&&0!==CL.cls.netcon.driver&&(a=CL.cls.netcon.address);if(null==a){if(0===CL.rcon_address.string.length){Con.Print("You must either be connected,\nor set the 'rcon_address' cvar\nto issue rcon commands\n");return}a=CL.rcon_address.string}var b="",c;for(c=1;c<Cmd.argv.length;++c)b+=Cmd.argv[c]+" ";c=new XMLHttpRequest;c.open("POST", "http://"+a);c.send("command=rcon&password="+encodeURIComponent(CL.rcon_password.string)+"&message="+encodeURIComponent(b))}}; CL.ClearState=function(){!0!==SV.server.active&&(Con.DPrint("Clearing memory\n"),Mod.ClearAll(),CL.cls.signon=0);CL.state={movemessages:0,cmd:{forwardmove:0,sidemove:0,upmove:0},stats:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],items:0,item_gettime:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],faceanimtime:0,cshifts:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],mviewangles:[[0,0,0],[0,0,0]],viewangles:[0,0,0],mvelocity:[[0,0,0],[0,0,0]],velocity:[0,0,0],punchangle:[0, 0,0],idealpitch:0,pitchvel:0,driftmove:0,laststop:0,crouch:0,intermission:0,completed_time:0,mtime:[0,0],time:0,oldtime:0,last_received_message:0,viewentity:0,num_statics:0,viewent:{skinnum:0},cdtrack:0,looptrack:0};CL.cls.message.cursize=0;CL.entities=[];var a;CL.dlights=[];for(a=0;31>=a;++a)CL.dlights[a]={radius:0,die:0};CL.lightstyle=[];for(a=0;63>=a;++a)CL.lightstyle[a]="";CL.beams=[];for(a=0;23>=a;++a)CL.beams[a]={endtime:0}}; CL.Disconnect=function(){S.StopAllSounds();!0===CL.cls.demoplayback?CL.StopPlayback():CL.cls.state===CL.active.connected&&(!0===CL.cls.demorecording&&CL.Stop_f(),Con.DPrint("Sending clc_disconnect\n"),CL.cls.message.cursize=0,MSG.WriteByte(CL.cls.message,Protocol.clc.disconnect),NET.SendUnreliableMessage(CL.cls.netcon,CL.cls.message),CL.cls.message.cursize=0,NET.Close(CL.cls.netcon),CL.cls.state=CL.active.disconnected,!0===SV.server.active&&Host.ShutdownServer());CL.cls.demoplayback=CL.cls.timedemo= !1;CL.cls.signon=0};CL.EstablishConnection=function(a){!0!==CL.cls.demoplayback&&(CL.Disconnect(),CL.cls.netcon=NET.Connect(a),null==CL.cls.netcon&&Con.Print("CL.EstablishConnection: connect failed\n"),Con.DPrint("CL.EstablishConnection: connected to "+a+"\n"),CL.cls.demonum=-1,CL.cls.state=CL.active.connected,CL.cls.signon=0)}; CL.SignonReply=function(){Con.DPrint("CL.SignonReply: "+CL.cls.signon+"\n");switch(CL.cls.signon){case 1:MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd);MSG.WriteString(CL.cls.message,"prespawn");break;case 2:MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd);MSG.WriteString(CL.cls.message,'name "'+CL.name.string+'"\n');MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd);MSG.WriteString(CL.cls.message,"color "+(CL.color.value>>4)+" "+(CL.color.value&15)+"\n");MSG.WriteByte(CL.cls.message, Protocol.clc.stringcmd);MSG.WriteString(CL.cls.message,"spawn "+CL.cls.spawnparms);break;case 3:MSG.WriteByte(CL.cls.message,Protocol.clc.stringcmd);MSG.WriteString(CL.cls.message,"begin");break;case 4:SCR.disabled_for_loading=!1}}; CL.NextDemo=function(){if(-1!==CL.cls.demonum){SCR.BeginLoadingPlaque();if(CL.cls.demonum>=CL.cls.demos.length){if(0===CL.cls.demos.length){Con.Print("No demos listed with startdemos\n");CL.cls.demonum=-1;return}CL.cls.demonum=0}Cmd.text="playdemo "+CL.cls.demos[CL.cls.demonum++]+"\n"+Cmd.text}}; CL.PrintEntities_f=function(){var a,b;for(a=0;a<CL.entities.length;++a)b=CL.entities[a],9>=a?Con.Print(" "+a+":"):99>=a?Con.Print(" "+a+":"):Con.Print(a+":"),null==b.model?Con.Print("EMPTY\n"):Con.Print(b.model.name+(9>=b.frame?": ":":")+b.frame+" ("+b.origin[0].toFixed(1)+","+b.origin[1].toFixed(1)+","+b.origin[2].toFixed(1)+") ["+b.angles[0].toFixed(1)+" "+b.angles[1].toFixed(1)+" "+b.angles[2].toFixed(1)+"]\n")}; CL.AllocDlight=function(a){var b,c;if(0!==a)for(b=0;31>=b;++b)if(CL.dlights[b].key===a){c=CL.dlights[b];break}if(null==c){for(b=0;31>=b;++b)if(CL.dlights[b].die<CL.state.time){c=CL.dlights[b];break}null==c&&(c=CL.dlights[0])}c.origin=[0,0,0];c.radius=0;c.die=0;c.decay=0;c.minlight=0;c.key=a;return c};CL.DecayLights=function(){var a,b,c=CL.state.time-CL.state.oldtime;for(a=0;31>=a;++a)b=CL.dlights[a],b.die<CL.state.time||0===b.radius||(b.radius-=c*b.decay,0>b.radius&&(b.radius=0))}; CL.LerpPoint=function(){var a=CL.state.mtime[0]-CL.state.mtime[1];if(0===a||0!==CL.nolerp.value||!0===CL.cls.timedemo||!0===SV.server.active)return CL.state.time=CL.state.mtime[0],1;0.1<a&&(CL.state.mtime[1]=CL.state.mtime[0]-0.1,a=0.1);a=(CL.state.time-CL.state.mtime[1])/a;return 0>a?(-0.01>a&&(CL.state.time=CL.state.mtime[1]),0):1<a?(1.01<a&&(CL.state.time=CL.state.mtime[0]),1):a}; CL.RelinkEntities=function(){var a,b,c=CL.LerpPoint(),e,f,g=[];CL.numvisedicts=0;CL.state.velocity[0]=CL.state.mvelocity[1][0]+c*(CL.state.mvelocity[0][0]-CL.state.mvelocity[1][0]);CL.state.velocity[1]=CL.state.mvelocity[1][1]+c*(CL.state.mvelocity[0][1]-CL.state.mvelocity[1][1]);if(!0===CL.cls.demoplayback)for(a=0;2>=a;++a)f=CL.state.mviewangles[0][a]-CL.state.mviewangles[1][a],180<f?f-=360:-180>f&&(f+=360),CL.state.viewangles[a]=CL.state.mviewangles[1][a]+c*f;var h=Vec.Anglemod(100*CL.state.time), d,j;for(a=1;a<CL.entities.length;++a)if(d=CL.entities[a],null!=d.model&&d.msgtime===CL.state.mtime[0]){j=[d.origin[0],d.origin[1],d.origin[2]];if(!0===d.forcelink)d.origin=[d.msg_origins[0][0],d.msg_origins[0][1],d.msg_origins[0][2]],d.angles=[d.msg_angles[0][0],d.msg_angles[0][1],d.msg_angles[0][2]];else{e=c;for(b=0;2>=b;++b)if(g[b]=d.msg_origins[0][b]-d.msg_origins[1][b],100<g[b]||-100>g[b])e=1;for(b=0;2>=b;++b)d.origin[b]=d.msg_origins[1][b]+e*g[b],f=d.msg_angles[0][b]-d.msg_angles[1][b],180<f? f-=360:-180>f&&(f+=360),d.angles[b]=d.msg_angles[1][b]+e*f}0!==(d.model.flags&Mod.flags.rotate)&&(d.angles[1]=h);0!==(d.effects&Mod.effects.brightfield)&&R.EntityParticles(d);0!==(d.effects&Mod.effects.muzzleflash)&&(b=CL.AllocDlight(a),e=[],Vec.AngleVectors(d.angles,e),b.origin=[d.origin[0]+18*e[0],d.origin[1]+18*e[1],d.origin[2]+16+18*e[2]],b.radius=200+32*Math.random(),b.minlight=32,b.die=CL.state.time+0.1);0!==(d.effects&Mod.effects.brightlight)&&(b=CL.AllocDlight(a),b.origin=[d.origin[0],d.origin[1], d.origin[2]+16],b.radius=400+32*Math.random(),b.die=CL.state.time+0.001);0!==(d.effects&Mod.effects.dimlight)&&(b=CL.AllocDlight(a),b.origin=[d.origin[0],d.origin[1],d.origin[2]+16],b.radius=200+32*Math.random(),b.die=CL.state.time+0.001);0!==(d.model.flags&Mod.flags.gib)?R.RocketTrail(j,d.origin,2):0!==(d.model.flags&Mod.flags.zomgib)?R.RocketTrail(j,d.origin,4):0!==(d.model.flags&Mod.flags.tracer)?R.RocketTrail(j,d.origin,3):0!==(d.model.flags&Mod.flags.tracer2)?R.RocketTrail(j,d.origin,5):0!== (d.model.flags&Mod.flags.rocket)?(R.RocketTrail(j,d.origin,0),b=CL.AllocDlight(a),b.origin=[d.origin[0],d.origin[1],d.origin[2]],b.radius=200,b.die=CL.state.time+0.01):0!==(d.model.flags&Mod.flags.grenade)?R.RocketTrail(j,d.origin,1):0!==(d.model.flags&Mod.flags.tracer3)&&R.RocketTrail(j,d.origin,6);d.forcelink=!1;a===CL.state.viewentity&&0===Chase.active.value||(CL.visedicts[CL.numvisedicts++]=d)}}; CL.ReadFromServer=function(){CL.state.oldtime=CL.state.time;CL.state.time+=Host.frametime;for(var a;;){a=CL.GetMessage();-1===a&&Host.Error("CL.ReadFromServer: lost server connection");if(0===a)break;CL.state.last_received_message=Host.realtime;CL.ParseServerMessage();if(CL.cls.state!==CL.active.connected)break}0!==CL.shownet.value&&Con.Print("\n");CL.RelinkEntities();CL.UpdateTEnts()}; CL.SendCmd=function(){CL.cls.state===CL.active.connected&&(4===CL.cls.signon&&(CL.BaseMove(),CL.SendMove()),!0===CL.cls.demoplayback?CL.cls.message.cursize=0:0!==CL.cls.message.cursize&&(!0!==NET.CanSendMessage(CL.cls.netcon)?Con.DPrint("CL.SendCmd: can't send\n"):(-1===NET.SendMessage(CL.cls.netcon,CL.cls.message)&&Host.Error("CL.SendCmd: lost server connection"),CL.cls.message.cursize=0)))}; CL.Init=function(){CL.ClearState();CL.InitInput();CL.InitTEnts();CL.name=Cvar.RegisterVariable("_cl_name","player",!0);CL.color=Cvar.RegisterVariable("_cl_color","0",!0);CL.upspeed=Cvar.RegisterVariable("cl_upspeed","200");CL.forwardspeed=Cvar.RegisterVariable("cl_forwardspeed","200",!0);CL.backspeed=Cvar.RegisterVariable("cl_backspeed","200",!0);CL.sidespeed=Cvar.RegisterVariable("cl_sidespeed","350");CL.movespeedkey=Cvar.RegisterVariable("cl_movespeedkey","2.0");CL.yawspeed=Cvar.RegisterVariable("cl_yawspeed", "140");CL.pitchspeed=Cvar.RegisterVariable("cl_pitchspeed","150");CL.anglespeedkey=Cvar.RegisterVariable("cl_anglespeedkey","1.5");CL.shownet=Cvar.RegisterVariable("cl_shownet","0");CL.nolerp=Cvar.RegisterVariable("cl_nolerp","0");CL.lookspring=Cvar.RegisterVariable("lookspring","0",!0);CL.lookstrafe=Cvar.RegisterVariable("lookstrafe","0",!0);CL.sensitivity=Cvar.RegisterVariable("sensitivity","3",!0);CL.m_pitch=Cvar.RegisterVariable("m_pitch","0.022",!0);CL.m_yaw=Cvar.RegisterVariable("m_yaw","0.022", !0);CL.m_forward=Cvar.RegisterVariable("m_forward","1",!0);CL.m_side=Cvar.RegisterVariable("m_side","0.8",!0);CL.rcon_password=Cvar.RegisterVariable("rcon_password","");CL.rcon_address=Cvar.RegisterVariable("rcon_address","");Cmd.AddCommand("entities",CL.PrintEntities_f);Cmd.AddCommand("disconnect",CL.Disconnect);Cmd.AddCommand("record",CL.Record_f);Cmd.AddCommand("stop",CL.Stop_f);Cmd.AddCommand("playdemo",CL.PlayDemo_f);Cmd.AddCommand("timedemo",CL.TimeDemo_f);Cmd.AddCommand("rcon",CL.Rcon_f)}; CL.svc_strings="bad;nop;disconnect;updatestat;version;setview;sound;time;print;stufftext;setangle;serverinfo;lightstyle;updatename;updatefrags;clientdata;stopsound;updatecolors;particle;damage;spawnstatic;OBSOLETE spawnbinary;spawnbaseline;temp_entity;setpause;signonnum;centerprint;killedmonster;foundsecret;spawnstaticsound;intermission;finale;cdtrack;sellscreen;cutscene".split(";"); CL.EntityNum=function(a){if(a<CL.entities.length)return CL.entities[a];for(;CL.entities.length<=a;)CL.entities[CL.entities.length]={num:a,update_type:0,baseline:{origin:[0,0,0],angles:[0,0,0],modelindex:0,frame:0,colormap:0,skin:0,effects:0},msgtime:0,msg_origins:[[0,0,0],[0,0,0]],origin:[0,0,0],msg_angles:[[0,0,0],[0,0,0]],angles:[0,0,0],frame:0,syncbase:0,effects:0,skinnum:0,visframe:0,dlightframe:0,dlightbits:0};return CL.entities[a]}; CL.ParseStartSoundPacket=function(){var a=MSG.ReadByte(),b=0!==(a&1)?MSG.ReadByte():255,a=0!==(a&2)?0.015625*MSG.ReadByte():1,c=MSG.ReadShort(),e=MSG.ReadByte(),f=c>>3,c=c&7,g=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()];S.StartSound(f,c,CL.state.sound_precache[e],g,b/255,a)};CL.lastmsg=0; CL.KeepaliveMessage=function(){if(!(!0===SV.server.active||!0===CL.cls.demoplayback)){var a=NET.message.cursize,b=new Uint8Array(8192);b.set(new Uint8Array(NET.message.data,0,a));for(var c;;){c=CL.GetMessage();switch(c){case 0:break;case 1:Host.Error("CL.KeepaliveMessage: received a message");case 2:MSG.ReadByte()!==Protocol.svc.nop&&Host.Error("CL.KeepaliveMessage: datagram wasn't a nop");default:Host.Error("CL.KeepaliveMessage: CL.GetMessage failed")}if(0===c)break}NET.message.cursize=a;(new Uint8Array(NET.message.data, 0,a)).set(b);a=Sys.FloatTime();5>a-CL.lastmsg||(CL.lastmsg=a,Con.Print("--\x3e client to server keepalive\n"),MSG.WriteByte(CL.cls.message,Protocol.clc.nop),NET.SendMessage(CL.cls.netcon,CL.cls.message),CL.cls.message.cursize=0)}}; CL.ParseServerInfo=function(){Con.DPrint("Serverinfo packet received.\n");CL.ClearState();var a=MSG.ReadLong();if(a!==Protocol.version)Con.Print("Server returned version "+a+", not "+Protocol.version+"\n");else if(CL.state.maxclients=MSG.ReadByte(),0>=CL.state.maxclients||16<CL.state.maxclients)Con.Print("Bad maxclients ("+CL.state.maxclients+") from server\n");else{CL.state.scores=[];for(a=0;a<CL.state.maxclients;++a)CL.state.scores[a]={name:"",entertime:0,frags:0,colors:0};CL.state.gametype=MSG.ReadByte(); CL.state.levelname=MSG.ReadString();Con.Print("\n\n\u001d\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001e\u001f\n\n");Con.Print("\u0002"+CL.state.levelname+"\n");var b,c=[];for(b=1;;++b){a=MSG.ReadString();if(0===a.length)break;c[b]=a}var e,f=[];for(e=1;;++e){a=MSG.ReadString();if(0===a.length)break;f[e]=a}CL.state.model_precache=[];for(a= 1;a<b;++a){CL.state.model_precache[a]=Mod.ForName(c[a]);if(null==CL.state.model_precache[a]){Con.Print("Model "+c[a]+" not found\n");return}CL.KeepaliveMessage()}CL.state.sound_precache=[];for(a=1;a<e;++a)CL.state.sound_precache[a]=S.PrecacheSound(f[a]),CL.KeepaliveMessage();CL.state.worldmodel=CL.state.model_precache[1];CL.EntityNum(0).model=CL.state.worldmodel;R.NewMap();Host.noclip_anglehack=!1}}; CL.ParseUpdate=function(a){3===CL.cls.signon&&(CL.cls.signon=4,CL.SignonReply());0!==(a&Protocol.u.morebits)&&(a+=MSG.ReadByte()<<8);var b=CL.EntityNum(0!==(a&Protocol.u.longentity)?MSG.ReadShort():MSG.ReadByte()),c=b.msgtime!==CL.state.mtime[1];b.msgtime=CL.state.mtime[0];var e=CL.state.model_precache[0!==(a&Protocol.u.model)?MSG.ReadByte():b.baseline.modelindex];e!==b.model&&(b.model=e,null!=e?b.syncbase=!0===e.random?Math.random():0:c=!0);b.frame=0!==(a&Protocol.u.frame)?MSG.ReadByte():b.baseline.frame; b.colormap=0!==(a&Protocol.u.colormap)?MSG.ReadByte():b.baseline.colormap;b.colormap>CL.state.maxclients&&Sys.Error("i >= cl.maxclients");b.skinnum=0!==(a&Protocol.u.skin)?MSG.ReadByte():b.baseline.skin;b.effects=0!==(a&Protocol.u.effects)?MSG.ReadByte():b.baseline.effects;b.msg_origins[1]=[b.msg_origins[0][0],b.msg_origins[0][1],b.msg_origins[0][2]];b.msg_angles[1]=[b.msg_angles[0][0],b.msg_angles[0][1],b.msg_angles[0][2]];b.msg_origins[0][0]=0!==(a&Protocol.u.origin1)?MSG.ReadCoord():b.baseline.origin[0]; b.msg_angles[0][0]=0!==(a&Protocol.u.angle1)?MSG.ReadAngle():b.baseline.angles[0];b.msg_origins[0][1]=0!==(a&Protocol.u.origin2)?MSG.ReadCoord():b.baseline.origin[1];b.msg_angles[0][1]=0!==(a&Protocol.u.angle2)?MSG.ReadAngle():b.baseline.angles[1];b.msg_origins[0][2]=0!==(a&Protocol.u.origin3)?MSG.ReadCoord():b.baseline.origin[2];b.msg_angles[0][2]=0!==(a&Protocol.u.angle3)?MSG.ReadAngle():b.baseline.angles[2];0!==(a&Protocol.u.nolerp)&&(b.forcelink=!0);!0===c&&(b.msg_origins[1]=[b.msg_origins[0][0], b.msg_origins[0][1],b.msg_origins[0][2]],b.origin=[b.msg_origins[0][0],b.msg_origins[0][1],b.msg_origins[0][2]],b.msg_angles[1]=[b.msg_angles[0][0],b.msg_angles[0][1],b.msg_angles[0][2]],b.angles=[b.msg_angles[0][0],b.msg_angles[0][1],b.msg_angles[0][2]],b.forcelink=!0)}; CL.ParseBaseline=function(a){a.baseline.modelindex=MSG.ReadByte();a.baseline.frame=MSG.ReadByte();a.baseline.colormap=MSG.ReadByte();a.baseline.skin=MSG.ReadByte();a.baseline.origin[0]=MSG.ReadCoord();a.baseline.angles[0]=MSG.ReadAngle();a.baseline.origin[1]=MSG.ReadCoord();a.baseline.angles[1]=MSG.ReadAngle();a.baseline.origin[2]=MSG.ReadCoord();a.baseline.angles[2]=MSG.ReadAngle()}; CL.ParseClientdata=function(a){var b;CL.state.viewheight=0!==(a&Protocol.su.viewheight)?MSG.ReadChar():Protocol.default_viewheight;CL.state.idealpitch=0!==(a&Protocol.su.idealpitch)?MSG.ReadChar():0;CL.state.mvelocity[1]=[CL.state.mvelocity[0][0],CL.state.mvelocity[0][1],CL.state.mvelocity[0][2]];for(b=0;2>=b;++b)CL.state.punchangle[b]=0!==(a&Protocol.su.punch1<<b)?MSG.ReadChar():0,CL.state.mvelocity[0][b]=0!==(a&Protocol.su.velocity1<<b)?16*MSG.ReadChar():0;b=MSG.ReadLong();var c;if(CL.state.items!== b){for(c=0;31>=c;++c)0!==(b>>>c&1)&&0===(CL.state.items>>>c&1)&&(CL.state.item_gettime[c]=CL.state.time);CL.state.items=b}CL.state.onground=0!==(a&Protocol.su.onground);CL.state.inwater=0!==(a&Protocol.su.inwater);CL.state.stats[Def.stat.weaponframe]=0!==(a&Protocol.su.weaponframe)?MSG.ReadByte():0;CL.state.stats[Def.stat.armor]=0!==(a&Protocol.su.armor)?MSG.ReadByte():0;CL.state.stats[Def.stat.weapon]=0!==(a&Protocol.su.weapon)?MSG.ReadByte():0;CL.state.stats[Def.stat.health]=MSG.ReadShort();CL.state.stats[Def.stat.ammo]= MSG.ReadByte();CL.state.stats[Def.stat.shells]=MSG.ReadByte();CL.state.stats[Def.stat.nails]=MSG.ReadByte();CL.state.stats[Def.stat.rockets]=MSG.ReadByte();CL.state.stats[Def.stat.cells]=MSG.ReadByte();CL.state.stats[Def.stat.activeweapon]=!0===COM.standard_quake?MSG.ReadByte():1<<MSG.ReadByte()}; CL.ParseStatic=function(){var a={num:-1,update_type:0,baseline:{origin:[],angles:[]},msgtime:0,msg_origins:[[0,0,0],[0,0,0]],msg_angles:[[0,0,0],[0,0,0]],syncbase:0,visframe:0,dlightframe:0,dlightbits:0,leafs:[]};CL.static_entities[CL.state.num_statics++]=a;CL.ParseBaseline(a);a.model=CL.state.model_precache[a.baseline.modelindex];a.frame=a.baseline.frame;a.skinnum=a.baseline.skin;a.effects=a.baseline.effects;a.origin=[a.baseline.origin[0],a.baseline.origin[1],a.baseline.origin[2]];a.angles=[a.baseline.angles[0], a.baseline.angles[1],a.baseline.angles[2]];R.currententity=a;R.emins=[a.origin[0]+a.model.mins[0],a.origin[1]+a.model.mins[1],a.origin[2]+a.model.mins[2]];R.emaxs=[a.origin[0]+a.model.maxs[0],a.origin[1]+a.model.maxs[1],a.origin[2]+a.model.maxs[2]];R.SplitEntityOnNode(CL.state.worldmodel.nodes[0])};CL.ParseStaticSound=function(){var a=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],b=MSG.ReadByte(),c=MSG.ReadByte(),e=MSG.ReadByte();S.StaticSound(CL.state.sound_precache[b],a,c/255,e)}; CL.Shownet=function(a){2===CL.shownet.value&&Con.Print((99>=MSG.readcount?9>=MSG.readcount?" ":" ":"")+(MSG.readcount-1)+":"+a+"\n")}; CL.ParseServerMessage=function(){1===CL.shownet.value?Con.Print(NET.message.cursize+" "):2===CL.shownet.value&&Con.Print("------------------\n");CL.state.onground=!1;MSG.BeginReading();for(var a;;){!0===MSG.badread&&Host.Error("CL.ParseServerMessage: Bad server message");a=MSG.ReadByte();if(-1===a){CL.Shownet("END OF MESSAGE");break}if(0!==(a&128))CL.Shownet("fast update"),CL.ParseUpdate(a&127);else{CL.Shownet("svc_"+CL.svc_strings[a]);switch(a){case Protocol.svc.nop:continue;case Protocol.svc.time:CL.state.mtime[1]= CL.state.mtime[0];CL.state.mtime[0]=MSG.ReadFloat();continue;case Protocol.svc.clientdata:CL.ParseClientdata(MSG.ReadShort());continue;case Protocol.svc.version:a=MSG.ReadLong();a!==Protocol.version&&Host.Error("CL.ParseServerMessage: Server is protocol "+a+" instead of "+Protocol.version+"\n");continue;case Protocol.svc.disconnect:Host.EndGame("Server disconnected\n");case Protocol.svc.print:Con.Print(MSG.ReadString());continue;case Protocol.svc.centerprint:SCR.CenterPrint(MSG.ReadString());continue; case Protocol.svc.stufftext:Cmd.text+=MSG.ReadString();continue;case Protocol.svc.damage:V.ParseDamage();continue;case Protocol.svc.serverinfo:CL.ParseServerInfo();SCR.recalc_refdef=!0;continue;case Protocol.svc.setangle:CL.state.viewangles[0]=MSG.ReadAngle();CL.state.viewangles[1]=MSG.ReadAngle();CL.state.viewangles[2]=MSG.ReadAngle();continue;case Protocol.svc.setview:CL.state.viewentity=MSG.ReadShort();continue;case Protocol.svc.lightstyle:a=MSG.ReadByte();64<=a&&Sys.Error("svc_lightstyle > MAX_LIGHTSTYLES"); CL.lightstyle[a]=MSG.ReadString();continue;case Protocol.svc.sound:CL.ParseStartSoundPacket();continue;case Protocol.svc.stopsound:a=MSG.ReadShort();S.StopSound(a>>3,a&7);continue;case Protocol.svc.updatename:a=MSG.ReadByte();a>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatename > MAX_SCOREBOARD");CL.state.scores[a].name=MSG.ReadString();continue;case Protocol.svc.updatefrags:a=MSG.ReadByte();a>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatefrags > MAX_SCOREBOARD"); CL.state.scores[a].frags=MSG.ReadShort();continue;case Protocol.svc.updatecolors:a=MSG.ReadByte();a>=CL.state.maxclients&&Host.Error("CL.ParseServerMessage: svc_updatecolors > MAX_SCOREBOARD");CL.state.scores[a].colors=MSG.ReadByte();continue;case Protocol.svc.particle:R.ParseParticleEffect();continue;case Protocol.svc.spawnbaseline:CL.ParseBaseline(CL.EntityNum(MSG.ReadShort()));continue;case Protocol.svc.spawnstatic:CL.ParseStatic();continue;case Protocol.svc.temp_entity:CL.ParseTEnt();continue; case Protocol.svc.setpause:CL.state.paused=0!==MSG.ReadByte();!0===CL.state.paused?CDAudio.Pause():CDAudio.Resume();continue;case Protocol.svc.signonnum:a=MSG.ReadByte();a<=CL.cls.signon&&Host.Error("Received signon "+a+" when at "+CL.cls.signon);CL.cls.signon=a;CL.SignonReply();continue;case Protocol.svc.killedmonster:++CL.state.stats[Def.stat.monsters];continue;case Protocol.svc.foundsecret:++CL.state.stats[Def.stat.secrets];continue;case Protocol.svc.updatestat:a=MSG.ReadByte();32<=a&&Sys.Error("svc_updatestat: "+ a+" is invalid");CL.state.stats[a]=MSG.ReadLong();continue;case Protocol.svc.spawnstaticsound:CL.ParseStaticSound();continue;case Protocol.svc.cdtrack:CL.state.cdtrack=MSG.ReadByte();MSG.ReadByte();(!0===CL.cls.demoplayback||!0===CL.cls.demorecording)&&-1!==CL.cls.forcetrack?CDAudio.Play(CL.cls.forcetrack,!0):CDAudio.Play(CL.state.cdtrack,!0);continue;case Protocol.svc.intermission:CL.state.intermission=1;CL.state.completed_time=CL.state.time;SCR.recalc_refdef=!0;continue;case Protocol.svc.finale:CL.state.intermission= 2;CL.state.completed_time=CL.state.time;SCR.recalc_refdef=!0;SCR.CenterPrint(MSG.ReadString());continue;case Protocol.svc.cutscene:CL.state.intermission=3;CL.state.completed_time=CL.state.time;SCR.recalc_refdef=!0;SCR.CenterPrint(MSG.ReadString());continue;case Protocol.svc.sellscreen:Cmd.ExecuteString("help");continue}Host.Error("CL.ParseServerMessage: Illegible server message\n")}}};CL.temp_entities=[]; CL.InitTEnts=function(){CL.sfx_wizhit=S.PrecacheSound("wizard/hit.wav");CL.sfx_knighthit=S.PrecacheSound("hknight/hit.wav");CL.sfx_tink1=S.PrecacheSound("weapons/tink1.wav");CL.sfx_ric1=S.PrecacheSound("weapons/ric1.wav");CL.sfx_ric2=S.PrecacheSound("weapons/ric2.wav");CL.sfx_ric3=S.PrecacheSound("weapons/ric3.wav");CL.sfx_r_exp3=S.PrecacheSound("weapons/r_exp3.wav")}; CL.ParseBeam=function(a){var b=MSG.ReadShort(),c=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],e=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],f,g;for(f=0;23>=f;++f)if(g=CL.beams[f],g.entity===b){g.model=a;g.endtime=CL.state.time+0.2;g.start=[c[0],c[1],c[2]];g.end=[e[0],e[1],e[2]];return}for(f=0;23>=f;++f)if(g=CL.beams[f],!(null!=g.model&&g.endtime>=CL.state.time)){g.entity=b;g.model=a;g.endtime=CL.state.time+0.2;g.start=[c[0],c[1],c[2]];g.end=[e[0],e[1],e[2]];return}Con.Print("beam list overflow!\n")}; CL.ParseTEnt=function(){var a=MSG.ReadByte();switch(a){case Protocol.te.lightning1:CL.ParseBeam(Mod.ForName("progs/bolt.mdl",!0));return;case Protocol.te.lightning2:CL.ParseBeam(Mod.ForName("progs/bolt2.mdl",!0));return;case Protocol.te.lightning3:CL.ParseBeam(Mod.ForName("progs/bolt3.mdl",!0));return;case Protocol.te.beam:CL.ParseBeam(Mod.ForName("progs/beam.mdl",!0));return}var b=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()];switch(a){case Protocol.te.wizspike:R.RunParticleEffect(b,Vec.origin, 20,20);S.StartSound(-1,0,CL.sfx_wizhit,b,1,1);return;case Protocol.te.knightspike:R.RunParticleEffect(b,Vec.origin,226,20);S.StartSound(-1,0,CL.sfx_knighthit,b,1,1);return;case Protocol.te.spike:R.RunParticleEffect(b,Vec.origin,0,10);return;case Protocol.te.superspike:R.RunParticleEffect(b,Vec.origin,0,20);return;case Protocol.te.gunshot:R.RunParticleEffect(b,Vec.origin,0,20);return;case Protocol.te.explosion:R.ParticleExplosion(b);a=CL.AllocDlight(0);a.origin=[b[0],b[1],b[2]];a.radius=350;a.die= CL.state.time+0.5;a.decay=300;S.StartSound(-1,0,CL.sfx_r_exp3,b,1,1);return;case Protocol.te.tarexplosion:R.BlobExplosion(b);S.StartSound(-1,0,CL.sfx_r_exp3,b,1,1);return;case Protocol.te.lavasplash:R.LavaSplash(b);return;case Protocol.te.teleport:R.TeleportSplash(b);return;case Protocol.te.explosion2:var a=MSG.ReadByte(),c=MSG.ReadByte();R.ParticleExplosion2(b,a,c);a=CL.AllocDlight(0);a.origin=[b[0],b[1],b[2]];a.radius=350;a.die=CL.state.time+0.5;a.decay=300;S.StartSound(-1,0,CL.sfx_r_exp3,b,1,1); return}Sys.Error("CL.ParseTEnt: bad type")};CL.NewTempEntity=function(){var a={frame:0,syncbase:0,skinnum:0};CL.temp_entities[CL.num_temp_entities++]=a;return CL.visedicts[CL.numvisedicts++]=a}; CL.UpdateTEnts=function(){CL.num_temp_entities=0;var a,b,c=[],e,f,g=[],h,d;for(a=0;23>=a;++a)if(b=CL.beams[a],!(null==b.model||b.endtime<CL.state.time)){b.entity===CL.state.viewentity&&Vec.Copy(CL.entities[CL.state.viewentity].origin,b.start);c[0]=b.end[0]-b.start[0];c[1]=b.end[1]-b.start[1];c[2]=b.end[2]-b.start[2];0===c[0]&&0===c[1]?(e=0,f=0<c[2]?90:270):(e=180*Math.atan2(c[1],c[0])/Math.PI>>0,0>e&&(e+=360),f=180*Math.atan2(c[2],Math.sqrt(c[0]*c[0]+c[1]*c[1]))/Math.PI>>0,0>f&&(f+=360));g[0]=b.start[0]; g[1]=b.start[1];g[2]=b.start[2];h=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);0!==h&&(c[0]/=h,c[1]/=h,c[2]/=h);for(;0<h;)d=CL.NewTempEntity(),d.origin=[g[0],g[1],g[2]],d.model=b.model,d.angles=[f,e,360*Math.random()],g[0]+=30*c[0],g[1]+=30*c[1],g[2]+=30*c[2],h-=30}};
var Cmd={alias:[],Wait_f:function(){Cmd.wait=!0},text:"",Execute:function(){for(var a,c="",b=!1;0!==Cmd.text.length;)if(a=Cmd.text.charCodeAt(0),Cmd.text=Cmd.text.substring(1),34===a)b=!b,c+='"';else if(!1===b&&59===a||10===a){if(0!==c.length){Cmd.ExecuteString(c);if(!0===Cmd.wait){Cmd.wait=!1;return}c=""}}else c+=String.fromCharCode(a);Cmd.text=""},StuffCmds_f:function(){var a,c=!1,b="",d;for(a=0;a<COM.argv.length;++a)d=COM.argv[a].charCodeAt(0),!0===c?43===d?b+="\n"+COM.argv[a].substring(1)+" ": 45===d?(c=!1,b+="\n"):b+=COM.argv[a]+" ":43===d&&(c=!0,b+=COM.argv[a].substring(1)+" ");0!==b.length&&(Cmd.text+=b+"\n")},Exec_f:function(){if(2!==Cmd.argv.length)Con.Print("exec <filename> : execute a script file\n");else{var a=COM.LoadTextFile(Cmd.argv[1]);null==a?Con.Print("couldn't exec "+Cmd.argv[1]+"\n"):(Con.Print("execing "+Cmd.argv[1]+"\n"),Cmd.text=a+Cmd.text)}},Echo_f:function(){var a;for(a=1;a<Cmd.argv.length;++a)Con.Print(Cmd.argv[a]+" ");Con.Print("\n")},Alias_f:function(){var a;if(1>= Cmd.argv.length){Con.Print("Current alias commands:\n");for(a=0;a<Cmd.alias.length;++a)Con.Print(Cmd.alias[a].name+" : "+Cmd.alias[a].value+"\n")}var c=Cmd.argv[1],b="";for(a=0;a<Cmd.alias.length&&Cmd.alias[a].name!==c;++a);var d;for(d=2;d<Cmd.argv.length;++d)b+=Cmd.argv[d],d!==Cmd.argv.length&&(b+=" ");Cmd.alias[a]={name:c,value:b+"\n"}},argv:[],functions:[],Init:function(){Cmd.AddCommand("stuffcmds",Cmd.StuffCmds_f);Cmd.AddCommand("exec",Cmd.Exec_f);Cmd.AddCommand("echo",Cmd.Echo_f);Cmd.AddCommand("alias", Cmd.Alias_f);Cmd.AddCommand("cmd",Cmd.ForwardToServer);Cmd.AddCommand("wait",Cmd.Wait_f)},TokenizeString:function(a){Cmd.argv=[];for(var c,b;;){for(c=0;c<a.length&&!(b=a.charCodeAt(c),32<b||10===b);++c);1===Cmd.argv.length&&(Cmd.args=a.substring(c));if(10===a.charCodeAt(c)||c>=a.length)break;a=COM.Parse(a);if(null==a)break;Cmd.argv[Cmd.argv.length]=COM.token}},AddCommand:function(a,c){var b;for(b=0;b<Cvar.vars.length;++b)if(Cvar.vars[b].name===a){Con.Print("Cmd.AddCommand: "+a+" already defined as a var\n"); return}for(b=0;b<Cmd.functions.length;++b)if(Cmd.functions[b].name===a){Con.Print("Cmd.AddCommand: "+a+" already defined\n");return}Cmd.functions[Cmd.functions.length]={name:a,command:c}},CompleteCommand:function(a){if(0!==a.length){var c;for(c=0;c<Cmd.functions.length;++c)if(Cmd.functions[c].name.substring(0,a.length)===a)return Cmd.functions[c].name}},ExecuteString:function(a,c){Cmd.client=c;Cmd.TokenizeString(a);if(0!==Cmd.argv.length){var b=Cmd.argv[0].toLowerCase(),d;for(d=0;d<Cmd.functions.length;++d)if(Cmd.functions[d].name=== b){Cmd.functions[d].command();return}for(d=0;d<Cmd.alias.length;++d)if(Cmd.alias[d].name===b){Cmd.text=Cmd.alias[d].value+Cmd.text;return}!0!==Cvar.Command()&&Con.Print('Unknown command "'+b+'"\n')}},ForwardToServer:function(){if(CL.cls.state!==CL.active.connected)Con.Print("Can't \""+Cmd.argv[0]+'", not connected\n');else if(!0!==CL.cls.demoplayback){var a=String.fromCharCode(Protocol.clc.stringcmd);"cmd"!==Cmd.argv[0].toLowerCase()&&(a+=Cmd.argv[0]+" ");a=2<=Cmd.argv.length?a+Cmd.args:a+"\n";MSG.WriteString(CL.cls.message, a)}}};
var COM={argv:[],standard_quake:!0,DefaultExtension:function(b,a){var c,d;for(c=b.length-1;0<=c;--c){d=b.charCodeAt(c);if(47===d)break;if(46===d)return b}return b+a},Parse:function(b){COM.token="";var a=0,c;if(0!==b.length){for(var d=!0;!0===d;){for(d=!1;;){if(a>=b.length)return;c=b.charCodeAt(a);if(32<c)break;++a}if(47===c&&47==b.charCodeAt(a+1)){for(;!(a>=b.length||10===b.charCodeAt(a));)++a;d=!0}}if(34===c)for(++a;;){c=b.charCodeAt(a);++a;if(a>=b.length||34===c)return b.substring(a);COM.token+= String.fromCharCode(c)}for(;!(a>=b.length||32>=c);)COM.token+=String.fromCharCode(c),++a,c=b.charCodeAt(a);return b.substring(a)}},CheckParm:function(b){var a;for(a=0;a<COM.argv.length;++a)if(COM.argv[a]===b)return a},CheckRegistered:function(){var b=COM.LoadFile("gfx/pop.lmp");if(null==b)Con.Print("Playing shareware version.\n"),!0===COM.modified&&Sys.Error("You must have the registered version to use modified games");else{var b=new Uint8Array(b),a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,102,0, 0,0,0,0,0,0,102,0,0,0,0,0,0,102,0,0,0,0,0,0,0,0,0,103,0,0,0,0,102,101,0,0,0,0,0,0,0,0,0,101,102,0,0,99,101,97,0,0,0,0,0,0,0,0,0,97,101,99,0,100,101,97,0,0,0,0,0,0,0,0,0,97,101,100,0,100,101,100,0,0,100,105,105,105,100,0,0,100,101,100,0,99,101,104,98,0,0,100,104,100,0,0,98,104,101,99,0,0,101,103,105,99,0,100,103,100,0,99,105,103,101,0,0,0,98,102,103,105,106,104,103,104,106,105,103,102,98,0,0,0,0,98,101,102,102,102,102,102,102,102,101,98,0,0,0,0,0,0,0,98,99,100,102,100,99,98,0,0,0,0,0,0,0,0,0,0,0,98, 102,98,0,0,0,0,0,0,0,0,0,0,0,0,0,97,102,97,0,0,0,0,0,0,0,0,0,0,0,0,0,0,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0],c;for(c=0;256>c;++c)b[c]!==a[c]&&Sys.Error("Corrupted data file.");Cvar.Set("registered","1");Con.Print("Playing registered version.\n")}},InitArgv:function(b){var a;for(a=0;a<b.length;++a)COM.argv[a]=b[a];null!=COM.CheckParm("-safe")&&(COM.argv[COM.argv.length]="-nosound",COM.argv[COM.argv.length]="-nocdaudio");null!=COM.CheckParm("-rogue")?(COM.rogue=!0,COM.standard_quake= !1):null!=COM.CheckParm("-hipnotic")&&(COM.hipnotic=!0,COM.standard_quake=!1)},Init:function(){"http:"!==document.location.protocol&&"https:"!==document.location.protocol&&Sys.Error("Protocol is "+document.location.protocol+", not http: or https:");var b=new ArrayBuffer(2),a=new Uint8Array(b);a[0]=1;a[1]=0;1===(new Uint16Array(b))[0]?(Q.BigShort=Q.ShortSwap,Q.LittleShort=Q.NoSwap,Q.BigUShort=Q.UShortSwap,Q.LittleUShort=Q.NoSwap,Q.BigLong=Q.LongSwap,Q.LittleLong=Q.NoSwap,Q.BigULong=Q.ULongSwap,Q.LittleULong= Q.NoSwap,Q.BigFloat=Q.FloatSwap,Q.LittleFloat=Q.NoSwap):(Q.BigShort=Q.NoSwap,Q.LittleShort=Q.ShortSwap,Q.BigUShort=Q.NoSwap,Q.LittleUShort=Q.UShortSwap,Q.BigLong=Q.NoSwap,Q.LittleLong=Q.LongSwap,Q.BigULong=Q.NoSwap,Q.LittleULong=Q.ULongSwap,Q.BigFloat=Q.NoSwap,Q.LittleFloat=Q.FloatSwap);COM.registered=Cvar.RegisterVariable("registered","0");COM.InitFilesystem();COM.CheckRegistered()},searchpaths:[],Path_f:function(){Con.Print("Current search path:\n");for(var b=COM.searchpaths.length,a,b=COM.searchpaths.length- 1;0<=b;--b){for(a=COM.searchpaths[b].pack.length-1;0<=a;--a)Con.Print(COM.searchpaths[b].filename+"/pak"+a+".pak ("+COM.searchpaths[b].pack[a].length+" files)\n");Con.Print(COM.searchpaths[b].filename+"\n")}},WriteFile:function(b,a,c){var d=[],e;for(e=0;e<c;++e)d[e]=String.fromCharCode(a[e]);try{localStorage.setItem("Quake."+COM.searchpaths[COM.searchpaths.length-1].filename+"/"+b,d.join(""))}catch(f){Sys.Print("COM.WriteFile: failed on "+b+"\n");return}Sys.Print("COM.WriteFile: "+b+"\n");return!0}, WriteTextFile:function(b,a){try{localStorage.setItem("Quake."+COM.searchpaths[COM.searchpaths.length-1].filename+"/"+b,a)}catch(c){Sys.Print("COM.WriteTextFile: failed on "+b+"\n");return}Sys.Print("COM.WriteTextFile: "+b+"\n");return!0},LoadFile:function(b){var a=new XMLHttpRequest;a.overrideMimeType("text/plain; charset=x-user-defined");var c,d,e,f,h,g;Draw.BeginDisc();for(c=COM.searchpaths.length-1;0<=c;--c){f=COM.searchpaths[c].filename+"/"+b;d=localStorage.getItem("Quake."+f);if(null!=d)return Draw.EndDisc(), Q.strmem(d);for(d=COM.searchpaths[c].pack.length-1;0<=d;--d){h=COM.searchpaths[c].pack[d];for(e=0;e<h.length;++e)if(g=h[e],g.name===b){if(0===g.filelen)return Draw.EndDisc(),new ArrayBuffer(0);a.open("GET",COM.searchpaths[c].filename+"/pak"+d+".pak",!1);a.setRequestHeader("Range","bytes="+g.filepos+"-"+(g.filepos+g.filelen-1));a.send();if(200<=a.status&&299>=a.status&&a.responseText.length===g.filelen)return Draw.EndDisc(),Q.strmem(a.responseText)}}a.open("GET",f,!1);a.send();if(200<=a.status&&299>= a.status)return Draw.EndDisc(),Q.strmem(a.responseText)}Draw.EndDisc()},LoadTextFile:function(b){b=COM.LoadFile(b);if(null!=b){b=new Uint8Array(b);var a=[],c;for(c=0;c<b.length;++c)13!==b[c]&&(a[a.length]=String.fromCharCode(b[c]));return a.join("")}},LoadPackFile:function(b){var a=new XMLHttpRequest;a.overrideMimeType("text/plain; charset=x-user-defined");a.open("GET",b,!1);a.setRequestHeader("Range","bytes=0-11");a.send();if(!(199>=a.status||300<=a.status||12!==a.responseText.length)){var c=new DataView(Q.strmem(a.responseText)); 1262698832!==c.getUint32(0,!0)&&Sys.Error(b+" is not a packfile");var d=c.getUint32(4,!0),e=c.getUint32(8,!0),c=e>>6;339!==c&&(COM.modified=!0);var f=[];if(0!==c){a.open("GET",b,!1);a.setRequestHeader("Range","bytes="+d+"-"+(d+e-1));a.send();if(199>=a.status||300<=a.status||a.responseText.length!==e)return;a=Q.strmem(a.responseText);32981!==CRC.Block(new Uint8Array(a))&&(COM.modified=!0);for(d=0;d<c;++d)f[f.length]={name:Q.memstr(new Uint8Array(a,d<<6,64)),filepos:(new DataView(a)).getUint32((d<< 6)+56,!0),filelen:(new DataView(a)).getUint32((d<<6)+60,!0)}}Con.Print("Added packfile "+b+" ("+c+" files)\n");return f}},AddGameDirectory:function(b){for(var a={filename:b,pack:[]},c,d=0;;){c=COM.LoadPackFile(b+"/pak"+d+".pak");if(null==c)break;a.pack[a.pack.length]=c;++d}COM.searchpaths[COM.searchpaths.length]=a},InitFilesystem:function(){var b;b=COM.CheckParm("-basedir");null!=b?(b=COM.argv[b+1],null!=b&&COM.AddGameDirectory(b)):COM.AddGameDirectory("id1");!0===COM.rogue?COM.AddGameDirectory("rogue"): !0===COM.hipnotic&&COM.AddGameDirectory("hipnotic");b=COM.CheckParm("-game");null!=b&&(b=COM.argv[b+1],null!=b&&(COM.modified=!0,COM.AddGameDirectory(b)))}};
var Con={backscroll:0,current:0,text:[],ToggleConsole_f:function(){SCR.disabled_for_loading=!1;var a=Con.text.length-4;for(0>a&&(a=0);a<Con.text.length;++a)Con.text[a].time=0;Key.dest.value===Key.dest.console?CL.cls.state!==CL.active.connected?M.Menu_Main_f():(Key.dest.value=Key.dest.game,Key.edit_line="",Key.history_line=Key.lines.length):Key.dest.value=Key.dest.console},Clear_f:function(){Con.backscroll=0;Con.current=0;Con.text=[]},MessageMode_f:function(){Key.dest.value=Key.dest.message;Key.team_message= !1},MessageMode2_f:function(){Key.dest.value=Key.dest.message;Key.team_message=!0},Init:function(){Con.debuglog=null!=COM.CheckParm("-condebug");!0===Con.debuglog&&COM.WriteTextFile("qconsole.log","");Con.Print("Console initialized.\n");Con.notifytime=Cvar.RegisterVariable("con_notifytime","3");Cmd.AddCommand("toggleconsole",Con.ToggleConsole_f);Cmd.AddCommand("messagemode",Con.MessageMode_f);Cmd.AddCommand("messagemode2",Con.MessageMode2_f);Cmd.AddCommand("clear",Con.Clear_f)},Print:function(a){if(!0=== Con.debuglog){var b=COM.LoadTextFile("qconsole.log");null!=b&&(b+=a,32768<=b.length&&(b=b.substring(b.length-16384)),COM.WriteTextFile("qconsole.log",b))}b=Con.backscroll=0;2>=a.charCodeAt(0)&&(b=128,1===a.charCodeAt(0)&&S.LocalSound(Con.sfx_talk),a=a.substring(1));var c;for(c=0;c<a.length;++c)null==Con.text[Con.current]&&(Con.text[Con.current]={text:"",time:Host.realtime}),10===a.charCodeAt(c)?1024<=Con.text.length?(Con.text=Con.text.slice(-512),Con.current=Con.text.length):++Con.current:Con.text[Con.current].text+= String.fromCharCode(a.charCodeAt(c)+b)},DPrint:function(a){0!==Host.developer.value&&Con.Print(a)},DrawInput:function(){if(!(Key.dest.value!==Key.dest.console&&!0!==Con.forcedup)){var a="]"+Key.edit_line+String.fromCharCode(10+(4*Host.realtime&1)),b=(VID.width>>3)-2;a.length>=b&&(a=a.substring(1+a.length-b));Draw.String(8,Con.vislines-16,a)}},DrawNotify:function(){var a=(VID.width>>3)-2,b=Con.text.length-4,c=0;for(0>b&&(b=0);b<Con.text.length;++b)Host.realtime-Con.text[b].time>Con.notifytime.value|| (Draw.String(8,c,Con.text[b].text.substring(0,a)),c+=8);Key.dest.value===Key.dest.message&&Draw.String(8,c,"say: "+Key.chat_buffer+String.fromCharCode(10+(4*Host.realtime&1)))},DrawConsole:function(a){if(!(0>=a)){a=Math.floor(0.005*a*VID.height);Draw.ConsoleBackground(a);Con.vislines=a;var b=(VID.width>>3)-2,c=a-16,d;for(d=Con.text.length-1-Con.backscroll;0<=d&&!(c=0===Con.text[d].text.length?c-8:c-(Math.ceil(Con.text[d].text.length/b)<<3),--d,0>=c););var e,f;for(++d;d<Con.text.length-Con.backscroll;++d)if(f= Con.text[d].text,a=Math.ceil(f.length/b),0===a)c+=8;else for(e=0;e<a;++e)Draw.String(8,c,f.substr(e*b,b)),c+=8;Con.DrawInput()}}};
var CRC={table:[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286, 6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411, 5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920], Block:function(c){var a=65535,b;for(b=0;b<c.length;++b)a=a<<8&65535^CRC.table[a>>8^c[b]];return a}};
var Cvar={vars:[],FindVar:function(b){var a;for(a=0;a<Cvar.vars.length;++a)if(Cvar.vars[a].name===b)return Cvar.vars[a]},CompleteVariable:function(b){if(0!==b.length){var a;for(a=0;a<Cvar.vars.length;++a)if(Cvar.vars[a].name.substring(0,b.length)===b)return Cvar.vars[a].name}},Set:function(b,a){var c,d,e;for(c=0;c<Cvar.vars.length;++c)if(d=Cvar.vars[c],d.name===b){d.string===a&&(e=!0);d.string=a;d.value=Q.atof(a);!0===d.server&&(!0===e&&!0===SV.server.active)&&Host.BroadcastPrint('"'+d.name+'" changed to "'+ d.string+'"\n');return}Con.Print("Cvar.Set: variable "+b+" not found\n")},SetValue:function(b,a){Cvar.Set(b,a.toFixed(6))},RegisterVariable:function(b,a,c,d){var e;for(e=0;e<Cvar.vars.length;++e)if(Cvar.vars[e].name===b){Con.Print("Can't register variable "+b+", allready defined\n");return}Cvar.vars[Cvar.vars.length]={name:b,string:a,archive:c,server:d,value:Q.atof(a)};return Cvar.vars[Cvar.vars.length-1]},Command:function(){var b=Cvar.FindVar(Cmd.argv[0]);if(null!=b){if(1>=Cmd.argv.length)return Con.Print('"'+ b.name+'" is "'+b.string+'"\n'),!0;Cvar.Set(b.name,Cmd.argv[1]);return!0}},WriteVariables:function(){var b=[],a,c;for(a=0;a<Cvar.vars.length;++a)c=Cvar.vars[a],!0===c.archive&&(b[b.length]=c.name+' "'+c.string+'"\n');return b.join("")}};
var Def={webquake_version:9,max_edicts:600,stat:{health:0,frags:1,weapon:2,ammo:3,armor:4,weaponframe:5,shells:6,nails:7,rockets:8,cells:9,activeweapon:10,totalsecrets:11,totalmonsters:12,secrets:13,monsters:14},it:{shotgun:1,super_shotgun:2,nailgun:4,super_nailgun:8,grenade_launcher:16,rocket_launcher:32,lightning:64,super_lightning:128,shells:256,nails:512,rockets:1024,cells:2048,axe:4096,armor1:8192,armor2:16384,armor3:32768,superhealth:65536,key1:131072,key2:262144,invisibility:524288,invulnerability:1048576, suit:2097152,quad:4194304},rit:{shells:128,nails:256,rockets:512,cells:1024,axe:2048,lava_nailgun:4096,lava_super_nailgun:8192,multi_grenade:16384,multi_rocket:32768,plasma_gun:65536,armor1:8388608,armor2:16777216,armor3:33554432,lava_nails:67108864,plasma_ammo:134217728,multi_rockets:268435456,shield:536870912,antigrav:1073741824,superhealth:2147483648},hit:{proximity_gun_bit:16,mjolnir_bit:7,laser_cannon_bit:23,proximity_gun:65536,mjolnir:128,laser_cannon:8388608,wetsuit:33554432,empathy_shields:67108864}, timedate:"Exe: 20:50:53 Feb 11 2013\n"};
var Draw={CharToConback:function(a,b){var c=(a>>4<<10)+((a&15)<<3),d,e;for(d=0;8>d;++d){for(e=0;8>e;++e)0!==Draw.chars[c+e]&&(Draw.conback.data[b+e]=96+Draw.chars[c+e]);c+=128;b+=320}},Init:function(){var a;Draw.chars=new Uint8Array(W.GetLumpName("conchars"));var b=new ArrayBuffer(65536),c=new Uint32Array(b);for(a=0;16384>a;++a)0!==Draw.chars[a]&&(c[a]=Q.LittleULong(VID.d_8to24table[Draw.chars[a]]));Draw.char_texture=gl.createTexture();GL.Bind(0,Draw.char_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, 128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(b));gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);Draw.conback={};a=COM.LoadFile("gfx/conback.lmp");null==a&&Sys.Error("Couldn't load gfx/conback.lmp");Draw.conback.width=320;Draw.conback.height=200;Draw.conback.data=new Uint8Array(a,8,64E3);b="(WebQuake Beta build "+Def.webquake_version+") 1.09";for(a=0;a<b.length;++a)Draw.CharToConback(b.charCodeAt(a),59829-(b.length- a<<3),186);Draw.conback.texnum=GL.LoadPicTexture(Draw.conback);Draw.loading=Draw.CachePic("loading");Draw.loadingElem=document.getElementById("loading");Draw.loadingElem.src=Draw.PicToDataURL(Draw.loading);document.body.style.backgroundImage='url("'+Draw.PicToDataURL(Draw.PicFromWad("backtile"))+'")';GL.CreateProgram("Character",["uCharacter","uDest","uOrtho"],["aPoint"],["tTexture"]);GL.CreateProgram("Fill",["uRect","uOrtho","uColor"],["aPoint"],[]);GL.CreateProgram("Pic",["uRect","uOrtho"],["aPoint"], ["tTexture"]);GL.CreateProgram("PicTranslate",["uRect","uOrtho","uTop","uBottom"],["aPoint"],["tTexture","tTrans"])},Character:function(a,b,c){var d=GL.UseProgram("Character");GL.Bind(d.tTexture,Draw.char_texture);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(d.aPoint,2,gl.FLOAT,!1,0,0);gl.uniform2f(d.uCharacter,c&15,c>>4);gl.uniform2f(d.uDest,a,b);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},String:function(a,b,c){var d=GL.UseProgram("Character");GL.Bind(d.tTexture,Draw.char_texture);gl.bindBuffer(gl.ARRAY_BUFFER, GL.rect);gl.vertexAttribPointer(d.aPoint,2,gl.FLOAT,!1,0,0);var e,f;for(e=0;e<c.length;++e)f=c.charCodeAt(e),gl.uniform2f(d.uCharacter,f&15,f>>4),gl.uniform2f(d.uDest,a,b),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),a+=8},StringWhite:function(a,b,c){var d=GL.UseProgram("Character");GL.Bind(d.tTexture,Draw.char_texture);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(d.aPoint,2,gl.FLOAT,!1,0,0);var e,f;for(e=0;e<c.length;++e)f=c.charCodeAt(e)+128,gl.uniform2f(d.uCharacter,f&15,f>>4),gl.uniform2f(d.uDest, a,b),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),a+=8},PicFromWad:function(a){a=W.GetLumpName(a);var b={},c=new DataView(a,0,8);b.width=c.getUint32(0,!0);b.height=c.getUint32(4,!0);b.data=new Uint8Array(a,8,b.width*b.height);b.texnum=GL.LoadPicTexture(b);return b},CachePic:function(a){a="gfx/"+a+".lmp";var b=COM.LoadFile(a);null==b&&Sys.Error("Draw.CachePic: failed to load "+a);a={};var c=new DataView(b,0,8);a.width=c.getUint32(0,!0);a.height=c.getUint32(4,!0);a.data=new Uint8Array(b,8,a.width*a.height); a.texnum=GL.LoadPicTexture(a);return a},Pic:function(a,b,c){var d=GL.UseProgram("Pic");GL.Bind(d.tTexture,c.texnum);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(d.aPoint,2,gl.FLOAT,!1,0,0);gl.uniform4f(d.uRect,a,b,c.width,c.height);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},PicTranslate:function(a,b,c,d,e){var f=GL.UseProgram("PicTranslate");GL.Bind(f.tTexture,c.texnum);GL.Bind(f.tTrans,c.translate);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(f.aPoint,2,gl.FLOAT,!1,0, 0);gl.uniform4f(f.uRect,a,b,c.width,c.height);a=VID.d_8to24table[d]&16777215;gl.uniform3f(f.uTop,a&255,a>>8&255,a>>16);a=VID.d_8to24table[e]&16777215;gl.uniform3f(f.uBottom,a&255,a>>8&255,a>>16);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},ConsoleBackground:function(a){var b=GL.UseProgram("Pic");GL.Bind(b.tTexture,Draw.conback.texnum);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(b.aPoint,2,gl.FLOAT,!1,0,0);gl.uniform4f(b.uRect,0,a-VID.height,VID.width,VID.height);gl.drawArrays(gl.TRIANGLE_STRIP, 0,4)},Fill:function(a,b,c,d,e){var f=GL.UseProgram("Fill");gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(f.aPoint,2,gl.FLOAT,!1,0,0);gl.uniform4f(f.uRect,a,b,c,d);a=VID.d_8to24table[e]&16777215;gl.uniform4f(f.uColor,a&255,a>>8&255,a>>16,1);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},FadeScreen:function(){var a=GL.UseProgram("Fill");gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(a.aPoint,2,gl.FLOAT,!1,0,0);gl.uniform4f(a.uRect,0,0,VID.width,VID.height);gl.uniform4f(a.uColor, 0,0,0,0.8);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)},BeginDisc:function(){null!=Draw.loadingElem&&(Draw.loadingElem.style.left=(VID.width-Draw.loading.width>>1)+"px",Draw.loadingElem.style.top=(VID.height-Draw.loading.height>>1)+"px",Draw.loadingElem.style.display="inline-block")},EndDisc:function(){null!=Draw.loadingElem&&(Draw.loadingElem.style.display="none")},PicToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width, a.height),e=new ArrayBuffer(d.data.length),f=new Uint32Array(e),g;for(g=0;g<a.data.length;++g)f[g]=Q.LittleULong(VID.d_8to24table[a.data[g]]);d.data.set(new Uint8Array(e));c.putImageData(d,0,0);return b.toDataURL()}};
var ED={ClearEdict:function(a){var b;for(b=0;b<PR.entityfields;++b)a.v_int[b]=0;a.free=!1},Alloc:function(){var a,b;for(a=SV.svs.maxclients+1;a<SV.server.num_edicts;++a)if(b=SV.server.edicts[a],!0===b.free&&(2>b.freetime||0.5<SV.server.time-b.freetime))return ED.ClearEdict(b),b;a===Def.max_edicts&&Sys.Error("ED.Alloc: no free edicts");b=SV.server.edicts[SV.server.num_edicts++];ED.ClearEdict(b);return b},Free:function(a){SV.UnlinkEdict(a);a.free=!0;a.v_int[PR.entvars.model]=0;a.v_float[PR.entvars.takedamage]= 0;a.v_float[PR.entvars.modelindex]=0;a.v_float[PR.entvars.colormap]=0;a.v_float[PR.entvars.skin]=0;a.v_float[PR.entvars.frame]=0;ED.SetVector(a,PR.entvars.origin,Vec.origin);ED.SetVector(a,PR.entvars.angles,Vec.origin);a.v_float[PR.entvars.nextthink]=-1;a.v_float[PR.entvars.solid]=0;a.freetime=SV.server.time},GlobalAtOfs:function(a){var b,c;for(b=0;b<PR.globaldefs.length;++b)if(c=PR.globaldefs[b],c.ofs===a)return c},FieldAtOfs:function(a){var b,c;for(b=0;b<PR.fielddefs.length;++b)if(c=PR.fielddefs[b], c.ofs===a)return c},FindField:function(a){var b,c;for(c=0;c<PR.fielddefs.length;++c)if(b=PR.fielddefs[c],PR.GetString(b.name)===a)return b},FindGlobal:function(a){var b,c;for(c=0;c<PR.globaldefs.length;++c)if(b=PR.globaldefs[c],PR.GetString(b.name)===a)return b},FindFunction:function(a){var b;for(b=0;b<PR.functions.length;++b)if(PR.GetString(PR.functions[b].name)===a)return b},Print:function(a){if(!0===a.free)Con.Print("FREE\n");else{Con.Print("\nEDICT "+a.num+":\n");var b,c,d,e;for(b=1;b<PR.fielddefs.length;++b)if(c= PR.fielddefs[b],d=PR.GetString(c.name),95!==d.charCodeAt(d.length-2)){e=c.ofs;if(0===a.v_int[e])if(3===(c.type&32767)){if(0===a.v_int[e+1]&&0===a.v_int[e+2])continue}else continue;for(;14>=d.length;)d+=" ";Con.Print(d+PR.ValueString(c.type,a.v,e)+"\n")}}},PrintEdicts:function(){if(!0===SV.server.active){Con.Print(SV.server.num_edicts+" entities\n");var a;for(a=0;a<SV.server.num_edicts;++a)ED.Print(SV.server.edicts[a])}},PrintEdict_f:function(){if(!0===SV.server.active){var a=Q.atoi(Cmd.argv[1]);0<= a&&a<SV.server.num_edicts&&ED.Print(SV.server.edicts[a])}},Count:function(){if(!0===SV.server.active){var a,b,c=0,d=0,e=0,f=0;for(a=0;a<SV.server.num_edicts;++a)b=SV.server.edicts[a],!0!==b.free&&(++c,0!==b.v_float[PR.entvars.solid]&&++e,0!==b.v_int[PR.entvars.model]&&++d,b.v_float[PR.entvars.movetype]===SV.movetype.step&&++f);a=SV.server.num_edicts;Con.Print("num_edicts:"+(9>=a?" ":99>=a?" ":"")+a+"\n");Con.Print("active :"+(9>=c?" ":99>=c?" ":"")+c+"\n");Con.Print("view :"+(9>=d?" ": 99>=d?" ":"")+d+"\n");Con.Print("touch :"+(9>=e?" ":99>=e?" ":"")+e+"\n");Con.Print("step :"+(9>=f?" ":99>=f?" ":"")+f+"\n")}},ParseGlobals:function(a){for(var b,c;;){a=COM.Parse(a);if(125===COM.token.charCodeAt(0))break;null==a&&Sys.Error("ED.ParseGlobals: EOF without closing brace");b=COM.token;a=COM.Parse(a);null==a&&Sys.Error("ED.ParseGlobals: EOF without closing brace");125===COM.token.charCodeAt(0)&&Sys.Error("ED.ParseGlobals: closing brace without data");c=ED.FindGlobal(b);null== c?Con.Print("'"+b+"' is not a global\n"):!0!==ED.ParseEpair(PR.globals,c,COM.token)&&Host.Error("ED.ParseGlobals: parse error")}},NewString:function(a){var b=[],c,d;for(c=0;c<a.length;++c)d=a.charCodeAt(c),92===d&&c<a.length-1?(++c,b[b.length]=110===a.charCodeAt(c)?"\n":"\\"):b[b.length]=String.fromCharCode(d);return PR.NewString(b.join(""),a.length+1)},ParseEpair:function(a,b,c){var d=new Float32Array(a);a=new Int32Array(a);switch(b.type&32767){case PR.etype.ev_string:a[b.ofs]=ED.NewString(c);break; case PR.etype.ev_float:d[b.ofs]=Q.atof(c);break;case PR.etype.ev_vector:c=c.split(" ");d[b.ofs]=Q.atof(c[0]);d[b.ofs+1]=Q.atof(c[1]);d[b.ofs+2]=Q.atof(c[2]);break;case PR.etype.ev_entity:a[b.ofs]=Q.atoi(c);break;case PR.etype.ev_field:d=ED.FindField(c);if(null==d){Con.Print("Can't find field "+c+"\n");return}a[b.ofs]=d.ofs;break;case PR.etype.ev_function:d=ED.FindFunction(c);if(null==d){Con.Print("Can't find function "+c+"\n");return}a[b.ofs]=d}return!0},ParseEdict:function(a,b){var c,d,e,f;if(b!== SV.server.edicts[0])for(c=0;c<PR.entityfields;++c)b.v_int[c]=0;for(;;){a=COM.Parse(a);if(125===COM.token.charCodeAt(0))break;null==a&&Sys.Error("ED.ParseEdict: EOF without closing brace");"angle"===COM.token?(COM.token="angles",c=!0):(c=!1,"light"===COM.token&&(COM.token="light_lev"));for(d=COM.token.length;0<d&&32===COM.token.charCodeAt(d-1);--d);e=COM.token.substring(0,d);a=COM.Parse(a);null==a&&Sys.Error("ED.ParseEdict: EOF without closing brace");125===COM.token.charCodeAt(0)&&Sys.Error("ED.ParseEdict: closing brace without data"); d=!0;95!==e.charCodeAt(0)&&(f=ED.FindField(e),null==f?Con.Print("'"+e+"' is not a field\n"):(!0==c&&(COM.token="0 "+COM.token+" 0"),!0!==ED.ParseEpair(b.v,f,COM.token)&&Host.Error("ED.ParseEdict: parse error")))}!0!==d&&(b.free=!0);return a},LoadFromFile:function(a){var b,c,d=0;for(PR.globals_float[PR.globalvars.time]=SV.server.time;;){a=COM.Parse(a);if(null==a)break;123!==COM.token.charCodeAt(0)&&Sys.Error("ED.LoadFromFile: found "+COM.token+" when expecting {");b=null==b?SV.server.edicts[0]:ED.Alloc(); a=ED.ParseEdict(a,b);c=b.v_float[PR.entvars.spawnflags]>>0;if(0!==Host.deathmatch.value){if(0!==(c&2048)){ED.Free(b);++d;continue}}else if(0===Host.current_skill&&0!==(c&256)||1===Host.current_skill&&0!==(c&512)||2===Host.current_skill&&0!==(c&1024)){ED.Free(b);++d;continue}0===b.v_int[PR.entvars.classname]?(Con.Print("No classname for:\n"),ED.Print(b),ED.Free(b)):(c=ED.FindFunction(PR.GetString(b.v_int[PR.entvars.classname])),null==c?(Con.Print("No spawn function for:\n"),ED.Print(b),ED.Free(b)): (PR.globals_int[PR.globalvars.self]=b.num,PR.ExecuteProgram(c)))}Con.DPrint(d+" entities inhibited\n")},Vector:function(a,b){return[a.v_float[b],a.v_float[b+1],a.v_float[b+2]]},SetVector:function(a,b,c){a.v_float[b]=c[0];a.v_float[b+1]=c[1];a.v_float[b+2]=c[2]}};
var GL={textures:[],currenttextures:[],programs:[],Bind:function(a,e){GL.currenttextures[a]!==e&&(GL.activetexture!==a&&(GL.activetexture=a,gl.activeTexture(gl.TEXTURE0+a)),GL.currenttextures[a]=e,gl.bindTexture(gl.TEXTURE_2D,e))},TextureMode_f:function(){var a;if(1>=Cmd.argv.length){for(a=0;a<GL.modes.length;++a)if(GL.filter_min===GL.modes[a][1]){Con.Print(GL.modes[a][0]+"\n");return}Con.Print("current filter is unknown???\n")}else{var e=Cmd.argv[1].toUpperCase();for(a=0;a<GL.modes.length&&GL.modes[a][0]!== e;++a);if(a===GL.modes.length)Con.Print("bad filter name\n");else{GL.filter_min=GL.modes[a][1];GL.filter_max=GL.modes[a][2];for(a=0;a<GL.textures.length;++a)GL.Bind(0,GL.textures[a].texnum),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min),gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max)}}},ortho:[0,0,0,0,0,0,0,0,0,0,1E-5,0,-1,1,0,1],Set2D:function(){gl.viewport(0,0,VID.width,VID.height);GL.UnbindProgram();var a,e;for(a=0;a<GL.programs.length;++a)e=GL.programs[a], null!=e.uOrtho&&(gl.useProgram(e.program),gl.uniformMatrix4fv(e.uOrtho,!1,GL.ortho));gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND)},ResampleTexture:function(a,e,b,c,f){var d=new ArrayBuffer(c*f),d=new Uint8Array(d),g=e/c;b/=f;var h,l=0,k,j;for(k=0;k<f;++k){h=Math.floor(k*b)*e;for(j=0;j<c;++j)d[l+j]=a[h+Math.floor(j*g)];l+=c}return d},Upload:function(a,e,b){var c=e,f=b;if(0!==(e&e-1)||0!==(b&b-1))--c,c|=c>>1,c|=c>>2,c|=c>>4,c|=c>>8,c|=c>>16,++c,--f,f|=f>>1,f|=f>>2,f|=f>>4,f|=f>>8,f|=f>>16,++f;1024< c&&(c=1024);1024<f&&(f=1024);if(c!==e||f!==b)a=GL.ResampleTexture(a,e,b,c,f);e=new ArrayBuffer(c*f<<2);b=new Uint32Array(e);var d;for(d=c*f-1;0<=d;--d)b[d]=Q.LittleULong(VID.d_8to24table[a[d]]),224<=a[d]&&(b[d]&=16777215);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,c,f,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(e));gl.generateMipmap(gl.TEXTURE_2D);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max)},LoadTexture:function(a, e,b,c){var f,d;if(0!==a.length)for(d=0;d<GL.textures.length;++d)if(f=GL.textures[d],f.identifier===a)return(e!==f.width||b!==f.height)&&Sys.Error("GL.LoadTexture: cache mismatch"),f;d=e;var g=b;if(0!==(e&e-1)||0!==(b&b-1))--d,d|=d>>1,d|=d>>2,d|=d>>4,d|=d>>8,d|=d>>16,++d,--g,g|=g>>1,g|=g>>2,g|=g>>4,g|=g>>8,g|=g>>16,++g;1024<d&&(d=1024);1024<g&&(g=1024);d>>=GL.picmip.value;0===d&&(d=1);g>>=GL.picmip.value;0===g&&(g=1);if(d!==e||g!==b)c=GL.ResampleTexture(c,e,b,d,g);f={texnum:gl.createTexture(),identifier:a, width:e,height:b};GL.Bind(0,f.texnum);GL.Upload(c,d,g);return GL.textures[GL.textures.length]=f},LoadPicTexture:function(a){var e=a.data,b=a.width,c=a.height;if(0!==(a.width&a.width-1)||0!==(a.height&a.height-1))--b,b|=b>>1,b|=b>>2,b|=b>>4,b|=b>>8,b|=b>>16,++b,--c,c|=c>>1,c|=c>>2,c|=c>>4,c|=c>>8,c|=c>>16,++c;1024<b&&(b=1024);1024<c&&(c=1024);if(b!==a.width||c!==a.height)e=GL.ResampleTexture(e,a.width,a.height,b,c);a=gl.createTexture();GL.Bind(0,a);var f=new ArrayBuffer(b*c<<2),d=new Uint32Array(f), g;for(g=b*c-1;0<=g;--g)255!==e[g]&&(d[g]=Q.LittleULong(VID.d_8to24table[e[g]]));gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b,c,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(f));gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);return a},CreateProgram:function(a,e,b,c){var f=gl.createProgram(),d={identifier:a,program:f,attribs:[]},g=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(g,document.getElementById("vsh"+a).text);gl.compileShader(g); !0!==gl.getShaderParameter(g,gl.COMPILE_STATUS)&&Sys.Error("Error compiling shader: "+gl.getShaderInfoLog(g));var h=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(h,document.getElementById("fsh"+a).text);gl.compileShader(h);!0!==gl.getShaderParameter(h,gl.COMPILE_STATUS)&&Sys.Error("Error compiling shader: "+gl.getShaderInfoLog(h));gl.attachShader(f,g);gl.attachShader(f,h);gl.linkProgram(f);!0!==gl.getProgramParameter(f,gl.LINK_STATUS)&&Sys.Error("Error linking program: "+gl.getProgramInfoLog(f)); gl.useProgram(f);for(a=0;a<e.length;++a)d[e[a]]=gl.getUniformLocation(f,e[a]);for(a=0;a<b.length;++a)d.attribs[d.attribs.length]=b[a],d[b[a]]=gl.getAttribLocation(f,b[a]);for(a=0;a<c.length;++a)d[c[a]]=a,gl.uniform1i(gl.getUniformLocation(f,c[a]),a);return GL.programs[GL.programs.length]=d},UseProgram:function(a){var e,b=GL.currentprogram;if(null!=b){if(b.identifier===a)return b;for(e=0;e<b.attribs.length;++e)gl.disableVertexAttribArray(b[b.attribs[e]])}for(e=0;e<GL.programs.length;++e)if(b=GL.programs[e], b.identifier===a){GL.currentprogram=b;gl.useProgram(b.program);for(a=0;a<b.attribs.length;++a)gl.enableVertexAttribArray(b[b.attribs[a]]);return b}},UnbindProgram:function(){if(null!=GL.currentprogram){var a;for(a=0;a<GL.currentprogram.attribs.length;++a)gl.disableVertexAttribArray(GL.currentprogram[GL.currentprogram.attribs[a]]);GL.currentprogram=null}},identity:[1,0,0,0,1,0,0,0,1],RotationMatrix:function(a,e,b){a*=Math.PI/-180;e*=Math.PI/180;b*=Math.PI/180;var c=Math.sin(a);a=Math.cos(a);var f= Math.sin(e);e=Math.cos(e);var d=Math.sin(b);b=Math.cos(b);return[e*a,f*a,-c,-f*b+e*c*d,e*b+f*c*d,a*d,-f*-d+e*c*b,e*-d+f*c*b,a*b]},Init:function(){VID.mainwindow=document.getElementById("mainwindow");try{gl=VID.mainwindow.getContext("webgl")||VID.mainwindow.getContext("experimental-webgl")}catch(a){}null==gl&&Sys.Error("Unable to initialize WebGL. Your browser may not support it.");gl.clearColor(0,0,0,0);gl.cullFace(gl.FRONT);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);GL.modes=[["GL_NEAREST", gl.NEAREST,gl.NEAREST],["GL_LINEAR",gl.LINEAR,gl.LINEAR],["GL_NEAREST_MIPMAP_NEAREST",gl.NEAREST_MIPMAP_NEAREST,gl.NEAREST],["GL_LINEAR_MIPMAP_NEAREST",gl.LINEAR_MIPMAP_NEAREST,gl.LINEAR],["GL_NEAREST_MIPMAP_LINEAR",gl.NEAREST_MIPMAP_LINEAR,gl.NEAREST],["GL_LINEAR_MIPMAP_LINEAR",gl.LINEAR_MIPMAP_LINEAR,gl.LINEAR]];GL.filter_min=gl.LINEAR_MIPMAP_NEAREST;GL.filter_max=gl.LINEAR;GL.picmip=Cvar.RegisterVariable("gl_picmip","0");Cmd.AddCommand("gl_texturemode",GL.TextureMode_f);GL.rect=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),gl.STATIC_DRAW);VID.mainwindow.style.display="inline-block"}};
var Host={framecount:0,EndGame:function(b){Con.DPrint("Host.EndGame: "+b+"\n");-1!==CL.cls.demonum?CL.NextDemo():CL.Disconnect();throw"Host.abortserver";},Error:function(b){!0===Host.inerror&&Sys.Error("Host.Error: recursively entered");Host.inerror=!0;SCR.disabled_for_loading=!1;Con.Print("Host.Error: "+b+"\n");!0===SV.server.active&&Host.ShutdownServer();CL.Disconnect();CL.cls.demonum=-1;Host.inerror=!1;throw Error("Host.abortserver");},FindMaxClients:function(){SV.svs.maxclients=SV.svs.maxclientslimit= 1;SV.svs.clients=[{num:0,message:{data:new ArrayBuffer(8E3),cursize:0,allowoverflow:!0},colors:0,old_frags:0}];Cvar.SetValue("deathmatch",0)},InitLocal:function(){Host.InitCommands();Host.framerate=Cvar.RegisterVariable("host_framerate","0");Host.speeds=Cvar.RegisterVariable("host_speeds","0");Host.ticrate=Cvar.RegisterVariable("sys_ticrate","0.05");Host.serverprofile=Cvar.RegisterVariable("serverprofile","0");Host.fraglimit=Cvar.RegisterVariable("fraglimit","0",!1,!0);Host.timelimit=Cvar.RegisterVariable("timelimit", "0",!1,!0);Host.teamplay=Cvar.RegisterVariable("teamplay","0",!1,!0);Host.samelevel=Cvar.RegisterVariable("samelevel","0");Host.noexit=Cvar.RegisterVariable("noexit","0",!1,!0);Host.skill=Cvar.RegisterVariable("skill","1");Host.developer=Cvar.RegisterVariable("developer","1");Host.deathmatch=Cvar.RegisterVariable("deathmatch","0");Host.coop=Cvar.RegisterVariable("coop","0");Host.pausable=Cvar.RegisterVariable("pausable","1");Host.temp1=Cvar.RegisterVariable("temp1","0");Host.FindMaxClients()},ClientPrint:function(b){MSG.WriteByte(Host.client.message, Protocol.svc.print);MSG.WriteString(Host.client.message,b)},BroadcastPrint:function(b){var a,c;for(a=0;a<SV.svs.maxclients;++a)c=SV.svs.clients[a],!0!==c.active||!0!==c.spawned||(MSG.WriteByte(c.message,Protocol.svc.print),MSG.WriteString(c.message,b))},DropClient:function(b){var a=Host.client;!0!==b&&(!0===NET.CanSendMessage(a.netconnection)&&(MSG.WriteByte(a.message,Protocol.svc.disconnect),NET.SendMessage(a.netconnection,a.message)),null!=a.edict&&!0===a.spawned&&(b=PR.globals_int[PR.globalvars.self], PR.globals_int[PR.globalvars.self]=a.edict.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientDisconnect]),PR.globals_int[PR.globalvars.self]=b),Sys.Print("Client "+SV.GetClientName(a)+" removed\n"));NET.Close(a.netconnection);a.netconnection=null;a.active=!1;SV.SetClientName(a,"");a.old_frags=-999999;--NET.activeconnections;var c=a.num;for(b=0;b<SV.svs.maxclients;++b)a=SV.svs.clients[b],!0===a.active&&(MSG.WriteByte(a.message,Protocol.svc.updatename),MSG.WriteByte(a.message,c),MSG.WriteByte(a.message, 0),MSG.WriteByte(a.message,Protocol.svc.updatefrags),MSG.WriteByte(a.message,c),MSG.WriteShort(a.message,0),MSG.WriteByte(a.message,Protocol.svc.updatecolors),MSG.WriteByte(a.message,c),MSG.WriteByte(a.message,0))},ShutdownServer:function(b){if(!0===SV.server.active){SV.server.active=!1;CL.cls.state===CL.active.connected&&CL.Disconnect();var a=Sys.FloatTime(),c,d;do{for(d=c=0;d<SV.svs.maxclients;++d)Host.cliet=SV.svs.clients[d],!0!==Host.client.active||0===Host.client.message.cursize||(!0===NET.CanSendMessage(Host.client.netconnection)? (NET.SendMessage(Host.client.netconnection,Host.client.message),Host.client.message.cursize=0):(NET.GetMessage(Host.client.netconnection),++c));if(3<Sys.FloatTime()-a)break}while(0!==c);a={data:new ArrayBuffer(4),cursize:1};(new Uint8Array(a.data))[0]=Protocol.svc.disconnect;c=NET.SendToAll(a);0!==c&&Con.Print("Host.ShutdownServer: NET.SendToAll failed for "+c+" clients\n");for(d=0;d<SV.svs.maxclients;++d)Host.client=SV.svs.clients[d],!0===Host.client.active&&Host.DropClient(b)}},WriteConfiguration:function(){COM.WriteTextFile("config.cfg", Key.WriteBindings()+Cvar.WriteVariables())},FilterTime:function(){Host.realtime=Sys.FloatTime();Host.frametime=Host.realtime-Host.oldrealtime;Host.oldrealtime=Host.realtime;0<Host.framerate.value?Host.frametime=Host.framerate.value:0.1<Host.frametime?Host.frametime=0.1:0.001>Host.frametime&&(Host.frametime=0.001);return!0},ServerFrame:function(){PR.globals_float[PR.globalvars.frametime]=Host.frametime;SV.server.datagram.cursize=0;SV.CheckForNewClients();SV.RunClients();!0!==SV.server.paused&&(1<SV.svs.maxclients|| Key.dest.value===Key.dest.game)&&SV.Physics();SV.SendClientMessages()},time3:0,_Frame:function(){Math.random();if(!0===Host.FilterTime())if(CL.cls.state===CL.active.connecting)SCR.UpdateScreen();else{var b,a,c,d;Cmd.Execute();SV.server.active&&CL.SendCmd();SV.server.active?Host.ServerFrame():CL.SendCmd();CL.cls.state===CL.active.connected&&CL.ReadFromServer();0!==Host.speeds.value&&(b=Sys.FloatTime());SCR.UpdateScreen();0!==Host.speeds.value&&(a=Sys.FloatTime());4===CL.cls.signon?(S.Update(R.refdef.vieworg, R.vpn,R.vright,R.vup),CL.DecayLights()):S.Update(Vec.origin,Vec.origin,Vec.origin,Vec.origin);CDAudio.Update();0!==Host.speeds.value&&(c=1E3*(b-Host.time3),Host.time3=Sys.FloatTime(),b=1E3*(a-b),a=1E3*(Host.time3-a),d=Math.floor(c+b+a),Con.Print((99>=d?9>=d?" ":" ":"")+d+" tot "+(100>c?10>c?" ":" ":"")+Math.floor(c)+" server "+(100>b?10>b?" ":" ":"")+Math.floor(b)+" gfx "+(100>a?10>a?" ":" ":"")+Math.floor(a)+" snd\n"));!0===Host.startdemos&&(CL.NextDemo(),Host.startdemos=!1);++Host.framecount}}, timetotal:0,timecount:0,Frame:function(){if(0===Host.serverprofile.value)Host._Frame();else{var b=Sys.FloatTime();Host._Frame();Host.timetotal+=Sys.FloatTime()-b;if(!(999>=++Host.timecount)){b=1E3*Host.timetotal/Host.timecount>>0;Host.timecount=0;Host.timetotal=0;var a,c=0;for(a=0;a<SV.svs.maxclients;++a)!0===SV.svs.clients[a].active&&++c;Con.Print("serverprofile: "+(9>=c?" ":"")+c+" clients "+(9>=b?" ":"")+b+" msec\n")}}},Init:function(){Host.oldrealtime=Sys.FloatTime();Cmd.Init();V.Init();Chase.Init(); COM.Init();Host.InitLocal();W.LoadWadFile("gfx.wad");Key.Init();Con.Init();PR.Init();Mod.Init();NET.Init();SV.Init();Con.Print(Def.timedate);VID.Init();Draw.Init();SCR.Init();R.Init();S.Init();M.Init();CDAudio.Init();Sbar.Init();CL.Init();Cmd.text="exec quake.rc\n"+Cmd.text;Host.initialized=!0;Sys.Print("========Quake Initialized=========\n")},Shutdown:function(){!0===Host.isdown?Sys.Print("recursive shutdown\n"):(Host.isdown=!0,Host.WriteConfiguration(),CDAudio.Stop(),S.StopAllSounds())},Quit_f:function(){Key.dest.value!== Key.dest.console?M.Menu_Quit_f():Sys.Quit()},Status_f:function(){var b;if(!0!==Cmd.client){if(!0!==SV.server.active){Cmd.ForwardToServer();return}b=Con.Print}else b=SV.ClientPrint;b("host: "+NET.hostname.string+"\n");b("version: 1.09\n");b("map: "+PR.GetString(PR.globals_int[PR.globalvars.mapname])+"\n");b("players: "+NET.activeconnections+" active ("+SV.svs.maxclients+" max)\n\n");var a,c,d,e,f,g,h;for(a=0;a<SV.svs.maxclients;++a)if(c=SV.svs.clients[a],!0===c.active){e=c.edict.v_float[PR.entvars.frags].toFixed(0); 1===e.length?e=" "+e:2===e.length&&(e=" "+e);h=NET.time-c.netconnection.connecttime>>0;g=h/60>>0;0!==g?(h-=60*g,f=g/60>>0,0!==f&&(g-=60*f)):f=0;d="#"+(a+1)+" ";8>=a&&(d+=" ");for(d+=SV.GetClientName(c);21>=d.length;)d+=" ";d+=e+" ";9>=f&&(d+=" ");d+=f+":";9>=g&&(d+="0");d+=g+":";9>=h&&(d+="0");b(d+h+"\n");b(" "+c.netconnection.address+"\n")}},God_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0===PR.globals_float[PR.globalvars.deathmatch]&&(SV.player.v_float[PR.entvars.flags]^=SV.fl.godmode, 0===(SV.player.v_float[PR.entvars.flags]&SV.fl.godmode)?Host.ClientPrint("godmode OFF\n"):Host.ClientPrint("godmode ON\n"))},Notarget_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0===PR.globals_float[PR.globalvars.deathmatch]&&(SV.player.v_float[PR.entvars.flags]^=SV.fl.notarget,0===(SV.player.v_float[PR.entvars.flags]&SV.fl.notarget)?Host.ClientPrint("notarget OFF\n"):Host.ClientPrint("notarget ON\n"))},Noclip_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0===PR.globals_float[PR.globalvars.deathmatch]&& (SV.player.v_float[PR.entvars.movetype]!==SV.movetype.noclip?(Host.noclip_anglehack=!0,SV.player.v_float[PR.entvars.movetype]=SV.movetype.noclip,Host.ClientPrint("noclip ON\n")):(Host.noclip_anglehack=!1,SV.player.v_float[PR.entvars.movetype]=SV.movetype.walk,Host.ClientPrint("noclip OFF\n")))},Fly_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0===PR.globals_float[PR.globalvars.deathmatch]&&(SV.player.v_float[PR.entvars.movetype]!==SV.movetype.fly?(SV.player.v_float[PR.entvars.movetype]=SV.movetype.fly, Host.ClientPrint("flymode ON\n")):(SV.player.v_float[PR.entvars.movetype]=SV.movetype.walk,Host.ClientPrint("flymode OFF\n")))},Ping_f:function(){if(!0!==Cmd.client)Cmd.ForwardToServer();else{Host.ClientPrint("Client ping times:\n");var b,a,c,d;for(b=0;b<SV.svs.maxclients;++b)if(a=SV.svs.clients[b],!0===a.active){for(d=c=0;15>=d;++d)c+=a.ping_times[d];c=(62.5*c).toFixed(0);1===c.length?c=" "+c:2===c.length?c=" "+c:3===c.length&&(c=" "+c);Host.ClientPrint(c+" "+SV.GetClientName(a)+"\n")}}},Map_f:function(){if(1>= Cmd.argv.length)Con.Print("USAGE: map <map>\n");else if(!0!==Cmd.client&&(CL.cls.demonum=-1,CL.Disconnect(),Host.ShutdownServer(),Key.dest.value=Key.dest.game,SCR.BeginLoadingPlaque(),SV.svs.serverflags=0,SV.SpawnServer(Cmd.argv[1]),!0===SV.server.active)){CL.cls.spawnparms="";var b;for(b=2;b<Cmd.argv.length;++b)CL.cls.spawnparms+=Cmd.argv[b]+" ";Cmd.ExecuteString("connect local")}},Changelevel_f:function(){2!==Cmd.argv.length?Con.Print("changelevel <levelname> : continue game on a new level\n"): !0!==SV.server.active||!0===CL.cls.demoplayback?Con.Print("Only the server may changelevel\n"):(SV.SaveSpawnparms(),SV.SpawnServer(Cmd.argv[1]))},Restart_f:function(){!0===CL.cls.demoplayback||(!0!==SV.server.active||!0===Cmd.client)||SV.SpawnServer(PR.GetString(PR.globals_int[PR.globalvars.mapname]))},Reconnect_f:function(){SCR.BeginLoadingPlaque();CL.cls.signon=0},Connect_f:function(){CL.cls.demonum=-1;!0===CL.cls.demoplayback&&(CL.StopPlayback(),CL.Disconnect());CL.EstablishConnection(Cmd.argv[1]); CL.cls.signon=0},SavegameComment:function(){var b=CL.state.levelname.replace(/\s/gm,"_"),a;for(a=CL.state.levelname.length;21>=a;++a)b+="_";b+="kills:";a=CL.state.stats[Def.stat.monsters].toString();2===a.length?b+="_":1===a.length&&(b+="__");b+=a+"/";a=CL.state.stats[Def.stat.totalmonsters].toString();2===a.length?b+="_":1===a.length&&(b+="__");return b+a+"____"},Savegame_f:function(){if(!0!==Cmd.client)if(!0!==SV.server.active)Con.Print("Not playing a local game.\n");else if(0!==CL.state.intermission)Con.Print("Can't save in intermission.\n"); else if(1!==SV.svs.maxclients)Con.Print("Can't save multiplayer games.\n");else if(2!==Cmd.argv.length)Con.Print("save <savename> : save a game\n");else if(-1!==Cmd.argv[1].indexOf(".."))Con.Print("Relative pathnames are not allowed.\n");else{var b=SV.svs.clients[0];if(!0===b.active&&0>=b.edict.v_float[PR.entvars.health])Con.Print("Can't savegame with a dead player\n");else{var a=["5\n"+Host.SavegameComment()+"\n"],c;for(c=0;15>=c;++c)a[a.length]=b.spawn_parms[c].toFixed(6)+"\n";a[a.length]=Host.current_skill+ "\n"+PR.GetString(PR.globals_int[PR.globalvars.mapname])+"\n"+SV.server.time.toFixed(6)+"\n";for(c=0;63>=c;++c)a[a.length]=0!==SV.server.lightstyles[c].length?SV.server.lightstyles[c]+"\n":"m\n";a[a.length]="{\n";var d;for(c=0;c<PR.globaldefs.length;++c)b=PR.globaldefs[c],d=b.type,0!==(d&32768)&&(d&=32767,d!==PR.etype.ev_string&&d!==PR.etype.ev_float&&d!==PR.etype.entity||(a[a.length]='"'+PR.GetString(b.name)+'" "'+PR.UglyValueString(d,PR.globals,b.ofs)+'"\n'));a[a.length]="}\n";var e,f,g,h;for(c= 0;c<SV.server.num_edicts;++c)if(e=SV.server.edicts[c],!0===e.free)a[a.length]="{\n}\n";else{a[a.length]="{\n";for(f=1;f<PR.fielddefs.length;++f)if(b=PR.fielddefs[f],g=PR.GetString(b.name),95!==g.charCodeAt(g.length-2)){d=b.type&32767;h=b.ofs;if(0===e.v_int[h])if(3===d){if(0===e.v_int[h+1]&&0===e.v_int[h+2])continue}else continue;a[a.length]='"'+g+'" "'+PR.UglyValueString(d,e.v,b.ofs)+'"\n'}a[a.length]="}\n"}g=COM.DefaultExtension(Cmd.argv[1],".sav");Con.Print("Saving game to "+g+"...\n");!0===COM.WriteTextFile(g, a.join(""))?Con.Print("done.\n"):Con.Print("ERROR: couldn't open.\n")}}},Loadgame_f:function(){if(!0!==Cmd.client)if(2!==Cmd.argv.length)Con.Print("load <savename> : load a game\n");else{CL.cls.demonum=-1;var b=COM.DefaultExtension(Cmd.argv[1],".sav");Con.Print("Loading game from "+b+"...\n");var a=COM.LoadTextFile(b);if(null==a)Con.Print("ERROR: couldn't open.\n");else{var a=a.split("\n"),c,b=parseFloat(a[0]);if(5!==b)Con.Print("Savegame is version "+b+", not 5\n");else{b=[];for(c=0;15>=c;++c)b[c]= parseFloat(a[2+c]);Host.current_skill=parseFloat(a[18])+0.1>>0;Cvar.SetValue("skill",Host.current_skill);var d=parseFloat(a[20]);CL.Disconnect();SV.SpawnServer(a[19]);if(!0!==SV.server.active)Con.Print("Couldn't load map\n");else{SV.server.paused=!0;SV.server.loadgame=!0;for(c=0;63>=c;++c)SV.server.lightstyles[c]=a[21+c];var e,f,g;"{"!==a[85]&&Sys.Error("First token isn't a brace");for(c=86;c<a.length;++c){if("}"===a[c]){++c;break}e=a[c].split('"');f=e[1];g=ED.FindGlobal(f);null==g?Con.Print("'"+ f+"' is not a global\n"):!0!==ED.ParseEpair(PR.globals,g,e[3])&&Host.Error("Host.Loadgame_f: parse error")}a[a.length]="";e=0;for(f=a.slice(c).join("\n");;){f=COM.Parse(f);if(null==f)break;123!==COM.token.charCodeAt(0)&&Sys.Error("Host.Loadgame_f: found "+COM.token+" when expecting {");a=SV.server.edicts[e++];for(c=0;c<PR.entityfields;++c)a.v_int[c]=0;a.free=!1;f=ED.ParseEdict(f,a);!0!==a.free&&SV.LinkEdict(a)}SV.server.num_edicts=e;SV.server.time=d;d=SV.svs.clients[0];d.spawn_parms=[];for(c=0;15>= c;++c)d.spawn_parms[c]=b[c];CL.EstablishConnection("local");Host.Reconnect_f()}}}}},Name_f:function(){if(1>=Cmd.argv.length)Con.Print('"name" is "'+CL.name.string+'"\n');else{var b;b=2===Cmd.argv.length?Cmd.argv[1].substring(0,15):Cmd.args.substring(0,15);if(!0!==Cmd.client)Cvar.Set("_cl_name",b),CL.cls.state===CL.active.connected&&Cmd.ForwardToServer();else{var a=SV.GetClientName(Host.client);0!==a.length&&("unconnected"!==a&&a!==b)&&Con.Print(a+" renamed to "+b+"\n");SV.SetClientName(Host.client, b);a=SV.server.reliable_datagram;MSG.WriteByte(a,Protocol.svc.updatename);MSG.WriteByte(a,Host.client.num);MSG.WriteString(a,b)}}},Version_f:function(){Con.Print("Version 1.09\n");Con.Print(Def.timedate)},Say:function(b){if(!0!==Cmd.client)Cmd.ForwardToServer();else if(!(1>=Cmd.argv.length)){var a=Host.client,c=Cmd.args;34===c.charCodeAt(0)&&(c=c.substring(1,c.length-1));text="\u0001"+SV.GetClientName(a)+": ";var d=62-text.length;c.length>d&&(c=c.substring(0,d));text+=c+"\n";for(d=0;d<SV.svs.maxclients;++d)if(c= SV.svs.clients[d],!(!0!==c.active||!0!==c.spawned)&&!(0!==Host.teamplay.value&&!0===b&&c.v_float[PR.entvars.team]!==a.v_float[PR.entvars.team]))Host.client=c,Host.ClientPrint(text);Host.client=a;Sys.Print(text.substring(1))}},Say_Team_f:function(){Host.Say(!0)},Tell_f:function(){if(!0!==Cmd.client)Cmd.ForwardToServer();else if(!(2>=Cmd.argv.length)){var b=SV.GetClientName(Host.client)+": ",a=Cmd.args;34===a.charCodeAt(0)&&(a=a.substring(1,a.length-1));var c=62-b.length;a.length>c&&(a=a.substring(0, c));for(var b=b+(a+"\n"),a=Host.client,d,c=0;c<SV.svs.maxclients;++c)if(d=SV.svs.clients[c],!(!0!==d.active||!0!==d.spawned)&&SV.GetClientName(d).toLowerCase()===Cmd.argv[1].toLowerCase()){Host.client=d;Host.ClientPrint(b);break}Host.client=a}},Color_f:function(){if(1>=Cmd.argv.length)Con.Print('"color" is "'+(CL.color.value>>4)+" "+(CL.color.value&15)+'"\ncolor <0-13> [0-13]\n');else{var b,a;2===Cmd.argv.length?b=a=Q.atoi(Cmd.argv[1]):(b=Q.atoi(Cmd.argv[1]),a=Q.atoi(Cmd.argv[2]));0>b?b=0:14<=b&& (b=13);0>a?a=0:14<=a&&(a=13);b=(b<<4)+a;!0!==Cmd.client?(Cvar.SetValue("_cl_color",b),CL.cls.state===CL.active.connected&&Cmd.ForwardToServer()):(Host.client.colors=b,Host.client.edict.v_float[PR.entvars.team]=a+1,a=SV.server.reliable_datagram,MSG.WriteByte(a,Protocol.svc.updatecolors),MSG.WriteByte(a,Host.client.num),MSG.WriteByte(a,b))}},Kill_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0>=SV.player.v_float[PR.entvars.health]?Host.ClientPrint("Can't suicide -- allready dead!\n"):(PR.globals_float[PR.globalvars.time]= SV.server.time,PR.globals_int[PR.globalvars.self]=SV.player.num,PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientKill]))},Pause_f:function(){!0!==Cmd.client?Cmd.ForwardToServer():0===Host.pausable.value?Host.ClientPrint("Pause not allowed.\n"):(SV.server.paused=!SV.server.paused,Host.BroadcastPrint(SV.GetClientName(Host.client)+(!0===SV.server.paused?" paused the game\n":" unpaused the game\n")),MSG.WriteByte(SV.server.reliable_datagram,Protocol.svc.setpause),MSG.WriteByte(SV.server.reliable_datagram, !0===SV.server.paused?1:0))},PreSpawn_f:function(){if(!0!==Cmd.client)Con.Print("prespawn is not valid from the console\n");else{var b=Host.client;!0===b.spawned?Con.Print("prespawn not valid -- allready spawned\n"):(SZ.Write(b.message,new Uint8Array(SV.server.signon.data),SV.server.signon.cursize),MSG.WriteByte(b.message,Protocol.svc.signonnum),MSG.WriteByte(b.message,2),b.sendsignon=!0)}},Spawn_f:function(){if(!0!==Cmd.client)Con.Print("spawn is not valid from the console\n");else{var b=Host.client; if(!0===b.spawned)Con.Print("Spawn not valid -- allready spawned\n");else{var a;if(!0===SV.server.loadgame)SV.server.paused=!1;else{var c=b.edict;for(a=0;a<PR.entityfields;++a)c.v_int[a]=0;c.v_float[PR.entvars.colormap]=c.num;c.v_float[PR.entvars.team]=(b.colors&15)+1;c.v_int[PR.entvars.netname]=PR.netnames+(b.num<<5);for(a=0;15>=a;++a)PR.globals_float[PR.globalvars.parms+a]=b.spawn_parms[a];PR.globals_float[PR.globalvars.time]=SV.server.time;PR.globals_int[PR.globalvars.self]=c.num;PR.ExecuteProgram(PR.globals_int[PR.globalvars.ClientConnect]); Sys.FloatTime()-b.netconnection.connecttime<=SV.server.time&&Sys.Print(SV.GetClientName(b)+" entered the game\n");PR.ExecuteProgram(PR.globals_int[PR.globalvars.PutClientInServer])}var d=b.message;d.cursize=0;MSG.WriteByte(d,Protocol.svc.time);MSG.WriteFloat(d,SV.server.time);for(a=0;a<SV.svs.maxclients;++a)b=SV.svs.clients[a],MSG.WriteByte(d,Protocol.svc.updatename),MSG.WriteByte(d,a),MSG.WriteString(d,SV.GetClientName(b)),MSG.WriteByte(d,Protocol.svc.updatefrags),MSG.WriteByte(d,a),MSG.WriteShort(d, b.old_frags),MSG.WriteByte(d,Protocol.svc.updatecolors),MSG.WriteByte(d,a),MSG.WriteByte(d,b.colors);for(a=0;63>=a;++a)MSG.WriteByte(d,Protocol.svc.lightstyle),MSG.WriteByte(d,a),MSG.WriteString(d,SV.server.lightstyles[a]);MSG.WriteByte(d,Protocol.svc.updatestat);MSG.WriteByte(d,Def.stat.totalsecrets);MSG.WriteLong(d,PR.globals_float[PR.globalvars.total_secrets]);MSG.WriteByte(d,Protocol.svc.updatestat);MSG.WriteByte(d,Def.stat.totalmonsters);MSG.WriteLong(d,PR.globals_float[PR.globalvars.total_monsters]); MSG.WriteByte(d,Protocol.svc.updatestat);MSG.WriteByte(d,Def.stat.secrets);MSG.WriteLong(d,PR.globals_float[PR.globalvars.found_secrets]);MSG.WriteByte(d,Protocol.svc.updatestat);MSG.WriteByte(d,Def.stat.monsters);MSG.WriteLong(d,PR.globals_float[PR.globalvars.killed_monsters]);MSG.WriteByte(d,Protocol.svc.setangle);c=SV.server.edicts[1+Host.client.num];MSG.WriteAngle(d,c.v_float[PR.entvars.angles]);MSG.WriteAngle(d,c.v_float[PR.entvars.angles1]);MSG.WriteAngle(d,0);SV.WriteClientdataToMessage(c, d);MSG.WriteByte(d,Protocol.svc.signonnum);MSG.WriteByte(d,3);Host.client.sendsignon=!0}}},Begin_f:function(){!0!==Cmd.client?Con.Print("begin is not valid from the console\n"):Host.client.spawned=!0},Kick_f:function(){if(!0!==Cmd.client){if(!0!==SV.server.active){Cmd.ForwardToServer();return}}else if(0!==PR.globals_float[PR.globalvars.deathmatch])return;var b=Host.client,a,c;if(3<=Cmd.argv.length&&"#"===Cmd.argv[1]){a=Q.atoi(Cmd.argv[2])-1;if(0>a||a>=SV.svs.maxclients||!0!==SV.svs.clients[a].active)return; Host.client=SV.svs.clients[a];c=!0}else for(a=0;a<SV.svs.maxclients&&!(Host.client=SV.svs.clients[a],!0===Host.client.active&&SV.GetClientName(Host.client).toLowerCase()===Cmd.argv[1].toLowerCase());++a);if(a>=SV.svs.maxclients)Host.client=b;else if(Host.client!==b){a=!0!==Cmd.client?CL.name.string:SV.GetClientName(b);var d;3<=Cmd.argv.length&&(d=COM.Parse(Cmd.args));if(null!=d){var e=0;if(!0===c){for(++e;e<d.length&&32===d.charCodeAt(e);++e);e+=Cmd.argv[2].length}for(;e<d.length&&32===d.charCodeAt(e);++e); Host.ClientPrint("Kicked by "+a+": "+d.substring(e)+"\n")}else Host.ClientPrint("Kicked by "+a+"\n");Host.DropClient();Host.client=b}},Give_f:function(){if(!0!==Cmd.client)Cmd.ForwardToServer();else if(0===PR.globals_float[PR.globalvars.deathmatch]&&!(1>=Cmd.argv.length)){var b=Cmd.argv[1].charCodeAt(0),a=SV.player;if(48<=b&&57>=b)!0!==COM.hipnotic?50<=b&&(a.v_float[PR.entvars.items]|=Def.it.shotgun<<b-50):54===b?a.v_float[PR.entvars.items]=97===Cmd.argv[1].charCodeAt(1)?a.v_float[PR.entvars.items]| Def.hit.proximity_gun:a.v_float[PR.entvars.items]|Def.it.grenade_launcher:57===b?a.v_float[PR.entvars.items]|=Def.hit.laser_cannon:48===b?a.v_float[PR.entvars.items]|=Def.hit.mjolnir:50<=b&&(a.v_float[PR.entvars.items]|=Def.it.shotgun<<b-50);else{var c=Q.atoi(Cmd.argv[2]);if(104===b)a.v_float[PR.entvars.health]=c;else if(!0!==COM.rogue)switch(b){case 115:a.v_float[PR.entvars.ammo_shells]=c;break;case 110:a.v_float[PR.entvars.ammo_nails]=c;break;case 114:a.v_float[PR.entvars.ammo_rockets]=c;break; case 99:a.v_float[PR.entvars.ammo_cells]=c}else switch(b){case 115:null!=PR.entvars.ammo_shells1&&(a.v_float[PR.entvars.ammo_shells1]=c);a.v_float[PR.entvars.ammo_shells]=c;break;case 110:null!=PR.entvars.ammo_nails1&&(a.v_float[PR.entvars.ammo_nails1]=c,a.v_float[PR.entvars.weapon]<=Def.it.lightning&&(a.v_float[PR.entvars.ammo_nails]=c));break;case 108:null!=PR.entvars.ammo_lava_nails&&(a.v_float[PR.entvars.ammo_lava_nails]=c,a.v_float[PR.entvars.weapon]>Def.it.lightning&&(a.v_float[PR.entvars.ammo_nails]= c));break;case 114:null!=PR.entvars.ammo_rockets1&&(a.v_float[PR.entvars.ammo_rockets1]=c,a.v_float[PR.entvars.weapon]<=Def.it.lightning&&(a.v_float[PR.entvars.ammo_rockets]=c));break;case 109:null!=PR.entvars.ammo_multi_rockets&&(a.v_float[PR.entvars.ammo_multi_rockets]=c,a.v_float[PR.entvars.weapon]>Def.it.lightning&&(a.v_float[PR.entvars.ammo_rockets]=c));break;case 99:null!=PR.entvars.ammo_cells1&&(a.v_float[PR.entvars.ammo_cells1]=c,a.v_float[PR.entvars.weapon]<=Def.it.lightning&&(a.v_float[PR.entvars.ammo_cells]= c));break;case 112:null!=PR.entvars.ammo_plasma&&(a.v_float[PR.entvars.ammo_plasma]=c,a.v_float[PR.entvars.weapon]>Def.it.lightning&&(a.v_float[PR.entvars.ammo_cells]=c))}}}},FindViewthing:function(){var b,a;if(!0===SV.server.active)for(b=0;b<SV.server.num_edicts;++b)if(a=SV.server.edicts[b],"viewthing"===PR.GetString(a.v_int[PR.entvars.classname]))return a;Con.Print("No viewthing on map\n")},Viewmodel_f:function(){if(2===Cmd.argv.length&&null!=Host.FindViewthing()){var b=Mod.ForName(Cmd.argv[1]); null==b?Con.Print("Can't load "+Cmd.argv[1]+"\n"):(ent.v_float[PR.entvars.frame]=0,CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0]=b)}},Viewframe_f:function(){var b=Host.FindViewthing();if(null!=b){var a=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0],c=Q.atoi(Cmd.argv[1]);c>=a.frames.length&&(c=a.frames.length-1);b.v_float[PR.entvars.frame]=c}},Viewnext_f:function(){var b=Host.FindViewthing();if(null!=b){var a=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>> 0],c=(ent.v_float[PR.entvars.frame]>>0)+1;c>=a.frames.length&&(c=a.frames.length-1);b.v_float[PR.entvars.frame]=c;Con.Print("frame "+c+": "+a.frames[c].name+"\n")}},Viewprev_f:function(){var b=Host.FindViewthing();if(null!=b){var a=CL.state.model_precache[ent.v_float[PR.entvars.modelindex]>>0],c=(ent.v_float[PR.entvars.frame]>>0)-1;0>c&&(c=0);b.v_float[PR.entvars.frame]=c;Con.Print("frame "+c+": "+a.frames[c].name+"\n")}},Startdemos_f:function(){Con.Print(Cmd.argv.length-1+" demo(s) in loop\n");CL.cls.demos= [];var b;for(b=1;b<Cmd.argv.length;++b)CL.cls.demos[b-1]=Cmd.argv[b];-1!==CL.cls.demonum&&!0!==CL.cls.demoplayback?(CL.cls.demonum=0,0!==Host.framecount?CL.NextDemo():Host.startdemos=!0):CL.cls.demonum=-1},Demos_f:function(){-1===CL.cls.demonum&&(CL.cls.demonum=1);CL.Disconnect();CL.NextDemo()},Stopdemo_f:function(){!0===CL.cls.demoplayback&&(CL.StopPlayback(),CL.Disconnect())},InitCommands:function(){Cmd.AddCommand("status",Host.Status_f);Cmd.AddCommand("quit",Host.Quit_f);Cmd.AddCommand("god",Host.God_f); Cmd.AddCommand("notarget",Host.Notarget_f);Cmd.AddCommand("fly",Host.Fly_f);Cmd.AddCommand("map",Host.Map_f);Cmd.AddCommand("restart",Host.Restart_f);Cmd.AddCommand("changelevel",Host.Changelevel_f);Cmd.AddCommand("connect",Host.Connect_f);Cmd.AddCommand("reconnect",Host.Reconnect_f);Cmd.AddCommand("name",Host.Name_f);Cmd.AddCommand("noclip",Host.Noclip_f);Cmd.AddCommand("version",Host.Version_f);Cmd.AddCommand("say",Host.Say);Cmd.AddCommand("say_team",Host.Say_Team_f);Cmd.AddCommand("tell",Host.Tell_f); Cmd.AddCommand("color",Host.Color_f);Cmd.AddCommand("kill",Host.Kill_f);Cmd.AddCommand("pause",Host.Pause_f);Cmd.AddCommand("spawn",Host.Spawn_f);Cmd.AddCommand("begin",Host.Begin_f);Cmd.AddCommand("prespawn",Host.PreSpawn_f);Cmd.AddCommand("kick",Host.Kick_f);Cmd.AddCommand("ping",Host.Ping_f);Cmd.AddCommand("load",Host.Loadgame_f);Cmd.AddCommand("save",Host.Savegame_f);Cmd.AddCommand("give",Host.Give_f);Cmd.AddCommand("startdemos",Host.Startdemos_f);Cmd.AddCommand("demos",Host.Demos_f);Cmd.AddCommand("stopdemo", Host.Stopdemo_f);Cmd.AddCommand("viewmodel",Host.Viewmodel_f);Cmd.AddCommand("viewframe",Host.Viewframe_f);Cmd.AddCommand("viewnext",Host.Viewnext_f);Cmd.AddCommand("viewprev",Host.Viewprev_f);Cmd.AddCommand("mcache",Mod.Print)}};
var Key={k:{tab:9,enter:13,escape:27,space:32,backspace:127,uparrow:128,downarrow:129,leftarrow:130,rightarrow:131,alt:132,ctrl:133,shift:134,f1:135,f2:136,f3:137,f4:138,f5:139,f6:140,f7:141,f8:142,f9:143,f10:144,f11:145,f12:146,ins:147,del:148,pgdn:149,pgup:150,home:151,end:152,pause:255,mouse1:200,mouse2:201,mouse3:202},lines:[""],edit_line:"",history_line:1,dest:{game:0,console:1,message:2,menu:3,value:0},bindings:[],consolekeys:[],shift:[],down:[]}; Key.names=[{name:"TAB",keynum:Key.k.tab},{name:"ENTER",keynum:Key.k.enter},{name:"ESCAPE",keynum:Key.k.escape},{name:"SPACE",keynum:Key.k.space},{name:"BACKSPACE",keynum:Key.k.backspace},{name:"UPARROW",keynum:Key.k.uparrow},{name:"DOWNARROW",keynum:Key.k.downarrow},{name:"LEFTARROW",keynum:Key.k.leftarrow},{name:"RIGHTARROW",keynum:Key.k.rightarrow},{name:"ALT",keynum:Key.k.alt},{name:"CTRL",keynum:Key.k.ctrl},{name:"SHIFT",keynum:Key.k.shift},{name:"F1",keynum:Key.k.f1},{name:"F2",keynum:Key.k.f2}, {name:"F3",keynum:Key.k.f3},{name:"F4",keynum:Key.k.f4},{name:"F5",keynum:Key.k.f5},{name:"F6",keynum:Key.k.f6},{name:"F7",keynum:Key.k.f7},{name:"F8",keynum:Key.k.f8},{name:"F9",keynum:Key.k.f9},{name:"F10",keynum:Key.k.f10},{name:"F11",keynum:Key.k.f11},{name:"F12",keynum:Key.k.f12},{name:"INS",keynum:Key.k.ins},{name:"DEL",keynum:Key.k.del},{name:"PGDN",keynum:Key.k.pgdn},{name:"PGUP",keynum:Key.k.pgup},{name:"HOME",keynum:Key.k.home},{name:"END",keynum:Key.k.end},{name:"MOUSE1",keynum:Key.k.mouse1}, {name:"MOUSE2",keynum:Key.k.mouse2},{name:"MOUSE3",keynum:Key.k.mouse3},{name:"PAUSE",keynum:Key.k.pause},{name:"SEMICOLON",keynum:59}]; Key.Console=function(a){a===Key.k.enter?(Cmd.text+=Key.edit_line+"\n",Con.Print("]"+Key.edit_line+"\n"),Key.lines[Key.lines.length]=Key.edit_line,Key.edit_line="",Key.history_line=Key.lines.length):a===Key.k.tab?(a=Cmd.CompleteCommand(Key.edit_line),null==a&&(a=Cvar.CompleteVariable(Key.edit_line)),null!=a&&(Key.edit_line=a+" ")):a===Key.k.backspace||a===Key.k.leftarrow?0<Key.edit_line.length&&(Key.edit_line=Key.edit_line.substring(0,Key.edit_line.length-1)):a===Key.k.uparrow?(0>--Key.history_line&& (Key.history_line=0),Key.edit_line=Key.lines[Key.history_line]):a===Key.k.downarrow?Key.history_line>=Key.lines.length||(++Key.history_line>=Key.lines.length?(Key.history_line=Key.lines.length,Key.edit_line=""):Key.edit_line=Key.lines[Key.history_line]):a===Key.k.pgup?(Con.backscroll+=2,Con.backscroll>Con.text.length&&(Con.backscroll=Con.text.length)):a===Key.k.pgdn?(Con.backscroll-=2,0>Con.backscroll&&(Con.backscroll=0)):a===Key.k.home?(Con.backscroll=Con.text.length-10,0>Con.backscroll&&(Con.backscroll= 0)):a===Key.k.end?Con.backscroll=0:32>a||127<a||(Key.edit_line+=String.fromCharCode(a))};Key.chat_buffer=""; Key.Message=function(a){a===Key.k.enter?(Cmd.text=!0===Key.team_message?Cmd.text+('say_team "'+Key.chat_buffer+'"\n'):Cmd.text+('say "'+Key.chat_buffer+'"\n'),Key.dest.value=Key.dest.game,Key.chat_buffer=""):a===Key.k.escape?(Key.dest.value=Key.dest.game,Key.chat_buffer=""):32>a||127<a||(a===Key.k.backspace?0!==Key.chat_buffer.length&&(Key.chat_buffer=Key.chat_buffer.substring(0,Key.chat_buffer.length-1)):31<=Key.chat_buffer.length||(Key.chat_buffer+=String.fromCharCode(a)))}; Key.StringToKeynum=function(a){if(1===a.length)return a.charCodeAt(0);a=a.toUpperCase();var b;for(b=0;b<Key.names.length;++b)if(Key.names[b].name===a)return Key.names[b].keynum};Key.KeynumToString=function(a){if(32<a&&127>a)return String.fromCharCode(a);var b;for(b=0;b<Key.names.length;++b)if(Key.names[b].keynum===a)return Key.names[b].name;return"<UNKNOWN KEYNUM>"}; Key.Unbind_f=function(){if(2!==Cmd.argv.length)Con.Print("unbind <key> : remove commands from a key\n");else{var a=Key.StringToKeynum(Cmd.argv[1]);null==a?Con.Print('"'+Cmd.argv[1]+"\" isn't a valid key\n"):delete Key.bindings[a]}};Key.Unbindall_f=function(){Key.bindings=[]}; Key.Bind_f=function(){var a=Cmd.argv.length;if(2!==a&&3!==a)Con.Print("bind <key> [command] : attach a command to a key\n");else{var b=Key.StringToKeynum(Cmd.argv[1]);if(null==b)Con.Print('"'+Cmd.argv[1]+"\" isn't a valid key\n");else if(2===a)null!=Key.bindings[b]?Con.Print('"'+Cmd.argv[1]+'" = "'+Key.bindings[b]+'"\n'):Con.Print('"'+Cmd.argv[1]+'" is not bound\n');else{var c,d=Cmd.argv[2];for(c=3;c<a;++c)d+=" "+Cmd.argv[c];Key.bindings[b]=d}}}; Key.WriteBindings=function(){var a=[],b;for(b=0;b<Key.bindings.length;++b)null!=Key.bindings[b]&&(a[a.length]='bind "'+Key.KeynumToString(b)+'" "'+Key.bindings[b]+'"\n');return a.join("")}; Key.Init=function(){var a;for(a=32;128>a;++a)Key.consolekeys[a]=!0;Key.consolekeys[Key.k.enter]=!0;Key.consolekeys[Key.k.tab]=!0;Key.consolekeys[Key.k.leftarrow]=!0;Key.consolekeys[Key.k.rightarrow]=!0;Key.consolekeys[Key.k.uparrow]=!0;Key.consolekeys[Key.k.downarrow]=!0;Key.consolekeys[Key.k.backspace]=!0;Key.consolekeys[Key.k.home]=!0;Key.consolekeys[Key.k.end]=!0;Key.consolekeys[Key.k.pgup]=!0;Key.consolekeys[Key.k.pgdn]=!0;Key.consolekeys[Key.k.shift]=!0;Key.consolekeys[96]=!1;Key.consolekeys[126]= !1;for(a=0;256>a;++a)Key.shift[a]=a;for(a=97;122>=a;++a)Key.shift[a]=a-32;Key.shift[49]=33;Key.shift[50]=64;Key.shift[51]=35;Key.shift[52]=36;Key.shift[53]=37;Key.shift[54]=94;Key.shift[55]=38;Key.shift[56]=42;Key.shift[57]=40;Key.shift[48]=41;Key.shift[45]=95;Key.shift[61]=43;Key.shift[43]=60;Key.shift[46]=62;Key.shift[47]=63;Key.shift[59]=58;Key.shift[39]=34;Key.shift[91]=123;Key.shift[93]=125;Key.shift[96]=126;Key.shift[92]=124;Cmd.AddCommand("bind",Key.Bind_f);Cmd.AddCommand("unbind",Key.Unbind_f); Cmd.AddCommand("unbindall",Key.Unbindall_f)}; Key.Event=function(a,b){if(!(a!==Key.k.backspace&&!0===b&&!0===Key.down[a]))if(Key.down[a]=b,a===Key.k.shift&&(Key.shift_down=b),a===Key.k.escape)!0===b&&(Key.dest.value===Key.dest.message?Key.Message(a):Key.dest.value===Key.dest.menu?M.Keydown(a):M.ToggleMenu_f());else{var c;!0!==b?(c=Key.bindings[a],null!=c&&43===c.charCodeAt(0)&&(Cmd.text+="-"+c.substring(1)+" "+a+"\n"),Key.shift[a]!==a&&(c=Key.bindings[Key.shift[a]],null!=c&&43===c.charCodeAt(0)&&(Cmd.text+="-"+c.substring(1)+" "+a+"\n"))):!0=== CL.cls.demoplayback&&!0===Key.consolekeys[a]&&Key.dest.value===Key.dest.game?M.ToggleMenu_f():Key.dest.value===Key.dest.menu&&(a===Key.k.escape||a>=Key.k.f1&&a<=Key.k.f12)||Key.dest.value===Key.dest.console&&!0!==Key.consolekeys[a]||Key.dest.value===Key.dest.game&&(!0!==Con.forcedup||!0!==Key.consolekeys[a])?(c=Key.bindings[a],null!=c&&(Cmd.text=43===c.charCodeAt(0)?Cmd.text+(c+" "+a+"\n"):Cmd.text+(c+"\n"))):(!0===Key.shift_down&&(a=Key.shift[a]),Key.dest.value===Key.dest.message?Key.Message(a): Key.dest.value===Key.dest.menu?M.Keydown(a):Key.Console(a))}};
var M={state:{none:0,main:1,singleplayer:2,load:3,save:4,multiplayer:5,options:6,keys:7,help:8,quit:9,value:0},DrawCharacter:function(a,b,c){Draw.Character(a+(VID.width>>1)-160,b+(VID.height>>1)-100,c)},Print:function(a,b,c){Draw.StringWhite(a+(VID.width>>1)-160,b+(VID.height>>1)-100,c)},PrintWhite:function(a,b,c){Draw.String(a+(VID.width>>1)-160,b+(VID.height>>1)-100,c)},DrawPic:function(a,b,c){Draw.Pic(a+(VID.width>>1)-160,b+(VID.height>>1)-100,c)},DrawPicTranslate:function(a,b,c,d,e){Draw.PicTranslate(a+ (VID.width>>1)-160,b+(VID.height>>1)-100,c,d,e)},DrawTextBox:function(a,b,c,d){var e,f;e=b;M.DrawPic(a,e,M.box_tl);for(f=0;f<d;++f)M.DrawPic(a,e+=8,M.box_ml);M.DrawPic(a,e+8,M.box_bl);a+=8;for(var g;0<c;){e=b;M.DrawPic(a,b,M.box_tm);g=M.box_mm;for(f=0;f<d;++f)M.DrawPic(a,e+=8,g),0===f&&(g=M.box_mm2);M.DrawPic(a,e+8,M.box_bm);c-=2;a+=16}e=b;M.DrawPic(a,e,M.box_tr);for(f=0;f<d;++f)M.DrawPic(a,e+=8,M.box_mr);M.DrawPic(a,e+8,M.box_br)},ToggleMenu_f:function(){M.entersound=!0;Key.dest.value===Key.dest.menu? M.state.value!==M.state.main?M.Menu_Main_f():(Key.dest.value=Key.dest.game,M.state.value=M.state.none):M.Menu_Main_f()},main_cursor:0,main_items:5,Menu_Main_f:function(){Key.dest.value!==Key.dest.menu&&(M.save_demonum=CL.cls.demonum,CL.cls.demonum=-1);Key.dest.value=Key.dest.menu;M.state.value=M.state.main;M.entersound=!0},Main_Draw:function(){M.DrawPic(16,4,M.qplaque);M.DrawPic(160-(M.ttl_main.width>>1),4,M.ttl_main);M.DrawPic(72,32,M.mainmenu);M.DrawPic(54,32+20*M.main_cursor,M.menudot[Math.floor(10* Host.realtime)%6])},Main_Key:function(a){switch(a){case Key.k.escape:Key.dest.value=Key.dest.game;M.state.value=M.state.none;CL.cls.demonum=M.save_demonum;-1!==CL.cls.demonum&&(!0!==CL.cls.demoplayback&&CL.cls.state!==CL.active.connected)&&CL.NextDemo();break;case Key.k.downarrow:S.LocalSound(M.sfx_menu1);++M.main_cursor>=M.main_items&&(M.main_cursor=0);break;case Key.k.uparrow:S.LocalSound(M.sfx_menu1);0>--M.main_cursor&&(M.main_cursor=M.main_items-1);break;case Key.k.enter:switch(M.entersound=!0, M.main_cursor){case 0:M.Menu_SinglePlayer_f();break;case 1:M.Menu_MultiPlayer_f();break;case 2:M.Menu_Options_f();break;case 3:M.Menu_Help_f();break;case 4:M.Menu_Quit_f()}}},singleplayer_cursor:0,singleplayer_items:3,Menu_SinglePlayer_f:function(){Key.dest.value=Key.dest.menu;M.state.value=M.state.singleplayer;M.entersound=!0},SinglePlayer_Draw:function(){M.DrawPic(16,4,M.qplaque);M.DrawPic(160-(M.ttl_sgl.width>>1),4,M.ttl_sgl);M.DrawPic(72,32,M.sp_menu);M.DrawPic(54,32+20*M.singleplayer_cursor, M.menudot[Math.floor(10*Host.realtime)%6])},SinglePlayer_Key:function(a){switch(a){case Key.k.escape:M.Menu_Main_f();break;case Key.k.downarrow:S.LocalSound(M.sfx_menu1);++M.singleplayer_cursor>=M.singleplayer_items&&(M.singleplayer_cursor=0);break;case Key.k.uparrow:S.LocalSound(M.sfx_menu1);0>--M.singleplayer_cursor&&(M.singleplayer_cursor=M.singleplayer_items-1);break;case Key.k.enter:switch(M.entersound=!0,M.singleplayer_cursor){case 0:if(!0===SV.server.active){if(!0!==confirm("Are you sure you want to start a new game?"))break; Cmd.text+="disconnect\n"}Key.dest.value=Key.dest.game;Cmd.text+="maxplayers 1\nmap start\n";break;case 1:M.Menu_Load_f();break;case 2:M.Menu_Save_f()}}},load_cursor:0,max_savegames:12,filenames:[],loadable:[],loadpaths:[],ScanSaves:function(){var a,b,c,d,e,f;for(a=0;a<M.max_savegames;++a){M.loadpaths[a]=null;for(b=COM.searchpaths.length-1;0<=b;--b)if(c="Quake."+COM.searchpaths[b].filename+"/s"+a+".sav",d=localStorage.getItem(c),null!=d){M.loadpaths[a]=c;break}0>b&&(d=COM.LoadTextFile("s"+a+".sav")); if(null==d)M.filenames[a]="--- UNUSED SLOT ---",M.loadable[a]=!1;else{for(c=0;c<d.length;++c)if(f=d.charCodeAt(c),10===f){++c;break}e=[];for(b=0;39>=b;++b){f=d.charCodeAt(c+b);if(13===f)break;e[b]=95===f?" ":String.fromCharCode(f)}M.filenames[a]=e.join("");M.loadable[a]=!0}}},Menu_Load_f:function(){M.entersound=!0;M.state.value=M.state.load;Key.dest.value=Key.dest.menu;M.ScanSaves()},Menu_Save_f:function(){!0!==SV.server.active||(0!==CL.state.intermission||1!==SV.svs.maxclients)||(M.entersound=!0, M.state.value=M.state.save,Key.dest.value=Key.dest.menu,M.ScanSaves())},Load_Draw:function(){M.DrawPic(160-(M.p_load.width>>1),4,M.p_load);var a;for(a=0;a<M.max_savegames;++a)M.Print(16,32+(a<<3),M.filenames[a]);M.DrawCharacter(8,32+(M.load_cursor<<3),12+(4*Host.realtime&1))},Save_Draw:function(){M.DrawPic(160-(M.p_save.width>>1),4,M.p_save);var a;for(a=0;a<M.max_savegames;++a)M.Print(16,32+(a<<3),M.filenames[a]);M.DrawCharacter(8,32+(M.load_cursor<<3),12+(4*Host.realtime&1))},Load_Key:function(a){switch(a){case Key.k.escape:M.Menu_SinglePlayer_f(); break;case Key.k.enter:S.LocalSound(M.sfx_menu2);if(!0!==M.loadable[M.load_cursor])break;M.state.value=M.state.none;Key.dest.value=Key.dest.game;SCR.BeginLoadingPlaque();Cmd.text+="load s"+M.load_cursor+"\n";break;case Key.k.uparrow:case Key.k.leftarrow:S.LocalSound(M.sfx_menu1);0>--M.load_cursor&&(M.load_cursor=M.max_savegames-1);break;case Key.k.downarrow:case Key.k.rightarrow:S.LocalSound(M.sfx_menu1);++M.load_cursor>=M.max_savegames&&(M.load_cursor=0);break;case Key.k.del:if(null==M.loadpaths[M.load_cursor])break; !0===confirm("Delete selected game?")&&(localStorage.removeItem(M.loadpaths[M.load_cursor]),M.ScanSaves())}},Save_Key:function(a){switch(a){case Key.k.escape:M.Menu_SinglePlayer_f();break;case Key.k.enter:M.state.value=M.state.none;Key.dest.value=Key.dest.game;Cmd.text+="save s"+M.load_cursor+"\n";break;case Key.k.uparrow:case Key.k.leftarrow:S.LocalSound(M.sfx_menu1);0>--M.load_cursor&&(M.load_cursor=M.max_savegames-1);break;case Key.k.downarrow:case Key.k.rightarrow:S.LocalSound(M.sfx_menu1);++M.load_cursor>= M.max_savegames&&(M.load_cursor=0);break;case Key.k.del:if(null==M.loadpaths[M.load_cursor])break;!0===confirm("Delete selected game?")&&(localStorage.removeItem(M.loadpaths[M.load_cursor]),M.ScanSaves())}},multiplayer_cursor:0,multiplayer_cursor_table:[56,72,96,120,156],multiplayer_joinname:"",multiplayer_items:5,return_reason:"",Menu_MultiPlayer_f:function(){Key.dest.value=Key.dest.menu;M.state.value=M.state.multiplayer;M.entersound=!0;M.multiplayer_myname=CL.name.string;M.multiplayer_top=M.multiplayer_oldtop= CL.color.value>>4;M.multiplayer_bottom=M.multiplayer_oldbottom=CL.color.value&15},MultiPlayer_Draw:function(){M.DrawPic(16,4,M.qplaque);M.DrawPic(160-(M.p_multi.width>>1),4,M.p_multi);M.Print(64,40,"Join game at:");M.DrawTextBox(72,48,22,1);M.Print(80,56,M.multiplayer_joinname.substring(M.multiplayer_joinname.length-21));M.Print(64,72,"Your name");M.DrawTextBox(160,64,16,1);M.Print(168,72,M.multiplayer_myname);M.Print(64,96,"Shirt color");M.Print(64,120,"Pants color");M.DrawTextBox(64,148,14,1);M.Print(72, 156,"Accept Changes");M.DrawPic(160,80,M.bigbox);M.DrawPicTranslate(172,88,M.menuplyr,(M.multiplayer_top<<4)+(8<=M.multiplayer_top?0:15),(M.multiplayer_bottom<<4)+(8<=M.multiplayer_bottom?0:15));M.DrawCharacter(56,M.multiplayer_cursor_table[M.multiplayer_cursor],12+(4*Host.realtime&1));0===M.multiplayer_cursor?M.DrawCharacter(20>=M.multiplayer_joinname.length?80+(M.multiplayer_joinname.length<<3):248,56,10+(4*Host.realtime&1)):1===M.multiplayer_cursor&&M.DrawCharacter(168+(M.multiplayer_myname.length<< 3),72,10+(4*Host.realtime&1));!0!==WEBS.available?M.PrintWhite(52,172,"No Communications Available"):0!==M.return_reason.length&&M.PrintWhite(64,172,M.return_reason)},MultiPlayer_Key:function(a){a===Key.k.escape&&M.Menu_Main_f();switch(a){case Key.k.uparrow:S.LocalSound(M.sfx_menu1);0>--M.multiplayer_cursor&&(M.multiplayer_cursor=M.multiplayer_items-1);return;case Key.k.downarrow:S.LocalSound(M.sfx_menu1);++M.multiplayer_cursor>=M.multiplayer_items&&(M.multiplayer_cursor=0);return;case Key.k.leftarrow:2=== M.multiplayer_cursor?(0>--M.multiplayer_top&&(M.multiplayer_top=13),S.LocalSound(M.sfx_menu3)):3===M.multiplayer_cursor&&(0>--M.multiplayer_bottom&&(M.multiplayer_bottom=13),S.LocalSound(M.sfx_menu3));return;case Key.k.rightarrow:if(2===M.multiplayer_cursor)12>=M.multiplayer_top?++M.multiplayer_top:M.multiplayer_top=0;else if(3===M.multiplayer_cursor)12>=M.multiplayer_bottom?++M.multiplayer_bottom:M.multiplayer_bottom=0;else return;S.LocalSound(M.sfx_menu3);return;case Key.k.enter:switch(M.multiplayer_cursor){case 0:S.LocalSound(M.sfx_menu2); if(!0!==WEBS.available)break;Key.dest.value=Key.dest.game;M.state.value=M.state.none;Cmd.text+='connect "'+multiplayer_joinname+'"\n';break;case 2:S.LocalSound(M.sfx_menu3);12>=M.multiplayer_top?++M.multiplayer_top:M.multiplayer_top=0;break;case 3:S.LocalSound(M.sfx_menu3);12>=M.multiplayer_bottom?++M.multiplayer_bottom:M.multiplayer_bottom=0;break;case 4:CL.name.string!==M.multiplayer_myname&&(Cmd.text+='name "'+M.multiplayer_myname+'"\n');if(M.multiplayer_top!==M.multiplayer_oldtop||M.multiplayer_bottom!== M.multiplayer_oldbottom)M.multiplayer_oldtop=M.multiplayer_top,M.multiplayer_oldbottom=M.multiplayer_bottom,Cmd.text+="color "+M.multiplayer_top+" "+M.multiplayer_bottom+"\n";M.entersound=!0}return;case Key.k.backspace:if(0===M.multiplayer_cursor){0!==M.multiplayer_joinname.length&&(M.multiplayer_joinname=M.multiplayer_joinname.substring(0,M.multiplayer_joinname.length-1));return}1===M.multiplayer_cursor&&0!==M.multiplayer_myname.length&&(M.multiplayer_myname=M.multiplayer_myname.substring(0,M.multiplayer_myname.length- 1));return}32>a||127<a||(0===M.multiplayer_cursor?M.multiplayer_joinname+=String.fromCharCode(a):1===M.multiplayer_cursor&&14>=M.multiplayer_myname.length&&(M.multiplayer_myname+=String.fromCharCode(a)))},options_cursor:0,options_items:7,Menu_Options_f:function(){Key.dest.value=Key.dest.menu;M.state.value=M.state.options;M.entersound=!0},AdjustSliders:function(a){S.LocalSound(M.sfx_menu3);switch(M.options_cursor){case 3:SCR.viewsize.value+=10*a;30>SCR.viewsize.value?SCR.viewsize.value=30:120<SCR.viewsize.value&& (SCR.viewsize.value=120);Cvar.SetValue("viewsize",SCR.viewsize.value);break;case 4:S.bgmvolume.value+=0.1*a;0>S.bgmvolume.value?S.bgmvolume.value=0:1<S.bgmvolume.value&&(S.bgmvolume.value=1);Cvar.SetValue("bgmvolume",S.bgmvolume.value);break;case 5:S.volume.value+=0.1*a;0>S.volume.value?S.volume.value=0:1<S.volume.value&&(S.volume.value=1);Cvar.SetValue("volume",S.volume.value);break;case 6:if(200<CL.forwardspeed.value){Cvar.SetValue("cl_forwardspeed",200);Cvar.SetValue("cl_backspeed",200);break}Cvar.SetValue("cl_forwardspeed", 400);Cvar.SetValue("cl_backspeed",400)}},DrawSlider:function(a,b,c){0>c?c=0:1<c&&(c=1);M.DrawCharacter(a-8,b,128);M.DrawCharacter(a,b,129);M.DrawCharacter(a+8,b,129);M.DrawCharacter(a+16,b,129);M.DrawCharacter(a+24,b,129);M.DrawCharacter(a+32,b,129);M.DrawCharacter(a+40,b,129);M.DrawCharacter(a+48,b,129);M.DrawCharacter(a+56,b,129);M.DrawCharacter(a+64,b,129);M.DrawCharacter(a+72,b,129);M.DrawCharacter(a+80,b,130);M.DrawCharacter(a+Math.floor(72*c),b,131)},Options_Draw:function(){M.DrawPic(16,4,M.qplaque); M.DrawPic(160-(M.p_option.width>>1),4,M.p_option);M.Print(48,32,"Customize controls");M.Print(88,40,"Go to console");M.Print(56,48,"Reset to defaults");M.Print(104,56,"Screen size");M.DrawSlider(220,56,(SCR.viewsize.value-30)/90);M.Print(72,64,"CD Music Volume");M.DrawSlider(220,64,S.bgmvolume.value);M.Print(96,72,"Sound Volume");M.DrawSlider(220,72,S.volume.value);M.Print(112,80,"Always Run");M.Print(220,80,200<CL.forwardspeed.value?"on":"off");M.DrawCharacter(200,32+(M.options_cursor<<3),12+(4* Host.realtime&1))},Options_Key:function(a){switch(a){case Key.k.escape:M.Menu_Main_f();break;case Key.k.enter:M.entersound=!0;switch(M.options_cursor){case 0:M.Menu_Keys_f();break;case 1:M.state.value=M.state.none;Con.ToggleConsole_f();break;case 2:Cmd.text+="exec default.cfg\n";break;default:M.AdjustSliders(1)}break;case Key.k.uparrow:S.LocalSound(M.sfx_menu1);0>--M.options_cursor&&(M.options_cursor=M.options_items-1);break;case Key.k.downarrow:S.LocalSound(M.sfx_menu1);++M.options_cursor>=M.options_items&& (M.options_cursor=0);break;case Key.k.leftarrow:M.AdjustSliders(-1);break;case Key.k.rightarrow:M.AdjustSliders(1)}},bindnames:[["+attack","attack"],["impulse 10","change weapon"],["+jump","jump / swim up"],["+forward","walk forward"],["+back","backpedal"],["+left","turn left"],["+right","turn right"],["+speed","run"],["+moveleft","step left"],["+moveright","step right"],["+strafe","sidestep"],["+lookup","look up"],["+lookdown","look down"],["centerview","center view"],["+mlook","mouse look"],["+klook", "keyboard look"],["+moveup","swim up"],["+movedown","swim down"]],keys_cursor:0,Menu_Keys_f:function(){Key.dest.value=Key.dest.menu;M.state.value=M.state.keys;M.entersound=!0},FindKeysForCommand:function(a){var b=[],c;for(c=0;c<Key.bindings.length&&!(Key.bindings[c]===a&&(b[b.length]=c,2===b.length));++c);return b},UnbindCommand:function(a){var b;for(b=0;b<Key.bindings.length;++b)Key.bindings[b]===a&&delete Key.bindings[b]},Keys_Draw:function(){M.DrawPic(160-(M.ttl_cstm.width>>1),4,M.ttl_cstm);!0=== M.bind_grab?(M.Print(12,32,"Press a key or button for this action"),M.DrawCharacter(130,48+(M.keys_cursor<<3),61)):(M.Print(18,32,"Enter to change, backspace to clear"),M.DrawCharacter(130,48+(M.keys_cursor<<3),12+(4*Host.realtime&1)));var a,b=48,c,d;for(a=0;a<M.bindnames.length;++a)M.Print(16,b,M.bindnames[a][1]),c=M.FindKeysForCommand(M.bindnames[a][0]),null==c[0]?M.Print(140,b,"???"):(d=Key.KeynumToString(c[0]),null!=c[1]&&(d+=" or "+Key.KeynumToString(c[1])),M.Print(140,b,d)),b+=8},Keys_Key:function(a){if(!0=== M.bind_grab)S.LocalSound(M.sfx_menu1),a!==Key.k.escape&&96!==a&&(Cmd.text='bind "'+Key.KeynumToString(a)+'" "'+M.bindnames[M.keys_cursor][0]+'"\n'+Cmd.text),M.bind_grab=!1;else switch(a){case Key.k.escape:M.Menu_Options_f();break;case Key.k.leftarrow:case Key.k.uparrow:S.LocalSound(M.sfx_menu1);0>--M.keys_cursor&&(M.keys_cursor=M.bindnames.length-1);break;case Key.k.downarrow:case Key.k.rightarrow:S.LocalSound(M.sfx_menu1);++M.keys_cursor>=M.bindnames.length&&(M.keys_cursor=0);break;case Key.k.enter:S.LocalSound(M.sfx_menu2); null!=M.FindKeysForCommand(M.bindnames[M.keys_cursor][0])[1]&&M.UnbindCommand(M.bindnames[M.keys_cursor][0]);M.bind_grab=!0;break;case Key.k.backspace:case Key.k.del:S.LocalSound(M.sfx_menu2),M.UnbindCommand(M.bindnames[M.keys_cursor][0])}},num_help_pages:6,Menu_Help_f:function(){Key.dest.value=Key.dest.menu;M.state.value=M.state.help;M.entersound=!0;M.help_page=0},Help_Draw:function(){M.DrawPic(0,0,M.help_pages[M.help_page])},Help_Key:function(a){switch(a){case Key.k.escape:M.Menu_Main_f();break; case Key.k.uparrow:case Key.k.rightarrow:M.entersound=!0;++M.help_page>=M.num_help_pages&&(M.help_page=0);break;case Key.k.downarrow:case Key.k.leftarrow:M.entersound=!0,0>--M.help_page&&(M.help_page=M.num_help_pages-1)}},quitMessage:[[" Are you gonna quit"," this game just like"," everything else?",""],[" Milord, methinks that"," thou art a lowly"," quitter. Is this true?",""],[" Do I need to bust your"," face open for trying"," to quit?",""],[" Man, I oughta smack you"," for trying to quit!", " Press Y to get"," smacked out."],[" Press Y to quit like a"," big loser in life."," Press N to stay proud"," and successful!"],[" If you press Y to"," quit, I will summon"," Satan all over your"," hard drive!"],[" Um, Asmodeus dislikes"," his children trying to"," quit. Press Y to return"," to your Tinkertoys."],[" If you quit now, I'll"," throw a blanket-party"," for you next time!",""]],Menu_Quit_f:function(){M.state.value!==M.state.quit&&(M.wasInMenus=Key.dest.value=== Key.dest.menu,Key.dest.value=Key.dest.menu,M.quit_prevstate=M.state.value,M.state.value=M.state.quit,M.entersound=!0,M.msgNumber=Math.floor(Math.random()*M.quitMessage.length))},Quit_Draw:function(){!0===M.wasInMenus&&(M.state.value=M.quit_prevstate,M.recursiveDraw=!0,M.Draw(),M.state.value=M.state.quit);M.DrawTextBox(56,76,24,4);M.Print(64,84,M.quitMessage[M.msgNumber][0]);M.Print(64,92,M.quitMessage[M.msgNumber][1]);M.Print(64,100,M.quitMessage[M.msgNumber][2]);M.Print(64,108,M.quitMessage[M.msgNumber][3])}, Quit_Key:function(a){switch(a){case Key.k.escape:case 110:!0===M.wasInMenus?(M.state.value=M.quit_prevstate,M.entersound=!0):(Key.dest.value=Key.dest.game,M.state.value=M.state.none);break;case 121:Key.dest.value=Key.dest.console,Host.Quit_f()}},Init:function(){Cmd.AddCommand("togglemenu",M.ToggleMenu_f);Cmd.AddCommand("menu_main",M.Menu_Main_f);Cmd.AddCommand("menu_singleplayer",M.Menu_SinglePlayer_f);Cmd.AddCommand("menu_load",M.Menu_Load_f);Cmd.AddCommand("menu_save",M.Menu_Save_f);Cmd.AddCommand("menu_multiplayer", M.Menu_MultiPlayer_f);Cmd.AddCommand("menu_setup",M.Menu_MultiPlayer_f);Cmd.AddCommand("menu_options",M.Menu_Options_f);Cmd.AddCommand("menu_keys",M.Menu_Keys_f);Cmd.AddCommand("help",M.Menu_Help_f);Cmd.AddCommand("menu_quit",M.Menu_Quit_f);M.sfx_menu1=S.PrecacheSound("misc/menu1.wav");M.sfx_menu2=S.PrecacheSound("misc/menu2.wav");M.sfx_menu3=S.PrecacheSound("misc/menu3.wav");M.box_tl=Draw.CachePic("box_tl");M.box_ml=Draw.CachePic("box_ml");M.box_bl=Draw.CachePic("box_bl");M.box_tm=Draw.CachePic("box_tm"); M.box_mm=Draw.CachePic("box_mm");M.box_mm2=Draw.CachePic("box_mm2");M.box_bm=Draw.CachePic("box_bm");M.box_tr=Draw.CachePic("box_tr");M.box_mr=Draw.CachePic("box_mr");M.box_br=Draw.CachePic("box_br");M.qplaque=Draw.CachePic("qplaque");M.menudot=[Draw.CachePic("menudot1"),Draw.CachePic("menudot2"),Draw.CachePic("menudot3"),Draw.CachePic("menudot4"),Draw.CachePic("menudot5"),Draw.CachePic("menudot6")];M.ttl_main=Draw.CachePic("ttl_main");M.mainmenu=Draw.CachePic("mainmenu");M.ttl_sgl=Draw.CachePic("ttl_sgl"); M.sp_menu=Draw.CachePic("sp_menu");M.p_load=Draw.CachePic("p_load");M.p_save=Draw.CachePic("p_save");M.p_multi=Draw.CachePic("p_multi");M.bigbox=Draw.CachePic("bigbox");M.menuplyr=Draw.CachePic("menuplyr");COM.LoadFile("gfx/menuplyr.lmp");var a=GL.ResampleTexture(M.menuplyr.data,M.menuplyr.width,M.menuplyr.height,64,64),b=new Uint8Array(new ArrayBuffer(16384)),c,d;for(c=0;4096>c;++c)d=a[c],1===d>>4?(b[c<<2]=17*(d&15),b[(c<<2)+1]=255):6===d>>4&&(b[(c<<2)+2]=17*(d&15),b[(c<<2)+3]=255);M.menuplyr.translate= gl.createTexture();GL.Bind(0,M.menuplyr.translate);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,64,64,0,gl.RGBA,gl.UNSIGNED_BYTE,b);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);M.p_option=Draw.CachePic("p_option");M.ttl_cstm=Draw.CachePic("ttl_cstm");M.help_pages=[Draw.CachePic("help0"),Draw.CachePic("help1"),Draw.CachePic("help2"),Draw.CachePic("help3"),Draw.CachePic("help4"),Draw.CachePic("help5")]},Draw:function(){if(!(M.state.value=== M.state.none||Key.dest.value!==Key.dest.menu)){!0!==M.recursiveDraw?0!==SCR.con_current?Draw.ConsoleBackground(VID.height):Draw.FadeScreen():M.recursiveDraw=!1;switch(M.state.value){case M.state.main:M.Main_Draw();break;case M.state.singleplayer:M.SinglePlayer_Draw();break;case M.state.load:M.Load_Draw();break;case M.state.save:M.Save_Draw();break;case M.state.multiplayer:M.MultiPlayer_Draw();break;case M.state.options:M.Options_Draw();break;case M.state.keys:M.Keys_Draw();break;case M.state.help:M.Help_Draw(); break;case M.state.quit:M.Quit_Draw()}!0===M.entersound&&(S.LocalSound(M.sfx_menu2),M.entersound=!1)}},Keydown:function(a){switch(M.state.value){case M.state.main:M.Main_Key(a);break;case M.state.singleplayer:M.SinglePlayer_Key(a);break;case M.state.load:M.Load_Key(a);break;case M.state.save:M.Save_Key(a);break;case M.state.multiplayer:M.MultiPlayer_Key(a);break;case M.state.options:M.Options_Key(a);break;case M.state.keys:M.Keys_Key(a);break;case M.state.help:M.Help_Key(a);break;case M.state.quit:M.Quit_Key(a)}}};
var Mod={effects:{brightfield:1,muzzleflash:2,brightlight:4,dimlight:8},type:{brush:0,sprite:1,alias:2},flags:{rocket:1,grenade:2,gib:4,rotate:8,tracer:16,zomgib:32,tracer2:64,tracer3:128},version:{brush:29,sprite:1,alias:6},known:[],Init:function(){Mod.novis=[];var b;for(b=0;1024>b;++b)Mod.novis[b]=255;for(b=Mod.filledcolor=0;255>=b;++b)if(0===(VID.d_8to24table[b]&16777215)){Mod.filledcolor=b;break}},PointInLeaf:function(b,a){null==a&&Sys.Error("Mod.PointInLeaf: bad model");null==a.nodes&&Sys.Error("Mod.PointInLeaf: bad model"); for(var c=a.nodes[0],d;;){if(0>c.contents)return c;d=c.plane.normal;c=0<b[0]*d[0]+b[1]*d[1]+b[2]*d[2]-c.plane.dist?c.children[0]:c.children[1]}},DecompressVis:function(b,a){var c=[],d,e,g=a.leafs.length+7>>3;if(null==a.visdata){for(;0<=g;--g)c[e++]=255;return c}for(e=0;e<g;)if(0!==a.visdata[b])c[e++]=a.visdata[b++];else{for(d=a.visdata[b+1];0<d;--d)c[e++]=0;b+=2}return c},LeafPVS:function(b,a){return b===a.leafs[0]?Mod.novis:Mod.DecompressVis(b.visofs,a)},ClearAll:function(){var b,a;for(b=0;b<Mod.known.length;++b)a= Mod.known[b],a.type===Mod.type.brush&&(null!=a.cmds&&gl.deleteBuffer(a.cmds),Mod.known[b]={name:a.name,needload:!0})},FindName:function(b){0===b.length&&Sys.Error("Mod.FindName: NULL name");var a;for(a=0;a<Mod.known.length;++a)if(null!=Mod.known[a]&&Mod.known[a].name===b)return Mod.known[a];for(a=0;a<=Mod.known.length;++a)if(null==Mod.known[a])return Mod.known[a]={name:b,needload:!0},Mod.known[a]},LoadModel:function(b,a){if(!0!==b.needload)return b;var c=COM.LoadFile(b.name);if(null==c)!0===a&&Sys.Error("Mod.LoadModel: "+ b.name+" not found");else{Mod.loadmodel=b;b.needload=!1;switch((new DataView(c)).getUint32(0,!0)){case 1330660425:Mod.LoadAliasModel(c);break;case 1347634249:Mod.LoadSpriteModel(c);break;default:Mod.LoadBrushModel(c)}return b}},ForName:function(b,a){return Mod.LoadModel(Mod.FindName(b),a)},lump:{entities:0,planes:1,textures:2,vertexes:3,visibility:4,nodes:5,texinfo:6,faces:7,lighting:8,clipnodes:9,leafs:10,marksurfaces:11,edges:12,surfedges:13,models:14,lumps:15},planetype:{x:0,y:1,z:2,anyx:3,anyy:4, anyz:5},contents:{empty:-1,solid:-2,water:-3,slime:-4,lava:-5,sky:-6,origin:-7,clip:-8,current_0:-9,current_90:-10,current_180:-11,current_270:-12,current_up:-13,current_down:-14},LoadTextures:function(b){var a=new DataView(b),c=a.getUint32((Mod.lump.textures<<3)+4,!0);a.getUint32((Mod.lump.textures<<3)+8,!0);Mod.loadmodel.textures=[];var d=a.getUint32(c,!0),e=c+4,g,f,h;for(g=0;g<d;++g)f=a.getInt32(e,!0),e+=4,-1===f?Mod.loadmodel.textures[g]=R.notexture_mip:(f+=c,h={name:Q.memstr(new Uint8Array(b, f,16)),width:a.getUint32(f+16,!0),height:a.getUint32(f+20,!0)},"sky"===h.name.substring(0,3).toLowerCase()?(R.InitSky(new Uint8Array(b,f+a.getUint32(f+24,!0),32768)),h.texturenum=R.solidskytexture,R.skytexturenum=g,h.sky=!0):(f=GL.LoadTexture(h.name,h.width,h.height,new Uint8Array(b,f+a.getUint32(f+24,!0),h.width*h.height)),h.texturenum=f.texnum,42===h.name.charCodeAt(0)&&(h.turbulent=!0)),Mod.loadmodel.textures[g]=h);for(g=0;g<d;++g)if(h=Mod.loadmodel.textures[g],43===h.name.charCodeAt(0)&&48=== h.name.charCodeAt(1)){e=h.name.substring(2);h.anims=[g];h.alternate_anims=[];for(b=0;b<d;++b)a=Mod.loadmodel.textures[b],43===a.name.charCodeAt(0)&&a.name.substring(2)===e&&(c=a.name.charCodeAt(1),48!==c&&(49<=c&&57>=c?(h.anims[c-48]=b,a.anim_base=g,a.anim_frame=c-48):(97<=c&&(c-=32),65<=c&&74>=c?(h.alternate_anims[c-65]=b,a.anim_base=g,a.anim_frame=c-65):Sys.Error("Bad animating texture "+h.name))));for(b=0;b<h.anims.length;++b)null==h.anims[b]&&Sys.Error("Missing frame "+b+" of "+h.name);for(b= 0;b<h.alternate_anims.length;++b)null==h.alternate_anims[b]&&Sys.Error("Missing frame "+b+" of "+h.name);Mod.loadmodel.textures[g]=h}Mod.loadmodel.textures[Mod.loadmodel.textures.length]=R.notexture_mip},LoadLighting:function(b){var a=new DataView(b),c=a.getUint32((Mod.lump.lighting<<3)+4,!0),a=a.getUint32((Mod.lump.lighting<<3)+8,!0);0!==a&&(Mod.loadmodel.lightdata=new Uint8Array(new ArrayBuffer(a)),Mod.loadmodel.lightdata.set(new Uint8Array(b,c,a)))},LoadVisibility:function(b){var a=new DataView(b), c=a.getUint32((Mod.lump.visibility<<3)+4,!0),a=a.getUint32((Mod.lump.visibility<<3)+8,!0);0!==a&&(Mod.loadmodel.visdata=new Uint8Array(new ArrayBuffer(a)),Mod.loadmodel.visdata.set(new Uint8Array(b,c,a)))},LoadEntities:function(b){var a=new DataView(b),c=a.getUint32((Mod.lump.entities<<3)+4,!0),a=a.getUint32((Mod.lump.entities<<3)+8,!0);Mod.loadmodel.entities=Q.memstr(new Uint8Array(b,c,a))},LoadVertexes:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.vertexes<<3)+4,!0),c=b.getUint32((Mod.lump.vertexes<< 3)+8,!0);0!==c%12&&Sys.Error("Mod.LoadVisibility: funny lump size in "+Mod.loadmodel.name);c/=12;Mod.loadmodel.vertexes=[];var d;for(d=0;d<c;++d)Mod.loadmodel.vertexes[d]=[b.getFloat32(a,!0),b.getFloat32(a+4,!0),b.getFloat32(a+8,!0)],a+=12},LoadSubmodels:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.models<<3)+4,!0),c=b.getUint32((Mod.lump.models<<3)+8,!0)>>6;0===c&&Sys.Error("Mod.LoadSubmodels: funny lump size in "+Mod.loadmodel.name);Mod.loadmodel.submodels=[];Mod.loadmodel.mins=[b.getFloat32(a, !0)-1,b.getFloat32(a+4,!0)-1,b.getFloat32(a+8,!0)-1];Mod.loadmodel.maxs=[b.getFloat32(a+12,!0)+1,b.getFloat32(a+16,!0)+1,b.getFloat32(a+20,!0)+1];Mod.loadmodel.hulls[0].firstclipnode=b.getUint32(a+36,!0);Mod.loadmodel.hulls[1].firstclipnode=b.getUint32(a+40,!0);Mod.loadmodel.hulls[2].firstclipnode=b.getUint32(a+44,!0);var a=a+64,d,e=Mod.loadmodel.hulls[0].clipnodes,g;for(d=1;d<c;++d)g=Mod.FindName("*"+d),g.needload=!1,g.type=Mod.type.brush,g.submodel=!0,g.mins=[b.getFloat32(a,!0)-1,b.getFloat32(a+ 4,!0)-1,b.getFloat32(a+8,!0)-1],g.maxs=[b.getFloat32(a+12,!0)+1,b.getFloat32(a+16,!0)+1,b.getFloat32(a+20,!0)+1],g.origin=[b.getFloat32(a+24,!0),b.getFloat32(a+28,!0),b.getFloat32(a+32,!0)],g.headnode=[b.getUint32(a+36,!0),b.getUint32(a+40,!0),b.getUint32(a+44,!0)],g.hulls=[{clipnodes:e,firstclipnode:g.headnode[0],lastclipnode:Mod.loadmodel.nodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[0,0,0],clip_maxs:[0,0,0]},{clipnodes:Mod.loadmodel.clipnodes,firstclipnode:g.headnode[1],lastclipnode:Mod.loadmodel.clipnodes.length- 1,planes:Mod.loadmodel.planes,clip_mins:[-16,-16,-24],clip_maxs:[16,16,32]},{clipnodes:Mod.loadmodel.clipnodes,firstclipnode:g.headnode[2],lastclipnode:Mod.loadmodel.clipnodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[-32,-32,-24],clip_maxs:[32,32,64]}],g.textures=Mod.loadmodel.textures,g.lightdata=Mod.loadmodel.lightdata,g.faces=Mod.loadmodel.faces,g.firstface=b.getUint32(a+56,!0),g.numfaces=b.getUint32(a+60,!0),Mod.loadmodel.submodels[d-1]=g,a+=64},LoadEdges:function(b){b=new DataView(b); var a=b.getUint32((Mod.lump.edges<<3)+4,!0),c=b.getUint32((Mod.lump.edges<<3)+8,!0);0!==(c&3)&&Sys.Error("Mod.LoadEdges: funny lump size in "+Mod.loadmodel.name);c>>=2;Mod.loadmodel.edges=[];var d;for(d=0;d<c;++d)Mod.loadmodel.edges[d]=[b.getUint16(a,!0),b.getUint16(a+2,!0)],a+=4},LoadTexinfo:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.texinfo<<3)+4,!0),c=b.getUint32((Mod.lump.texinfo<<3)+8,!0);0!==c%40&&Sys.Error("Mod.LoadTexinfo: funny lump size in "+Mod.loadmodel.name);c/=40;Mod.loadmodel.texinfo= [];var d,e;for(d=0;d<c;++d)e={vecs:[[b.getFloat32(a,!0),b.getFloat32(a+4,!0),b.getFloat32(a+8,!0),b.getFloat32(a+12,!0)],[b.getFloat32(a+16,!0),b.getFloat32(a+20,!0),b.getFloat32(a+24,!0),b.getFloat32(a+28,!0)]],texture:b.getUint32(a+32,!0),flags:b.getUint32(a+36,!0)},e.texture>=Mod.loadmodel.textures.length&&(e.texture=Mod.loadmodel.textures.length-1,e.flags=0),Mod.loadmodel.texinfo[d]=e,a+=40},LoadFaces:function(b){var a=new DataView(b),c=a.getUint32((Mod.lump.faces<<3)+4,!0),d=a.getUint32((Mod.lump.faces<< 3)+8,!0);0!==d%20&&Sys.Error("Mod.LoadFaces: funny lump size in "+Mod.loadmodel.name);d/=20;Mod.loadmodel.firstface=0;Mod.loadmodel.numfaces=d;Mod.loadmodel.faces=[];var e,g,f,h,j,l,m,k;for(e=0;e<d;++e){g=new Uint8Array(b,c+12,4);f={plane:Mod.loadmodel.planes[a.getUint16(c,!0)],firstedge:a.getUint16(c+4,!0),numedges:a.getUint16(c+8,!0),texinfo:a.getUint16(c+10,!0),styles:[],lightofs:a.getInt32(c+16,!0),planeback:0!==a.getUint16(c+2,!0)};255!==g[0]&&(f.styles[0]=g[0]);255!==g[1]&&(f.styles[1]=g[1]); 255!==g[2]&&(f.styles[2]=g[2]);255!==g[3]&&(f.styles[3]=g[3]);g=[999999,999999];h=[-99999,-99999];m=Mod.loadmodel.texinfo[f.texinfo];f.texture=m.texture;for(j=0;j<f.numedges;++j)l=Mod.loadmodel.surfedges[f.firstedge+j],l=0<=l?Mod.loadmodel.vertexes[Mod.loadmodel.edges[l][0]]:Mod.loadmodel.vertexes[Mod.loadmodel.edges[-l][1]],k=Vec.DotProduct(l,m.vecs[0])+m.vecs[0][3],k<g[0]&&(g[0]=k),k>h[0]&&(h[0]=k),k=Vec.DotProduct(l,m.vecs[1])+m.vecs[1][3],k<g[1]&&(g[1]=k),k>h[1]&&(h[1]=k);f.texturemins=[16*Math.floor(g[0]/ 16),16*Math.floor(g[1]/16)];f.extents=[16*Math.ceil(h[0]/16)-f.texturemins[0],16*Math.ceil(h[1]/16)-f.texturemins[1]];!0===Mod.loadmodel.textures[m.texture].turbulent?f.turbulent=!0:!0===Mod.loadmodel.textures[m.texture].sky&&(f.sky=!0);Mod.loadmodel.faces[e]=f;c+=20}},SetParent:function(b,a){b.parent=a;0>b.contents||(Mod.SetParent(b.children[0],b),Mod.SetParent(b.children[1],b))},LoadNodes:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.nodes<<3)+4,!0),c=b.getUint32((Mod.lump.nodes<<3)+ 8,!0);(0===c||0!==c%24)&&Sys.Error("Mod.LoadNodes: funny lump size in "+Mod.loadmodel.name);c/=24;Mod.loadmodel.nodes=[];var d;for(d=0;d<c;++d)Mod.loadmodel.nodes[d]={num:d,contents:0,planenum:b.getUint32(a,!0),children:[b.getInt16(a+4,!0),b.getInt16(a+6,!0)],mins:[b.getInt16(a+8,!0),b.getInt16(a+10,!0),b.getInt16(a+12,!0)],maxs:[b.getInt16(a+14,!0),b.getInt16(a+16,!0),b.getInt16(a+18,!0)],firstface:b.getUint16(a+20,!0),numfaces:b.getUint16(a+22,!0),cmds:[]},a+=24;for(d=0;d<c;++d)b=Mod.loadmodel.nodes[d], b.plane=Mod.loadmodel.planes[b.planenum],b.children[0]=0<=b.children[0]?Mod.loadmodel.nodes[b.children[0]]:Mod.loadmodel.leafs[-1-b.children[0]],b.children[1]=0<=b.children[1]?Mod.loadmodel.nodes[b.children[1]]:Mod.loadmodel.leafs[-1-b.children[1]];Mod.SetParent(Mod.loadmodel.nodes[0])},LoadLeafs:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.leafs<<3)+4,!0),c=b.getUint32((Mod.lump.leafs<<3)+8,!0);0!==c%28&&Sys.Error("Mod.LoadLeafs: funny lump size in "+Mod.loadmodel.name);c/=28;Mod.loadmodel.leafs= [];var d,e,g;for(d=0;d<c;++d){g={num:d,contents:b.getInt32(a,!0),visofs:b.getInt32(a+4,!0),mins:[b.getInt16(a+8,!0),b.getInt16(a+10,!0),b.getInt16(a+12,!0)],maxs:[b.getInt16(a+14,!0),b.getInt16(a+16,!0),b.getInt16(a+18,!0)],firstmarksurface:b.getUint16(a+20,!0),nummarksurfaces:b.getUint16(a+22,!0),ambient_level:[b.getUint8(a+24),b.getUint8(a+25),b.getUint8(a+26),b.getUint8(a+27)],cmds:[],waterchain:0};for(e=0;e<g.nummarksurfaces;++e)if(!0===Mod.loadmodel.faces[Mod.loadmodel.marksurfaces[g.firstmarksurface+ e]].sky){g.drawsky=!0;break}Mod.loadmodel.leafs[d]=g;a+=28}},LoadClipnodes:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.clipnodes<<3)+4,!0),c=b.getUint32((Mod.lump.clipnodes<<3)+8,!0)>>3;Mod.loadmodel.clipnodes=[];Mod.loadmodel.hulls=[];Mod.loadmodel.hulls[1]={clipnodes:Mod.loadmodel.clipnodes,firstclipnode:0,lastclipnode:c-1,planes:Mod.loadmodel.planes,clip_mins:[-16,-16,-24],clip_maxs:[16,16,32]};Mod.loadmodel.hulls[2]={clipnodes:Mod.loadmodel.clipnodes,firstclipnode:0,lastclipnode:c- 1,planes:Mod.loadmodel.planes,clip_mins:[-32,-32,-24],clip_maxs:[32,32,64]};var d;for(d=0;d<c;++d)Mod.loadmodel.clipnodes[d]={planenum:b.getUint32(a,!0),children:[b.getInt16(a+4,!0),b.getInt16(a+6,!0)]},a+=8},MakeHull0:function(){var b,a,c=[],d,e,g={clipnodes:c,lastclipnode:Mod.loadmodel.nodes.length-1,planes:Mod.loadmodel.planes,clip_mins:[0,0,0],clip_maxs:[0,0,0]};for(d=0;d<Mod.loadmodel.nodes.length;++d)b=Mod.loadmodel.nodes[d],e={planenum:b.planenum,children:[]},a=b.children[0],e.children[0]= 0>a.contents?a.contents:a.num,a=b.children[1],e.children[1]=0>a.contents?a.contents:a.num,c[d]=e;Mod.loadmodel.hulls[0]=g},LoadMarksurfaces:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.marksurfaces<<3)+4,!0),c=b.getUint32((Mod.lump.marksurfaces<<3)+8,!0)>>1;Mod.loadmodel.marksurfaces=[];var d,e;for(d=0;d<c;++d)e=b.getUint16(a+(d<<1),!0),e>Mod.loadmodel.faces.length&&Sys.Error("Mod.LoadMarksurfaces: bad surface number"),Mod.loadmodel.marksurfaces[d]=e},LoadSurfedges:function(b){b=new DataView(b); var a=b.getUint32((Mod.lump.surfedges<<3)+4,!0),c=b.getUint32((Mod.lump.surfedges<<3)+8,!0)>>2;Mod.loadmodel.surfedges=[];var d;for(d=0;d<c;++d)Mod.loadmodel.surfedges[d]=b.getInt32(a+(d<<2),!0)},LoadPlanes:function(b){b=new DataView(b);var a=b.getUint32((Mod.lump.planes<<3)+4,!0),c=b.getUint32((Mod.lump.planes<<3)+8,!0);0!==c%20&&Sys.Error("Mod.LoadPlanes: funny lump size in "+Mod.loadmodel.name);c/=20;Mod.loadmodel.planes=[];var d,e;for(d=0;d<c;++d)e={normal:[b.getFloat32(a,!0),b.getFloat32(a+4, !0),b.getFloat32(a+8,!0)],dist:b.getFloat32(a+12,!0),type:b.getUint32(a+16,!0),signbits:0},0>e.normal[0]&&++e.signbits,0>e.normal[1]&&(e.signbits+=2),0>e.normal[2]&&(e.signbits+=4),Mod.loadmodel.planes[d]=e,a+=20},LoadBrushModel:function(b){Mod.loadmodel.type=Mod.type.brush;var a=(new DataView(b)).getUint32(0,!0);a!==Mod.version.brush&&Sys.Error("Mod.LoadBrushModel: "+Mod.loadmodel.name+" has wrong version number ("+a+" should be "+Mod.version.brush+")");Mod.LoadVertexes(b);Mod.LoadEdges(b);Mod.LoadSurfedges(b); Mod.LoadTextures(b);Mod.LoadLighting(b);Mod.LoadPlanes(b);Mod.LoadTexinfo(b);Mod.LoadFaces(b);Mod.LoadMarksurfaces(b);Mod.LoadVisibility(b);Mod.LoadLeafs(b);Mod.LoadNodes(b);Mod.LoadClipnodes(b);Mod.MakeHull0();Mod.LoadEntities(b);Mod.LoadSubmodels(b);var c=[0,0,0],d=[0,0,0];for(b=0;b<Mod.loadmodel.vertexes.length;++b)a=Mod.loadmodel.vertexes[b],a[0]<c[0]?c[0]=a[0]:a[0]>d[0]&&(d[0]=a[0]),a[1]<c[1]?c[1]=a[1]:a[1]>d[1]&&(d[1]=a[1]),a[2]<c[2]?c[2]=a[2]:a[2]>d[2]&&(d[2]=a[2]);Mod.loadmodel.radius=Vec.Length([Math.abs(c[0])> Math.abs(d[0])?Math.abs(c[0]):Math.abs(d[0]),Math.abs(c[1])>Math.abs(d[1])?Math.abs(c[1]):Math.abs(d[1]),Math.abs(c[2])>Math.abs(d[2])?Math.abs(c[2]):Math.abs(d[2])])},TranslatePlayerSkin:function(b,a){if(512!==Mod.loadmodel.skinwidth||256!==Mod.loadmodel.skinheight)b=GL.ResampleTexture(b,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight,512,256);var c=new Uint8Array(new ArrayBuffer(524288)),d,e;for(d=0;131072>d;++d)e=b[d],1===e>>4?(c[d<<2]=17*(e&15),c[(d<<2)+1]=255):6===e>>4&&(c[(d<<2)+2]=17*(e&15), c[(d<<2)+3]=255);a.playertexture=gl.createTexture();GL.Bind(0,a.playertexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,512,256,0,gl.RGBA,gl.UNSIGNED_BYTE,c);gl.generateMipmap(gl.TEXTURE_2D);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max)},FloodFillSkin:function(b){var a=b[0];if(a!==Mod.filledcolor){var c=Mod.loadmodel.skinwidth,d=Mod.loadmodel.skinheight,e=[[0,0]],g,f,h;for(g=1;0<g;)f=e[--g],h=f[0],f=f[1],b[f*c+ h]=Mod.filledcolor,0<h&&b[f*c+h-1]===a&&(e[g++]=[h-1,f]),h<c-1&&b[f*c+h+1]===a&&(e[g++]=[h+1,f]),0<f&&b[(f-1)*c+h]===a&&(e[g++]=[h,f-1]),f<d-1&&b[(f+1)*c+h]===a&&(e[g++]=[h,f+1])}},LoadAllSkins:function(b,a){Mod.loadmodel.skins=[];var c=new DataView(b),d,e,g,f,h=Mod.loadmodel.skinwidth*Mod.loadmodel.skinheight,j;for(d=0;d<Mod.loadmodel.numskins;++d)if(a+=4,0===c.getUint32(a-4,!0))j=new Uint8Array(b,a,h),Mod.FloodFillSkin(j),Mod.loadmodel.skins[d]={group:!1,texturenum:GL.LoadTexture(Mod.loadmodel.name+ "_"+d,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight,j)},!0===Mod.loadmodel.player&&Mod.TranslatePlayerSkin(new Uint8Array(b,a,h),Mod.loadmodel.skins[d]),a+=h;else{g={group:!0,skins:[]};f=c.getUint32(a,!0);a+=4;for(e=0;e<f;++e)g.skins[e]={interval:c.getFloat32(a,!0)},0>=g.skins[e].interval&&Sys.Error("Mod.LoadAllSkins: interval<=0"),a+=4;for(e=0;e<f;++e)j=new Uint8Array(b,a,h),Mod.FloodFillSkin(j),g.skins[e].texturenum=GL.LoadTexture(Mod.loadmodel.name+"_"+d+"_"+e,Mod.loadmodel.skinwidth,Mod.loadmodel.skinheight, j),!0===Mod.loadmodel.player&&Mod.TranslatePlayerSkin(new Uint8Array(b,a,h),g.skins[e]),a+=h;Mod.loadmodel.skins[d]=g}return a},LoadAllFrames:function(b,a){Mod.loadmodel.frames=[];var c=new DataView(b),d,e,g,f,h,j;for(d=0;d<Mod.loadmodel.numframes;++d)if(a+=4,0===c.getUint32(a-4,!0)){f={group:!1,bboxmin:[c.getUint8(a),c.getUint8(a+1),c.getUint8(a+2)],bboxmax:[c.getUint8(a+4),c.getUint8(a+5),c.getUint8(a+6)],name:Q.memstr(new Uint8Array(b,a+8,16)),v:[]};a+=24;for(e=0;e<Mod.loadmodel.numverts;++e)f.v[e]= {v:[c.getUint8(a),c.getUint8(a+1),c.getUint8(a+2)],lightnormalindex:c.getUint8(a+3)},a+=4;Mod.loadmodel.frames[d]=f}else{h={group:!0,bboxmin:[c.getUint8(a+4),c.getUint8(a+5),c.getUint8(a+6)],bboxmax:[c.getUint8(a+8),c.getUint8(a+9),c.getUint8(a+10)],frames:[]};j=c.getUint32(a,!0);a+=12;for(e=0;e<j;++e)h.frames[e]={interval:c.getFloat32(a,!0)},0>=h.frames[e].interval&&Sys.Error("Mod.LoadAllFrames: interval<=0"),a+=4;for(e=0;e<j;++e){f=h.frames[e];f.bboxmin=[c.getUint8(a),c.getUint8(a+1),c.getUint8(a+ 2)];f.bboxmax=[c.getUint8(a+4),c.getUint8(a+5),c.getUint8(a+6)];f.name=Q.memstr(new Uint8Array(b,a+8,16));f.v=[];a+=24;for(g=0;g<Mod.loadmodel.numverts;++g)f.v[g]={v:[c.getUint8(a),c.getUint8(a+1),c.getUint8(a+2)],lightnormalindex:c.getUint8(a+3)},a+=4}Mod.loadmodel.frames[d]=h}},LoadAliasModel:function(b){var a,c,d;Mod.loadmodel.type=Mod.type.alias;Mod.loadmodel.player="progs/player.mdl"===Mod.loadmodel.name;c=new DataView(b);a=c.getUint32(4,!0);a!==Mod.version.alias&&Sys.Error(Mod.loadmodel.name+ " has wrong version number ("+a+" should be "+Mod.version.alias+")");Mod.loadmodel.scale=[c.getFloat32(8,!0),c.getFloat32(12,!0),c.getFloat32(16,!0)];Mod.loadmodel.scale_origin=[c.getFloat32(20,!0),c.getFloat32(24,!0),c.getFloat32(28,!0)];Mod.loadmodel.boundingradius=c.getFloat32(32,!0);Mod.loadmodel.numskins=c.getUint32(48,!0);0===Mod.loadmodel.numskins&&Sys.Error("model "+Mod.loadmodel.name+" has no skins");Mod.loadmodel.skinwidth=c.getUint32(52,!0);Mod.loadmodel.skinheight=c.getUint32(56,!0);Mod.loadmodel.numverts= c.getUint32(60,!0);0===Mod.loadmodel.numverts&&Sys.Error("model "+Mod.loadmodel.name+" has no vertices");Mod.loadmodel.numtris=c.getUint32(64,!0);0===Mod.loadmodel.numtris&&Sys.Error("model "+Mod.loadmodel.name+" has no triangles");Mod.loadmodel.numframes=c.getUint32(68,!0);0===Mod.loadmodel.numframes&&Sys.Error("model "+Mod.loadmodel.name+" has no frames");Mod.loadmodel.random=1===c.getUint32(72,!0);Mod.loadmodel.flags=c.getUint32(76,!0);Mod.loadmodel.mins=[-16,-16,-16];Mod.loadmodel.maxs=[16,16, 16];d=Mod.LoadAllSkins(b,84);Mod.loadmodel.stverts=[];for(a=0;a<Mod.loadmodel.numverts;++a)Mod.loadmodel.stverts[a]={onseam:0!==c.getUint32(d,!0),s:c.getUint32(d+4,!0),t:c.getUint32(d+8,!0)},d+=12;Mod.loadmodel.triangles=[];for(a=0;a<Mod.loadmodel.numtris;++a)Mod.loadmodel.triangles[a]={facesfront:0!==c.getUint32(d,!0),vertindex:[c.getUint32(d+4,!0),c.getUint32(d+8,!0),c.getUint32(d+12,!0)]},d+=16;Mod.LoadAllFrames(b,d);var e=[],g,f;for(a=0;a<Mod.loadmodel.numtris;++a)if(g=Mod.loadmodel.triangles[a], !0===g.facesfront)f=Mod.loadmodel.stverts[g.vertindex[0]],e[e.length]=(f.s+0.5)/Mod.loadmodel.skinwidth,e[e.length]=(f.t+0.5)/Mod.loadmodel.skinheight,f=Mod.loadmodel.stverts[g.vertindex[1]],e[e.length]=(f.s+0.5)/Mod.loadmodel.skinwidth,e[e.length]=(f.t+0.5)/Mod.loadmodel.skinheight,f=Mod.loadmodel.stverts[g.vertindex[2]],e[e.length]=(f.s+0.5)/Mod.loadmodel.skinwidth,e[e.length]=(f.t+0.5)/Mod.loadmodel.skinheight;else for(b=0;3>b;++b)f=Mod.loadmodel.stverts[g.vertindex[b]],e[e.length]=!0===f.onseam? (f.s+Mod.loadmodel.skinwidth/2+0.5)/Mod.loadmodel.skinwidth:(f.s+0.5)/Mod.loadmodel.skinwidth,e[e.length]=(f.t+0.5)/Mod.loadmodel.skinheight;var h,j;for(a=0;a<Mod.loadmodel.numframes;++a)if(h=Mod.loadmodel.frames[a],!0===h.group)for(b=0;b<h.frames.length;++b){j=h.frames[b];j.cmdofs=e.length<<2;for(c=0;c<Mod.loadmodel.numtris;++c){g=Mod.loadmodel.triangles[c];for(d=0;3>d;++d)f=j.v[g.vertindex[d]],162<=f.lightnormalindex&&Sys.Error("lightnormalindex >= NUMVERTEXNORMALS"),e[e.length]=f.v[0]*Mod.loadmodel.scale[0]+ Mod.loadmodel.scale_origin[0],e[e.length]=f.v[1]*Mod.loadmodel.scale[1]+Mod.loadmodel.scale_origin[1],e[e.length]=f.v[2]*Mod.loadmodel.scale[2]+Mod.loadmodel.scale_origin[2],e[e.length]=R.avertexnormals[f.lightnormalindex][0],e[e.length]=R.avertexnormals[f.lightnormalindex][1],e[e.length]=R.avertexnormals[f.lightnormalindex][2]}}else{j=h;j.cmdofs=e.length<<2;for(b=0;b<Mod.loadmodel.numtris;++b){g=Mod.loadmodel.triangles[b];for(c=0;3>c;++c)f=j.v[g.vertindex[c]],162<=f.lightnormalindex&&Sys.Error("lightnormalindex >= NUMVERTEXNORMALS"), e[e.length]=f.v[0]*Mod.loadmodel.scale[0]+Mod.loadmodel.scale_origin[0],e[e.length]=f.v[1]*Mod.loadmodel.scale[1]+Mod.loadmodel.scale_origin[1],e[e.length]=f.v[2]*Mod.loadmodel.scale[2]+Mod.loadmodel.scale_origin[2],e[e.length]=R.avertexnormals[f.lightnormalindex][0],e[e.length]=R.avertexnormals[f.lightnormalindex][1],e[e.length]=R.avertexnormals[f.lightnormalindex][2]}}Mod.loadmodel.cmds=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,Mod.loadmodel.cmds);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e), gl.STATIC_DRAW)},LoadSpriteFrame:function(b,a,c,d){var e;e=new DataView(a);d.origin=[e.getInt32(c,!0),-e.getInt32(c+4,!0)];d.width=e.getUint32(c+8,!0);d.height=e.getUint32(c+12,!0);var g=d.width*d.height,f;for(e=0;e<GL.textures.length;++e)if(f=GL.textures[e],f.identifier===b)return(width!==f.width||height!==f.height)&&Sys.Error("Mod.LoadSpriteFrame: cache mismatch"),d.texturenum=f.texnum,c+16+d.width*d.height;f=new Uint8Array(a,c+16,g);a=d.width;var h=d.height;if(0!==(d.width&d.width-1)||0!==(d.height& d.height-1))--a,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,++a,--h,h|=h>>1,h|=h>>2,h|=h>>4,h|=h>>8,h|=h>>16,++h;1024<a&&(a=1024);1024<h&&(h=1024);if(a!==d.width||h!==d.height)g=a*h,f=GL.ResampleTexture(f,d.width,d.height,a,h);var j=new ArrayBuffer(g<<2),l=new Uint32Array(j);for(e=0;e<g;++e)255!==f[e]&&(l[e]=Q.LittleULong(VID.d_8to24table[f[e]]));f={texnum:gl.createTexture(),identifier:b,width:d.width,height:d.height};GL.Bind(0,f.texnum);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,h,0,gl.RGBA,gl.UNSIGNED_BYTE, new Uint8Array(j));gl.generateMipmap(gl.TEXTURE_2D);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,GL.filter_min);gl.texParameterf(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,GL.filter_max);GL.textures[GL.textures.length]=f;d.texturenum=f.texnum;return c+16+d.width*d.height},LoadSpriteModel:function(b){var a;Mod.loadmodel.type=Mod.type.sprite;var c=new DataView(b);a=c.getUint32(4,!0);a!==Mod.version.sprite&&Sys.Error(Mod.loadmodel.name+" has wrong version number ("+a+" should be "+Mod.version.sprite+ ")");Mod.loadmodel.oriented=3===c.getUint32(8,!0);Mod.loadmodel.boundingradius=c.getFloat32(12,!0);Mod.loadmodel.width=c.getUint32(16,!0);Mod.loadmodel.height=c.getUint32(20,!0);Mod.loadmodel.numframes=c.getUint32(24,!0);0===Mod.loadmodel.numframes&&Sys.Error("model "+Mod.loadmodel.name+" has no frames");Mod.loadmodel.random=1===c.getUint32(32,!0);Mod.loadmodel.mins=[-0.5*Mod.loadmodel.width,-0.5*Mod.loadmodel.width,-0.5*Mod.loadmodel.height];Mod.loadmodel.maxs=[0.5*Mod.loadmodel.width,0.5*Mod.loadmodel.width, 0.5*Mod.loadmodel.height];Mod.loadmodel.frames=[];var d=36,e,g,f;for(e=0;e<Mod.loadmodel.numframes;++e)if(d+=4,0===c.getUint32(d-4,!0))Mod.loadmodel.frames[e]={group:!1},d=Mod.LoadSpriteFrame(Mod.loadmodel.name+"_"+e+"_"+g,b,d,Mod.loadmodel.frames[e]);else{a=[];f=c.getUint32(d,!0);d+=4;for(g=0;g<f;++g)a[g]={interval:mod.getFloat32(d,!0)},0>=a[g].interval&&Sys.Error("Mod.LoadSpriteModel: interval<=0"),d+=4;for(g=0;g<f;++g)d=Mod.LoadSpriteFrame(Mod.loadmodel.name+"_"+e+"_"+g,b,d,void 0)}},Print:function(){Con.Print("Cached models:\n"); var b;for(b=0;b<Mod.known.length;++b)Con.Print(Mod.known[b].name+"\n")}};
var MSG={WriteChar:function(a,b){(new DataView(a.data)).setInt8(SZ.GetSpace(a,1),b)},WriteByte:function(a,b){(new DataView(a.data)).setUint8(SZ.GetSpace(a,1),b)},WriteShort:function(a,b){(new DataView(a.data)).setInt16(SZ.GetSpace(a,2),b,!0)},WriteLong:function(a,b){(new DataView(a.data)).setInt32(SZ.GetSpace(a,4),b,!0)},WriteFloat:function(a,b){(new DataView(a.data)).setFloat32(SZ.GetSpace(a,4),b,!0)},WriteString:function(a,b){null!=b&&SZ.Write(a,new Uint8Array(Q.strmem(b)),b.length);MSG.WriteChar(a, 0)},WriteCoord:function(a,b){MSG.WriteShort(a,8*b)},WriteAngle:function(a,b){MSG.WriteByte(a,(b>>0)*(256/360)&255)},BeginReading:function(){MSG.readcount=0;MSG.badread=!1},ReadChar:function(){if(MSG.readcount>=NET.message.cursize)return MSG.badread=!0,-1;var a=(new Int8Array(NET.message.data,MSG.readcount,1))[0];++MSG.readcount;return a},ReadByte:function(){if(MSG.readcount>=NET.message.cursize)return MSG.badread=!0,-1;var a=(new Uint8Array(NET.message.data,MSG.readcount,1))[0];++MSG.readcount;return a}, ReadShort:function(){if(MSG.readcount+2>NET.message.cursize)return MSG.badread=!0,-1;var a=(new DataView(NET.message.data)).getInt16(MSG.readcount,!0);MSG.readcount+=2;return a},ReadLong:function(){if(MSG.readcount+4>NET.message.cursize)return MSG.badread=!0,-1;var a=(new DataView(NET.message.data)).getInt32(MSG.readcount,!0);MSG.readcount+=4;return a},ReadFloat:function(){if(MSG.readcount+4>NET.message.cursize)return MSG.badread=!0,-1;var a=(new DataView(NET.message.data)).getFloat32(MSG.readcount, !0);MSG.readcount+=4;return a},ReadString:function(){var a=[],b,c;for(b=0;2048>b;++b){c=MSG.ReadByte();if(0>=c)break;a[b]=String.fromCharCode(c)}return a.join("")},ReadCoord:function(){return 0.125*MSG.ReadShort()},ReadAngle:function(){return 1.40625*MSG.ReadChar()}};
var NET={activeSockets:[]};NET.message={data:new ArrayBuffer(8192),cursize:0};NET.activeconnections=0;NET.NewQSocket=function(){var a;for(a=0;a<NET.activeSockets.length&&!0!==NET.activeSockets[a].disconnected;++a);NET.activeSockets[a]={connecttime:NET.time,lastMessageTime:NET.time,driver:NET.driverlevel,sendMessageLength:0,sendMessage:new Uint8Array(new ArrayBuffer(8192)),receiveMessageLength:0,receiveMessage:new Uint8Array(new ArrayBuffer(8192)),address:"UNSET ADDRESS"};return NET.activeSockets[a]}; NET.Connect=function(a){NET.time=Sys.FloatTime();if("local"===a)return NET.driverlevel=0,Loop.Connect(a);var b;for(NET.driverlevel=1;NET.driverlevel<NET.drivers.length;++NET.driverlevel)if(b=NET.drivers[NET.driverlevel],!0===b.initialized){b=b.Connect(a);if(0===b)throw CL.cls.state=CL.active.connecting,"NET.Connect";if(null!=b)return b}}; NET.CheckNewConnections=function(){NET.time=Sys.FloatTime();var a;for(NET.driverlevel=0;NET.driverlevel<NET.drivers.length;++NET.driverlevel)if(a=NET.drivers[NET.driverlevel],!0===a.initialized&&(a=a.CheckNewConnections(),null!=a))return a};NET.Close=function(a){null!=a&&!0!==a.disconnected&&(NET.time=Sys.FloatTime(),NET.drivers[a.driver].Close(a),a.disconnected=!0)}; NET.GetMessage=function(a){if(null==a)return-1;if(!0===a.disconnected)return Con.Print("NET.GetMessage: disconnected socket\n"),-1;NET.time=Sys.FloatTime();var b=NET.drivers[a.driver].GetMessage(a);return 0===b&&0!==a.driver&&NET.time-a.lastMessageTime>NET.messagetimeout.value?(NET.Close(a),-1):b}; NET.SendMessage=function(a,b){if(null==a)return-1;if(!0===a.disconnected)return Con.Print("NET.SendMessage: disconnected socket\n"),-1;NET.time=Sys.FloatTime();return NET.drivers[a.driver].SendMessage(a,b)};NET.SendUnreliableMessage=function(a,b){if(null==a)return-1;if(!0===a.disconnected)return Con.Print("NET.SendUnreliableMessage: disconnected socket\n"),-1;NET.time=Sys.FloatTime();return NET.drivers[a.driver].SendUnreliableMessage(a,b)}; NET.CanSendMessage=function(a){if(null!=a&&!0!==a.disconnected)return NET.time=Sys.FloatTime(),NET.drivers[a.driver].CanSendMessage(a)}; NET.SendToAll=function(a){var b,c=0,d=[],e=[];for(b=0;b<SV.svs.maxclients;++b)Host.client=SV.svs.clients[b],null!=Host.client.netconnection&&(!0!==Host.client.active?d[b]=e[b]=!0:0===Host.client.netconnection.driver?(NET.SendMessage(Host.client.netconnection,a),d[b]=e[b]=!0):(++c,d[b]=e[b]=!1));for(var f=Sys.FloatTime();0!==c;){for(b=c=0;b<SV.svs.maxclients;++b)Host.client=SV.svs.clients[b],!0!==d[b]?(!0===NET.CanSendMessage(Host.client.netconnection)?(d[b]=!0,NET.SendMessage(Host.client.netconnection, a)):NET.GetMessage(Host.client.netconnection),++c):!0!==e[b]&&(!0===NET.CanSendMessage(Host.client.netconnection)?e[b]=!0:NET.GetMessage(Host.client.netconnection),++c);if(5<Sys.FloatTime()-f)break}return c}; NET.Init=function(){NET.time=Sys.FloatTime();NET.messagetimeout=Cvar.RegisterVariable("net_messagetimeout","300");NET.hostname=Cvar.RegisterVariable("hostname","UNNAMED");NET.drivers=[Loop];for(NET.driverlevel=0;NET.driverlevel<NET.drivers.length;++NET.driverlevel)NET.drivers[NET.driverlevel].initialized=NET.drivers[NET.driverlevel].Init()};
var Loop={Init:function(){return!0},Connect:function(a){if("local"===a)return Loop.localconnectpending=!0,null==Loop.client&&(Loop.client=NET.NewQSocket(),Loop.client.address="localhost"),Loop.client.receiveMessageLength=0,Loop.client.sendMessageLength=0,Loop.client.canSend=!0,null==Loop.server&&(Loop.server=NET.NewQSocket(),Loop.server.address="LOCAL"),Loop.server.receiveMessageLength=0,Loop.server.sendMessageLength=0,Loop.server.canSend=!0,Loop.client.driverdata=Loop.server,Loop.server.driverdata= Loop.client},CheckNewConnections:function(){if(!0===Loop.localconnectpending)return Loop.localconnectpending=!1,Loop.server.sendMessageLength=0,Loop.server.receiveMessageLength=0,Loop.server.canSend=!0,Loop.client.sendMessageLength=0,Loop.client.receiveMessageLength=0,Loop.client.canSend=!0,Loop.server},GetMessage:function(a){if(0===a.receiveMessageLength)return 0;var c=a.receiveMessage[0],b=a.receiveMessage[1]+(a.receiveMessage[2]<<8);b>NET.message.data.byteLength&&Sys.Error("Loop.GetMessage: overflow"); NET.message.cursize=b;var d=new Uint8Array(NET.message.data),e;for(e=0;e<b;++e)d[e]=a.receiveMessage[e+3];a.receiveMessageLength-=b;if(4<=a.receiveMessageLength)for(e=0;e<a.receiveMessageLength;++e)a.receiveMessage[e]=a.receiveMessage[b+3+e];a.receiveMessageLength-=3;null!=a.driverdata&&1===c&&(a.driverdata.canSend=!0);return c},SendMessage:function(a,c){if(null==a.driverdata)return-1;var b=a.driverdata.receiveMessageLength;a.driverdata.receiveMessageLength+=c.cursize+3;8192<a.driverdata.receiveMessageLength&& Sys.Error("Loop.SendMessage: overflow");var d=a.driverdata.receiveMessage;d[b]=1;d[b+1]=c.cursize&255;d[b+2]=c.cursize>>8;d.set(new Uint8Array(c.data,0,c.cursize),b+3);a.canSend=!1;return 1},SendUnreliableMessage:function(a,c){if(null==a.driverdata)return-1;var b=a.driverdata.receiveMessageLength;a.driverdata.receiveMessageLength+=c.cursize+3;8192<a.driverdata.receiveMessageLength&&Sys.Error("Loop.SendMessage: overflow");var d=a.driverdata.receiveMessage;d[b]=2;d[b+1]=c.cursize&255;d[b+2]=c.cursize>> 8;d.set(new Uint8Array(c.data,0,c.cursize),b+3);return 1},CanSendMessage:function(a){if(null!=a.driverdata)return a.canSend},Close:function(a){null!=a.driverdata&&(a.driverdata.driverdata=null);a.receiveMessageLength=0;a.sendMessageLength=0;a.canSend=!1;a===Loop.client?Loop.client=null:Loop.server=null}};
var WEBS={};
var PF={VarString:function(a){for(var b="";a<PR.argc;++a)b+=PR.GetString(PR.globals_int[4+3*a]);return b},error:function(){Con.Print("======SERVER ERROR in "+PR.GetString(PR.xfunction.name)+"\n"+PF.VarString(0)+"\n");ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]);Host.Error("Program error")},objerror:function(){Con.Print("======OBJECT ERROR in "+PR.GetString(PR.xfunction.name)+"\n"+PF.VarString(0)+"\n");ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]);Host.Error("Program error")}, makevectors:function(){var a=[],b=[],c=[];Vec.AngleVectors([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],a,b,c);var d;for(d=0;2>=d;++d)PR.globals_float[PR.globalvars.v_forward+d]=a[d],PR.globals_float[PR.globalvars.v_right+d]=b[d],PR.globals_float[PR.globalvars.v_up+d]=c[d]},setorigin:function(){var a=SV.server.edicts[PR.globals_int[4]];a.v_float[PR.entvars.origin]=PR.globals_float[7];a.v_float[PR.entvars.origin1]=PR.globals_float[8];a.v_float[PR.entvars.origin2]=PR.globals_float[9]; SV.LinkEdict(a)},SetMinMaxSize:function(a,b,c){(b[0]>c[0]||b[1]>c[1]||b[2]>c[2])&&PR.RunError("backwards mins/maxs");ED.SetVector(a,PR.entvars.mins,b);ED.SetVector(a,PR.entvars.maxs,c);a.v_float[PR.entvars.size]=c[0]-b[0];a.v_float[PR.entvars.size1]=c[1]-b[1];a.v_float[PR.entvars.size2]=c[2]-b[2];SV.LinkEdict(a)},setsize:function(){PF.SetMinMaxSize(SV.server.edicts[PR.globals_int[4]],[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],[PR.globals_float[10],PR.globals_float[11],PR.globals_float[12]])}, setmodel:function(){var a=SV.server.edicts[PR.globals_int[4]],b=PR.GetString(PR.globals_int[7]),c;for(c=0;c<SV.server.model_precache.length&&SV.server.model_precache[c]!==b;++c);c===SV.server.model_precache.length&&PR.RunError("no precache: "+b+"\n");a.v_int[PR.entvars.model]=PR.globals_int[7];a.v_float[PR.entvars.modelindex]=c;b=SV.server.models[c];null!=b?PF.SetMinMaxSize(a,b.mins,b.maxs):PF.SetMinMaxSize(a,Vec.origin,Vec.origin)},bprint:function(){Host.BroadcastPrint(PF.VarString(0))},sprint:function(){var a= PR.globals_int[4];0>=a||a>SV.svs.maxclients?Con.Print("tried to sprint to a non-client\n"):(a=SV.svs.clients[a-1],MSG.WriteByte(a.message,Protocol.svc.print),MSG.WriteString(a.message,PF.VarString(1)))},centerprint:function(){var a=PR.globals_int[4];0>=a||a>SV.svs.maxclients?Con.Print("tried to sprint to a non-client\n"):(a=SV.svs.clients[a-1],MSG.WriteByte(a.message,Protocol.svc.centerprint),MSG.WriteString(a.message,PF.VarString(1)))},normalize:function(){var a=[PR.globals_float[4],PR.globals_float[5], PR.globals_float[6]];Vec.Normalize(a);PR.globals_float[1]=a[0];PR.globals_float[2]=a[1];PR.globals_float[3]=a[2]},vlen:function(){PR.globals_float[1]=Vec.Length([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]])},vectoyaw:function(){var a=PR.globals_float[4],b=PR.globals_float[5];0===a&&0===b?PR.globals_float[1]=0:(a=180*Math.atan2(b,a)/Math.PI>>0,0>a&&(a+=360),PR.globals_float[1]=a)},vectoangles:function(){PR.globals_float[3]=0;var a=[PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]]; if(0===a[0]&&0===a[1])PR.globals_float[1]=0<a[2]?90:270,PR.globals_float[2]=0;else{var b=180*Math.atan2(a[1],a[0])/Math.PI>>0;0>b&&(b+=360);a=180*Math.atan2(a[2],Math.sqrt(a[0]*a[0]+a[1]*a[1]))/Math.PI>>0;0>a&&(a+=360);PR.globals_float[1]=a;PR.globals_float[2]=b}},random:function(){PR.globals_float[1]=Math.random()},particle:function(){SV.StartParticle([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],PR.globals_float[10]>> 0,PR.globals_float[13]>>0)},ambientsound:function(){var a=PR.GetString(PR.globals_int[7]),b;for(b=0;b<SV.server.sound_precache.length&&SV.server.sound_precache[b]!==a;++b);b===SV.server.sound_precache.length?Con.Print("no precache: "+a+"\n"):(a=SV.server.signon,MSG.WriteByte(a,Protocol.svc.spawnstaticsound),MSG.WriteCoord(a,PR.globals_float[4]),MSG.WriteCoord(a,PR.globals_float[5]),MSG.WriteCoord(a,PR.globals_float[6]),MSG.WriteByte(a,b),MSG.WriteByte(a,255*PR.globals_float[10]),MSG.WriteByte(a,64* PR.globals_float[13]))},sound:function(){SV.StartSound(SV.server.edicts[PR.globals_int[4]],PR.globals_float[7]>>0,PR.GetString(PR.globals_int[10]),255*PR.globals_float[13]>>0,PR.globals_float[16])},breakstatement:function(){Con.Print("break statement\n")},traceline:function(){var a=SV.Move([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]],Vec.origin,Vec.origin,[PR.globals_float[7],PR.globals_float[8],PR.globals_float[9]],PR.globals_float[10]>>0,SV.server.edicts[PR.globals_int[13]]);PR.globals_float[PR.globalvars.trace_allsolid]= !0===a.allsolid?1:0;PR.globals_float[PR.globalvars.trace_startsolid]=!0===a.startsolid?1:0;PR.globals_float[PR.globalvars.trace_fraction]=a.fraction;PR.globals_float[PR.globalvars.trace_inwater]=!0===a.inwater?1:0;PR.globals_float[PR.globalvars.trace_inopen]=!0===a.inopen?1:0;PR.globals_float[PR.globalvars.trace_endpos]=a.endpos[0];PR.globals_float[PR.globalvars.trace_endpos1]=a.endpos[1];PR.globals_float[PR.globalvars.trace_endpos2]=a.endpos[2];var b=a.plane;PR.globals_float[PR.globalvars.trace_plane_normal]= b.normal[0];PR.globals_float[PR.globalvars.trace_plane_normal1]=b.normal[1];PR.globals_float[PR.globalvars.trace_plane_normal2]=b.normal[2];PR.globals_float[PR.globalvars.trace_plane_dist]=b.dist;PR.globals_int[PR.globalvars.trace_ent]=null!=a.ent?a.ent.num:0},newcheckclient:function(a){0>=a?a=1:a>SV.svs.maxclients&&(a=SV.svs.maxclients);var b=1;a!==SV.svs.maxclients&&(b+=a);for(var c;;++b){b===SV.svs.maxclients+1&&(b=1);c=SV.server.edicts[b];if(b===a)break;if(!0!==c.free&&!(0>=c.v_float[PR.entvars.health]|| 0!==(c.v_float[PR.entvars.flags]&SV.fl.notarget)))break}PF.checkpvs=Mod.LeafPVS(Mod.PointInLeaf([c.v_float[PR.entvars.origin]+c.v_float[PR.entvars.view_ofs],c.v_float[PR.entvars.origin1]+c.v_float[PR.entvars.view_ofs1],c.v_float[PR.entvars.origin2]+c.v_float[PR.entvars.view_ofs2]],SV.server.worldmodel),SV.server.worldmodel);return b},checkclient:function(){0.1<=SV.server.time-SV.server.lastchecktime&&(SV.server.lastcheck=PF.newcheckclient(SV.server.lastcheck),SV.server.lastchecktime=SV.server.time); var a=SV.server.edicts[SV.server.lastcheck];if(!0===a.free||0>=a.v_float[PR.entvars.health])PR.globals_int[1]=0;else{var b=SV.server.edicts[PR.globals_int[PR.globalvars.self]],b=Mod.PointInLeaf([b.v_float[PR.entvars.origin]+b.v_float[PR.entvars.view_ofs],b.v_float[PR.entvars.origin1]+b.v_float[PR.entvars.view_ofs1],b.v_float[PR.entvars.origin2]+b.v_float[PR.entvars.view_ofs2]],SV.server.worldmodel).num-1;PR.globals_int[1]=0>b||0===(PF.checkpvs[b>>3]&1<<(b&7))?0:a.num}},stuffcmd:function(){var a=PR.globals_int[4]; (0>=a||a>SV.svs.maxclients)&&PR.RunError("Parm 0 not a client");a=SV.svs.clients[a-1];MSG.WriteByte(a.message,Protocol.svc.stufftext);MSG.WriteString(a.message,PR.GetString(PR.globals_int[7]))},localcmd:function(){Cmd.text+=PR.GetString(PR.globals_int[4])},cvar:function(){var a=Cvar.FindVar(PR.GetString(PR.globals_int[4]));PR.globals_float[1]=null!=a?a.value:0},cvar_set:function(){Cvar.Set(PR.GetString(PR.globals_int[4]),PR.GetString(PR.globals_int[7]))},findradius:function(){var a=0,b=[PR.globals_float[4], PR.globals_float[5],PR.globals_float[6]],c=[],d=PR.globals_float[7],g,e;for(g=1;g<SV.server.num_edicts;++g)e=SV.server.edicts[g],!0!==e.free&&e.v_float[PR.entvars.solid]!==SV.solid.not&&(c[0]=b[0]-(e.v_float[PR.entvars.origin]+0.5*(e.v_float[PR.entvars.mins]+e.v_float[PR.entvars.maxs])),c[1]=b[1]-(e.v_float[PR.entvars.origin1]+0.5*(e.v_float[PR.entvars.mins1]+e.v_float[PR.entvars.maxs1])),c[2]=b[2]-(e.v_float[PR.entvars.origin2]+0.5*(e.v_float[PR.entvars.mins2]+e.v_float[PR.entvars.maxs2])),Math.sqrt(c[0]* c[0]+c[1]*c[1]+c[2]*c[2])>d||(e.v_int[PR.entvars.chain]=a,a=g));PR.globals_int[1]=a},dprint:function(){Con.DPrint(PF.VarString(0))},ftos:function(){var a=PR.globals_float[4];a===Math.floor(a)?PR.TempString(a.toString()):PR.TempString(a.toFixed(1));PR.globals_int[1]=PR.string_temp},fabs:function(){PR.globals_float[1]=Math.abs(PR.globals_float[4])},vtos:function(){PR.TempString(PR.globals_float[4].toFixed(1)+" "+PR.globals_float[5].toFixed(1)+" "+PR.globals_float[6].toFixed(1));PR.globals_int[1]=PR.string_temp}, Spawn:function(){PR.globals_int[1]=ED.Alloc().num},Remove:function(){ED.Free(SV.server.edicts[PR.globals_int[4]])},Find:function(){var a=PR.globals_int[4],b=PR.globals_int[7],c=PR.GetString(PR.globals_int[10]),d;for(++a;a<SV.server.num_edicts;++a)if(d=SV.server.edicts[a],!0!==d.free&&PR.GetString(d.v_int[b])===c){PR.globals_int[1]=d.num;return}PR.globals_int[1]=0},MoveToGoal:function(){var a=SV.server.edicts[PR.globals_int[PR.globalvars.self]];if(0===(a.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+ SV.fl.swim))PR.globals_float[1]=0;else{var b=SV.server.edicts[a.v_int[PR.entvars.goalentity]],c=PR.globals_float[4];0!==a.v_int[PR.entvars.enemy]&&!0===SV.CloseEnough(a,b,c)||(0.75<=Math.random()||!0!==SV.StepDirection(a,a.v_float[PR.entvars.ideal_yaw],c))&&SV.NewChaseDir(a,b,c)}},precache_file:function(){PR.globals_int[1]=PR.globals_int[4]},precache_sound:function(){var a=PR.GetString(PR.globals_int[4]);PR.globals_int[1]=PR.globals_int[4];PR.CheckEmptyString(a);var b;for(b=0;b<SV.server.sound_precache.length;++b)if(SV.server.sound_precache[b]=== a)return;SV.server.sound_precache[b]=a},precache_model:function(){!0!==SV.server.loading&&PR.RunError("PF.Precache_*: Precache can only be done in spawn functions");var a=PR.GetString(PR.globals_int[4]);PR.globals_int[1]=PR.globals_int[4];PR.CheckEmptyString(a);var b;for(b=0;b<SV.server.model_precache.length;++b)if(SV.server.model_precache[b]===a)return;SV.server.model_precache[b]=a;SV.server.models[b]=Mod.ForName(a,!0)},coredump:function(){ED.PrintEdicts()},traceon:function(){PR.trace=!0},traceoff:function(){PR.trace= !1},eprint:function(){ED.Print(SV.server.edicts[PR.globals_float[4]])},walkmove:function(){var a=SV.server.edicts[PR.globals_int[PR.globalvars.self]];if(0===(a.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+SV.fl.swim))PR.globals_float[1]=0;else{var b=PR.globals_float[4]*Math.PI/180,c=PR.globals_float[7],d=PR.xfunction;PR.globals_float[1]=SV.movestep(a,[Math.cos(b)*c,Math.sin(b)*c],!0);PR.xfunction=d;PR.globals_int[PR.globalvars.self]=a.num}},droptofloor:function(){var a=SV.server.edicts[PR.globals_int[PR.globalvars.self]], b=SV.Move(ED.Vector(a,PR.entvars.origin),ED.Vector(a,PR.entvars.mins),ED.Vector(a,PR.entvars.maxs),[a.v_float[PR.entvars.origin],a.v_float[PR.entvars.origin1],a.v_float[PR.entvars.origin2]-256],0,a);1===b.fraction||!0===b.allsolid?PR.globals_float[1]=0:(ED.SetVector(a,PR.entvars.origin,b.endpos),SV.LinkEdict(a),a.v_float[PR.entvars.flags]|=SV.fl.onground,a.v_int[PR.entvars.groundentity]=b.ent.num,PR.globals_float[1]=1)},lightstyle:function(){var a=PR.globals_float[4]>>0,b=PR.GetString(PR.globals_int[7]); SV.server.lightstyles[a]=b;if(!0!==SV.server.loading){var c,d;for(c=0;c<SV.svs.maxclients;++c)d=SV.svs.clients[c],!0!==d.active&&!0!==d.spawned||(MSG.WriteByte(d.message,Protocol.svc.lightstyle),MSG.WriteByte(d.message,a),MSG.WriteString(d.message,b))}},rint:function(){var a=PR.globals_float[4];PR.globals_float[1]=(0<=a?a+0.5:a-0.5)>>0},floor:function(){PR.globals_float[1]=Math.floor(PR.globals_float[4])},ceil:function(){PR.globals_float[1]=Math.ceil(PR.globals_float[4])},checkbottom:function(){PR.globals_float[1]= SV.CheckBottom(SV.server.edicts[PR.globals_int[4]])},pointcontents:function(){PR.globals_float[1]=SV.PointContents([PR.globals_float[4],PR.globals_float[5],PR.globals_float[6]])},nextent:function(){var a;for(a=PR.globals_int[4]+1;a<SV.server.num_edicts;++a)if(!0!==SV.server.edicts[a].free){PR.globals_int[1]=a;return}PR.globals_int[1]=0},aim:function(){var a=SV.server.edicts[PR.globals_int[4]],b=[a.v_float[PR.entvars.origin],a.v_float[PR.entvars.origin1],a.v_float[PR.entvars.origin2]+20],c=[PR.globals_float[PR.globalvars.v_forward], PR.globals_float[PR.globalvars.v_forward1],PR.globals_float[PR.globalvars.v_forward2]],d=[b[0]+2048*c[0],b[1]+2048*c[1],b[2]+2048*c[2]],g=SV.Move(b,Vec.origin,Vec.origin,d,0,a);if(null!=g.ent&&g.ent.v_float[PR.entvars.takedamage]===SV.damage.aim&&(0===Host.teamplay.value||0>=a.v_float[PR.entvars.team]||a.v_float[PR.entvars.team]!==g.ent.v_float[PR.entvars.team]))PR.globals_float[1]=c[0],PR.globals_float[2]=c[1],PR.globals_float[3]=c[2];else{var e=[c[0],c[1],c[2]],l=SV.aim.value,j,k,f,h,d=[];for(k= 1;k<SV.server.num_edicts;++k)f=SV.server.edicts[k],f.v_float[PR.entvars.takedamage]===SV.damage.aim&&(f!==a&&!(0!==Host.teamplay.value&&0<a.v_float[PR.entvars.team]&&a.v_float[PR.entvars.team]===f.v_float[PR.entvars.team]))&&(d[0]=f.v_float[PR.entvars.origin]+0.5*(f.v_float[PR.entvars.mins]+f.v_float[PR.entvars.maxs]),d[1]=f.v_float[PR.entvars.origin1]+0.5*(f.v_float[PR.entvars.mins1]+f.v_float[PR.entvars.maxs1]),d[2]=f.v_float[PR.entvars.origin2]+0.5*(f.v_float[PR.entvars.mins2]+f.v_float[PR.entvars.maxs2]), c[0]=d[0]-b[0],c[1]=d[1]-b[1],c[2]=d[2]-b[2],Vec.Normalize(c),h=c[0]*e[0]+c[1]*e[1]+c[2]*e[2],h<l||(g=SV.Move(b,Vec.origin,Vec.origin,d,0,a),g.ent===f&&(l=h,j=f)));null!=j?(c[0]=j.v_float[PR.entvars.origin]-a.v_float[PR.entvars.origin],c[1]=j.v_float[PR.entvars.origin1]-a.v_float[PR.entvars.origin1],c[2]=j.v_float[PR.entvars.origin2]-a.v_float[PR.entvars.origin2],h=c[0]*e[0]+c[1]*e[1]+c[2]*e[2],d[0]=e[0]*h,d[1]=e[1]*h,d[2]=c[2],Vec.Normalize(d),PR.globals_float[1]=d[0],PR.globals_float[2]=d[1],PR.globals_float[3]= d[2]):(PR.globals_float[1]=e[0],PR.globals_float[2]=e[1],PR.globals_float[3]=e[2])}},changeyaw:function(){var a=SV.server.edicts[PR.globals_int[PR.globalvars.self]],b=Vec.Anglemod(a.v_float[PR.entvars.angles1]),c=a.v_float[PR.entvars.ideal_yaw];if(b!==c){var d=c-b;c>b?180<=d&&(d-=360):-180>=d&&(d+=360);c=a.v_float[PR.entvars.yaw_speed];0<d?d>c&&(d=c):d<-c&&(d=-c);a.v_float[PR.entvars.angles1]=Vec.Anglemod(b+d)}},WriteDest:function(){switch(PR.globals_float[4]>>0){case 0:return SV.server.datagram; case 1:var a=PR.globals_int[PR.globalvars.msg_entity];(0>=a||a>SV.svs.maxclients)&&PR.RunError("WriteDest: not a client");return SV.svs.clients[a-1].message;case 2:return SV.server.reliable_datagram;case 3:return SV.server.signon}PR.RunError("WriteDest: bad destination")},WriteByte:function(){MSG.WriteByte(PF.WriteDest(),PR.globals_float[7])},WriteChar:function(){MSG.WriteChar(PF.WriteDest(),PR.globals_float[7])},WriteShort:function(){MSG.WriteShort(PF.WriteDest(),PR.globals_float[7])},WriteLong:function(){MSG.WriteLong(PF.WriteDest(), PR.globals_float[7])},WriteAngle:function(){MSG.WriteAngle(PF.WriteDest(),PR.globals_float[7])},WriteCoord:function(){MSG.WriteCoord(PF.WriteDest(),PR.globals_float[7])},WriteString:function(){MSG.WriteString(PF.WriteDest(),PR.GetString(PR.globals_int[7]))},WriteEntity:function(){MSG.WriteShort(PF.WriteDest(),PR.globals_int[7])},makestatic:function(){var a=SV.server.edicts[PR.globals_int[4]],b=SV.server.signon;MSG.WriteByte(b,Protocol.svc.spawnstatic);MSG.WriteByte(b,SV.ModelIndex(PR.GetString(a.v_int[PR.entvars.model]))); MSG.WriteByte(b,a.v_float[PR.entvars.frame]);MSG.WriteByte(b,a.v_float[PR.entvars.colormap]);MSG.WriteByte(b,a.v_float[PR.entvars.skin]);MSG.WriteCoord(b,a.v_float[PR.entvars.origin]);MSG.WriteAngle(b,a.v_float[PR.entvars.angles]);MSG.WriteCoord(b,a.v_float[PR.entvars.origin1]);MSG.WriteAngle(b,a.v_float[PR.entvars.angles1]);MSG.WriteCoord(b,a.v_float[PR.entvars.origin2]);MSG.WriteAngle(b,a.v_float[PR.entvars.angles2]);ED.Free(a)},setspawnparms:function(){var a=PR.globals_int[4];(0>=a||a>SV.svs.maxclients)&& PR.RunError("Entity is not a client");for(var b=SV.svs.clients[a-1].spawn_parms,a=0;15>=a;++a)PR.globals_float[PR.globalvars.parms+a]=b[a]},changelevel:function(){!0!==SV.svs.changelevel_issued&&(SV.svs.changelevel_issued=!0,Cmd.text+="changelevel "+PR.GetString(PR.globals_int[4])+"\n")},Fixme:function(){PR.RunError("unimplemented builtin")}}; PF.builtin=[PF.Fixme,PF.makevectors,PF.setorigin,PF.setmodel,PF.setsize,PF.Fixme,PF.breakstatement,PF.random,PF.sound,PF.normalize,PF.error,PF.objerror,PF.vlen,PF.vectoyaw,PF.Spawn,PF.Remove,PF.traceline,PF.checkclient,PF.Find,PF.precache_sound,PF.precache_model,PF.stuffcmd,PF.findradius,PF.bprint,PF.sprint,PF.dprint,PF.ftos,PF.vtos,PF.coredump,PF.traceon,PF.traceoff,PF.eprint,PF.walkmove,PF.Fixme,PF.droptofloor,PF.lightstyle,PF.rint,PF.floor,PF.ceil,PF.Fixme,PF.checkbottom,PF.pointcontents,PF.Fixme, PF.fabs,PF.aim,PF.cvar,PF.localcmd,PF.nextent,PF.particle,PF.changeyaw,PF.Fixme,PF.vectoangles,PF.WriteByte,PF.WriteChar,PF.WriteShort,PF.WriteLong,PF.WriteCoord,PF.WriteAngle,PF.WriteString,PF.WriteEntity,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.Fixme,PF.MoveToGoal,PF.precache_file,PF.makestatic,PF.changelevel,PF.Fixme,PF.cvar_set,PF.centerprint,PF.ambientsound,PF.precache_model,PF.precache_sound,PF.precache_file,PF.setspawnparms];
var PR={etype:{ev_void:0,ev_string:1,ev_float:2,ev_vector:3,ev_entity:4,ev_field:5,ev_function:6,ev_pointer:7},op:{done:0,mul_f:1,mul_v:2,mul_fv:3,mul_vf:4,div_f:5,add_f:6,add_v:7,sub_f:8,sub_v:9,eq_f:10,eq_v:11,eq_s:12,eq_e:13,eq_fnc:14,ne_f:15,ne_v:16,ne_s:17,ne_e:18,ne_fnc:19,le:20,ge:21,lt:22,gt:23,load_f:24,load_v:25,load_s:26,load_ent:27,load_fld:28,load_fnc:29,address:30,store_f:31,store_v:32,store_s:33,store_ent:34,store_fld:35,store_fnc:36,storep_f:37,storep_v:38,storep_s:39,storep_ent:40, storep_fld:41,storep_fnc:42,ret:43,not_f:44,not_v:45,not_s:46,not_ent:47,not_fnc:48,jnz:49,jz:50,call0:51,call1:52,call2:53,call3:54,call4:55,call5:56,call6:57,call7:58,call8:59,state:60,jump:61,and:62,or:63,bitand:64,bitor:65},version:6,globalvars:{self:28,other:29,world:30,time:31,frametime:32,force_retouch:33,mapname:34,deathmatch:35,coop:36,teamplay:37,serverflags:38,total_secrets:39,total_monsters:40,found_secrets:41,killed_monsters:42,parms:43,v_forward:59,v_forward1:60,v_forward2:61,v_up:62, v_up1:63,v_up2:64,v_right:65,v_right1:66,v_right2:67,trace_allsolid:68,trace_startsolid:69,trace_fraction:70,trace_endpos:71,trace_endpos1:72,trace_endpos2:73,trace_plane_normal:74,trace_plane_normal1:75,trace_plane_normal2:76,trace_plane_dist:77,trace_ent:78,trace_inopen:79,trace_inwater:80,msg_entity:81,main:82,StartFrame:83,PlayerPreThink:84,PlayerPostThink:85,ClientKill:86,ClientConnect:87,PutClientInServer:88,ClientDisconnect:89,SetNewParms:90,SetChangeParms:91},entvars:{modelindex:0,absmin:1, absmin1:2,absmin2:3,absmax:4,absmax1:5,absmax2:6,ltime:7,movetype:8,solid:9,origin:10,origin1:11,origin2:12,oldorigin:13,oldorigin1:14,oldorigin2:15,velocity:16,velocity1:17,velocity2:18,angles:19,angles1:20,angles2:21,avelocity:22,avelocity1:23,avelocity2:24,punchangle:25,punchangle1:26,punchangle2:27,classname:28,model:29,frame:30,skin:31,effects:32,mins:33,mins1:34,mins2:35,maxs:36,maxs1:37,maxs2:38,size:39,size1:40,size2:41,touch:42,use:43,think:44,blocked:45,nextthink:46,groundentity:47,health:48, frags:49,weapon:50,weaponmodel:51,weaponframe:52,currentammo:53,ammo_shells:54,ammo_nails:55,ammo_rockets:56,ammo_cells:57,items:58,takedamage:59,chain:60,deadflag:61,view_ofs:62,view_ofs1:63,view_ofs2:64,button0:65,button1:66,button2:67,impulse:68,fixangle:69,v_angle:70,v_angle1:71,v_angle2:72,idealpitch:73,netname:74,enemy:75,flags:76,colormap:77,team:78,max_health:79,teleport_time:80,armortype:81,armorvalue:82,waterlevel:83,watertype:84,ideal_yaw:85,yaw_speed:86,aiment:87,goalentity:88,spawnflags:89, target:90,targetname:91,dmg_take:92,dmg_save:93,dmg_inflictor:94,owner:95,movedir:96,movedir1:97,movedir2:98,message:99,sounds:100,noise:101,noise1:102,noise2:103,noise3:104},progheader_crc:5927,CheckEmptyString:function(b){b=b.charCodeAt(0);(!0===isNaN(b)||32>=b)&&PR.RunError("Bad string")},ValueString:function(b,c,d){var a=new Float32Array(c);c=new Int32Array(c);b&=32767;switch(b){case PR.etype.ev_string:return PR.GetString(c[d]);case PR.etype.ev_entity:return"entity "+c[d];case PR.etype.ev_function:return PR.GetString(PR.functions[c[d]].name)+ "()";case PR.etype.ev_field:return b=ED.FieldAtOfs(c[d]),null!=b?"."+PR.GetString(b.name):".";case PR.etype.ev_void:return"void";case PR.etype.ev_float:return a[d].toFixed(1);case PR.etype.ev_vector:return"'"+a[d].toFixed(1)+" "+a[d+1].toFixed(1)+" "+a[d+2].toFixed(1)+"'";case PR.etype.ev_pointer:return"pointer"}return"bad type "+b},UglyValueString:function(b,c,d){var a=new Float32Array(c);c=new Int32Array(c);b&=32767;switch(b){case PR.etype.ev_string:return PR.GetString(c[d]);case PR.etype.ev_entity:return c[d].toString(); case PR.etype.ev_function:return PR.GetString(PR.functions[c[d]].name);case PR.etype.ev_field:return b=ED.FieldAtOfs(c[d]),null!=b?PR.GetString(b.name):"";case PR.etype.ev_void:return"void";case PR.etype.ev_float:return a[d].toFixed(6);case PR.etype.ev_vector:return a[d].toFixed(6)+" "+a[d+1].toFixed(6)+" "+a[d+2].toFixed(6)}return"bad type "+b},GlobalString:function(b){var c=ED.GlobalAtOfs(b);for(b=null!=c?b+"("+PR.GetString(c.name)+")"+PR.ValueString(c.type,PR.globals,b):b+"(???)";20>=b.length;)b+= " ";return b},GlobalStringNoContents:function(b){var c=ED.GlobalAtOfs(b);for(b=null!=c?b+"("+PR.GetString(c.name)+")":b+"(???)";20>=b.length;)b+=" ";return b},LoadProgs:function(){var b=COM.LoadFile("progs.dat");null==b&&Sys.Error("PR.LoadProgs: couldn't load progs.dat");Con.DPrint("Programs occupy "+(b.byteLength>>10)+"K.\n");var c=new DataView(b),d=c.getUint32(0,!0);d!==PR.version&&Sys.Error("progs.dat has wrong version number ("+d+" should be "+PR.version+")");c.getUint32(4,!0)!==PR.progheader_crc&& Sys.Error("progs.dat system vars have been modified, PR.js is out of date");PR.crc=CRC.Block(new Uint8Array(b));PR.stack=[];PR.depth=0;PR.localstack=[];for(d=0;d<PR.localstack_size;++d)PR.localstack[d]=0;PR.localstack_used=0;var a,b=c.getUint32(8,!0);a=c.getUint32(12,!0);PR.statements=[];for(d=0;d<a;++d)PR.statements[d]={op:c.getUint16(b,!0),a:c.getInt16(b+2,!0),b:c.getInt16(b+4,!0),c:c.getInt16(b+6,!0)},b+=8;b=c.getUint32(16,!0);a=c.getUint32(20,!0);PR.globaldefs=[];for(d=0;d<a;++d)PR.globaldefs[d]= {type:c.getUint16(b,!0),ofs:c.getUint16(b+2,!0),name:c.getUint32(b+4,!0)},b+=8;b=c.getUint32(24,!0);a=c.getUint32(28,!0);PR.fielddefs=[];for(d=0;d<a;++d)PR.fielddefs[d]={type:c.getUint16(b,!0),ofs:c.getUint16(b+2,!0),name:c.getUint32(b+4,!0)},b+=8;b=c.getUint32(32,!0);a=c.getUint32(36,!0);PR.functions=[];for(d=0;d<a;++d)PR.functions[d]={first_statement:c.getInt32(b,!0),parm_start:c.getUint32(b+4,!0),locals:c.getUint32(b+8,!0),profile:c.getUint32(b+12,!0),name:c.getUint32(b+16,!0),file:c.getUint32(b+ 20,!0),numparms:c.getUint32(b+24,!0),parm_size:[c.getUint8(b+28),c.getUint8(b+29),c.getUint8(b+30),c.getUint8(b+31),c.getUint8(b+32),c.getUint8(b+33),c.getUint8(b+34),c.getUint8(b+35)]},b+=36;b=c.getUint32(40,!0);a=c.getUint32(44,!0);PR.strings=[];for(d=0;d<a;++d)PR.strings[d]=c.getUint8(b+d);PR.string_temp=PR.NewString("",128);PR.netnames=PR.NewString("",SV.svs.maxclients<<5);b=c.getUint32(48,!0);a=c.getUint32(52,!0);PR.globals=new ArrayBuffer(a<<2);PR.globals_float=new Float32Array(PR.globals); PR.globals_int=new Int32Array(PR.globals);for(d=0;d<a;++d)PR.globals_int[d]=c.getInt32(b+(d<<2),!0);PR.entityfields=c.getUint32(56,!0);PR.edict_size=96+(PR.entityfields<<2);c="ammo_shells1 ammo_nails1 ammo_lava_nails ammo_rockets1 ammo_multi_rockets ammo_cells1 ammo_plasma gravity items2".split(" ");for(d=0;d<c.length;++d)b=c[d],a=ED.FindField(b),PR.entvars[b]=null!=a?a.ofs:null},Init:function(){Cmd.AddCommand("edict",ED.PrintEdict_f);Cmd.AddCommand("edicts",ED.PrintEdicts);Cmd.AddCommand("edictcount", ED.Count);Cmd.AddCommand("profile",PR.Profile_f);Cvar.RegisterVariable("nomonsters","0");Cvar.RegisterVariable("gamecfg","0");Cvar.RegisterVariable("scratch1","0");Cvar.RegisterVariable("scratch2","0");Cvar.RegisterVariable("scratch3","0");Cvar.RegisterVariable("scratch4","0");Cvar.RegisterVariable("savedgamecfg","0",!0);Cvar.RegisterVariable("saved1","0",!0);Cvar.RegisterVariable("saved2","0",!0);Cvar.RegisterVariable("saved3","0",!0);Cvar.RegisterVariable("saved4","0",!0)},localstack_size:2048, opnames:"DONE MUL_F MUL_V MUL_FV MUL_VF DIV ADD_F ADD_V SUB_F SUB_V EQ_F EQ_V EQ_S EQ_E EQ_FNC NE_F NE_V NE_S NE_E NE_FNC LE GE LT GT INDIRECT INDIRECT INDIRECT INDIRECT INDIRECT INDIRECT ADDRESS STORE_F STORE_V STORE_S STORE_ENT STORE_FLD STORE_FNC STOREP_F STOREP_V STOREP_S STOREP_ENT STOREP_FLD STOREP_FNC RETURN NOT_F NOT_V NOT_S NOT_ENT NOT_FNC IF IFNOT CALL0 CALL1 CALL2 CALL3 CALL4 CALL5 CALL6 CALL7 CALL8 STATE GOTO AND OR BITAND BITOR".split(" "),PrintStatement:function(b){var c;if(b.op<PR.opnames.length)for(c= PR.opnames[b.op]+" ";9>=c.length;)c+=" ";else c="";b.op===PR.op.jnz||b.op===PR.op.jz?c+=PR.GlobalString(b.a)+"branch "+b.b:b.op===PR.op.jump?c+="branch "+b.a:b.op>=PR.op.store_f&&b.op<=PR.op.store_fnc?c+=PR.GlobalString(b.a)+PR.GlobalStringNoContents(b.b):(0!==b.a&&(c+=PR.GlobalString(b.a)),0!==b.b&&(c+=PR.GlobalString(b.b)),0!==b.c&&(c+=PR.GlobalStringNoContents(b.c)));Con.Print(c+"\n")},StackTrace:function(){if(0===PR.depth)Con.Print("<NO STACK>\n");else{PR.stack[PR.depth]=[PR.xstatement,PR.xfunction]; for(var b,c;0<=PR.depth;--PR.depth)if(b=PR.stack[PR.depth][1],null==b)Con.Print("<NO FUNCTION>\n");else{for(c=PR.GetString(b.file);11>=c.length;)c+=" ";Con.Print(c+" : "+PR.GetString(b.name)+"\n")}PR.depth=0}},Profile_f:function(){if(!0===SV.server.active)for(var b=0,c,d,a,e;;){c=0;d=null;for(a=0;a<PR.functions.length;++a)e=PR.functions[a],e.profile>c&&(c=e.profile,d=e);if(null==d)break;if(10>b){for(c=d.profile.toString();6>=c.length;)c=" "+c;Con.Print(c+" "+PR.GetString(d.name)+"\n")}++b;d.profile= 0}},RunError:function(b){PR.PrintStatement(PR.statements[PR.xstatement]);PR.StackTrace();Con.Print(b+"\n");Host.Error("Program error")},EnterFunction:function(b){PR.stack[PR.depth++]=[PR.xstatement,PR.xfunction];var c=b.locals;PR.localstack_used+c>PR.localstack_size&&PR.RunError("PR.EnterFunction: locals stack overflow\n");var d;for(d=0;d<c;++d)PR.localstack[PR.localstack_used+d]=PR.globals_int[b.parm_start+d];PR.localstack_used+=c;var c=b.parm_start,a;for(d=0;d<b.numparms;++d)for(a=0;a<b.parm_size[d];++a)PR.globals_int[c++]= PR.globals_int[4+3*d+a];PR.xfunction=b;return b.first_statement-1},LeaveFunction:function(){0>=PR.depth&&Sys.Error("prog stack underflow");var b=PR.xfunction.locals;PR.localstack_used-=b;0>PR.localstack_used&&PR.RunError("PR.LeaveFunction: locals stack underflow\n");for(--b;0<=b;--b)PR.globals_int[PR.xfunction.parm_start+b]=PR.localstack[PR.localstack_used+b];PR.xfunction=PR.stack[--PR.depth][1];return PR.stack[PR.depth][0]},ExecuteProgram:function(b){if(0===b||b>=PR.functions.length)0!==PR.globals_int[PR.globalvars.self]&& ED.Print(SV.server.edicts[PR.globals_int[PR.globalvars.self]]),Host.Error("PR.ExecuteProgram: NULL function");var c=1E5;PR.trace=!1;var d=PR.depth;b=PR.EnterFunction(PR.functions[b]);for(var a,e,f;;){++b;a=PR.statements[b];0===--c&&PR.RunError("runaway loop error");++PR.xfunction.profile;PR.xstatement=b;!0===PR.trace&&PR.PrintStatement(a);switch(a.op){case PR.op.add_f:PR.globals_float[a.c]=PR.globals_float[a.a]+PR.globals_float[a.b];continue;case PR.op.add_v:PR.globals_float[a.c]=PR.globals_float[a.a]+ PR.globals_float[a.b];PR.globals_float[a.c+1]=PR.globals_float[a.a+1]+PR.globals_float[a.b+1];PR.globals_float[a.c+2]=PR.globals_float[a.a+2]+PR.globals_float[a.b+2];continue;case PR.op.sub_f:PR.globals_float[a.c]=PR.globals_float[a.a]-PR.globals_float[a.b];continue;case PR.op.sub_v:PR.globals_float[a.c]=PR.globals_float[a.a]-PR.globals_float[a.b];PR.globals_float[a.c+1]=PR.globals_float[a.a+1]-PR.globals_float[a.b+1];PR.globals_float[a.c+2]=PR.globals_float[a.a+2]-PR.globals_float[a.b+2];continue; case PR.op.mul_f:PR.globals_float[a.c]=PR.globals_float[a.a]*PR.globals_float[a.b];continue;case PR.op.mul_v:PR.globals_float[a.c]=PR.globals_float[a.a]*PR.globals_float[a.b]+PR.globals_float[a.a+1]*PR.globals_float[a.b+1]+PR.globals_float[a.a+2]*PR.globals_float[a.b+2];continue;case PR.op.mul_fv:PR.globals_float[a.c]=PR.globals_float[a.a]*PR.globals_float[a.b];PR.globals_float[a.c+1]=PR.globals_float[a.a]*PR.globals_float[a.b+1];PR.globals_float[a.c+2]=PR.globals_float[a.a]*PR.globals_float[a.b+ 2];continue;case PR.op.mul_vf:PR.globals_float[a.c]=PR.globals_float[a.b]*PR.globals_float[a.a];PR.globals_float[a.c+1]=PR.globals_float[a.b]*PR.globals_float[a.a+1];PR.globals_float[a.c+2]=PR.globals_float[a.b]*PR.globals_float[a.a+2];continue;case PR.op.div_f:PR.globals_float[a.c]=PR.globals_float[a.a]/PR.globals_float[a.b];continue;case PR.op.bitand:PR.globals_float[a.c]=PR.globals_float[a.a]&PR.globals_float[a.b];continue;case PR.op.bitor:PR.globals_float[a.c]=PR.globals_float[a.a]|PR.globals_float[a.b]; continue;case PR.op.ge:PR.globals_float[a.c]=PR.globals_float[a.a]>=PR.globals_float[a.b]?1:0;continue;case PR.op.le:PR.globals_float[a.c]=PR.globals_float[a.a]<=PR.globals_float[a.b]?1:0;continue;case PR.op.gt:PR.globals_float[a.c]=PR.globals_float[a.a]>PR.globals_float[a.b]?1:0;continue;case PR.op.lt:PR.globals_float[a.c]=PR.globals_float[a.a]<PR.globals_float[a.b]?1:0;continue;case PR.op.and:PR.globals_float[a.c]=0!==PR.globals_float[a.a]&&0!==PR.globals_float[a.b]?1:0;continue;case PR.op.or:PR.globals_float[a.c]= 0!==PR.globals_float[a.a]||0!==PR.globals_float[a.b]?1:0;continue;case PR.op.not_f:PR.globals_float[a.c]=0===PR.globals_float[a.a]?1:0;continue;case PR.op.not_v:PR.globals_float[a.c]=0===PR.globals_float[a.a]&&0===PR.globals_float[a.a+1]&&0===PR.globals_float[a.a+2]?1:0;continue;case PR.op.not_s:PR.globals_float[a.c]=0!==PR.globals_int[a.a]?0===PR.strings[PR.globals_int[a.a]]?1:0:1;continue;case PR.op.not_fnc:case PR.op.not_ent:PR.globals_float[a.c]=0===PR.globals_int[a.a]?1:0;continue;case PR.op.eq_f:PR.globals_float[a.c]= PR.globals_float[a.a]===PR.globals_float[a.b]?1:0;continue;case PR.op.eq_v:PR.globals_float[a.c]=PR.globals_float[a.a]===PR.globals_float[a.b]&&PR.globals_float[a.a+1]===PR.globals_float[a.b+1]&&PR.globals_float[a.a+2]===PR.globals_float[a.b+2]?1:0;continue;case PR.op.eq_s:PR.globals_float[a.c]=PR.GetString(PR.globals_int[a.a])===PR.GetString(PR.globals_int[a.b])?1:0;continue;case PR.op.eq_e:case PR.op.eq_fnc:PR.globals_float[a.c]=PR.globals_int[a.a]===PR.globals_int[a.b]?1:0;continue;case PR.op.ne_f:PR.globals_float[a.c]= PR.globals_float[a.a]!==PR.globals_float[a.b]?1:0;continue;case PR.op.ne_v:PR.globals_float[a.c]=PR.globals_float[a.a]!==PR.globals_float[a.b]||PR.globals_float[a.a+1]!==PR.globals_float[a.b+1]||PR.globals_float[a.a+2]!==PR.globals_float[a.b+2]?1:0;continue;case PR.op.ne_s:PR.globals_float[a.c]=PR.GetString(PR.globals_int[a.a])!==PR.GetString(PR.globals_int[a.b])?1:0;continue;case PR.op.ne_e:case PR.op.ne_fnc:PR.globals_float[a.c]=PR.globals_int[a.a]!==PR.globals_int[a.b]?1:0;continue;case PR.op.store_f:case PR.op.store_ent:case PR.op.store_fld:case PR.op.store_s:case PR.op.store_fnc:PR.globals_int[a.b]= PR.globals_int[a.a];continue;case PR.op.store_v:PR.globals_int[a.b]=PR.globals_int[a.a];PR.globals_int[a.b+1]=PR.globals_int[a.a+1];PR.globals_int[a.b+2]=PR.globals_int[a.a+2];continue;case PR.op.storep_f:case PR.op.storep_ent:case PR.op.storep_fld:case PR.op.storep_s:case PR.op.storep_fnc:f=PR.globals_int[a.b];SV.server.edicts[Math.floor(f/PR.edict_size)].v_int[f%PR.edict_size-96>>2]=PR.globals_int[a.a];continue;case PR.op.storep_v:e=SV.server.edicts[Math.floor(PR.globals_int[a.b]/PR.edict_size)]; f=PR.globals_int[a.b]%PR.edict_size-96>>2;e.v_int[f]=PR.globals_int[a.a];e.v_int[f+1]=PR.globals_int[a.a+1];e.v_int[f+2]=PR.globals_int[a.a+2];continue;case PR.op.address:e=PR.globals_int[a.a];0===e&&!0!==SV.server.loading&&PR.RunError("assignment to world entity");PR.globals_int[a.c]=e*PR.edict_size+96+(PR.globals_int[a.b]<<2);continue;case PR.op.load_f:case PR.op.load_fld:case PR.op.load_ent:case PR.op.load_s:case PR.op.load_fnc:PR.globals_int[a.c]=SV.server.edicts[PR.globals_int[a.a]].v_int[PR.globals_int[a.b]]; continue;case PR.op.load_v:e=SV.server.edicts[PR.globals_int[a.a]];f=PR.globals_int[a.b];PR.globals_int[a.c]=e.v_int[f];PR.globals_int[a.c+1]=e.v_int[f+1];PR.globals_int[a.c+2]=e.v_int[f+2];continue;case PR.op.jz:0===PR.globals_int[a.a]&&(b+=a.b-1);continue;case PR.op.jnz:0!==PR.globals_int[a.a]&&(b+=a.b-1);continue;case PR.op.jump:b+=a.a-1;continue;case PR.op.call0:case PR.op.call1:case PR.op.call2:case PR.op.call3:case PR.op.call4:case PR.op.call5:case PR.op.call6:case PR.op.call7:case PR.op.call8:PR.argc= a.op-PR.op.call0;0===PR.globals_int[a.a]&&PR.RunError("NULL function");a=PR.functions[PR.globals_int[a.a]];if(0>a.first_statement){f=-a.first_statement;f>=PF.builtin.length&&PR.RunError("Bad builtin call number");PF.builtin[f]();continue}b=PR.EnterFunction(a);continue;case PR.op.done:case PR.op.ret:PR.globals_int[1]=PR.globals_int[a.a];PR.globals_int[2]=PR.globals_int[a.a+1];PR.globals_int[3]=PR.globals_int[a.a+2];b=PR.LeaveFunction();if(PR.depth===d)return;continue;case PR.op.state:e=SV.server.edicts[PR.globals_int[PR.globalvars.self]]; e.v_float[PR.entvars.nextthink]=PR.globals_float[PR.globalvars.time]+0.1;e.v_float[PR.entvars.frame]=PR.globals_float[a.a];e.v_int[PR.entvars.think]=PR.globals_int[a.b];continue}PR.RunError("Bad opcode "+a.op)}},GetString:function(b){for(var c=[];b<PR.strings.length&&0!==PR.strings[b];++b)c[c.length]=String.fromCharCode(PR.strings[b]);return c.join("")},NewString:function(b,c){var d=PR.strings.length,a;if(b.length>=c){for(a=0;a<c-1;++a)PR.strings[PR.strings.length]=b.charCodeAt(a);PR.strings[PR.strings.length]= 0;return d}for(a=0;a<b.length;++a)PR.strings[PR.strings.length]=b.charCodeAt(a);c-=b.length;for(a=0;a<c;++a)PR.strings[PR.strings.length]=0;return d},TempString:function(b){var c;127<b.length&&(b=b.substring(0,127));for(c=0;c<b.length;++c)PR.strings[PR.string_temp+c]=b.charCodeAt(c);PR.strings[PR.string_temp+b.length]=0}};
var Protocol={version:15,u:{morebits:1,origin1:2,origin2:4,origin3:8,angle2:16,nolerp:32,frame:64,signal:128,angle1:256,angle3:512,model:1024,colormap:2048,skin:4096,effects:8192,longentity:16384},su:{viewheight:1,idealpitch:2,punch1:4,punch2:8,punch3:16,velocity1:32,velocity2:64,velocity3:128,items:512,onground:1024,inwater:2048,weaponframe:4096,armor:8192,weapon:16384},default_viewheight:22,svc:{nop:1,disconnect:2,updatestat:3,version:4,setview:5,sound:6,time:7,print:8,stufftext:9,setangle:10,serverinfo:11, lightstyle:12,updatename:13,updatefrags:14,clientdata:15,stopsound:16,updatecolors:17,particle:18,damage:19,spawnstatic:20,spawnbaseline:22,temp_entity:23,setpause:24,signonnum:25,centerprint:26,killedmonster:27,foundsecret:28,spawnstaticsound:29,intermission:30,finale:31,cdtrack:32,sellscreen:33,cutscene:34},clc:{nop:1,disconnect:2,move:3,stringcmd:4},te:{spike:0,superspike:1,gunshot:2,explosion:3,tarexplosion:4,lightning1:5,lightning2:6,wizspike:7,knightspike:8,lightning3:9,lavasplash:10,teleport:11, explosion2:12,beam:13}};
var Q={memstr:function(c){var a=[],b;for(b=0;b<c.length&&0!==c[b];++b)a[b]=String.fromCharCode(c[b]);return a.join("")},strmem:function(c){var a=new ArrayBuffer(c.length),b=new Uint8Array(a),e;for(e=0;e<c.length;++e)b[e]=c.charCodeAt(e)&255;return a},atoi:function(c){if(null==c)return 0;var a,b=0,e,d,f;45===c.charCodeAt(0)?(e=-1,a=1):(e=1,a=0);d=c.charCodeAt(a);f=c.charCodeAt(a+1);if(48===d&&(120===f||88===f))for(a+=2;;)if(d=c.charCodeAt(a++),48<=d&&57>=d)b=(b<<4)+d-48;else if(97<=d&&102>=d)b=(b<< 4)+d-87;else if(65<=d&&70>=d)b=(b<<4)+d-55;else return b*e;if(39===d)return!0===isNaN(f)?0:e*f;for(;;){d=c.charCodeAt(a++);if(!0===isNaN(d)||47>=d||58<=d)return b*e;b=10*b+d-48}return 0},atof:function(c){if(null==c)return 0;var a,b,e,d,f;45===c.charCodeAt(0)?(e=-1,a=1):(e=1,a=0);d=c.charCodeAt(a);f=c.charCodeAt(a+1);if(48===d&&(120===f||88===f)){a+=2;for(b=0;;)if(d=c.charCodeAt(a++),48<=d&&57>=d)b=16*b+d-48;else if(97<=d&&102>=d)b=16*b+d-87;else if(65<=d&&70>=d)b=16*b+d-55;else return b*e}if(39=== d)return!0===isNaN(f)?0:e*f;b=parseFloat(c);return!0===isNaN(b)?0:b},btoa:function(c){var a=[],b=c.length-c.length%3,e,d;for(d=0;d<b;d+=3)e=(c[d]<<16)+(c[d+1]<<8)+c[d+2],a[a.length]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>18)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e& 63);1===c.length-b?(e=c[b],a[a.length]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>2)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((e&3)<<4)+"=="):2===c.length-b&&(e=(c[b]<<8)+c[b+1],a[a.length]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>10)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>4&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((e&15)<< 2)+"=");return a.join("")}};Q.swapbuf=new ArrayBuffer(8);Q.ShortSwap=function(c){var a=new Uint8Array(Q.swapbuf,0,2),b=new Int16Array(Q.swapbuf,0,2);b[0]=c;c=a[0];a[0]=a[1];a[1]=c;return b[0]};Q.UShortSwap=function(c){var a=new Uint8Array(Q.swapbuf,0,2),b=new Uint16Array(Q.swapbuf,0,2);b[0]=c;c=a[0];a[0]=a[1];a[1]=c;return b[0]};Q.LongSwap=function(c){var a=new Uint8Array(Q.swapbuf),b=new Int32Array(Q.swapbuf);b[0]=b[1]=c;a[0]=a[7];a[1]=a[6];a[2]=a[5];a[3]=a[4];return b[0]}; Q.ULongSwap=function(c){var a=new Uint8Array(Q.swapbuf),b=new Uint32Array(Q.swapbuf);b[0]=b[1]=c;a[0]=a[7];a[1]=a[6];a[2]=a[5];a[3]=a[4];return b[0]};Q.FloatSwap=function(c){var a=new Uint8Array(Q.swapbuf),b=new Float32Array(Q.swapbuf);b[0]=b[1]=c;a[0]=a[7];a[1]=a[6];a[2]=a[5];a[3]=a[4];return b[0]};Q.NoSwap=function(c){return c};
var R={SplitEntityOnNode:function(a){if(a.contents!==Mod.contents.solid)if(0>a.contents)R.currententity.leafs[R.currententity.leafs.length]=a.num;else{var b=Vec.BoxOnPlaneSide(R.emins,R.emaxs,a.plane);0!==(b&1)&&R.SplitEntityOnNode(a.children[0]);0!==(b&2)&&R.SplitEntityOnNode(a.children[1])}},dlightframecount:0};R.lightstylevalue=new Uint8Array(new ArrayBuffer(64)); R.AnimateLight=function(){var a;if(0===R.fullbright.value){var b=Math.floor(10*CL.state.time);for(a=0;64>a;++a)R.lightstylevalue[a]=0===CL.lightstyle[a].length?12:CL.lightstyle[a].charCodeAt(b%CL.lightstyle[a].length)-97}else for(a=0;64>a;++a)R.lightstylevalue[a]=12;GL.Bind(0,R.lightstyle_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,64,1,0,gl.ALPHA,gl.UNSIGNED_BYTE,R.lightstylevalue)}; R.RenderDlights=function(){if(0!==R.flashblend.value){++R.dlightframecount;gl.enable(gl.BLEND);var a=GL.UseProgram("Dlight"),b;gl.bindBuffer(gl.ARRAY_BUFFER,R.dlightvecs);gl.vertexAttribPointer(a.aPoint,3,gl.FLOAT,!1,0,0);for(i=0;31>=i;++i)b=CL.dlights[i],b.die<CL.state.time||0===b.radius||(Vec.Length([b.origin[0]-R.refdef.vieworg[0],b.origin[1]-R.refdef.vieworg[1],b.origin[2]-R.refdef.vieworg[2]])<0.35*b.radius?(b=3E-4*b.radius,V.blend[3]+=b*(1-V.blend[3]),b/=V.blend[3],V.blend[0]=V.blend[1]*(1- b)+255*b,V.blend[1]=V.blend[1]*(1-b)+127.5*b,V.blend[2]*=1-b):(gl.uniform3fv(a.uOrigin,b.origin),gl.uniform1f(a.uRadius,b.radius),gl.drawArrays(gl.TRIANGLE_FAN,0,18)));gl.disable(gl.BLEND)}}; R.MarkLights=function(a,b,d){if(!(0>d.contents)){var c=d.plane.normal,c=a.origin[0]*c[0]+a.origin[1]*c[1]+a.origin[2]*c[2]-d.plane.dist;if(c>a.radius)R.MarkLights(a,b,d.children[0]);else{if(!(c<-a.radius)){for(var f,c=0;c<d.numfaces;++c)f=CL.state.worldmodel.faces[d.firstface+c],!0===f.sky||!0===f.turbulent||(f.dlightframe!==R.dlightframecount+1&&(f.dlightbits=0,f.dlightframe=R.dlightframecount+1),f.dlightbits+=b);R.MarkLights(a,b,d.children[0])}R.MarkLights(a,b,d.children[1])}}}; R.PushDlights=function(){if(0===R.flashblend.value){var a;for(a=0;1023>=a;++a)R.lightmap_modified[a]=!1;var b,d=1,c,f;for(a=0;31>=a;++a){b=CL.dlights[a];if(b.die>=CL.state.time&&0!==b.radius){R.MarkLights(b,d,CL.state.worldmodel.nodes[0]);for(c=0;c<CL.numvisedicts;++c)f=CL.visedicts[c],null!=f.model&&(f.model.type!==Mod.type.brush||!0!==f.model.submodel||R.MarkLights(b,d,CL.state.worldmodel.nodes[f.model.headnode[0]]))}d+=d}for(a=0;a<CL.state.worldmodel.faces.length;++a)b=CL.state.worldmodel.faces[a], b.dlightframe===R.dlightframecount?R.RemoveDynamicLights(b):b.dlightframe===R.dlightframecount+1&&R.AddDynamicLights(b);GL.Bind(0,R.dlightmap_texture);var e;for(a=0;1023>=a;++a)null==e&&!0===R.lightmap_modified[a]?e=a:null!=e&&!0!==R.lightmap_modified[a]&&(gl.texSubImage2D(gl.TEXTURE_2D,0,0,e,1024,a-e,gl.ALPHA,gl.UNSIGNED_BYTE,R.dlightmaps.subarray(e<<10,a<<10)),e=null);null!=e&&gl.texSubImage2D(gl.TEXTURE_2D,0,0,e,1024,1024-e,gl.ALPHA,gl.UNSIGNED_BYTE,R.dlightmaps.subarray(e<<10,1048576));++R.dlightframecount}}; R.RecursiveLightPoint=function(a,b,d){if(0>a.contents)return-1;var c=a.plane.normal,f=b[0]*c[0]+b[1]*c[1]+b[2]*c[2]-a.plane.dist,e=d[0]*c[0]+d[1]*c[1]+d[2]*c[2]-a.plane.dist,c=0>f;if(0>e===c)return R.RecursiveLightPoint(a.children[!0===c?1:0],b,d);var f=f/(f-e),f=[b[0]+(d[0]-b[0])*f,b[1]+(d[1]-b[1])*f,b[2]+(d[2]-b[2])*f],g=R.RecursiveLightPoint(a.children[!0===c?1:0],b,f);if(0<=g)return g;if(0>e===c)return-1;for(var h,g=0;g<a.numfaces;++g)if(b=CL.state.worldmodel.faces[a.firstface+g],!(!0===b.sky|| !0===b.turbulent))if(h=CL.state.worldmodel.texinfo[b.texinfo],e=Vec.DotProduct(f,h.vecs[0])+h.vecs[0][3],h=Vec.DotProduct(f,h.vecs[1])+h.vecs[1][3],!(e<b.texturemins[0]||h<b.texturemins[1]))if(e-=b.texturemins[0],h-=b.texturemins[1],!(e>b.extents[0]||h>b.extents[1])){if(0===b.lightofs)return 0;e>>=4;h>>=4;a=b.lightofs;if(0===a)return 0;a+=h*((b.extents[0]>>4)+1)+e;g=0;d=((b.extents[0]>>4)+1)*((b.extents[1]>>4)+1);for(c=0;c<b.styles.length;++c)g+=22*CL.state.worldmodel.lightdata[a]*R.lightstylevalue[b.styles[c]], a+=d;return g>>8}return R.RecursiveLightPoint(a.children[!0!==c?1:0],f,d)};R.LightPoint=function(a){if(null==CL.state.worldmodel.lightdata)return 255;a=R.RecursiveLightPoint(CL.state.worldmodel.nodes[0],a,[a[0],a[1],a[2]-2048]);return-1===a?0:a};R.visframecount=0;R.frustum=[{},{},{},{}];R.vup=[];R.vpn=[];R.vright=[];R.refdef={vrect:{},vieworg:[0,0,0],viewangles:[0,0,0]}; R.CullBox=function(a,b){if(2===Vec.BoxOnPlaneSide(a,b,R.frustum[0])||2===Vec.BoxOnPlaneSide(a,b,R.frustum[1])||2===Vec.BoxOnPlaneSide(a,b,R.frustum[2])||2===Vec.BoxOnPlaneSide(a,b,R.frustum[3]))return!0}; R.DrawSpriteModel=function(a){var b;!0===a.model.oriented?(b=GL.UseProgram("SpriteOriented"),gl.uniformMatrix3fv(b.uAngles,!1,GL.RotationMatrix(a.angles[0],a.angles[1]-90,a.angles[2]))):b=GL.UseProgram("Sprite");var d=a.frame;if(d>=a.model.numframes||0>d)Con.DPrint("R.DrawSpriteModel: no such frame "+d+"\n"),d=0;var c=a.model.frames[d];if(!0===c.group){var f,e;e=CL.state.time+a.syncbase;d=c.frames.length-1;f=c.frames[d].interval;f=e-Math.floor(e/f)*f;for(e=0;e<d&&!(c.frames[e].interval>f);++e);c= c.frames[e]}gl.uniform4f(b.uRect,c.origin[0],c.origin[1],c.width,c.height);gl.uniform3fv(b.uOrigin,a.origin);GL.Bind(b.tTexture,c.texturenum);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(b.aPoint,2,gl.FLOAT,!1,0,0);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}; R.avertexnormals=[[-0.525731,0,0.850651],[-0.442863,0.238856,0.864188],[-0.295242,0,0.955423],[-0.309017,0.5,0.809017],[-0.16246,0.262866,0.951056],[0,0,1],[0,0.850651,0.525731],[-0.147621,0.716567,0.681718],[0.147621,0.716567,0.681718],[0,0.525731,0.850651],[0.309017,0.5,0.809017],[0.525731,0,0.850651],[0.295242,0,0.955423],[0.442863,0.238856,0.864188],[0.16246,0.262866,0.951056],[-0.681718,0.147621,0.716567],[-0.809017,0.309017,0.5],[-0.587785,0.425325,0.688191],[-0.850651,0.525731,0],[-0.864188, 0.442863,0.238856],[-0.716567,0.681718,0.147621],[-0.688191,0.587785,0.425325],[-0.5,0.809017,0.309017],[-0.238856,0.864188,0.442863],[-0.425325,0.688191,0.587785],[-0.716567,0.681718,-0.147621],[-0.5,0.809017,-0.309017],[-0.525731,0.850651,0],[0,0.850651,-0.525731],[-0.238856,0.864188,-0.442863],[0,0.955423,-0.295242],[-0.262866,0.951056,-0.16246],[0,1,0],[0,0.955423,0.295242],[-0.262866,0.951056,0.16246],[0.238856,0.864188,0.442863],[0.262866,0.951056,0.16246],[0.5,0.809017,0.309017],[0.238856, 0.864188,-0.442863],[0.262866,0.951056,-0.16246],[0.5,0.809017,-0.309017],[0.850651,0.525731,0],[0.716567,0.681718,0.147621],[0.716567,0.681718,-0.147621],[0.525731,0.850651,0],[0.425325,0.688191,0.587785],[0.864188,0.442863,0.238856],[0.688191,0.587785,0.425325],[0.809017,0.309017,0.5],[0.681718,0.147621,0.716567],[0.587785,0.425325,0.688191],[0.955423,0.295242,0],[1,0,0],[0.951056,0.16246,0.262866],[0.850651,-0.525731,0],[0.955423,-0.295242,0],[0.864188,-0.442863,0.238856],[0.951056,-0.16246,0.262866], [0.809017,-0.309017,0.5],[0.681718,-0.147621,0.716567],[0.850651,0,0.525731],[0.864188,0.442863,-0.238856],[0.809017,0.309017,-0.5],[0.951056,0.16246,-0.262866],[0.525731,0,-0.850651],[0.681718,0.147621,-0.716567],[0.681718,-0.147621,-0.716567],[0.850651,0,-0.525731],[0.809017,-0.309017,-0.5],[0.864188,-0.442863,-0.238856],[0.951056,-0.16246,-0.262866],[0.147621,0.716567,-0.681718],[0.309017,0.5,-0.809017],[0.425325,0.688191,-0.587785],[0.442863,0.238856,-0.864188],[0.587785,0.425325,-0.688191],[0.688191, 0.587785,-0.425325],[-0.147621,0.716567,-0.681718],[-0.309017,0.5,-0.809017],[0,0.525731,-0.850651],[-0.525731,0,-0.850651],[-0.442863,0.238856,-0.864188],[-0.295242,0,-0.955423],[-0.16246,0.262866,-0.951056],[0,0,-1],[0.295242,0,-0.955423],[0.16246,0.262866,-0.951056],[-0.442863,-0.238856,-0.864188],[-0.309017,-0.5,-0.809017],[-0.16246,-0.262866,-0.951056],[0,-0.850651,-0.525731],[-0.147621,-0.716567,-0.681718],[0.147621,-0.716567,-0.681718],[0,-0.525731,-0.850651],[0.309017,-0.5,-0.809017],[0.442863, -0.238856,-0.864188],[0.16246,-0.262866,-0.951056],[0.238856,-0.864188,-0.442863],[0.5,-0.809017,-0.309017],[0.425325,-0.688191,-0.587785],[0.716567,-0.681718,-0.147621],[0.688191,-0.587785,-0.425325],[0.587785,-0.425325,-0.688191],[0,-0.955423,-0.295242],[0,-1,0],[0.262866,-0.951056,-0.16246],[0,-0.850651,0.525731],[0,-0.955423,0.295242],[0.238856,-0.864188,0.442863],[0.262866,-0.951056,0.16246],[0.5,-0.809017,0.309017],[0.716567,-0.681718,0.147621],[0.525731,-0.850651,0],[-0.238856,-0.864188,-0.442863], [-0.5,-0.809017,-0.309017],[-0.262866,-0.951056,-0.16246],[-0.850651,-0.525731,0],[-0.716567,-0.681718,-0.147621],[-0.716567,-0.681718,0.147621],[-0.525731,-0.850651,0],[-0.5,-0.809017,0.309017],[-0.238856,-0.864188,0.442863],[-0.262866,-0.951056,0.16246],[-0.864188,-0.442863,0.238856],[-0.809017,-0.309017,0.5],[-0.688191,-0.587785,0.425325],[-0.681718,-0.147621,0.716567],[-0.442863,-0.238856,0.864188],[-0.587785,-0.425325,0.688191],[-0.309017,-0.5,0.809017],[-0.147621,-0.716567,0.681718],[-0.425325, -0.688191,0.587785],[-0.16246,-0.262866,0.951056],[0.442863,-0.238856,0.864188],[0.16246,-0.262866,0.951056],[0.309017,-0.5,0.809017],[0.147621,-0.716567,0.681718],[0,-0.525731,0.850651],[0.425325,-0.688191,0.587785],[0.587785,-0.425325,0.688191],[0.688191,-0.587785,0.425325],[-0.955423,0.295242,0],[-0.951056,0.16246,0.262866],[-1,0,0],[-0.850651,0,0.525731],[-0.955423,-0.295242,0],[-0.951056,-0.16246,0.262866],[-0.864188,0.442863,-0.238856],[-0.951056,0.16246,-0.262866],[-0.809017,0.309017,-0.5], [-0.864188,-0.442863,-0.238856],[-0.951056,-0.16246,-0.262866],[-0.809017,-0.309017,-0.5],[-0.681718,0.147621,-0.716567],[-0.681718,-0.147621,-0.716567],[-0.850651,0,-0.525731],[-0.688191,0.587785,-0.425325],[-0.587785,0.425325,-0.688191],[-0.425325,0.688191,-0.587785],[-0.425325,-0.688191,-0.587785],[-0.587785,-0.425325,-0.688191],[-0.688191,-0.587785,-0.425325]]; R.DrawAliasModel=function(a){var b=a.model;if(!0!==R.CullBox([a.origin[0]-b.boundingradius,a.origin[1]-b.boundingradius,a.origin[2]-b.boundingradius],[a.origin[0]+b.boundingradius,a.origin[1]+b.boundingradius,a.origin[2]+b.boundingradius])){var d;if(0!==a.colormap&&!0===b.player&&0===R.nocolors.value){d=GL.UseProgram("Player");var c=CL.state.scores[a.colormap-1].colors&240,f=(CL.state.scores[a.colormap-1].colors&15)<<4;127>=c&&(c+=15);127>=f&&(f+=15);c=VID.d_8to24table[c]&16777215;f=VID.d_8to24table[f]& 16777215;gl.uniform3f(d.uTop,c&255,c>>8&255,c>>16);gl.uniform3f(d.uBottom,f&255,f>>8&255,f>>16)}else d=GL.UseProgram("Alias");gl.uniform3fv(d.uOrigin,a.origin);gl.uniformMatrix3fv(d.uAngles,!1,GL.RotationMatrix(a.angles[0],a.angles[1],a.angles[2]));var e=f=R.LightPoint(a.origin);a===CL.state.viewent&&24>f&&(f=e=24);for(var g,c=0;31>=c;++c)g=CL.dlights[c],g.die<CL.state.time||(g=g.radius-Vec.Length([a.origin[0]-g.origin[0],a.origin[1]-g.origin[1],a.origin[1]-g.origin[1]]),0<g&&(f+=g,e+=g));128<f&& (f=128);192<f+e&&(e=192-f);1<=a.num&&(a.num<=CL.state.maxclients&&8>f)&&(f=e=8);gl.uniform1f(d.uAmbientLight,0.0078125*f);gl.uniform1f(d.uShadeLight,0.0078125*e);c=[];f=[];e=[];Vec.AngleVectors(a.angles,c,f,e);gl.uniform3fv(d.uLightVec,[Vec.DotProduct([-1,0,0],c),-Vec.DotProduct([-1,0,0],f),Vec.DotProduct([-1,0,0],e)]);R.c_alias_polys+=b.numtris;e=CL.state.time+a.syncbase;f=a.frame;if(f>=b.numframes||0>f)Con.DPrint("R.DrawAliasModel: no such frame "+f+"\n"),f=0;var h=b.frames[f];if(!0===h.group){f= h.frames.length-1;c=h.frames[f].interval;g=e-Math.floor(e/c)*c;for(c=0;c<f&&!(h.frames[c].interval>g);++c);h=h.frames[c]}gl.bindBuffer(gl.ARRAY_BUFFER,b.cmds);gl.vertexAttribPointer(d.aPoint,3,gl.FLOAT,!1,24,h.cmdofs);gl.vertexAttribPointer(d.aLightNormal,3,gl.FLOAT,!1,24,h.cmdofs+12);gl.vertexAttribPointer(d.aTexCoord,2,gl.FLOAT,!1,0,0);f=a.skinnum;if(f>=b.numskins||0>f)Con.DPrint("R.DrawAliasModel: no such skin # "+f+"\n"),f=0;a=b.skins[f];if(!0===a.group){f=a.skins.length-1;c=a.skins[f].interval; g=e-Math.floor(e/c)*c;for(c=0;c<f&&!(a.skins[c].interval>g);++c);a=a.skins[c]}GL.Bind(d.tTexture,a.texturenum.texnum);!0===b.player&&GL.Bind(d.tPlayer,a.playertexture);gl.drawArrays(gl.TRIANGLES,0,3*b.numtris)}}; R.DrawEntitiesOnList=function(){if(0!==R.drawentities.value){var a=0!==R.novis.value?Mod.novis:Mod.LeafPVS(R.viewleaf,CL.state.worldmodel),b,d,c;for(b=0;b<CL.state.num_statics;++b)if(R.currententity=CL.static_entities[b],null!=R.currententity.model){for(d=0;d<R.currententity.leafs.length&&!(c=R.currententity.leafs[d],0!==(a[c>>3]&1<<(c&7)));++d);if(d!==R.currententity.leafs.length)switch(R.currententity.model.type){case Mod.type.alias:R.DrawAliasModel(R.currententity);continue;case Mod.type.brush:R.DrawBrushModel(R.currententity)}}for(b= 0;b<CL.numvisedicts;++b)if(R.currententity=CL.visedicts[b],null!=R.currententity.model)switch(R.currententity.model.type){case Mod.type.alias:R.DrawAliasModel(R.currententity);continue;case Mod.type.brush:R.DrawBrushModel(R.currententity)}gl.depthMask(!1);gl.enable(gl.BLEND);for(b=0;b<CL.state.num_statics;++b)R.currententity=CL.static_entities[b],null!=R.currententity.model&&R.currententity.model.type===Mod.type.sprite&&R.DrawSpriteModel(R.currententity);for(b=0;b<CL.numvisedicts;++b)R.currententity= CL.visedicts[b],null!=R.currententity.model&&R.currententity.model.type===Mod.type.sprite&&R.DrawSpriteModel(R.currententity);gl.disable(gl.BLEND);gl.depthMask(!0)}}; R.DrawViewModel=function(){if(0!==R.drawviewmodel.value&&0===Chase.active.value&&0!==R.drawentities.value&&0===(CL.state.items&Def.it.invisibility)&&!(0>=CL.state.stats[Def.stat.health])&&null!=CL.state.viewent.model){gl.depthRange(0,0.3);var a=4*Math.tan(0.82*SCR.fov.value*Math.PI/360);R.perspective[0]=4/(a*R.refdef.vrect.width/R.refdef.vrect.height);R.perspective[5]=4/a;a=GL.UseProgram("Alias");gl.uniformMatrix4fv(a.uPerspective,!1,R.perspective);R.DrawAliasModel(CL.state.viewent);a=4*Math.tan(R.refdef.fov_y* Math.PI/360);R.perspective[0]=4/(a*R.refdef.vrect.width/R.refdef.vrect.height);R.perspective[5]=4/a;a=GL.UseProgram("Alias");gl.uniformMatrix4fv(a.uPerspective,!1,R.perspective);gl.depthRange(0,1)}}; R.PolyBlend=function(){if(0!==R.polyblend.value&&0!==V.blend[3]){var a=GL.UseProgram("Fill");gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(a.aPoint,2,gl.FLOAT,!1,0,0);var b=R.refdef.vrect;gl.uniform4f(a.uRect,b.x,b.y,b.width,b.height);gl.uniform4fv(a.uColor,V.blend);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}}; R.SetFrustum=function(){R.frustum[0].normal=Vec.RotatePointAroundVector(R.vup,R.vpn,-(90-0.5*R.refdef.fov_x));R.frustum[1].normal=Vec.RotatePointAroundVector(R.vup,R.vpn,90-0.5*R.refdef.fov_x);R.frustum[2].normal=Vec.RotatePointAroundVector(R.vright,R.vpn,90-0.5*R.refdef.fov_y);R.frustum[3].normal=Vec.RotatePointAroundVector(R.vright,R.vpn,-(90-0.5*R.refdef.fov_y));var a,b;for(a=0;3>=a;++a)b=R.frustum[a],b.type=Mod.planetype.anyz,b.dist=Vec.DotProduct(R.refdef.vieworg,b.normal),b.signbits=0,0>b.normal[0]&& (b.signbits=1),0>b.normal[1]&&(b.signbits+=2),0>b.normal[2]&&(b.signbits+=4),0>b.normal[3]&&(b.signbits+=8)};R.perspective=[0,0,0,0,0,0,0,0,0,0,-8196/8188,-1,0,0,-65536/8188,0]; R.Perspective=function(){var a=[R.refdef.viewangles[0]*Math.PI/180,(R.refdef.viewangles[1]-90)*Math.PI/-180,R.refdef.viewangles[2]*Math.PI/-180],b=Math.sin(a[0]),d=Math.cos(a[0]),c=Math.sin(a[1]),f=Math.cos(a[1]),e=Math.sin(a[2]),a=Math.cos(a[2]),b=[a*f+e*b*c,d*c,-e*f+a*b*c,a*-c+e*b*f,d*f,-e*-c+a*b*f,e*d,-b,a*d];GL.UnbindProgram();for(d=0;d<GL.programs.length;++d)c=GL.programs[d],gl.useProgram(c.program),null!=c.uViewOrigin&&gl.uniform3fv(c.uViewOrigin,R.refdef.vieworg),null!=c.uViewAngles&&gl.uniformMatrix3fv(c.uViewAngles, !1,b),null!=c.uPerspective&&gl.uniformMatrix4fv(c.uPerspective,!1,R.perspective)};R.SetupGL=function(){var a=R.refdef.vrect;!0===R.dowarp?(gl.bindFramebuffer(gl.FRAMEBUFFER,R.warpbuffer),gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT),gl.viewport(0,0,R.warpwidth,R.warpheight)):gl.viewport(a.x,VID.height-a.height-a.y,a.width,a.height);R.Perspective();gl.enable(gl.DEPTH_TEST)}; R.RenderScene=function(){2<=CL.state.maxclients&&Cvar.Set("r_fullbright","0");R.AnimateLight();Vec.AngleVectors(R.refdef.viewangles,R.vpn,R.vright,R.vup);R.viewleaf=Mod.PointInLeaf(R.refdef.vieworg,CL.state.worldmodel);V.SetContentsColor(R.viewleaf.contents);V.CalcBlend();R.dowarp=0!==R.waterwarp.value&&R.viewleaf.contents<=Mod.contents.water;R.SetFrustum();R.SetupGL();R.MarkLeaves();gl.enable(gl.CULL_FACE);R.DrawViewModel();R.DrawWorld();R.DrawEntitiesOnList();gl.disable(gl.CULL_FACE);R.DrawSkyBox(); R.RenderDlights();R.DrawParticles()};R.RenderView=function(){gl.finish();var a;0!==R.speeds.value&&(a=Sys.FloatTime());R.c_brush_verts=0;R.c_alias_polys=0;gl.clear(gl.COLOR_BUFFER_BIT+gl.DEPTH_BUFFER_BIT);R.RenderScene();if(0!==R.speeds.value){var b=Math.floor(1E3*(Sys.FloatTime()-a)),d=R.c_brush_verts/3;a=R.c_alias_polys;b=(100<=b?"":10<=b?" ":" ")+b+" ms "+((1E3<=d?"":100<=d?" ":10<=d?" ":" ")+d+" wpoly ");b+=(1E3<=a?"":100<=a?" ":10<=a?" ":" ")+a+" epoly\n";Con.Print(b)}}; R.MakeBrushModelDisplayLists=function(a){null!=a.cmds&&gl.deleteBuffer(a.cmds);var b,d,c,f=[],e,g,h,j,k=0;a.chains=[];for(b=0;b<a.textures.length;++b)if(d=a.textures[b],!(!0===d.sky||!0===d.turbulent)){e=[b,k,0];for(d=0;d<a.numfaces;++d)if(g=a.faces[a.firstface+d],g.texture===b){j=[0,0,0,0];switch(g.styles.length){case 4:j[3]=0.015625*g.styles[3]+0.0078125;case 3:j[2]=0.015625*g.styles[2]+0.0078125;case 2:j[1]=0.015625*g.styles[1]+0.0078125;case 1:j[0]=0.015625*g.styles[0]+0.0078125}e[2]+=g.verts.length; for(c=0;c<g.verts.length;++c)h=g.verts[c],f[f.length]=h[0],f[f.length]=h[1],f[f.length]=h[2],f[f.length]=h[3],f[f.length]=h[4],f[f.length]=h[5],f[f.length]=h[6],f[f.length]=j[0],f[f.length]=j[1],f[f.length]=j[2],f[f.length]=j[3]}0!==e[2]&&(a.chains[a.chains.length]=e,k+=e[2])}a.waterchain=44*k;for(b=k=0;b<a.textures.length;++b)if(d=a.textures[b],!(!0===d.sky||!0!==d.turbulent)){for(d=0;d<a.numfaces;++d)if(g=a.faces[a.firstface+d],g.texture===b){e[2]+=g.verts.length;for(c=0;c<g.verts.length;++c)h= g.verts[c],f[f.length]=h[0],f[f.length]=h[1],f[f.length]=h[2],f[f.length]=h[3],f[f.length]=h[4]}0!==e[2]&&(a.chains[a.chains.length]=e,k+=e[2])}a.cmds=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,a.cmds);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(f),gl.STATIC_DRAW)}; R.MakeWorldModelDisplayLists=function(a){if(null==a.cmds){var b,d,c,f,e=[],g,h,j,k,l,m=0;for(b=0;b<a.textures.length;++b)if(d=a.textures[b],!(!0===d.sky||!0===d.turbulent))for(d=0;d<a.leafs.length;++d){g=a.leafs[d];h=[b,m,0];for(c=0;c<g.nummarksurfaces;++c)if(j=a.faces[a.marksurfaces[g.firstmarksurface+c]],j.texture===b){l=[0,0,0,0];switch(j.styles.length){case 4:l[3]=0.015625*j.styles[3]+0.0078125;case 3:l[2]=0.015625*j.styles[2]+0.0078125;case 2:l[1]=0.015625*j.styles[1]+0.0078125;case 1:l[0]=0.015625* j.styles[0]+0.0078125}h[2]+=j.verts.length;for(f=0;f<j.verts.length;++f)k=j.verts[f],e[e.length]=k[0],e[e.length]=k[1],e[e.length]=k[2],e[e.length]=k[3],e[e.length]=k[4],e[e.length]=k[5],e[e.length]=k[6],e[e.length]=l[0],e[e.length]=l[1],e[e.length]=l[2],e[e.length]=l[3]}0!==h[2]&&(g.cmds[g.cmds.length]=h,++g.waterchain,m+=h[2])}a.waterchain=44*m;for(b=m=0;b<a.textures.length;++b)if(d=a.textures[b],!(!0===d.sky||!0!==d.turbulent))for(d=0;d<a.leafs.length;++d){g=a.leafs[d];h=[b,m,0];for(c=0;c<g.nummarksurfaces;++c)if(j= a.faces[a.marksurfaces[g.firstmarksurface+c]],j.texture===b){h[2]+=j.verts.length;for(f=0;f<j.verts.length;++f)k=j.verts[f],e[e.length]=k[0],e[e.length]=k[1],e[e.length]=k[2],e[e.length]=k[3],e[e.length]=k[4]}0!==h[2]&&(g.cmds[g.cmds.length]=h,m+=h[2])}a.cmds=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,a.cmds);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e),gl.STATIC_DRAW)}}; R.InitTextures=function(){var a=new Uint8Array(new ArrayBuffer(256)),b,d;for(b=0;8>b;++b)for(d=0;8>d;++d)a[(b<<4)+d]=a[136+(b<<4)+d]=255,a[8+(b<<4)+d]=a[128+(b<<4)+d]=0;R.notexture_mip={name:"notexture",width:16,height:16,texturenum:gl.createTexture()};GL.Bind(0,R.notexture_mip.texturenum);GL.Upload(a,16,16);R.solidskytexture=gl.createTexture();GL.Bind(0,R.solidskytexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR); R.alphaskytexture=gl.createTexture();GL.Bind(0,R.alphaskytexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);R.lightmap_texture=gl.createTexture();GL.Bind(0,R.lightmap_texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);R.dlightmap_texture=gl.createTexture();GL.Bind(0,R.dlightmap_texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER, gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);R.lightstyle_texture=gl.createTexture();GL.Bind(0,R.lightstyle_texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);R.fullbright_texture=gl.createTexture();GL.Bind(0,R.fullbright_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([255,0,0,0]));gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);R.null_texture=gl.createTexture();GL.Bind(0,R.null_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,0]));gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}; R.Init=function(){R.InitTextures();Cmd.AddCommand("timerefresh",R.TimeRefresh_f);Cmd.AddCommand("pointfile",R.ReadPointFile_f);R.waterwarp=Cvar.RegisterVariable("r_waterwarp","1");R.fullbright=Cvar.RegisterVariable("r_fullbright","0");R.drawentities=Cvar.RegisterVariable("r_drawentities","1");R.drawviewmodel=Cvar.RegisterVariable("r_drawviewmodel","1");R.novis=Cvar.RegisterVariable("r_novis","0");R.speeds=Cvar.RegisterVariable("r_speeds","0");R.polyblend=Cvar.RegisterVariable("gl_polyblend","1"); R.flashblend=Cvar.RegisterVariable("gl_flashblend","0");R.nocolors=Cvar.RegisterVariable("gl_nocolors","0");R.InitParticles();GL.CreateProgram("Alias","uOrigin uAngles uViewOrigin uViewAngles uPerspective uLightVec uAmbientLight uShadeLight".split(" "),["aPoint","aLightNormal","aTexCoord"],["tTexture"]);GL.CreateProgram("Brush",["uOrigin","uAngles","uViewOrigin","uViewAngles","uPerspective"],["aPoint","aTexCoord","aLightStyle"],["tTexture","tLightmap","tDlight","tLightStyle"]);GL.CreateProgram("Dlight", ["uOrigin","uViewOrigin","uViewAngles","uPerspective","uRadius"],["aPoint"],[]);GL.CreateProgram("Player","uOrigin uAngles uViewOrigin uViewAngles uPerspective uLightVec uAmbientLight uShadeLight uTop uBottom".split(" "),["aPoint","aLightNormal","aTexCoord"],["tTexture","tPlayer"]);GL.CreateProgram("Sprite",["uRect","uOrigin","uViewOrigin","uViewAngles","uPerspective"],["aPoint"],["tTexture"]);GL.CreateProgram("SpriteOriented","uRect uOrigin uAngles uViewOrigin uViewAngles uPerspective".split(" "), ["aPoint"],["tTexture"]);GL.CreateProgram("Turbulent","uOrigin uAngles uViewOrigin uViewAngles uPerspective uTime".split(" "),["aPoint","aTexCoord"],["tTexture"]);GL.CreateProgram("Warp",["uRect","uOrtho","uTime"],["aPoint"],["tTexture"]);R.warpbuffer=gl.createFramebuffer();R.warptexture=gl.createTexture();GL.Bind(0,R.warptexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);R.warprenderbuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,R.warprenderbuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,0,0);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,R.warpbuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,R.warptexture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER, R.warprenderbuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,null);R.dlightvecs=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,R.dlightvecs);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,-1,0,0,0,1,-0.382683,0,0.92388,-0.707107,0,0.707107,-0.92388,0,0.382683,-1,0,0,-0.92388,0,-0.382683,-0.707107,0,-0.707107,-0.382683,0,-0.92388,0,0,-1,0.382683,0,-0.92388,0.707107,0,-0.707107,0.92388,0,-0.382683,1,0,0,0.92388,0,0.382683,0.707107,0,0.707107,0.382683,0,0.92388,0,0,1]),gl.STATIC_DRAW);R.MakeSky()}; R.NewMap=function(){var a;for(a=0;64>a;++a)R.lightstylevalue[a]=12;R.ClearParticles();R.BuildLightmaps();for(a=0;1048575>=a;++a)R.dlightmaps[a]=0;GL.Bind(0,R.dlightmap_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,1024,1024,0,gl.ALPHA,gl.UNSIGNED_BYTE,null)};R.TimeRefresh_f=function(){gl.finish();var a,b=Sys.FloatTime();for(a=0;127>=a;++a)R.refdef.viewangles[1]=2.8125*a,R.RenderView();gl.finish();a=Sys.FloatTime()-b;Con.Print(a.toFixed(6)+" seconds ("+(128/a).toFixed(6)+" fps)\n")}; R.ptype={tracer:0,grav:1,slowgrav:2,fire:3,explode:4,explode2:5,blob:6,blob2:7};R.ramp1=[111,109,107,105,103,101,99,97];R.ramp2=[111,110,109,108,107,106,104,102];R.ramp3=[109,107,6,5,4,3]; R.InitParticles=function(){var a=COM.CheckParm("-particles");null!=a?(R.numparticles=Q.atoi(COM.argv[a+1]),512>R.numparticles&&(R.numparticles=512)):R.numparticles=2048;R.avelocities=[];for(a=0;161>=a;++a)R.avelocities[a]=[2.56*Math.random(),2.56*Math.random(),2.56*Math.random()];GL.CreateProgram("Particle","uOrigin uViewOrigin uViewAngles uPerspective uScale uColor".split(" "),["aPoint"],[])}; R.EntityParticles=function(a){var b=R.AllocParticles(162),d,c,f,e,g;for(d=0;d<b.length;++d)c=CL.state.time*R.avelocities[d][0],f=Math.sin(c),g=Math.cos(c),c=CL.state.time*R.avelocities[d][1],e=Math.sin(c),c=Math.cos(c),R.particles[b[d]]={die:CL.state.time+0.01,color:111,ramp:0,type:R.ptype.explode,org:[a.origin[0]+64*R.avertexnormals[d][0]+16*g*c,a.origin[1]+64*R.avertexnormals[d][1]+16*g*e,a.origin[2]+64*R.avertexnormals[d][2]+-16*f],vel:[0,0,0]}}; R.ClearParticles=function(){var a;R.particles=[];for(a=0;a<R.numparticles;++a)R.particles[a]={die:-1}}; R.ReadPointFile_f=function(){if(!0===SV.server.active){var a="maps/"+PR.GetString(PR.globals_int[PR.globalvars.mapname])+".pts",b=COM.LoadTextFile(a);if(null==b)Con.Print("couldn't open "+a+"\n");else{Con.Print("Reading "+a+"...\n");for(var b=b.split("\n"),d,c,a=0;a<b.length;){d=b[a].split(" ");if(3!==d.length)break;++a;c=R.AllocParticles(1);if(0===c.length){Con.Print("Not enough free particles\n");break}R.particles[c[0]]={die:99999,color:-a&15,type:R.ptype.tracer,vel:[0,0,0],org:[Q.atof(d[0]),Q.atof(d[1]), Q.atof(d[2])]}}Con.Print(a+" points read\n")}}};R.ParseParticleEffect=function(){var a=[MSG.ReadCoord(),MSG.ReadCoord(),MSG.ReadCoord()],b=[0.0625*MSG.ReadChar(),0.0625*MSG.ReadChar(),0.0625*MSG.ReadChar()],d=MSG.ReadByte(),c=MSG.ReadByte();255===d?R.ParticleExplosion(a):R.RunParticleEffect(a,b,c,d)}; R.ParticleExplosion=function(a){var b=R.AllocParticles(1024),d;for(d=0;d<b.length;++d)R.particles[b[d]]={die:CL.state.time+5,color:R.ramp1[0],ramp:Math.floor(4*Math.random()),type:0!==(d&1)?R.ptype.explode:R.ptype.explode2,org:[a[0]+32*Math.random()-16,a[1]+32*Math.random()-16,a[2]+32*Math.random()-16],vel:[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]}}; R.ParticleExplosion2=function(a,b,d){var c=R.AllocParticles(512),f,e=0;for(f=0;f<c.length;++f)R.particles[c[f]]={die:CL.state.time+0.3,color:b+e++%d,type:R.ptype.blob,org:[a[0]+32*Math.random()-16,a[1]+32*Math.random()-16,a[2]+32*Math.random()-16],vel:[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]}}; R.BlobExplosion=function(a){var b=R.AllocParticles(1024),d,c;for(d=0;d<b.length;++d)c=R.particles[b[d]],c.die=CL.state.time+1+0.4*Math.random(),0!==(d&1)?(c.type=R.ptype.blob,c.color=66+Math.floor(7*Math.random())):(c.type=R.ptype.blob2,c.color=150+Math.floor(7*Math.random())),c.org=[a[0]+32*Math.random()-16,a[1]+32*Math.random()-16,a[2]+32*Math.random()-16],c.vel=[512*Math.random()-256,512*Math.random()-256,512*Math.random()-256]}; R.RunParticleEffect=function(a,b,d,c){c=R.AllocParticles(c);var f;for(f=0;f<c.length;++f)R.particles[c[f]]={die:CL.state.time+0.6*Math.random(),color:(d&248)+Math.floor(8*Math.random()),type:R.ptype.slowgrav,org:[a[0]+16*Math.random()-8,a[1]+16*Math.random()-8,a[2]+16*Math.random()-8],vel:[15*b[0],15*b[1],15*b[2]]}}; R.LavaSplash=function(a){var b=R.AllocParticles(1024),d,c,f=0,e,g=[],h;for(d=-16;15>=d;++d)for(c=-16;15>=c;++c){if(f>=b.length)return;e=R.particles[b[f++]];e.die=CL.state.time+2+0.64*Math.random();e.color=224+Math.floor(8*Math.random());e.type=R.ptype.slowgrav;g[0]=8*(c+Math.random);g[1]=8*(d+Math.random);g[2]=256;e.org=[a[0]+g[0],a[1]+g[1],a[2]+64*Math.random()];Vec.Normalize(g);h=50+64*Math.random();e.vel=[g[0]*h,g[1]*h,g[2]*h]}}; R.TeleportSplash=function(a){var b=R.AllocParticles(896),d,c,f,e=0,g,h=[],j;for(d=-16;15>=d;d+=4)for(c=-16;15>=c;c+=4)for(f=-24;31>=f;f+=4){if(e>=b.length)return;g=R.particles[b[e++]];g.die=CL.state.time+0.2+0.16*Math.random();g.color=7+Math.floor(8*Math.random());g.type=R.ptype.slowgrav;h[0]=8*c;h[1]=8*d;h[2]=8*f;g.org=[a[0]+d+4*Math.random(),a[1]+c+4*Math.random(),a[2]+f+4*Math.random()];Vec.Normalize(h);j=50+64*Math.random();g.vel=[h[0]*j,h[1]*j,h[2]*j]}};R.tracercount=0; R.RocketTrail=function(a,b,d){b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];var c=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);if(0!==c){b=[b[0]/c,b[1]/c,b[2]/c];var c=4===d?R.AllocParticles(Math.floor(c/6)):R.AllocParticles(Math.floor(c/3)),f,e;for(f=0;f<c.length;++f){e=R.particles[c[f]];e.vel=[0,0,0];e.die=CL.state.time+2;switch(d){case 0:case 1:e.ramp=Math.floor(4*Math.random())+(d<<1);e.color=R.ramp3[e.ramp];e.type=R.ptype.fire;e.org=[a[0]+6*Math.random()-3,a[1]+6*Math.random()-3,a[2]+6*Math.random()-3];break; case 2:e.type=R.ptype.grav;e.color=67+Math.floor(4*Math.random());e.org=[a[0]+6*Math.random()-3,a[1]+6*Math.random()-3,a[2]+6*Math.random()-3];break;case 3:case 5:e.die=CL.state.time+0.5;e.type=R.ptype.tracer;e.color=3===d?52+((R.tracercount++&4)<<1):230+((R.tracercount++&4)<<1);e.org=[a[0],a[1],a[2]];0!==(R.tracercount&1)?(e.vel[0]=30*b[1],e.vel[2]=-30*b[0]):(e.vel[0]=-30*b[1],e.vel[2]=30*b[0]);break;case 4:e.type=R.ptype.grav;e.color=67+Math.floor(4*Math.random());e.org=[a[0]+6*Math.random()-3, a[1]+6*Math.random()-3,a[2]+6*Math.random()-3];break;case 6:e.color=152+Math.floor(4*Math.random()),e.type=R.ptype.tracer,e.die=CL.state.time+0.3,e.org=[a[0]+16*Math.random()-8,a[1]+16*Math.random()-8,a[2]+16*Math.random()-8]}a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]}}}; R.DrawParticles=function(){var a=GL.UseProgram("Particle");gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(a.aPoint,2,gl.FLOAT,!1,0,0);gl.depthMask(!1);gl.enable(gl.BLEND);var b=CL.state.time-CL.state.oldtime,d=0.05*b*SV.gravity.value,c=4*b,f,e,g;for(e=0;e<R.numparticles;++e)if(g=R.particles[e],!(g.die<CL.state.time))switch(f=VID.d_8to24table[g.color]&16777215,gl.uniform3f(a.uColor,f&255,f>>8&255,f>>16),gl.uniform3fv(a.uOrigin,g.org),f=(g.org[0]-R.refdef.vieworg[0])*R.vpn[0]+(g.org[1]- R.refdef.vieworg[1])*R.vpn[1]+(g.org[2]-R.refdef.vieworg[2])*R.vpn[2],20>f?gl.uniform1f(a.uScale,0.75):gl.uniform1f(a.uScale,0.75+0.003*f),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),g.org[0]+=g.vel[0]*b,g.org[1]+=g.vel[1]*b,g.org[2]+=g.vel[2]*b,g.type){case R.ptype.fire:g.ramp+=5*b;6<=g.ramp?g.die=-1:g.color=R.ramp3[Math.floor(g.ramp)];g.vel[2]+=d;continue;case R.ptype.explode:g.ramp+=10*b;8<=g.ramp?g.die=-1:g.color=R.ramp1[Math.floor(g.ramp)];g.vel[0]+=g.vel[0]*c;g.vel[1]+=g.vel[1]*c;g.vel[2]+=g.vel[2]* c-d;continue;case R.ptype.explode2:g.ramp+=15*b;8<=g.ramp?g.die=-1:g.color=R.ramp2[Math.floor(g.ramp)];g.vel[0]-=g.vel[0]*b;g.vel[1]-=g.vel[1]*b;g.vel[2]-=g.vel[2]*b+d;continue;case R.ptype.blob:g.vel[0]+=g.vel[0]*c;g.vel[1]+=g.vel[1]*c;g.vel[2]+=g.vel[2]*c-d;continue;case R.ptype.blob2:g.vel[0]+=g.vel[0]*c;g.vel[1]+=g.vel[1]*c;g.vel[2]-=d;continue;case R.ptype.grav:case R.ptype.slowgrav:g.vel[2]-=d}gl.disable(gl.BLEND);gl.depthMask(!0)}; R.AllocParticles=function(a){var b=[],d;for(d=0;d<R.numparticles&&0!==a;++d)R.particles[d].die<CL.state.time&&(b[b.length]=d,--a);return b};R.lightmap_modified=[];R.lightmaps=new Uint8Array(new ArrayBuffer(4194304));R.dlightmaps=new Uint8Array(new ArrayBuffer(1048576)); R.AddDynamicLights=function(a){var b=(a.extents[0]>>4)+1,d=(a.extents[1]>>4)+1,c=b*d,f=CL.state.worldmodel.texinfo[a.texinfo],e,g,h,j,k,l=[],m=[],n,p=[];for(e=0;e<c;++e)p[e]=0;for(e=0;31>=e;++e)if(0!==(a.dlightbits>>>e&1)&&(c=CL.dlights[e],h=Vec.DotProduct(c.origin,a.plane.normal)-a.plane.dist,j=c.radius-Math.abs(h),k=c.minlight,!(j<k))){k=j-k;l[0]=c.origin[0]-a.plane.normal[0]*h;l[1]=c.origin[1]-a.plane.normal[1]*h;l[2]=c.origin[2]-a.plane.normal[2]*h;m[0]=Vec.DotProduct(l,f.vecs[0])+f.vecs[0][3]- a.texturemins[0];m[1]=Vec.DotProduct(l,f.vecs[1])+f.vecs[1][3]-a.texturemins[1];for(g=0;g<d;++g){n=m[1]-(g<<4);0>n&&(n=-n);n=Math.floor(n);for(c=0;c<b;++c)h=m[0]-(c<<4),0>h&&(h=-h),h=Math.floor(h),h=h>n?h+(n>>1):n+(h>>1),h<k&&(p[g*b+c]+=Math.floor(256*(j-h)))}}for(g=e=0;g<d;++g){R.lightmap_modified[a.light_t+g]=!0;f=(a.light_t+g<<10)+a.light_s;for(c=0;c<b;++c)l=p[e++]>>7,255<l&&(l=255),R.dlightmaps[f+c]=l}}; R.RemoveDynamicLights=function(a){var b=(a.extents[0]>>4)+1,d=(a.extents[1]>>4)+1,c,f,e;for(e=0;e<d;++e){R.lightmap_modified[a.light_t+e]=!0;c=(a.light_t+e<<10)+a.light_s;for(f=0;f<b;++f)R.dlightmaps[c+f]=0}}; R.BuildLightMap=function(a){var b,d=(a.extents[0]>>4)+1,c=(a.extents[1]>>4)+1,f,e,g=a.lightofs,h;for(h=0;h<a.styles.length;++h){b=(a.light_t<<12)+(a.light_s<<2)+h;for(f=0;f<c;++f){for(e=0;e<d;++e)R.lightmaps[b+(e<<2)]=R.currentmodel.lightdata[g+e];g+=d;b+=4096}}for(;3>=h;++h){b=(a.light_t<<12)+(a.light_s<<2)+h;for(f=0;f<c;++f){for(e=0;e<d;++e)R.lightmaps[b+(e<<2)]=0;b+=4096}}}; R.TextureAnimation=function(a){var b=0;null!=a.anim_base&&(b=a.anim_frame,a=R.currententity.model.textures[a.anim_base]);var d=a.anims;if(null==d)return a;0!==R.currententity.frame&&0!==a.alternate_anims.length&&(d=a.alternate_anims);return R.currententity.model.textures[d[(Math.floor(5*CL.state.time)+b)%d.length]]}; R.DrawBrushModel=function(a){var b=a.model;if(!0===b.submodel){if(!0===R.CullBox([a.origin[0]+b.mins[0],a.origin[1]+b.mins[1],a.origin[2]+b.mins[2]],[a.origin[0]+b.maxs[0],a.origin[1]+b.maxs[1],a.origin[2]+b.maxs[2]]))return}else if(!0===R.CullBox([a.origin[0]-b.radius,a.origin[1]-b.radius,a.origin[2]-b.radius],[a.origin[0]+b.radius,a.origin[1]+b.radius,a.origin[2]+b.radius]))return;gl.bindBuffer(gl.ARRAY_BUFFER,b.cmds);var d=GL.RotationMatrix(a.angles[0],a.angles[1],a.angles[2]),c=GL.UseProgram("Brush"); gl.uniform3fv(c.uOrigin,a.origin);gl.uniformMatrix3fv(c.uAngles,!1,d);gl.vertexAttribPointer(c.aPoint,3,gl.FLOAT,!1,44,0);gl.vertexAttribPointer(c.aTexCoord,4,gl.FLOAT,!1,44,12);gl.vertexAttribPointer(c.aLightStyle,4,gl.FLOAT,!1,44,28);0!==R.fullbright.value||null==b.lightdata?GL.Bind(c.tLightmap,R.fullbright_texture):GL.Bind(c.tLightmap,R.lightmap_texture);GL.Bind(c.tDlight,0===R.flashblend.value&&!0===b.submodel?R.dlightmap_texture:R.null_texture);GL.Bind(c.tLightStyle,R.lightstyle_texture);var f, e,g;for(f=0;f<b.chains.length;++f)e=b.chains[f],g=R.TextureAnimation(b.textures[e[0]]),!0!==g.turbulent&&(R.c_brush_verts+=e[2],GL.Bind(c.tTexture,g.texturenum),gl.drawArrays(gl.TRIANGLES,e[1],e[2]));c=GL.UseProgram("Turbulent");gl.uniform3f(c.uOrigin,0,0,0);gl.uniformMatrix3fv(c.uAngles,!1,d);gl.uniform1f(c.uTime,Host.realtime);gl.vertexAttribPointer(c.aPoint,3,gl.FLOAT,!1,20,a.model.waterchain);gl.vertexAttribPointer(c.aTexCoord,2,gl.FLOAT,!1,20,a.model.waterchain+12);for(f=0;f<b.chains.length;++f)e= b.chains[f],g=b.textures[e[0]],!0===g.turbulent&&(R.c_brush_verts+=e[2],GL.Bind(c.tTexture,g.texturenum),gl.drawArrays(gl.TRIANGLES,e[1],e[2]))};R.RecursiveWorldNode=function(a){a.contents!==Mod.contents.solid&&(0>a.contents?a.markvisframe===R.visframecount&&(a.visframe=R.visframecount,!0===a.drawsky&&(R.drawsky=!0)):(R.RecursiveWorldNode(a.children[0]),R.RecursiveWorldNode(a.children[1])))}; R.DrawWorld=function(){var a=CL.entities[0];R.currententity=a;gl.bindBuffer(gl.ARRAY_BUFFER,a.model.cmds);var b=GL.UseProgram("Brush");gl.uniform3f(b.uOrigin,0,0,0);gl.uniformMatrix3fv(b.uAngles,!1,GL.identity);gl.vertexAttribPointer(b.aPoint,3,gl.FLOAT,!1,44,0);gl.vertexAttribPointer(b.aTexCoord,4,gl.FLOAT,!1,44,12);gl.vertexAttribPointer(b.aLightStyle,4,gl.FLOAT,!1,44,28);0!==R.fullbright.value||null==a.model.lightdata?GL.Bind(b.tLightmap,R.fullbright_texture):GL.Bind(b.tLightmap,R.lightmap_texture); 0===R.flashblend.value?GL.Bind(b.tDlight,R.dlightmap_texture):GL.Bind(b.tDlight,R.null_texture);GL.Bind(b.tLightStyle,R.lightstyle_texture);var d,c,f,e;for(d=0;d<a.model.leafs.length;++d)if(f=a.model.leafs[d],f.visframe===R.visframecount&&!0!==R.CullBox(f.mins,f.maxs))for(c=0;c<f.waterchain;++c)e=f.cmds[c],R.c_brush_verts+=e[2],GL.Bind(b.tTexture,R.TextureAnimation(a.model.textures[e[0]]).texturenum),gl.drawArrays(gl.TRIANGLES,e[1],e[2]);b=GL.UseProgram("Turbulent");gl.uniform3f(b.uOrigin,0,0,0); gl.uniformMatrix3fv(b.uAngles,!1,GL.identity);gl.uniform1f(b.uTime,Host.realtime);gl.vertexAttribPointer(b.aPoint,3,gl.FLOAT,!1,20,a.model.waterchain);gl.vertexAttribPointer(b.aTexCoord,2,gl.FLOAT,!1,20,a.model.waterchain+12);for(d=0;d<a.model.leafs.length;++d)if(f=a.model.leafs[d],!(f.visframe!==R.visframecount||f.waterchain===f.cmds.length)&&!0!==R.CullBox(f.mins,f.maxs))for(c=f.waterchain;c<f.cmds.length;++c)e=f.cmds[c],R.c_brush_verts+=e[2],GL.Bind(b.tTexture,a.model.textures[e[0]].texturenum), gl.drawArrays(gl.TRIANGLES,e[1],e[2])}; R.MarkLeaves=function(){if(!(R.oldviewleaf===R.viewleaf&&0===R.novis.value)){++R.visframecount;R.oldviewleaf=R.viewleaf;var a=0!==R.novis.value?Mod.novis:Mod.LeafPVS(R.viewleaf,CL.state.worldmodel),b,d;for(b=0;b<CL.state.worldmodel.leafs.length;++b)if(0!==(a[b>>3]&1<<(b&7)))for(d=CL.state.worldmodel.leafs[b+1];null!=d&&d.markvisframe!==R.visframecount;d=d.parent)d.markvisframe=R.visframecount;do if(0===R.novis.value){if(R.viewleaf.contents<=Mod.contents.water){if(a=Mod.PointInLeaf([R.refdef.vieworg[0], R.refdef.vieworg[1],R.refdef.vieworg[2]+16],CL.state.worldmodel),a.contents<=Mod.contents.water)break}else if(a=Mod.PointInLeaf([R.refdef.vieworg[0],R.refdef.vieworg[1],R.refdef.vieworg[2]-16],CL.state.worldmodel),a.contents>Mod.contents.water)break;if(a!==R.viewleaf){a=Mod.LeafPVS(a,CL.state.worldmodel);for(b=0;b<CL.state.worldmodel.leafs.length;++b)if(0!==(a[b>>3]&1<<(b&7)))for(d=CL.state.worldmodel.leafs[b+1];null!=d&&d.markvisframe!==R.visframecount;d=d.parent)d.markvisframe=R.visframecount}}while(0); R.drawsky=!1;R.RecursiveWorldNode(CL.state.worldmodel.nodes[0])}};R.AllocBlock=function(a){var b=(a.extents[0]>>4)+1,d=(a.extents[1]>>4)+1,c,f,e,g,h=1024,j;for(e=0;e<1024-b;++e){for(g=j=0;g<b&&!(R.allocated[e+g]>=h);++g)R.allocated[e+g]>j&&(j=R.allocated[e+g]);g===b&&(c=e,f=h=j)}1024<h+d&&Sys.Error("AllocBlock: full");for(e=0;e<b;++e)R.allocated[c+e]=h+d;a.light_s=c;a.light_t=f}; R.BuildSurfaceDisplayList=function(a){var b,d,c,f,e=R.currentmodel.texinfo[a.texinfo],g=R.currentmodel.textures[e.texture];a.verts=[];for(b=0;3>b;++b)d=R.currentmodel.surfedges[a.firstedge+b],c=0<=d?R.currentmodel.vertexes[R.currentmodel.edges[d][0]]:R.currentmodel.vertexes[R.currentmodel.edges[-d][1]],d=Vec.DotProduct(c,e.vecs[0])+e.vecs[0][3],f=Vec.DotProduct(c,e.vecs[1])+e.vecs[1][3],c=[c[0],c[1],c[2],d/g.width,f/g.height],!0!==a.turbulent&&(c[5]=(d-a.texturemins[0]+(a.light_s<<4)+8)/16384,c[6]= (f-a.texturemins[1]+(a.light_t<<4)+8)/16384),a.verts[a.verts.length]=c;for(b=3;b<a.numedges;++b)d=R.currentmodel.surfedges[a.firstedge+b],c=0<=d?R.currentmodel.vertexes[R.currentmodel.edges[d][0]]:R.currentmodel.vertexes[R.currentmodel.edges[-d][1]],a.verts[a.verts.length]=a.verts[0],a.verts[a.verts.length]=a.verts[a.verts.length-2],d=Vec.DotProduct(c,e.vecs[0])+e.vecs[0][3],f=Vec.DotProduct(c,e.vecs[1])+e.vecs[1][3],c=[c[0],c[1],c[2],d/g.width,f/g.height],!0!==a.turbulent&&(c[5]=(d-a.texturemins[0]+ (a.light_s<<4)+8)/16384,c[6]=(f-a.texturemins[1]+(a.light_t<<4)+8)/16384),a.verts[a.verts.length]=c}; R.BuildLightmaps=function(){var a,b;R.allocated=[];for(a=0;1024>a;++a)R.allocated[a]=0;var d;for(a=1;a<CL.state.model_precache.length;++a)if(R.currentmodel=CL.state.model_precache[a],R.currentmodel.type===Mod.type.brush){if(42!==R.currentmodel.name.charCodeAt(0))for(b=0;b<R.currentmodel.faces.length;++b)d=R.currentmodel.faces[b],!0!==d.sky&&(!0!==d.turbulent&&(R.AllocBlock(d),null!=R.currentmodel.lightdata&&R.BuildLightMap(d)),R.BuildSurfaceDisplayList(d));1===a?R.MakeWorldModelDisplayLists(R.currentmodel): R.MakeBrushModelDisplayLists(R.currentmodel)}GL.Bind(0,R.lightmap_texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1024,1024,0,gl.RGBA,gl.UNSIGNED_BYTE,R.lightmaps)}; R.WarpScreen=function(){gl.finish();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);var a=GL.UseProgram("Warp"),b=R.refdef.vrect;gl.uniform4f(a.uRect,b.x,b.y,b.width,b.height);gl.uniform1f(a.uTime,Host.realtime);GL.Bind(a.tTexture,R.warptexture);gl.clear(gl.COLOR_BUFFER_BIT);gl.bindBuffer(gl.ARRAY_BUFFER,GL.rect);gl.vertexAttribPointer(a.aPoint,2,gl.FLOAT,!1,0,0);gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}; R.MakeSky=function(){var a=[0,0.19509,0.382683,0.55557,0.707107,0.83147,0.92388,0.980785,1],b=[],d,c;for(d=0;7>d;d+=2){b=b.concat([0,0,2048,0,0,799.088*a[d+2],799.088*a[6-d],2008.64,0.58527*a[d+2],0.58527*a[6-d],799.088*a[d],799.088*a[8-d],2008.64,0.58527*a[d],0.58527*a[8-d]]);for(c=0;7>c;++c)b=b.concat([4096*a[d]*a[8-c],4096*a[8-d]*a[8-c],2048*a[c],3*a[d]*a[8-c],3*a[8-d]*a[8-c],4096*a[d]*a[7-c],4096*a[8-d]*a[7-c],2048*a[c+1],3*a[d]*a[7-c],3*a[8-d]*a[7-c],4096*a[d+2]*a[7-c],4096*a[6-d]*a[7-c],2048* a[c+1],3*a[d+2]*a[7-c],3*a[6-d]*a[7-c],4096*a[d]*a[8-c],4096*a[8-d]*a[8-c],2048*a[c],3*a[d]*a[8-c],3*a[8-d]*a[8-c],4096*a[d+2]*a[7-c],4096*a[6-d]*a[7-c],2048*a[c+1],3*a[d+2]*a[7-c],3*a[6-d]*a[7-c],4096*a[d+2]*a[8-c],4096*a[6-d]*a[8-c],2048*a[c],3*a[d+2]*a[8-c],3*a[6-d]*a[8-c]])}GL.CreateProgram("Sky",["uViewAngles","uPerspective","uScale","uTime"],["aPoint","aTexCoord"],["tSolid","tAlpha"]);R.skyvecs=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,R.skyvecs);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(b), gl.STATIC_DRAW)}; R.DrawSkyBox=function(){if(!0===R.drawsky){var a=GL.UseProgram("Sky");gl.uniform1f(a.uTime,Host.realtime);GL.Bind(a.tSolid,R.solidskytexture);GL.Bind(a.tAlpha,R.alphaskytexture);gl.bindBuffer(gl.ARRAY_BUFFER,R.skyvecs);gl.vertexAttribPointer(a.aPoint,3,gl.FLOAT,!1,20,0);gl.vertexAttribPointer(a.aTexCoord,2,gl.FLOAT,!1,20,12);gl.uniform3f(a.uScale,1,-1,1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,1,-1,-1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,1,1,1);gl.drawArrays(gl.TRIANGLES, 0,180);gl.uniform3f(a.uScale,1,1,-1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,-1,-1,1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,-1,-1,-1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,-1,1,1);gl.drawArrays(gl.TRIANGLES,0,180);gl.uniform3f(a.uScale,-1,1,-1);gl.drawArrays(gl.TRIANGLES,0,180)}}; R.InitSky=function(a){var b,d,c,f=new ArrayBuffer(65536),e=new Uint32Array(f);for(b=0;128>b;++b)for(d=0;128>d;++d)e[(b<<7)+d]=Q.LittleULong(VID.d_8to24table[a[(b<<8)+d+128]]);GL.Bind(0,R.solidskytexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(f));gl.generateMipmap(gl.TEXTURE_2D);for(b=0;128>b;++b)for(d=0;128>d;++d)c=(b<<8)+d,e[(b<<7)+d]=0!==a[c]?Q.LittleULong(VID.d_8to24table[a[c]]):0;GL.Bind(0,R.alphaskytexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, 128,128,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(f));gl.generateMipmap(gl.TEXTURE_2D)};
var S={channels:[],static_channels:[],ambient_channels:[],listener_origin:[0,0,0],listener_forward:[0,0,0],listener_right:[0,0,0],listener_up:[0,0,0],known_sfx:[],Init:function(){Con.Print("\nSound Initialization\n");Cmd.AddCommand("play",S.Play);Cmd.AddCommand("playvol",S.PlayVol);Cmd.AddCommand("stopsound",S.StopAllSounds);Cmd.AddCommand("soundlist",S.SoundList);S.nosound=Cvar.RegisterVariable("nosound",null!=COM.CheckParm("-nosound")?"1":"0");S.volume=Cvar.RegisterVariable("volume","0.7",!0);S.precache= Cvar.RegisterVariable("precache","1");S.bgmvolume=Cvar.RegisterVariable("bgmvolume","1",!0);S.ambient_level=Cvar.RegisterVariable("ambient_level","0.3");S.ambient_fade=Cvar.RegisterVariable("ambient_fade","100");S.started=!0;var b,a=["water1","wind2"],c;for(b=0;b<a.length;++b)c={sfx:S.PrecacheSound("ambience/"+a[b]+".wav"),end:0,master_vol:0},S.ambient_channels[b]=c,!0===S.LoadSound(c.sfx)&&(null==c.sfx.cache.loopstart?Con.Print("Sound ambience/"+sfx.name+".wav not looped\n"):c.audio=c.sfx.cache.audio.cloneNode()); Con.sfx_talk=S.PrecacheSound("misc/talk.wav")},PrecacheSound:function(b){if(0===S.nosound.value){var a,c;for(a=0;a<S.known_sfx.length;++a)if(S.known_sfx[a].name===b){c=S.known_sfx[a];break}a===S.known_sfx.length&&(S.known_sfx[a]={name:b},c=S.known_sfx[a]);0!==S.precache.value&&S.LoadSound(c);return c}},PickChannel:function(b,a){var c,d;if(0!==a)for(c=0;c<S.channels.length;++c)if(d=S.channels[c],null!=d&&d.entnum===b&&(d.entchannel===a||-1===a)){d.sfx=null;null!=d.audio&&(d.audio.pause(),d.audio=null); break}if(0===a||c===S.channels.length)for(c=0;c<S.channels.length;++c){d=S.channels[c];if(null==d)break;if(null==d.sfx)break}return c===S.channels.length?(S.channels[c]={end:0},S.channels[c]):d},Spatialize:function(b){if(b.entnum===CL.state.viewentity)b.leftvol=b.master_vol,b.rightvol=b.master_vol;else{var a=[b.origin[0]-S.listener_origin[0],b.origin[1]-S.listener_origin[1],b.origin[2]-S.listener_origin[2]],c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);0!==c&&(a[0]/=c,a[1]/=c,a[2]/=c);c*=b.dist_mult; a=S.listener_right[0]*a[0]+S.listener_right[1]*a[1]+S.listener_right[2]*a[2];b.rightvol=b.master_vol*(1-c)*(1+a);0>b.rightvol&&(b.rightvol=0);b.leftvol=b.master_vol*(1-c)*(1-a);0>b.leftvol&&(b.leftvol=0)}},StartSound:function(b,a,c,d,e,g){if(!(0!==S.nosound.value||null==c)){var f=S.PickChannel(b,a);f.origin=[d[0],d[1],d[2]];f.dist_mult=0.001*g;f.master_vol=e;f.entnum=b;f.entchannel=a;S.Spatialize(f);0===f.leftvol&&0===f.rightvol||(!0!==S.LoadSound(c)?f.sfx=null:(f.sfx=c,f.end=Host.realtime+c.cache.length, f.audio=c.cache.audio.cloneNode(),b=0.5*(f.leftvol+f.rightvol),1<b&&(b=1),f.audio.volume=b*S.volume.value,f.audio.play()))}},StopSound:function(b,a){if(0===S.nosound.value){var c,d;for(c=0;c<S.channels.length;++c)if(d=S.channels[c],null!=d&&d.entnum===b&&d.entchannel===a){d.end=0;d.sfx=null;null!=d.audio&&(d.audio.pause(),d.audio=null);break}}},StopAllSounds:function(){if(0===S.nosound.value){var b,a;for(b=0;b<S.ambient_channels.length;++b)a=S.ambient_channels[b],a.master_vol=0,a.audio.pause();for(b= 0;b<S.channels.length;++b)a=S.channels[b],null!=a&&null!=a.audio&&a.audio.pause();S.channels=[];for(b=0;b<S.static_channels.length;++b)S.static_channels[b].audio.pause();S.static_channels=[]}},StaticSound:function(b,a,c,d){if(!(0!==S.nosound.value||null==b)&&!0===S.LoadSound(b))if(null==b.cache.loopstart)Con.Print("Sound "+b.name+" not looped\n");else{var e={};e.sfx=b;e.origin=[a[0],a[1],a[2]];e.master_vol=c;e.dist_mult=1.5625E-5*d;e.end=Host.realtime+b.cache.length;S.Spatialize(e);e.audio=b.cache.audio.cloneNode(); e.audio.play();S.static_channels[S.static_channels.length]=e}},SoundList:function(){var b=0,a,c,d,e;for(a=0;a<S.known_sfx.length;++a)if(c=S.known_sfx[a],d=c.cache,null!=d){e=d.audio.src.length;b+=e;for(e=e.toString();5>=e.length;)e=" "+e;e=null!=d.loopstart?"L"+e:" "+e;Con.Print(e+" : "+c.name+"\n")}Con.Print("Total resident: "+b+"\n")},LocalSound:function(b){S.StartSound(CL.state.viewentity,-1,b,Vec.origin,1,1)},UpdateAmbientSounds:function(){if(null!=CL.state.worldmodel){var b,a,c,d=Mod.PointInLeaf(S.listener_origin, CL.state.worldmodel);if(null==d||0===S.ambient_level.value)for(b=0;b<S.ambient_channels.length;++b)a=S.ambient_channels[b],null!=a.audio&&(a.master_vol=0,!0!==a.audio.paused&&a.audio.pause());else for(b=0;b<S.ambient_channels.length;++b)if(a=S.ambient_channels[b],c=S.ambient_level.value*d.ambient_level[b],8>c&&(c=0),c/=255,a.master_vol<c?(a.master_vol+=Host.frametime*S.ambient_fade.value/255,a.master_vol>c&&(a.master_vol=c)):a.master_vol>c&&(a.master_vol-=Host.frametime*S.ambient_fade.value/255,a.master_vol< c&&(a.master_vol=c)),0===a.master_vol)!0!==a.audio.paused&&a.audio.pause();else if(a.audio.volume=a.master_vol*S.volume.value,c=a.sfx.cache,!0===a.audio.paused)a.audio.play(),a.end=Host.realtime+c.length;else if(Host.realtime>=a.end){try{a.audio.currentTime=c.loopstart}catch(e){a.end=Host.realtime;continue}a.end=Host.realtime+c.length-c.loopstart}}},UpdateDynamicSounds:function(){var b,a,c;for(b=0;b<S.channels.length;++b)if(a=S.channels[b],null!=a&&null!=a.sfx){if(Host.realtime>=a.end)if(c=a.sfx.cache, null!=c.loopstart){try{a.audio.currentTime=c.loopstart}catch(d){a.end=Host.realtime;continue}a.end=Host.realtime+c.length-c.loopstart}else{a.sfx=null;a.audio=null;continue}S.Spatialize(a);c=0.5*(a.leftvol+a.rightvol);1<c&&(c=1);a.audio.volume=c*S.volume.value}},UpdateStaticSounds:function(){var b,a,c,d,e;for(b=0;b<S.static_channels.length;++b)S.Spatialize(S.static_channels[b]);for(b=0;b<S.static_channels.length;++b)if(c=S.static_channels[b],!(0===c.leftvol&&0===c.rightvol)){e=c.sfx;for(a=b+1;a<S.static_channels.length;++a)d= S.static_channels[a],e===d.sfx&&(c.leftvol+=d.leftvol,c.rightvol+=d.rightvol,d.leftvol=0,d.rightvol=0)}for(b=0;b<S.static_channels.length;++b)if(c=S.static_channels[b],a=0.5*(c.leftvol+c.rightvol),1<a&&(a=1),0===a)!0!==c.audio.paused&&c.audio.pause();else if(c.audio.volume=a*S.volume.value,a=c.sfx.cache,!0===c.audio.paused)c.audio.play(),c.end=Host.realtime+a.length;else if(Host.realtime>=c.end)try{c.audio.currentTime=a.loopstart}catch(g){c.end=Host.realtime}},Update:function(b,a,c,d){0===S.nosound.value&& (S.listener_origin[0]=b[0],S.listener_origin[1]=b[1],S.listener_origin[2]=b[2],S.listener_forward[0]=a[0],S.listener_forward[1]=a[1],S.listener_forward[2]=a[2],S.listener_right[0]=c[0],S.listener_right[1]=c[1],S.listener_right[2]=c[2],S.listener_up[0]=d[0],S.listener_up[1]=d[1],S.listener_up[2]=d[2],S.UpdateAmbientSounds(),S.UpdateDynamicSounds(),S.UpdateStaticSounds())},Play:function(){if(0===S.nosound.value){var b,a;for(b=1;b<Cmd.argv.length;++b)a=S.PrecacheSound(COM.DefaultExtension(Cmd.argv[b], ".wav")),null!=a&&S.StartSound(CL.state.viewentity,0,a,S.listener_origin,1,1)}},PlayVol:function(){if(0===S.nosound.value){var b,a;for(b=1;b<Cmd.argv.length;b+=2)a=S.PrecacheSound(COM.DefaultExtension(Cmd.argv[b],".wav")),null!=a&&S.StartSound(CL.state.viewentity,0,a,S.listener_origin,Q.atof(Cmd.argv[b+1]),1)}},LoadSound:function(b){if(0===S.nosound.value){if(null!=b.cache)return!0;var a={},c=COM.LoadFile("sound/"+b.name);if(null==c)Con.Print("Couldn't load sound/"+b.name+"\n");else{var d=new DataView(c); if(1179011410!==d.getUint32(0,!0)||1163280727!==d.getUint32(8,!0))Con.Print("Missing RIFF/WAVE chunks\n");else{var e,g,f,j,h,k,l;for(e=12;e<c.byteLength;){switch(d.getUint32(e,!0)){case 544501094:if(1!==d.getInt16(e+8,!0)){Con.Print("Microsoft PCM format only\n");return}g={channels:d.getUint16(e+10,!0),samplesPerSec:d.getUint32(e+12,!0),avgBytesPerSec:d.getUint32(e+16,!0),blockAlign:d.getUint16(e+20,!0),bitsPerSample:d.getUint16(e+22,!0)};break;case 1635017060:f=e+8;j=d.getUint32(e+4,!0);break;case 543520099:h= !0;k=d.getUint32(e+32,!0);break;case 1414744396:if(!0!==h)break;h=!1;1802658157===d.getUint32(e+28,!0)&&(l=k+d.getUint32(e+24,!0))}e+=d.getUint32(e+4,!0)+8;0!==(e&1)&&++e}if(null==g)Con.Print("Missing fmt chunk\n");else if(null==f)Con.Print("Missing data chunk\n");else return null!=k&&(a.loopstart=k*g.blockAlign/g.samplesPerSec),a.length=null!=l?l/g.samplesPerSec:j/g.avgBytesPerSec,e=j+44,0!==(e&1)&&++e,h=new ArrayBuffer(e),d=new DataView(h),d.setUint32(0,1179011410,!0),d.setUint32(4,e-8,!0),d.setUint32(8, 1163280727,!0),d.setUint32(12,544501094,!0),d.setUint32(16,16,!0),d.setUint16(20,1,!0),d.setUint16(22,g.channels,!0),d.setUint32(24,g.samplesPerSec,!0),d.setUint32(28,g.avgBytesPerSec,!0),d.setUint16(32,g.blockAlign,!0),d.setUint16(34,g.bitsPerSample,!0),d.setUint32(36,1635017060,!0),d.setUint32(40,j,!0),(new Uint8Array(h,44,j)).set(new Uint8Array(c,f,j)),a.audio=new Audio("data:audio/wav;base64,"+Q.btoa(new Uint8Array(h))),b.cache=a,!0}}}}};
var Sbar={ShowScores:function(){Sbar.showscores=!0},DontShowScores:function(){Sbar.showscores=!1},Init:function(){var a;Sbar.nums=[[],[]];for(a=0;10>a;++a)Sbar.nums[0][a]=Draw.PicFromWad("num_"+a),Sbar.nums[1][a]=Draw.PicFromWad("anum_"+a);Sbar.nums[0][10]=Draw.PicFromWad("num_minus");Sbar.nums[1][10]=Draw.PicFromWad("anum_minus");Sbar.colon=Draw.PicFromWad("num_colon");Sbar.slash=Draw.PicFromWad("num_slash");Sbar.weapons=[[Draw.PicFromWad("inv_shotgun"),Draw.PicFromWad("inv_sshotgun"),Draw.PicFromWad("inv_nailgun"), Draw.PicFromWad("inv_snailgun"),Draw.PicFromWad("inv_rlaunch"),Draw.PicFromWad("inv_srlaunch"),Draw.PicFromWad("inv_lightng")],[Draw.PicFromWad("inv2_shotgun"),Draw.PicFromWad("inv2_sshotgun"),Draw.PicFromWad("inv2_nailgun"),Draw.PicFromWad("inv2_snailgun"),Draw.PicFromWad("inv2_rlaunch"),Draw.PicFromWad("inv2_srlaunch"),Draw.PicFromWad("inv2_lightng")]];for(a=0;4>=a;++a)Sbar.weapons[2+a]=[Draw.PicFromWad("inva"+(a+1)+"_shotgun"),Draw.PicFromWad("inva"+(a+1)+"_sshotgun"),Draw.PicFromWad("inva"+(a+ 1)+"_nailgun"),Draw.PicFromWad("inva"+(a+1)+"_snailgun"),Draw.PicFromWad("inva"+(a+1)+"_rlaunch"),Draw.PicFromWad("inva"+(a+1)+"_srlaunch"),Draw.PicFromWad("inva"+(a+1)+"_lightng")];Sbar.ammo=[Draw.PicFromWad("sb_shells"),Draw.PicFromWad("sb_nails"),Draw.PicFromWad("sb_rocket"),Draw.PicFromWad("sb_cells")];Sbar.armor=[Draw.PicFromWad("sb_armor1"),Draw.PicFromWad("sb_armor2"),Draw.PicFromWad("sb_armor3")];Sbar.items=[Draw.PicFromWad("sb_key1"),Draw.PicFromWad("sb_key2"),Draw.PicFromWad("sb_invis"), Draw.PicFromWad("sb_invuln"),Draw.PicFromWad("sb_suit"),Draw.PicFromWad("sb_quad")];Sbar.sigil=[Draw.PicFromWad("sb_sigil1"),Draw.PicFromWad("sb_sigil2"),Draw.PicFromWad("sb_sigil3"),Draw.PicFromWad("sb_sigil4")];Sbar.faces=[];for(a=0;4>=a;++a)Sbar.faces[a]=[Draw.PicFromWad("face"+(5-a)),Draw.PicFromWad("face_p"+(5-a))];Sbar.face_invis=Draw.PicFromWad("face_invis");Sbar.face_invuln=Draw.PicFromWad("face_invul2");Sbar.face_invis_invuln=Draw.PicFromWad("face_inv2");Sbar.face_quad=Draw.PicFromWad("face_quad"); Cmd.AddCommand("+showscores",Sbar.ShowScores);Cmd.AddCommand("-showscores",Sbar.DontShowScores);Sbar.sbar=Draw.PicFromWad("sbar");Sbar.ibar=Draw.PicFromWad("ibar");Sbar.scorebar=Draw.PicFromWad("scorebar");Sbar.ranking=Draw.CachePic("ranking");Sbar.complete=Draw.CachePic("complete");Sbar.inter=Draw.CachePic("inter");Sbar.finale=Draw.CachePic("finale");Sbar.disc=Draw.PicFromWad("disc");if(!0===COM.hipnotic){Sbar.h_weapons=[[Draw.PicFromWad("inv_laser"),Draw.PicFromWad("inv_mjolnir"),Draw.PicFromWad("inv_gren_prox"), Draw.PicFromWad("inv_prox_gren"),Draw.PicFromWad("inv_prox")],[Draw.PicFromWad("inv2_laser"),Draw.PicFromWad("inv2_mjolnir"),Draw.PicFromWad("inv2_gren_prox"),Draw.PicFromWad("inv2_prox_gren"),Draw.PicFromWad("inv2_prox")]];for(a=0;4>=a;++a)Sbar.h_weapons[2+a]=[Draw.PicFromWad("inva"+(a+1)+"_laser"),Draw.PicFromWad("inva"+(a+1)+"_mjolnir"),Draw.PicFromWad("inva"+(a+1)+"_gren_prox"),Draw.PicFromWad("inva"+(a+1)+"_prox_gren"),Draw.PicFromWad("inva"+(a+1)+"_prox")];Sbar.hipweapons=[Def.hit.laser_cannon_bit, Def.hit.mjolnir_bit,4,Def.hit.proximity_gun_bit];Sbar.h_items=[Draw.PicFromWad("sb_wsuit"),Draw.PicFromWad("sb_eshld")]}else!0===COM.rogue&&(Sbar.r_invbar=[Draw.PicFromWad("r_invbar1"),Draw.PicFromWad("r_invbar2")],Sbar.r_weapons=[Draw.PicFromWad("r_lava"),Draw.PicFromWad("r_superlava"),Draw.PicFromWad("r_gren"),Draw.PicFromWad("r_multirock"),Draw.PicFromWad("r_plasma")],Sbar.r_items=[Draw.PicFromWad("r_shield1"),Draw.PicFromWad("r_agrav1")],Sbar.r_teambord=Draw.PicFromWad("r_teambord"),Sbar.r_ammo= [Draw.PicFromWad("r_ammolava"),Draw.PicFromWad("r_ammomulti"),Draw.PicFromWad("r_ammoplasma")])},DrawPic:function(a,b,c){1===CL.state.gametype?Draw.Pic(a,b+VID.height-24,c):Draw.Pic(a+(VID.width>>1)-160,b+VID.height-24,c)},DrawCharacter:function(a,b,c){1===CL.state.gametype?Draw.Character(a+4,b+VID.height-24,c):Draw.Character(a+(VID.width>>1)-156,b+VID.height-24,c)},DrawString:function(a,b,c){1===CL.state.gametype?Draw.String(a,b+VID.height-24,c):Draw.String(a+(VID.width>>1)-160,b+VID.height-24,c)}, DrawNum:function(a,b,c,d,e){c=c.toString();c.length>d?c=c.substring(c.length-d,c.length):c.length<d&&(a+=24*(d-c.length));var f;for(d=0;d<c.length;++d)f=c.charCodeAt(d),Sbar.DrawPic(a,b,Sbar.nums[e][45===f?10:f-48]),a+=24},fragsort:[],SortFrags:function(){Sbar.scoreboardlines=0;var a,b,c;for(a=0;a<CL.state.maxclients;++a)0!==CL.state.scores[a].name.length&&(Sbar.fragsort[Sbar.scoreboardlines++]=a);for(a=0;a<Sbar.scoreboardlines;++a)for(b=0;b<Sbar.scoreboardlines-1-a;++b)CL.state.scores[Sbar.fragsort[b]].frags< CL.state.scores[Sbar.fragsort[b+1]].frags&&(c=Sbar.fragsort[b],Sbar.fragsort[b]=Sbar.fragsort[b+1],Sbar.fragsort[b+1]=c)},SoloScoreboard:function(){var a;Sbar.DrawString(8,4,"Monsters: /");a=CL.state.stats[Def.stat.monsters].toString();Sbar.DrawString(104-(a.length<<3),4,a);a=CL.state.stats[Def.stat.totalmonsters].toString();Sbar.DrawString(144-(a.length<<3),4,a);Sbar.DrawString(8,12,"Secrets : /");a=CL.state.stats[Def.stat.secrets].toString();Sbar.DrawString(104-(a.length<<3),12,a);a=CL.state.stats[Def.stat.totalsecrets].toString(); Sbar.DrawString(144-(a.length<<3),12,a);var b=Math.floor(CL.state.time/60);a=Math.floor(CL.state.time-60*b);var c=Math.floor(0.1*a);a=(a-10*c).toString();Sbar.DrawString(184,4,"Time : :"+c+a);a=b.toString();Sbar.DrawString(256-(a.length<<3),4,a);Sbar.DrawString(232-(CL.state.levelname.length<<2),12,CL.state.levelname)},DrawInventory:function(){var a;!0===COM.rogue?Sbar.DrawPic(0,-24,Sbar.r_invbar[CL.state.stats[Def.stat.activeweapon]>=Def.rit.lava_nailgun?0:1]):Sbar.DrawPic(0,-24,Sbar.ibar);var b; for(a=0;6>=a;++a)0!==(CL.state.items&Def.it.shotgun<<a)&&(b=Math.floor(10*(CL.state.time-CL.state.item_gettime[a])),b=10<=b?CL.state.stats[Def.stat.activeweapon]===Def.it.shotgun<<a?1:0:b%5+2,Sbar.DrawPic(24*a,-16,Sbar.weapons[b][a]));if(!0===COM.hipnotic){var c=!1;for(a=0;3>=a;++a)0!==(CL.state.items&1<<Sbar.hipweapons[a])&&(b=Math.floor(10*(CL.state.time-CL.state.item_gettime[a])),b=10<=b?CL.state.stats[Def.stat.activeweapon]===1<<Sbar.hipweapons[a]?1:0:b%5+2,2===a?0!==(CL.state.items&Def.hit.proximity_gun)&& 0!==b&&(c=!0,Sbar.DrawPic(96,-16,Sbar.h_weapons[b][2])):3===a?0!==(CL.items&Def.it.grenade_launcher)?!0!==c&&Sbar.DrawPic(96,-16,Sbar.h_weapons[b][3]):Sbar.DrawPic(96,-16,Sbar.h_weapons[b][4]):Sbar.DrawPic(176+24*a,-16,Sbar.h_weapons[b][a]))}else if(!0===COM.rogue&&CL.state.stats[Def.stat.activeweapon]>=Def.rit.lava_nailgun)for(a=0;4>=a;++a)CL.state.stats[Def.stat.activeweapon]===Def.rit.lava_nailgun<<a&&Sbar.DrawPic(24*(a+2),-16,Sbar.r_weapons[a]);for(a=0;3>=a;++a)switch(b=CL.state.stats[Def.stat.shells+ a].toString(),b.length){case 1:Sbar.DrawCharacter((6*a+3<<3)-2,-24,b.charCodeAt(0)-30);continue;case 2:Sbar.DrawCharacter((6*a+2<<3)-2,-24,b.charCodeAt(0)-30);Sbar.DrawCharacter((6*a+3<<3)-2,-24,b.charCodeAt(1)-30);continue;case 3:Sbar.DrawCharacter((6*a+1<<3)-2,-24,b.charCodeAt(0)-30),Sbar.DrawCharacter((6*a+2<<3)-2,-24,b.charCodeAt(1)-30),Sbar.DrawCharacter((6*a+3<<3)-2,-24,b.charCodeAt(2)-30)}if(!0===COM.hipnotic){for(a=2;5>=a;++a)0!==(CL.state.items&1<<17+a)&&Sbar.DrawPic(192+(a<<4),-16,Sbar.items[a]); 0!==(CL.state.items&16777216)&&Sbar.DrawPic(288,-16,Sbar.h_items[0]);0!==(CL.state.items&33554432)&&Sbar.DrawPic(304,-16,Sbar.h_items[1])}else{for(a=0;5>=a;++a)0!==(CL.state.items&1<<17+a)&&Sbar.DrawPic(192+(a<<4),-16,Sbar.items[a]);if(!0===COM.rogue)0!==(CL.state.items&536870912)&&Sbar.DrawPic(288,-16,Sbar.r_items[0]),0!==(CL.state.items&1073741824)&&Sbar.DrawPic(304,-16,Sbar.r_items[1]);else for(a=0;3>=a;++a)0!==(CL.state.items>>>28+a&1)&&Sbar.DrawPic(288+(a<<3),-16,Sbar.sigil[a])}},DrawFrags:function(){Sbar.SortFrags(); var a=4>=Sbar.scoreboardlines?Sbar.scoreboardlines:4,b=23,c=1===CL.state.gametype?10:(VID.width>>1)-150,d=VID.height-47,e,f,g;for(e=0;e<a;++e)f=Sbar.fragsort[e],g=CL.state.scores[f],0!==g.name.length&&(Draw.Fill(c+(b<<3),d,28,4,(g.colors&240)+8),Draw.Fill(c+(b<<3),d+4,28,3,((g.colors&15)<<4)+8),g=g.frags.toString(),Sbar.DrawString((b-g.length<<3)+36,-24,g),f===CL.state.viewentity-1&&(Sbar.DrawCharacter((b<<3)+2,-24,16),Sbar.DrawCharacter((b<<3)+28,-24,17)),b+=4)},DrawFace:function(){if(!0===COM.rogue&& 1!==CL.state.maxclients&&4<=Host.teamplay.value&&6>=Host.teamplay.value){var a=CL.state.scores[CL.state.viewentity-1],b=(a.colors&240)+8,c=1===CL.state.gametype?113:(VID.width>>1)-47;Sbar.DrawPic(112,0,Sbar.r_teambord);Draw.Fill(c,VID.height-21,22,9,b);Draw.Fill(c,VID.height-12,22,9,((a.colors&15)<<4)+8);a=(8===b?">>>":" ")+a.frags;3<a.length&&(a=a.substring(a.length-3));8===b?(Sbar.DrawCharacter(109,3,a.charCodeAt(0)-30),Sbar.DrawCharacter(116,3,a.charCodeAt(1)-30),Sbar.DrawCharacter(123,3,a.charCodeAt(2)- 30)):(Sbar.DrawCharacter(109,3,a.charCodeAt(0)),Sbar.DrawCharacter(116,3,a.charCodeAt(1)),Sbar.DrawCharacter(123,3,a.charCodeAt(2)))}else(CL.state.items&Def.it.invisibility+Def.it.invulnerability)===Def.it.invisibility+Def.it.invulnerability?Sbar.DrawPic(112,0,Sbar.face_invis_invuln):0!==(CL.state.items&Def.it.quad)?Sbar.DrawPic(112,0,Sbar.face_quad):0!==(CL.state.items&Def.it.invisibility)?Sbar.DrawPic(112,0,Sbar.face_invis):0!==(CL.state.items&Def.it.invulnerability)?Sbar.DrawPic(112,0,Sbar.face_invuln): Sbar.DrawPic(112,0,Sbar.faces[100<=CL.state.stats[Def.stat.health]?4:Math.floor(CL.state.stats[Def.stat.health]/20)][CL.state.time<=CL.state.faceanimtime?1:0])},Draw:function(){if(!(200<=SCR.con_current))if(24<Sbar.lines&&(Sbar.DrawInventory(),1!==CL.state.maxclients&&Sbar.DrawFrags()),!0===Sbar.showscores||0>=CL.state.stats[Def.stat.health])Sbar.DrawPic(0,0,Sbar.scorebar),Sbar.SoloScoreboard(),1===CL.state.gametype&&Sbar.DeathmatchOverlay();else if(0!==Sbar.lines){Sbar.DrawPic(0,0,Sbar.sbar);!0=== COM.hipnotic&&(0!==(CL.state.items&Def.it.key1)&&Sbar.DrawPic(209,3,Sbar.items[0]),0!==(CL.state.items&Def.it.key2)&&Sbar.DrawPic(209,12,Sbar.items[1]));var a=!0===COM.rogue?Def.rit:Def.it;0!==(CL.state.items&Def.it.invulnerability)?(Sbar.DrawNum(24,0,666,3,1),Sbar.DrawPic(0,0,Sbar.disc)):(Sbar.DrawNum(24,0,CL.state.stats[Def.stat.armor],3,25>=CL.state.stats[Def.stat.armor]?1:0),0!==(CL.state.items&a.armor3)?Sbar.DrawPic(0,0,Sbar.armor[2]):0!==(CL.state.items&a.armor2)?Sbar.DrawPic(0,0,Sbar.armor[1]): 0!==(CL.state.items&a.armor1)&&Sbar.DrawPic(0,0,Sbar.armor[0]));Sbar.DrawFace();Sbar.DrawNum(136,0,CL.state.stats[Def.stat.health],3,25>=CL.state.stats[Def.stat.health]?1:0);0!==(CL.state.items&a.shells)?Sbar.DrawPic(224,0,Sbar.ammo[0]):0!==(CL.state.items&a.nails)?Sbar.DrawPic(224,0,Sbar.ammo[1]):0!==(CL.state.items&a.rockets)?Sbar.DrawPic(224,0,Sbar.ammo[2]):0!==(CL.state.items&a.cells)?Sbar.DrawPic(224,0,Sbar.ammo[3]):!0===COM.rogue&&(0!==(CL.state.items&Def.rit.lava_nails)?Sbar.DrawPic(224,0, Sbar.r_ammo[0]):0!==(CL.state.items&Def.rit.plasma_ammo)?Sbar.DrawPic(224,0,Sbar.r_ammo[1]):0!==(CL.state.items&Def.rit.multi_rockets)&&Sbar.DrawPic(224,0,Sbar.r_ammo[2]));Sbar.DrawNum(248,0,CL.state.stats[Def.stat.ammo],3,10>=CL.state.stats[Def.stat.ammo]?1:0);512<=VID.width&&1===CL.state.gametype&&Sbar.MiniDeathmatchOverlay()}},IntermissionNumber:function(a,b,c){c=c.toString();3<c.length?c=c.substring(c.length-3,c.length):3>c.length&&(a+=24*(3-c.length));var d,e;for(d=0;d<c.length;++d)e=c.charCodeAt(d), Draw.Pic(a,b,Sbar.nums[0][45===e?10:e-48]),a+=24},DeathmatchOverlay:function(){Draw.Pic(VID.width-Sbar.ranking.width>>1,8,Sbar.ranking);Sbar.SortFrags();var a=(VID.width>>1)-80,b=40,c,d,e;for(c=0;c<Sbar.scoreboardlines;++c)d=CL.state.scores[Sbar.fragsort[c]],0!==d.name.length&&(Draw.Fill(a,b,40,4,(d.colors&240)+8),Draw.Fill(a,b+4,40,4,((d.colors&15)<<4)+8),e=d.frags.toString(),Draw.String(a+32-(e.length<<3),b,e),Sbar.fragsort[c]===CL.state.viewentity-1&&Draw.Character(a-8,b,12),Draw.String(a+64,b, d.name),b+=10)},MiniDeathmatchOverlay:function(){Sbar.SortFrags();var a=Sbar.scoreboardlines,b=VID.height-Sbar.lines,c=Sbar.lines>>3,d;for(d=0;d<a&&Sbar.fragsort[d]!==CL.state.viewentity-1;++d);d=d===a?0:d-(c>>1);d>a-c&&(d=a-c);0>d&&(d=0);for(var e,f;d<a&&b<VID.height-8;++d)c=Sbar.fragsort[d],e=CL.state.scores[c],0!==e.name.length&&(Draw.Fill(324,b+1,40,3,(e.colors&240)+8),Draw.Fill(324,b+4,40,4,((e.colors&15)<<4)+8),f=e.frags.toString(),Draw.String(356-(f.length<<3),b,f),c===CL.state.viewentity- 1&&(Draw.Character(324,b,16),Draw.Character(356,b,17)),Draw.String(372,b,e.name),b+=8)},IntermissionOverlay:function(){if(1===CL.state.gametype)Sbar.DeathmatchOverlay();else{Draw.Pic(64,24,Sbar.complete);Draw.Pic(0,56,Sbar.inter);var a=Math.floor(CL.state.completed_time/60);Sbar.IntermissionNumber(160,64,a);a=Math.floor(CL.state.completed_time-60*a);Draw.Pic(234,64,Sbar.colon);Draw.Pic(246,64,Sbar.nums[0][Math.floor(a/10)]);Draw.Pic(266,64,Sbar.nums[0][Math.floor(a%10)]);Sbar.IntermissionNumber(160, 104,CL.state.stats[Def.stat.secrets]);Draw.Pic(232,104,Sbar.slash);Sbar.IntermissionNumber(240,104,CL.state.stats[Def.stat.totalsecrets]);Sbar.IntermissionNumber(160,144,CL.state.stats[Def.stat.monsters]);Draw.Pic(232,144,Sbar.slash);Sbar.IntermissionNumber(240,144,CL.state.stats[Def.stat.totalmonsters])}},FinaleOverlay:function(){Draw.Pic(VID.width-Sbar.finale.width>>1,16,Sbar.finale)}};
var SCR={con_current:0,centerstring:[],centertime_off:0,CenterPrint:function(a){SCR.centerstring=[];var b,c=0,d;for(b=0;b<a.length;++b){if(10===a.charCodeAt(b))d=b+1;else if(40<=b-c)d=b;else continue;SCR.centerstring[SCR.centerstring.length]=a.substring(c,b);c=d}SCR.centerstring[SCR.centerstring.length]=a.substring(c,b);SCR.centertime_off=SCR.centertime.value;SCR.centertime_start=CL.state.time},DrawCenterString:function(){SCR.centertime_off-=Host.frametime;if(!(0>=SCR.centertime_off&&0===CL.state.intermission|| Key.dest.value!==Key.dest.game)){var a;a=4>=SCR.centerstring.length?Math.floor(0.35*VID.height):48;var b;if(CL.state.intermission){var c=Math.floor(SCR.printspeed.value*(CL.state.time-SCR.centertime_start)),d,e,f;for(b=0;b<SCR.centerstring.length;++b){d=SCR.centerstring[b];e=VID.width-(d.length<<3)>>1;for(f=0;f<d.length;++f){Draw.Character(e,a,d.charCodeAt(f));if(0===c--)return;e+=8}a+=8}}else for(b=0;b<SCR.centerstring.length;++b)Draw.String(VID.width-(SCR.centerstring[b].length<<3)>>1,a,SCR.centerstring[b]), a+=8}},CalcRefdef:function(){SCR.recalc_refdef=!1;30>SCR.viewsize.value?Cvar.Set("viewsize","30"):120<SCR.viewsize.value&&Cvar.Set("viewsize","120");var a,b;0!==CL.state.intermission?(b=!0,a=1,Sbar.lines=0):(a=SCR.viewsize.value,Sbar.lines=120<=a?0:110<=a?24:48,100<=a&&(b=!0,a=100),a*=0.01);var c=R.refdef.vrect;c.width=Math.floor(VID.width*a);96>c.width&&(a=96/c.width,c.width=96);c.height=Math.floor(VID.height*a);c.height>VID.height-Sbar.lines&&(c.height=VID.height-Sbar.lines);c.x=VID.width-c.width>> 1;c.y=!0===b?0:VID.height-Sbar.lines-c.height>>1;10>SCR.fov.value?Cvar.Set("fov","10"):170<SCR.fov.value&&Cvar.Set("fov","170");0.75*c.width<=c.height?(R.refdef.fov_x=SCR.fov.value,R.refdef.fov_y=360*Math.atan(c.height/(c.width/Math.tan(SCR.fov.value*Math.PI/360)))/Math.PI):(R.refdef.fov_x=360*Math.atan(c.width/(c.height/Math.tan(0.82*SCR.fov.value*Math.PI/360)))/Math.PI,R.refdef.fov_y=0.82*SCR.fov.value);a=4*Math.tan(R.refdef.fov_y*Math.PI/360);R.perspective[0]=4/(a*R.refdef.vrect.width/R.refdef.vrect.height); R.perspective[5]=4/a;GL.ortho[0]=2/VID.width;GL.ortho[5]=-2/VID.height;R.warpwidth=c.width;R.warpheight=c.height;2048<R.warpwidth&&(R.warpwidth=2048);2048<R.warpheight&&(R.warpheight=2048);if(R.oldwarpwidth!==R.warpwidth||R.oldwarpheight!==R.warpheight)R.oldwarpwidth=R.warpwidth,R.oldwarpheight=R.warpheight,GL.Bind(0,R.warptexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,R.warpwidth,R.warpheight,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,R.warprenderbuffer),gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16,R.warpwidth,R.warpheight),gl.bindRenderbuffer(gl.RENDERBUFFER,null)},SizeUp_f:function(){Cvar.SetValue("viewsize",SCR.viewsize.value+10);SCR.recalc_refdef=!0},SizeDown_f:function(){Cvar.SetValue("viewsize",SCR.viewsize.value-10);SCR.recalc_refdef=!0},Init:function(){SCR.fov=Cvar.RegisterVariable("fov","90");SCR.viewsize=Cvar.RegisterVariable("viewsize","100",!0);SCR.conspeed=Cvar.RegisterVariable("scr_conspeed","300");SCR.showturtle=Cvar.RegisterVariable("showturtle","0");SCR.showpause= Cvar.RegisterVariable("showpause","1");SCR.centertime=Cvar.RegisterVariable("scr_centertime","2");SCR.printspeed=Cvar.RegisterVariable("scr_printspeed","8");Cmd.AddCommand("screenshot",SCR.ScreenShot_f);Cmd.AddCommand("sizeup",SCR.SizeUp_f);Cmd.AddCommand("sizedown",SCR.SizeDown_f);SCR.net=Draw.PicFromWad("net");SCR.turtle=Draw.PicFromWad("turtle");SCR.pause=Draw.CachePic("pause")},count:0,DrawTurtle:function(){0!==SCR.showturtle.value&&(0.1>Host.frametime?SCR.count=0:3<=++SCR.count&&Draw.Pic(R.refdef.vrect.x, R.refdef.vrect.y,SCR.turtle))},DrawNet:function(){0.3<=Host.realtime-CL.state.last_received_message&&!0!==CL.cls.demoplayback&&Draw.Pic(R.refdef.vrect.x,R.refdef.vrect.y,SCR.net)},DrawPause:function(){0!==SCR.showpause.value&&!0===CL.state.paused&&Draw.Pic(VID.width-SCR.pause.width>>1,VID.height-48-SCR.pause.height>>1,SCR.pause)},SetUpToDrawConsole:function(){Con.forcedup=null==CL.state.worldmodel||4!==CL.cls.signon;if(!0===Con.forcedup)SCR.con_current=200;else{var a;a=Key.dest.value===Key.dest.console? 100:0;a<SCR.con_current?(SCR.con_current-=SCR.conspeed.value*Host.frametime,a>SCR.con_current&&(SCR.con_current=a)):a>SCR.con_current&&(SCR.con_current+=SCR.conspeed.value*Host.frametime,a<SCR.con_current&&(SCR.con_current=a))}},DrawConsole:function(){0<SCR.con_current?Con.DrawConsole(SCR.con_current):(Key.dest.value===Key.dest.game||Key.dest.value===Key.dest.message)&&Con.DrawNotify()},ScreenShot_f:function(){SCR.screenshot=!0},BeginLoadingPlaque:function(){S.StopAllSounds();CL.cls.state!==CL.active.connected|| 4!==CL.cls.signon||(SCR.centertime_off=0,SCR.con_current=0,SCR.disabled_for_loading=!0,SCR.disabled_time=Host.realtime+60)},UpdateScreen:function(){if(!0===SCR.disabled_for_loading){if(Host.realtime<=SCR.disabled_time)return;SCR.disabled_for_loading=!1;Con.Print("load failed.\n")}var a=document.getElementsByTagName("html")[0],b=320>=a.clientWidth?320:a.clientWidth,a=200>=a.clientHeight?200:a.clientHeight;if(VID.width!=b||VID.height!=a||0===Host.framecount)VID.width=b,VID.height=a,VID.mainwindow.width= b,VID.mainwindow.height=a,SCR.recalc_refdef=!0;SCR.oldfov!==SCR.fov.value&&(SCR.oldfov=SCR.fov.value,SCR.recalc_refdef=!0);SCR.oldscreensize!==SCR.viewsize.value&&(SCR.oldscreensize=SCR.viewsize.value,SCR.recalc_refdef=!0);!0===SCR.recalc_refdef&&SCR.CalcRefdef();SCR.SetUpToDrawConsole();V.RenderView();GL.Set2D();!0===R.dowarp&&R.WarpScreen();!0!==Con.forcedup&&R.PolyBlend();CL.cls.state===CL.active.connecting?SCR.DrawConsole():1===CL.state.intermission&&Key.dest.value===Key.dest.game?Sbar.IntermissionOverlay(): 2===CL.state.intermission&&Key.dest.value===Key.dest.game?(Sbar.FinaleOverlay(),SCR.DrawCenterString()):3===CL.state.intermission&&Key.dest.value===Key.dest.game?SCR.DrawCenterString():(0!==V.crosshair.value&&Draw.Character(R.refdef.vrect.x+(R.refdef.vrect.width>>1)+V.crossx.value,R.refdef.vrect.y+(R.refdef.vrect.height>>1)+V.crossy.value,43),SCR.DrawNet(),SCR.DrawTurtle(),SCR.DrawPause(),SCR.DrawCenterString(),Sbar.Draw(),SCR.DrawConsole(),M.Draw());gl.disable(gl.BLEND);!0===SCR.screenshot&&(SCR.screenshot= !1,gl.finish(),open(VID.mainwindow.toDataURL("image/jpeg")))}};
var SV={movetype:{none:0,anglenoclip:1,angleclip:2,walk:3,step:4,fly:5,toss:6,push:7,noclip:8,flymissile:9,bounce:10},solid:{not:0,trigger:1,bbox:2,slidebox:3,bsp:4},damage:{no:0,yes:1,aim:2},fl:{fly:1,swim:2,conveyor:4,client:8,inwater:16,monster:32,godmode:64,notarget:128,item:256,onground:512,partialground:1024,waterjump:2048,jumpreleased:4096}}; SV.server={num_edicts:0,datagram:{data:new ArrayBuffer(1024),cursize:0},reliable_datagram:{data:new ArrayBuffer(1024),cursize:0},signon:{data:new ArrayBuffer(8192),cursize:0}};SV.svs={}; SV.Init=function(){SV.maxvelocity=Cvar.RegisterVariable("sv_maxvelocity","2000");SV.gravity=Cvar.RegisterVariable("sv_gravity","800",!1,!0);SV.friction=Cvar.RegisterVariable("sv_friction","4",!1,!0);SV.edgefriction=Cvar.RegisterVariable("edgefriction","2");SV.stopspeed=Cvar.RegisterVariable("sv_stopspeed","100");SV.maxspeed=Cvar.RegisterVariable("sv_maxspeed","320",!1,!0);SV.accelerate=Cvar.RegisterVariable("sv_accelerate","10");SV.idealpitchscale=Cvar.RegisterVariable("sv_idealpitchscale","0.8"); SV.aim=Cvar.RegisterVariable("sv_aim","0.93");SV.nostep=Cvar.RegisterVariable("sv_nostep","0");SV.nop={data:new ArrayBuffer(4),cursize:1};(new Uint8Array(SV.nop.data))[0]=Protocol.svc.nop;SV.reconnect={data:new ArrayBuffer(128),cursize:0};MSG.WriteByte(SV.reconnect,Protocol.svc.stufftext);MSG.WriteString(SV.reconnect,"reconnect\n");SV.InitBoxHull()}; SV.StartParticle=function(a,b,c,d){var e=SV.server.datagram;if(!(1009<=e.cursize)){MSG.WriteByte(e,Protocol.svc.particle);MSG.WriteCoord(e,a[0]);MSG.WriteCoord(e,a[1]);MSG.WriteCoord(e,a[2]);var f;for(a=0;2>=a;++a)f=16*b[a]>>0,127<f?f=127:-128>f&&(f=-128),MSG.WriteChar(e,f);MSG.WriteByte(e,d);MSG.WriteByte(e,c)}}; SV.StartSound=function(a,b,c,d,e){(0>d||255<d)&&Sys.Error("SV.StartSound: volume = "+d);(0>e||4<e)&&Sys.Error("SV.StartSound: attenuation = "+e);(0>b||7<b)&&Sys.Error("SV.StartSound: channel = "+b);var f=SV.server.datagram;if(!(1009<=f.cursize)){var g;for(g=1;g<SV.server.sound_precache.length&&c!==SV.server.sound_precache[g];++g);g>=SV.server.sound_precache.length?Con.Print("SV.StartSound: "+c+" not precached\n"):(c=0,255!==d&&(c+=1),1!==e&&(c+=2),MSG.WriteByte(f,Protocol.svc.sound),MSG.WriteByte(f, c),0!==(c&1)&&MSG.WriteByte(f,d),0!==(c&2)&&MSG.WriteByte(f,Math.floor(64*e)),MSG.WriteShort(f,(a.num<<3)+b),MSG.WriteByte(f,g),MSG.WriteCoord(f,a.v_float[PR.entvars.origin]+0.5*(a.v_float[PR.entvars.mins]+a.v_float[PR.entvars.maxs])),MSG.WriteCoord(f,a.v_float[PR.entvars.origin1]+0.5*(a.v_float[PR.entvars.mins1]+a.v_float[PR.entvars.maxs1])),MSG.WriteCoord(f,a.v_float[PR.entvars.origin2]+0.5*(a.v_float[PR.entvars.mins2]+a.v_float[PR.entvars.maxs2])))}}; SV.SendServerinfo=function(a){var b=a.message;MSG.WriteByte(b,Protocol.svc.print);MSG.WriteString(b,"\u0002\nVERSION 1.09 SERVER ("+PR.crc+" CRC)");MSG.WriteByte(b,Protocol.svc.serverinfo);MSG.WriteLong(b,Protocol.version);MSG.WriteByte(b,SV.svs.maxclients);MSG.WriteByte(b,0===Host.coop.value&&0!==Host.deathmatch.value?1:0);MSG.WriteString(b,PR.GetString(SV.server.edicts[0].v_int[PR.entvars.message]));var c;for(c=1;c<SV.server.model_precache.length;++c)MSG.WriteString(b,SV.server.model_precache[c]); MSG.WriteByte(b,0);for(c=1;c<SV.server.sound_precache.length;++c)MSG.WriteString(b,SV.server.sound_precache[c]);MSG.WriteByte(b,0);MSG.WriteByte(b,Protocol.svc.cdtrack);MSG.WriteByte(b,SV.server.edicts[0].v_float[PR.entvars.sounds]);MSG.WriteByte(b,SV.server.edicts[0].v_float[PR.entvars.sounds]);MSG.WriteByte(b,Protocol.svc.setview);MSG.WriteShort(b,a.edict.num);MSG.WriteByte(b,Protocol.svc.signonnum);MSG.WriteByte(b,1);a.sendsignon=!0;a.spawned=!1}; SV.ConnectClient=function(a){var b=SV.svs.clients[a],c,d;if(!0===SV.server.loadgame){d=[];null==b.spawn_parms&&(b.spawn_parms=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(c=0;15>=c;++c)d[c]=b.spawn_parms[c]}Con.DPrint("Client "+b.netconnection.address+" connected\n");b.active=!0;b.dropasap=!1;b.last_message=0;b.cmd={forwardmove:0,sidemove:0,upmove:0};b.wishdir=[0,0,0];b.message.cursize=0;b.edict=SV.server.edicts[a+1];b.edict.v_int[PR.entvars.netname]=PR.netnames+(a<<5);SV.SetClientName(b,"unconnected"); b.colors=0;b.ping_times=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];b.num_pings=0;!0!==SV.server.loadgame&&(b.spawn_parms=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);b.old_frags=0;if(!0===SV.server.loadgame)for(c=0;15>=c;++c)b.spawn_parms[c]=d[c];else{PR.ExecuteProgram(PR.globals_int[PR.globalvars.SetNewParms]);for(c=0;15>=c;++c)b.spawn_parms[c]=PR.globals_float[PR.globalvars.parms+c]}SV.SendServerinfo(b)};SV.fatpvs=[]; SV.CheckForNewClients=function(){for(var a,b;;){a=NET.CheckNewConnections();if(null==a)break;for(b=0;b<SV.svs.maxclients&&!0===SV.svs.clients[b].active;++b);b===SV.svs.maxclients&&Sys.Error("SV.CheckForNewClients: no free clients");SV.svs.clients[b].netconnection=a;SV.ConnectClient(b);++NET.activeconnections}}; SV.AddToFatPVS=function(a,b){for(var c,d;;){if(0>b.contents){if(b.contents!==Mod.contents.solid){c=Mod.LeafPVS(b,SV.server.worldmodel);for(d=0;d<SV.fatbytes;++d)SV.fatpvs[d]|=c[d]}break}c=b.plane.normal;c=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]-b.plane.dist;8<c?b=b.children[0]:(-8<=c&&SV.AddToFatPVS(a,b.children[0]),b=b.children[1])}};SV.FatPVS=function(a){SV.fatbytes=SV.server.worldmodel.leafs.length+31>>3;var b;for(b=0;b<SV.fatbytes;++b)SV.fatpvs[b]=0;SV.AddToFatPVS(a,SV.server.worldmodel.nodes[0])}; SV.WriteEntitiesToClient=function(a,b){SV.FatPVS([a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.view_ofs],a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.view_ofs1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.view_ofs2]]);var c=SV.fatpvs,d,e,f,g,h;for(e=1;e<SV.server.num_edicts;++e){d=SV.server.edicts[e];if(d!==a){if(0===d.v_float[PR.entvars.modelindex]||0===PR.strings[d.v_int[PR.entvars.model]])continue;for(f=0;f<d.leafnums.length&&0===(c[d.leafnums[f]>>3]&1<<(d.leafnums[f]&7));++f); if(f===d.leafnums.length)continue}if(16>b.data.byteLength-b.cursize){Con.Print("packet overflow\n");break}for(f=g=0;2>=f;++f)if(h=d.v_float[PR.entvars.origin+f]-d.baseline.origin[f],-0.1>h||0.1<h)g+=Protocol.u.origin1<<f;d.v_float[PR.entvars.angles]!==d.baseline.angles[0]&&(g+=Protocol.u.angle1);d.v_float[PR.entvars.angles1]!==d.baseline.angles[1]&&(g+=Protocol.u.angle2);d.v_float[PR.entvars.angles2]!==d.baseline.angles[2]&&(g+=Protocol.u.angle3);d.v_float[PR.entvars.movetype]!==SV.movetype.step&& (g+=Protocol.u.nolerp);d.baseline.colormap!==d.v_float[PR.entvars.colormap]&&(g+=Protocol.u.colormap);d.baseline.skin!==d.v_float[PR.entvars.skin]&&(g+=Protocol.u.skin);d.baseline.frame!==d.v_float[PR.entvars.frame]&&(g+=Protocol.u.frame);d.baseline.effects!==d.v_float[PR.entvars.effects]&&(g+=Protocol.u.effects);d.baseline.modelindex!==d.v_float[PR.entvars.modelindex]&&(g+=Protocol.u.model);256<=e&&(g+=Protocol.u.longentity);256<=g&&(g+=Protocol.u.morebits);MSG.WriteByte(b,g+Protocol.u.signal);0!== (g&Protocol.u.morebits)&&MSG.WriteByte(b,g>>8);0!==(g&Protocol.u.longentity)?MSG.WriteShort(b,e):MSG.WriteByte(b,e);0!==(g&Protocol.u.model)&&MSG.WriteByte(b,d.v_float[PR.entvars.modelindex]);0!==(g&Protocol.u.frame)&&MSG.WriteByte(b,d.v_float[PR.entvars.frame]);0!==(g&Protocol.u.colormap)&&MSG.WriteByte(b,d.v_float[PR.entvars.colormap]);0!==(g&Protocol.u.skin)&&MSG.WriteByte(b,d.v_float[PR.entvars.skin]);0!==(g&Protocol.u.effects)&&MSG.WriteByte(b,d.v_float[PR.entvars.effects]);0!==(g&Protocol.u.origin1)&& MSG.WriteCoord(b,d.v_float[PR.entvars.origin]);0!==(g&Protocol.u.angle1)&&MSG.WriteAngle(b,d.v_float[PR.entvars.angles]);0!==(g&Protocol.u.origin2)&&MSG.WriteCoord(b,d.v_float[PR.entvars.origin1]);0!==(g&Protocol.u.angle2)&&MSG.WriteAngle(b,d.v_float[PR.entvars.angles1]);0!==(g&Protocol.u.origin3)&&MSG.WriteCoord(b,d.v_float[PR.entvars.origin2]);0!==(g&Protocol.u.angle3)&&MSG.WriteAngle(b,d.v_float[PR.entvars.angles2])}}; SV.WriteClientdataToMessage=function(a,b){if(0!==a.v_float[PR.entvars.dmg_take]||0!==a.v_float[PR.entvars.dmg_save]){var c=SV.server.edicts[a.v_int[PR.entvars.dmg_inflictor]];MSG.WriteByte(b,Protocol.svc.damage);MSG.WriteByte(b,a.v_float[PR.entvars.dmg_save]);MSG.WriteByte(b,a.v_float[PR.entvars.dmg_take]);MSG.WriteCoord(b,c.v_float[PR.entvars.origin]+0.5*(c.v_float[PR.entvars.mins]+c.v_float[PR.entvars.maxs]));MSG.WriteCoord(b,c.v_float[PR.entvars.origin1]+0.5*(c.v_float[PR.entvars.mins1]+c.v_float[PR.entvars.maxs1])); MSG.WriteCoord(b,c.v_float[PR.entvars.origin2]+0.5*(c.v_float[PR.entvars.mins2]+c.v_float[PR.entvars.maxs2]));a.v_float[PR.entvars.dmg_take]=0;a.v_float[PR.entvars.dmg_save]=0}SV.SetIdealPitch();0!==a.v_float[PR.entvars.fixangle]&&(MSG.WriteByte(b,Protocol.svc.setangle),MSG.WriteAngle(b,a.v_float[PR.entvars.angles]),MSG.WriteAngle(b,a.v_float[PR.entvars.angles1]),MSG.WriteAngle(b,a.v_float[PR.entvars.angles2]),a.v_float[PR.entvars.fixangle]=0);c=Protocol.su.items+Protocol.su.weapon;a.v_float[PR.entvars.view_ofs2]!== Protocol.default_viewheight&&(c+=Protocol.su.viewheight);0!==a.v_float[PR.entvars.idealpitch]&&(c+=Protocol.su.idealpitch);var d=PR.entvars.items2,d=null!=d?0!==a.v_float[d]?(a.v_float[PR.entvars.items]>>0)+(a.v_float[d]<<23>>>0):(a.v_float[PR.entvars.items]>>0)+(PR.globals_float[PR.globalvars.serverflags]<<28>>>0):(a.v_float[PR.entvars.items]>>0)+(PR.globals_float[PR.globalvars.serverflags]<<28>>>0);a.v_float[PR.entvars.flags]&SV.fl.onground&&(c+=Protocol.su.onground);2<=a.v_float[PR.entvars.waterlevel]&& (c+=Protocol.su.inwater);0!==a.v_float[PR.entvars.punchangle]&&(c+=Protocol.su.punch1);0!==a.v_float[PR.entvars.velocity]&&(c+=Protocol.su.velocity1);0!==a.v_float[PR.entvars.punchangle1]&&(c+=Protocol.su.punch2);0!==a.v_float[PR.entvars.velocity1]&&(c+=Protocol.su.velocity2);0!==a.v_float[PR.entvars.punchangle2]&&(c+=Protocol.su.punch3);0!==a.v_float[PR.entvars.velocity2]&&(c+=Protocol.su.velocity3);0!==a.v_float[PR.entvars.weaponframe]&&(c+=Protocol.su.weaponframe);0!==a.v_float[PR.entvars.armorvalue]&& (c+=Protocol.su.armor);MSG.WriteByte(b,Protocol.svc.clientdata);MSG.WriteShort(b,c);0!==(c&Protocol.su.viewheight)&&MSG.WriteChar(b,a.v_float[PR.entvars.view_ofs2]);0!==(c&Protocol.su.idealpitch)&&MSG.WriteChar(b,a.v_float[PR.entvars.idealpitch]);0!==(c&Protocol.su.punch1)&&MSG.WriteChar(b,a.v_float[PR.entvars.punchangle]);0!==(c&Protocol.su.velocity1)&&MSG.WriteChar(b,0.0625*a.v_float[PR.entvars.velocity]);0!==(c&Protocol.su.punch2)&&MSG.WriteChar(b,a.v_float[PR.entvars.punchangle1]);0!==(c&Protocol.su.velocity2)&& MSG.WriteChar(b,0.0625*a.v_float[PR.entvars.velocity1]);0!==(c&Protocol.su.punch3)&&MSG.WriteChar(b,a.v_float[PR.entvars.punchangle2]);0!==(c&Protocol.su.velocity3)&&MSG.WriteChar(b,0.0625*a.v_float[PR.entvars.velocity2]);MSG.WriteLong(b,d);0!==(c&Protocol.su.weaponframe)&&MSG.WriteByte(b,a.v_float[PR.entvars.weaponframe]);0!==(c&Protocol.su.armor)&&MSG.WriteByte(b,a.v_float[PR.entvars.armorvalue]);MSG.WriteByte(b,SV.ModelIndex(PR.GetString(a.v_int[PR.entvars.weaponmodel])));MSG.WriteShort(b,a.v_float[PR.entvars.health]); MSG.WriteByte(b,a.v_float[PR.entvars.currentammo]);MSG.WriteByte(b,a.v_float[PR.entvars.ammo_shells]);MSG.WriteByte(b,a.v_float[PR.entvars.ammo_nails]);MSG.WriteByte(b,a.v_float[PR.entvars.ammo_rockets]);MSG.WriteByte(b,a.v_float[PR.entvars.ammo_cells]);if(!0===COM.standard_quake)MSG.WriteByte(b,a.v_float[PR.entvars.weapon]);else{d=a.v_float[PR.entvars.weapon];for(c=0;31>=c;++c)if(0!==(d&1<<c)){MSG.WriteByte(b,c);break}}};SV.clientdatagram={data:new ArrayBuffer(1024),cursize:0}; SV.SendClientDatagram=function(){var a=Host.client,b=SV.clientdatagram;b.cursize=0;MSG.WriteByte(b,Protocol.svc.time);MSG.WriteFloat(b,SV.server.time);SV.WriteClientdataToMessage(a.edict,b);SV.WriteEntitiesToClient(a.edict,b);b.cursize+SV.server.datagram.cursize<b.data.byteLength&&SZ.Write(b,new Uint8Array(SV.server.datagram.data),SV.server.datagram.cursize);if(-1===NET.SendUnreliableMessage(a.netconnection,b))Host.DropClient(!0);else return!0}; SV.UpdateToReliableMessages=function(){var a,b,c,d;for(a=0;a<SV.svs.maxclients;++a)if(Host.client=SV.svs.clients[a],Host.client.edict.v_float[PR.entvars.frags]>>=0,b=Host.client.edict.v_float[PR.entvars.frags],Host.client.old_frags!==b){for(c=0;c<SV.svs.maxclients;++c)d=SV.svs.clients[c],!0===d.active&&(MSG.WriteByte(d.message,Protocol.svc.updatefrags),MSG.WriteByte(d.message,a),MSG.WriteShort(d.message,b));Host.client.old_frags=b}for(a=0;a<SV.svs.maxclients;++a)d=SV.svs.clients[a],!0===d.active&& SZ.Write(d.message,new Uint8Array(SV.server.reliable_datagram.data),SV.server.reliable_datagram.cursize);SV.server.reliable_datagram.cursize=0}; SV.SendClientMessages=function(){SV.UpdateToReliableMessages();var a,b;for(a=0;a<SV.svs.maxclients;++a)if(Host.client=b=SV.svs.clients[a],!0===b.active){if(!0===b.spawned){if(!0!==SV.SendClientDatagram())continue}else if(!0!==b.sendsignon){5<Host.realtime-b.last_message&&(-1===NET.SendUnreliableMessage(b.netconnection,SV.nop)&&Host.DropClient(!0),b.last_message=Host.realtime);continue}!0===b.message.overflowed?(Host.DropClient(!0),b.message.overflowed=!1):!0===b.dropasap?!0===NET.CanSendMessage(b.netconnection)&& Host.DropClient():0!==b.message.cursize&&!0===NET.CanSendMessage(b.netconnection)&&(-1===NET.SendMessage(b.netconnection,b.message)&&Host.DropClient(!0),b.message.cursize=0,b.last_message=Host.realtime,b.sendsignon=!1)}for(a=1;a<SV.server.num_edicts;++a)SV.server.edicts[a].v_float[PR.entvars.effects]&=~Mod.effects.muzzleflash>>>0}; SV.ModelIndex=function(a){if(null==a||0===a.length)return 0;var b;for(b=0;b<SV.server.model_precache.length;++b)if(SV.server.model_precache[b]===a)return b;Sys.Error("SV.ModelIndex: model "+a+" not precached")}; SV.CreateBaseline=function(){var a,b,c,d=SV.ModelIndex("progs/player.mdl"),e=SV.server.signon;for(a=0;a<SV.server.num_edicts;++a)b=SV.server.edicts[a],!0!==b.free&&!(a>SV.svs.maxclients&&0===b.v_int[PR.entvars.modelindex])&&(c=b.baseline,c.origin=ED.Vector(b,PR.entvars.origin),c.angles=ED.Vector(b,PR.entvars.angles),c.frame=b.v_float[PR.entvars.frame]>>0,c.skin=b.v_float[PR.entvars.skin]>>0,0<a&&a<=SV.server.maxclients?(c.colormap=entnum,c.modelindex=d):(c.colormap=0,c.modelindex=SV.ModelIndex(PR.GetString(b.v_int[PR.entvars.model]))), MSG.WriteByte(e,Protocol.svc.spawnbaseline),MSG.WriteShort(e,a),MSG.WriteByte(e,c.modelindex),MSG.WriteByte(e,c.frame),MSG.WriteByte(e,c.colormap),MSG.WriteByte(e,c.skin),MSG.WriteCoord(e,c.origin[0]),MSG.WriteAngle(e,c.angles[0]),MSG.WriteCoord(e,c.origin[1]),MSG.WriteAngle(e,c.angles[1]),MSG.WriteCoord(e,c.origin[2]),MSG.WriteAngle(e,c.angles[2]))}; SV.SaveSpawnparms=function(){SV.svs.serverflags=PR.globals_float[PR.globalvars.serverflags];var a,b;for(a=0;a<SV.svs.maxclients;++a)if(Host.client=SV.svs.clients[a],!0===Host.client.active){PR.globals_int[PR.globalvars.self]=Host.client.edict.num;PR.ExecuteProgram(PR.globals_int[PR.globalvars.SetChangeParms]);for(b=0;15>=b;++b)Host.client.spawn_parms[b]=PR.globals_float[PR.globalvars.parms+b]}}; SV.SpawnServer=function(a){var b;0===NET.hostname.string.length&&Cvar.Set("hostname","UNNAMED");SCR.centertime_off=0;Con.DPrint("SpawnServer: "+a+"\n");SV.svs.changelevel_issued=!1;!0===SV.server.active&&(NET.SendToAll(SV.reconnect),Cmd.ExecuteString("reconnect\n"));0!==Host.coop.value&&Cvar.SetValue("deathmatch",0);Host.current_skill=Math.floor(Host.skill.value+0.5);0>Host.current_skill?Host.current_skill=0:3<Host.current_skill&&(Host.current_skill=3);Cvar.SetValue("skill",Host.current_skill);Con.DPrint("Clearing memory\n"); Mod.ClearAll();PR.LoadProgs();SV.server.edicts=[];var c;for(b=0;b<Def.max_edicts;++b)c={num:b,free:!1,area:{},leafnums:[],baseline:{origin:[0,0,0],angles:[0,0,0],modelindex:0,frame:0,colormap:0,skin:0,effects:0},freetime:0,v:new ArrayBuffer(PR.entityfields<<2)},c.area.ent=c,c.v_float=new Float32Array(c.v),c.v_int=new Int32Array(c.v),SV.server.edicts[b]=c;SV.server.datagram.cursize=0;SV.server.reliable_datagram.cursize=0;SV.server.signon.cursize=0;SV.server.num_edicts=SV.svs.maxclients+1;for(b=0;b< SV.svs.maxclients;++b)SV.svs.clients[b].edict=SV.server.edicts[b+1];SV.server.loading=!0;SV.server.paused=!1;SV.server.loadgame=!1;SV.server.time=1;SV.server.lastcheck=0;SV.server.lastchecktime=0;SV.server.modelname="maps/"+a+".bsp";SV.server.worldmodel=Mod.ForName(SV.server.modelname);if(null==SV.server.worldmodel)Con.Print("Couldn't spawn server "+SV.server.modelname+"\n"),SV.server.active=!1;else{SV.server.models=[];SV.server.models[1]=SV.server.worldmodel;SV.areanodes=[];SV.CreateAreaNode(0,SV.server.worldmodel.mins, SV.server.worldmodel.maxs);SV.server.sound_precache=[""];SV.server.model_precache=["",SV.server.modelname];for(b=1;b<=SV.server.worldmodel.submodels.length;++b)SV.server.model_precache[b+1]="*"+b,SV.server.models[b+1]=Mod.ForName("*"+b);SV.server.lightstyles=[];for(b=0;63>=b;++b)SV.server.lightstyles[b]="";b=SV.server.edicts[0];b.v_int[PR.entvars.model]=PR.NewString(SV.server.modelname,64);b.v_float[PR.entvars.modelindex]=1;b.v_float[PR.entvars.solid]=SV.solid.bsp;b.v_float[PR.entvars.movetype]=SV.movetype.push; 0!==Host.coop.value?PR.globals_float[PR.globalvars.coop]=Host.coop.value:PR.globals_float[PR.globalvars.deathmatch]=Host.deathmatch.value;PR.globals_int[PR.globalvars.mapname]=PR.NewString(a,64);PR.globals_float[PR.globalvars.serverflags]=SV.svs.serverflags;ED.LoadFromFile(SV.server.worldmodel.entities);SV.server.active=!0;SV.server.loading=!1;Host.frametime=0.1;SV.Physics();SV.Physics();SV.CreateBaseline();for(b=0;b<SV.svs.maxclients;++b)Host.client=SV.svs.clients[b],!0===Host.client.active&&(Host.client.edict.v_int[PR.entvars.netname]= PR.netnames+(b<<5),SV.SendServerinfo(Host.client));Con.DPrint("Server spawned.\n")}};SV.GetClientName=function(a){return PR.GetString(PR.netnames+(a.num<<5))};SV.SetClientName=function(a,b){var c=PR.netnames+(a.num<<5),d;for(d=0;d<b.length;++d)PR.strings[c+d]=b.charCodeAt(d);PR.strings[c+d]=0}; SV.CheckBottom=function(a){for(var b=[a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.mins],a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.mins1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.mins2]],c=[a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.maxs],a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.maxs1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.maxs2]];SV.PointContents([b[0],b[1],b[2]-1])===Mod.contents.solid&&SV.PointContents([b[0],c[1],b[2]-1])===Mod.contents.solid&& SV.PointContents([c[0],b[1],b[2]-1])===Mod.contents.solid&&SV.PointContents([c[0],c[1],b[2]-1])===Mod.contents.solid;)return!0;var d=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),b[2]],e=[d[0],d[1],d[2]-36],f=SV.Move(d,Vec.origin,Vec.origin,e,1,a);if(1!==f.fraction){var g,h;g=h=f.endpos[2];var j,k;for(j=0;1>=j;++j)for(k=0;1>=k;++k)if(d[0]=e[0]=0!==j?c[0]:b[0],d[1]=e[1]=0!==k?c[1]:b[1],f=SV.Move(d,Vec.origin,Vec.origin,e,1,a),1!==f.fraction&&f.endpos[2]>h&&(h=f.endpos[2]),1===f.fraction||18<g-f.endpos[2])return; return!0}}; SV.movestep=function(a,b,c){var d=ED.Vector(a,PR.entvars.origin),e=[],f=ED.Vector(a,PR.entvars.mins),g=ED.Vector(a,PR.entvars.maxs),h;if(0!==(a.v_float[PR.entvars.flags]&SV.fl.swim+SV.fl.fly)){for(var j=a.v_int[PR.entvars.enemy],d=0;1>=d;++d){e[0]=a.v_float[PR.entvars.origin]+b[0];e[1]=a.v_float[PR.entvars.origin1]+b[1];e[2]=a.v_float[PR.entvars.origin2];0===d&&0!==j&&(h=a.v_float[PR.entvars.origin2]-SV.server.edicts[j].v_float[PR.entvars.origin2],40<h?e[2]-=8:30>h&&(e[2]+=8));h=SV.Move(ED.Vector(a,PR.entvars.origin), f,g,e,0,a);if(1===h.fraction){if(0!==(a.v_float[PR.entvars.flags]&SV.fl.swim)&&SV.PointContents(h.endpos)===Mod.contents.empty)break;a.v_float[PR.entvars.origin]=h.endpos[0];a.v_float[PR.entvars.origin1]=h.endpos[1];a.v_float[PR.entvars.origin2]=h.endpos[2];!0===c&&SV.LinkEdict(a,!0);return 1}if(0===j)break}return 0}e[0]=a.v_float[PR.entvars.origin]+b[0];e[1]=a.v_float[PR.entvars.origin1]+b[1];e[2]=a.v_float[PR.entvars.origin2]+18;j=[e[0],e[1],e[2]-36];h=SV.Move(e,f,g,j,0,a);if(!0===h.allsolid||!0=== h.startsolid&&(e[2]-=18,h=SV.Move(e,f,g,j,0,a),!0===h.allsolid||!0===h.startsolid))return 0;if(1===h.fraction){if(0===(a.v_float[PR.entvars.flags]&SV.fl.partialground))return 0;a.v_float[PR.entvars.origin]+=b[0];a.v_float[PR.entvars.origin1]+=b[1];!0===c&&SV.LinkEdict(a,!0);a.v_float[PR.entvars.flags]&=~SV.fl.onground>>>0;return 1}a.v_float[PR.entvars.origin]=h.endpos[0];a.v_float[PR.entvars.origin1]=h.endpos[1];a.v_float[PR.entvars.origin2]=h.endpos[2];if(!0!==SV.CheckBottom(a)){if(0!==(a.v_float[PR.entvars.flags]& SV.fl.partialground))return!0===c&&SV.LinkEdict(a,!0),1;a.v_float[PR.entvars.origin]=d[0];a.v_float[PR.entvars.origin1]=d[1];a.v_float[PR.entvars.origin2]=d[2];return 0}a.v_float[PR.entvars.flags]&=~SV.fl.partialground>>>0;a.v_int[PR.entvars.groundentity]=h.ent.num;!0===c&&SV.LinkEdict(a,!0);return 1}; SV.StepDirection=function(a,b,c){a.v_float[PR.entvars.ideal_yaw]=b;PF.changeyaw();b*=Math.PI/180;var d=ED.Vector(a,PR.entvars.origin);if(1===SV.movestep(a,[Math.cos(b)*c,Math.sin(b)*c],!1))return b=a.v_float[PR.entvars.angles1]-a.v_float[PR.entvars.ideal_yaw],45<b&&315>b&&ED.SetVector(a,PR.entvars.origin,d),SV.LinkEdict(a,!0),!0;SV.LinkEdict(a,!0)}; SV.NewChaseDir=function(a,b,c){var d=Vec.Anglemod(45*(a.v_float[PR.entvars.ideal_yaw]/45>>0)),e=Vec.Anglemod(d-180),f=b.v_float[PR.entvars.origin]-a.v_float[PR.entvars.origin];b=b.v_float[PR.entvars.origin1]-a.v_float[PR.entvars.origin1];var g,h;g=10<f?0:-10>f?180:-1;h=-10>b?270:10<b?90:-1;var j;if(-1!==g&&-1!==h&&(j=0===g?90===h?45:315:90===h?135:215,j!==e&&!0===SV.StepDirection(a,j,c)))return;if(0.25<=Math.random()||Math.abs(b)>Math.abs(f))j=g,g=h,h=j;if(!(-1!==g&&g!==e&&!0===SV.StepDirection(a, g,c))&&!(-1!==h&&h!==e&&!0===SV.StepDirection(a,h,c))&&!(-1!==d&&!0===SV.StepDirection(a,d,c))){if(0.5<=Math.random())for(j=0;315>=j;j+=45){if(j!==e&&!0===SV.StepDirection(a,j,c))return}else for(j=315;0<=j;j-=45)if(j!==e&&!0===SV.StepDirection(a,j,c))return;-1!==e&&!0===SV.StepDirection(a,e,c)||(a.v_float[PR.entvars.ideal_yaw]=d,!0!==SV.CheckBottom(a)&&(a.v_float[PR.entvars.flags]|=SV.fl.partialground))}}; SV.CloseEnough=function(a,b,c){var d;for(d=0;2>=d;++d)if(b.v_float[PR.entvars.absmin+d]>a.v_float[PR.entvars.absmax+d]+c||b.v_float[PR.entvars.absmax+d]<a.v_float[PR.entvars.absmin+d]-c)return;return!0};SV.CheckAllEnts=function(){var a,b;for(a=1;a<SV.server.num_edicts;++a)if(b=SV.server.edicts[a],!0!==b.free){switch(b.v_float[PR.entvars.movetype]){case SV.movetype.push:case SV.movetype.none:case SV.movetype.noclip:continue}!0===SV.TestEntityPosition(b)&&Con.Print("entity in invalid position\n")}}; SV.CheckVelocity=function(a){var b,c;for(b=0;2>=b;++b)c=a.v_float[PR.entvars.velocity+b],!0===isNaN(c)&&(Con.Print("Got a NaN velocity on "+PR.GetString(a.v_int[PR.entvars.classname])+"\n"),c=0),!0===isNaN(a.v_float[PR.entvars.origin+b])&&(Con.Print("Got a NaN origin on "+PR.GetString(a.v_int[PR.entvars.classname])+"\n"),a.v_float[PR.entvars.origin+b]=0),c>SV.maxvelocity.value?c=SV.maxvelocity.value:c<-SV.maxvelocity.value&&(c=-SV.maxvelocity.value),a.v_float[PR.entvars.velocity+b]=c}; SV.RunThink=function(a){var b=a.v_float[PR.entvars.nextthink];if(0>=b||b>SV.server.time+Host.frametime)return!0;b<SV.server.time&&(b=SV.server.time);a.v_float[PR.entvars.nextthink]=0;PR.globals_float[PR.globalvars.time]=b;PR.globals_int[PR.globalvars.self]=a.num;PR.globals_int[PR.globalvars.other]=0;PR.ExecuteProgram(a.v_int[PR.entvars.think]);return!0!==a.free}; SV.Impact=function(a,b){var c=PR.globals_int[PR.globalvars.self],d=PR.globals_int[PR.globalvars.other];PR.globals_float[PR.globalvars.time]=SV.server.time;0!==a.v_int[PR.entvars.touch]&&a.v_float[PR.entvars.solid]!==SV.solid.not&&(PR.globals_int[PR.globalvars.self]=a.num,PR.globals_int[PR.globalvars.other]=b.num,PR.ExecuteProgram(a.v_int[PR.entvars.touch]));0!==b.v_int[PR.entvars.touch]&&b.v_float[PR.entvars.solid]!==SV.solid.not&&(PR.globals_int[PR.globalvars.self]=b.num,PR.globals_int[PR.globalvars.other]= a.num,PR.ExecuteProgram(b.v_int[PR.entvars.touch]));PR.globals_int[PR.globalvars.self]=c;PR.globals_int[PR.globalvars.other]=d};SV.ClipVelocity=function(a,b,c,d){d*=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];c[0]=a[0]-b[0]*d;-0.1<c[0]&&0.1>c[0]&&(c[0]=0);c[1]=a[1]-b[1]*d;-0.1<c[1]&&0.1>c[1]&&(c[1]=0);c[2]=a[2]-b[2]*d;-0.1<c[2]&&0.1>c[2]&&(c[2]=0)}; SV.FlyMove=function(a,b){var c,d=0,e,f,g=[],h=ED.Vector(a,PR.entvars.velocity),j=ED.Vector(a,PR.entvars.velocity),k=[],m,l=[],n=b,p=0;for(c=0;3>=c&&!(0===a.v_float[PR.entvars.velocity]&&0===a.v_float[PR.entvars.velocity1]&&0===a.v_float[PR.entvars.velocity2]);++c){l[0]=a.v_float[PR.entvars.origin]+n*a.v_float[PR.entvars.velocity];l[1]=a.v_float[PR.entvars.origin1]+n*a.v_float[PR.entvars.velocity1];l[2]=a.v_float[PR.entvars.origin2]+n*a.v_float[PR.entvars.velocity2];e=SV.Move(ED.Vector(a,PR.entvars.origin), ED.Vector(a,PR.entvars.mins),ED.Vector(a,PR.entvars.maxs),l,0,a);if(!0===e.allsolid)return ED.SetVector(a,PR.entvars.velocity,Vec.origin),3;if(0<e.fraction&&(ED.SetVector(a,PR.entvars.origin,e.endpos),j=ED.Vector(a,PR.entvars.velocity),d=0,1===e.fraction))break;null==e.ent&&Sys.Error("SV.FlyMove: !trace.ent");0.7<e.plane.normal[2]?(p|=1,e.ent.v_float[PR.entvars.solid]===SV.solid.bsp&&(a.v_float[PR.entvars.flags]|=SV.fl.onground,a.v_int[PR.entvars.groundentity]=e.ent.num)):0===e.plane.normal[2]&&(p|= 2,SV.steptrace=e);SV.Impact(a,e.ent);if(!0===a.free)break;n-=n*e.fraction;if(5<=d)return ED.SetVector(a,PR.entvars.velocity,Vec.origin),3;g[d++]=[e.plane.normal[0],e.plane.normal[1],e.plane.normal[2]];for(f=0;f<d;++f){SV.ClipVelocity(j,g[f],k,1);for(m=0;m<d&&!(m!==f&&(e=g[m],0>k[0]*e[0]+k[1]*e[1]+k[2]*e[2]));++m);if(m===d)break}if(f!==d)ED.SetVector(a,PR.entvars.velocity,k);else{if(2!==d)return ED.SetVector(a,PR.entvars.velocity,Vec.origin),7;e=Vec.CrossProduct(g[0],g[1]);f=e[0]*a.v_float[PR.entvars.velocity]+ e[1]*a.v_float[PR.entvars.velocity1]+e[2]*a.v_float[PR.entvars.velocity2];a.v_float[PR.entvars.velocity]=e[0]*f;a.v_float[PR.entvars.velocity1]=e[1]*f;a.v_float[PR.entvars.velocity2]=e[2]*f}if(0>=a.v_float[PR.entvars.velocity]*h[0]+a.v_float[PR.entvars.velocity1]*h[1]+a.v_float[PR.entvars.velocity2]*h[2]){ED.SetVector(a,PR.entvars.velocity,Vec.origin);break}}return p}; SV.AddGravity=function(a){var b=PR.entvars.gravity;a.v_float[PR.entvars.velocity2]-=(null!=b?0!==a.v_float[b]?a.v_float[b]:1:1)*SV.gravity.value*Host.frametime}; SV.PushEntity=function(a,b){var c=[a.v_float[PR.entvars.origin]+b[0],a.v_float[PR.entvars.origin1]+b[1],a.v_float[PR.entvars.origin2]+b[2]],d;d=a.v_float[PR.entvars.solid];d=a.v_float[PR.entvars.movetype]===SV.movetype.flymissile?SV.move.missile:d===SV.solid.trigger||d===SV.solid.not?SV.move.nomonsters:SV.move.normal;c=SV.Move(ED.Vector(a,PR.entvars.origin),ED.Vector(a,PR.entvars.mins),ED.Vector(a,PR.entvars.maxs),c,d,a);ED.SetVector(a,PR.entvars.origin,c.endpos);SV.LinkEdict(a,!0);null!=c.ent&&SV.Impact(a, c.ent);return c}; SV.PushMove=function(a,b){if(0===a.v_float[PR.entvars.velocity]&&0===a.v_float[PR.entvars.velocity1]&&0===a.v_float[PR.entvars.velocity2])a.v_float[PR.entvars.ltime]+=b;else{var c=[a.v_float[PR.entvars.velocity]*b,a.v_float[PR.entvars.velocity1]*b,a.v_float[PR.entvars.velocity2]*b],d=[a.v_float[PR.entvars.absmin]+c[0],a.v_float[PR.entvars.absmin1]+c[1],a.v_float[PR.entvars.absmin2]+c[2]],e=[a.v_float[PR.entvars.absmax]+c[0],a.v_float[PR.entvars.absmax1]+c[1],a.v_float[PR.entvars.absmax2]+c[2]],f= ED.Vector(a,PR.entvars.origin);a.v_float[PR.entvars.origin]+=c[0];a.v_float[PR.entvars.origin1]+=c[1];a.v_float[PR.entvars.origin2]+=c[2];a.v_float[PR.entvars.ltime]+=b;SV.LinkEdict(a);var g,h,j,k=[];for(g=1;g<SV.server.num_edicts;++g)if(h=SV.server.edicts[g],!0!==h.free&&(j=h.v_float[PR.entvars.movetype],!(j===SV.movetype.push||j===SV.movetype.none||j===SV.movetype.noclip))){if(0===(h.v_float[PR.entvars.flags]&SV.fl.onground)||h.v_int[PR.entvars.groundentity]!==a.num){if(h.v_float[PR.entvars.absmin]>= e[0]||h.v_float[PR.entvars.absmin1]>=e[1]||h.v_float[PR.entvars.absmin2]>=e[2]||h.v_float[PR.entvars.absmax]<=d[0]||h.v_float[PR.entvars.absmax1]<=d[1]||h.v_float[PR.entvars.absmax2]<=d[2])continue;if(!0!==SV.TestEntityPosition(h))continue}j!==SV.movetype.walk&&(h.v_float[PR.entvars.flags]&=~SV.fl.onground>>>0);j=ED.Vector(h,PR.entvars.origin);k[k.length]=[j[0],j[1],j[2],h];a.v_float[PR.entvars.solid]=SV.solid.not;SV.PushEntity(h,c);a.v_float[PR.entvars.solid]=SV.solid.bsp;if(!0===SV.TestEntityPosition(h)&& h.v_float[PR.entvars.mins]!==h.v_float[PR.entvars.maxs])if(h.v_float[PR.entvars.solid]===SV.solid.not||h.v_float[PR.entvars.solid]===SV.solid.trigger)h.v_float[PR.entvars.mins]=h.v_float[PR.entvars.maxs]=0,h.v_float[PR.entvars.mins1]=h.v_float[PR.entvars.maxs1]=0,h.v_float[PR.entvars.maxs2]=h.v_float[PR.entvars.mins2];else{h.v_float[PR.entvars.origin]=j[0];h.v_float[PR.entvars.origin1]=j[1];h.v_float[PR.entvars.origin2]=j[2];SV.LinkEdict(h,!0);a.v_float[PR.entvars.origin]=f[0];a.v_float[PR.entvars.origin1]= f[1];a.v_float[PR.entvars.origin2]=f[2];SV.LinkEdict(a);a.v_float[PR.entvars.ltime]-=b;0!==a.v_int[PR.entvars.blocked]&&(PR.globals_int[PR.globalvars.self]=a.num,PR.globals_int[PR.globalvars.other]=h.num,PR.ExecuteProgram(a.v_int[PR.entvars.blocked]));for(d=0;d<k.length;++d)c=k[d],c[3].v_float[PR.entvars.origin]=c[0],c[3].v_float[PR.entvars.origin1]=c[1],c[3].v_float[PR.entvars.origin2]=c[2],SV.LinkEdict(c[3]);break}}}}; SV.Physics_Pusher=function(a){var b=a.v_float[PR.entvars.ltime],c=a.v_float[PR.entvars.nextthink],d;c<b+Host.frametime?(d=c-b,0>d&&(d=0)):d=Host.frametime;0!==d&&SV.PushMove(a,d);c<=b||c>a.v_float[PR.entvars.ltime]||(a.v_float[PR.entvars.nextthink]=0,PR.globals_float[PR.globalvars.time]=SV.server.time,PR.globals_int[PR.globalvars.self]=a.num,PR.globals_int[PR.globalvars.other]=0,PR.ExecuteProgram(a.v_int[PR.entvars.think]))}; SV.CheckStuck=function(a){if(!0!==SV.TestEntityPosition(a))a.v_float[PR.entvars.oldorigin]=a.v_float[PR.entvars.origin],a.v_float[PR.entvars.oldorigin1]=a.v_float[PR.entvars.origin1],a.v_float[PR.entvars.oldorigin2]=a.v_float[PR.entvars.origin2];else{var b=ED.Vector(a,PR.entvars.origin);a.v_float[PR.entvars.origin]=a.v_float[PR.entvars.oldorigin];a.v_float[PR.entvars.origin1]=a.v_float[PR.entvars.oldorigin1];a.v_float[PR.entvars.origin2]=a.v_float[PR.entvars.oldorigin2];if(!0!==SV.TestEntityPosition(a))Con.DPrint("Unstuck.\n"), SV.LinkEdict(a,!0);else{var c,d,e;for(c=0;17>=c;++c)for(d=-1;1>=d;++d)for(e=-1;1>=e;++e)if(a.v_float[PR.entvars.origin]=b[0]+d,a.v_float[PR.entvars.origin1]=b[1]+e,a.v_float[PR.entvars.origin2]=b[2]+c,!0!==SV.TestEntityPosition(a)){Con.DPrint("Unstuck.\n");SV.LinkEdict(a,!0);return}ED.SetVector(a,PR.entvars.origin,b);Con.DPrint("player is stuck.\n")}}}; SV.CheckWater=function(a){var b=[a.v_float[PR.entvars.origin],a.v_float[PR.entvars.origin1],a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.mins2]+1];a.v_float[PR.entvars.waterlevel]=0;a.v_float[PR.entvars.watertype]=Mod.contents.empty;var c=SV.PointContents(b);if(!(c>Mod.contents.water))return a.v_float[PR.entvars.watertype]=c,a.v_float[PR.entvars.waterlevel]=1,b[2]=a.v_float[PR.entvars.origin2]+0.5*(a.v_float[PR.entvars.mins2]+a.v_float[PR.entvars.maxs2]),c=SV.PointContents(b),c<=Mod.contents.water&& (a.v_float[PR.entvars.waterlevel]=2,b[2]=a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.view_ofs2],c=SV.PointContents(b),c<=Mod.contents.water&&(a.v_float[PR.entvars.waterlevel]=3)),1<a.v_float[PR.entvars.waterlevel]}; SV.WallFriction=function(a,b){var c=[];Vec.AngleVectors(ED.Vector(a,PR.entvars.v_angle),c);var d=b.plane.normal,c=d[0]*c[0]+d[1]*c[1]+d[2]*c[2]+0.5;if(!(0<=c)){var c=c+1,e=d[0]*a.v_float[PR.entvars.velocity]+d[1]*a.v_float[PR.entvars.velocity1]+d[2]*a.v_float[PR.entvars.velocity2];a.v_float[PR.entvars.velocity]=(a.v_float[PR.entvars.velocity]-d[0]*e)*c;a.v_float[PR.entvars.velocity1]=(a.v_float[PR.entvars.velocity1]-d[1]*e)*c}}; SV.TryUnstick=function(a,b){var c=ED.Vector(a,PR.entvars.origin),d=[2,0,0],e,f;for(e=0;7>=e;++e){switch(e){case 1:d[0]=0;d[1]=2;break;case 2:d[0]=-2;d[1]=0;break;case 3:d[0]=0;d[1]=-2;break;case 4:d[0]=2;d[1]=2;break;case 5:d[0]=-2;d[1]=2;break;case 6:d[0]=2;d[1]=-2;break;case 7:d[0]=-2,d[1]=-2}SV.PushEntity(a,d);a.v_float[PR.entvars.velocity]=b[0];a.v_float[PR.entvars.velocity1]=b[1];a.v_float[PR.entvars.velocity2]=0;f=SV.FlyMove(a,0.1);if(4<Math.abs(c[1]-a.v_float[PR.entvars.origin1])||4<Math.abs(c[0]- a.v_float[PR.entvars.origin]))return f;ED.SetVector(a,PR.entvars.origin,c)}ED.SetVector(a,PR.entvars.velocity,Vec.origin);return 7}; SV.WalkMove=function(a){var b=a.v_float[PR.entvars.flags]&SV.fl.onground;a.v_float[PR.entvars.flags]^=b;var c=ED.Vector(a,PR.entvars.origin),d=ED.Vector(a,PR.entvars.velocity),e=SV.FlyMove(a,Host.frametime);if(0!==(e&2)&&!(0===b&&0===a.v_float[PR.entvars.waterlevel])&&a.v_float[PR.entvars.movetype]===SV.movetype.walk&&0===SV.nostep.value&&0===(SV.player.v_float[PR.entvars.flags]&SV.fl.waterjump)){var b=ED.Vector(a,PR.entvars.origin),f=ED.Vector(a,PR.entvars.velocity);ED.SetVector(a,PR.entvars.origin, c);SV.PushEntity(a,[0,0,18]);a.v_float[PR.entvars.velocity]=d[0];a.v_float[PR.entvars.velocity1]=d[1];a.v_float[PR.entvars.velocity2]=0;e=SV.FlyMove(a,Host.frametime);0!==e&&(0.03125>Math.abs(c[1]-a.v_float[PR.entvars.origin1])&&0.03125>Math.abs(c[0]-a.v_float[PR.entvars.origin])&&(e=SV.TryUnstick(a,d)),0!==(e&2)&&SV.WallFriction(a,SV.steptrace));c=SV.PushEntity(a,[0,0,d[2]*Host.frametime-18]);0.7<c.plane.normal[2]?a.v_float[PR.entvars.solid]===SV.solid.bsp&&(a.v_float[PR.entvars.flags]|=SV.fl.onground, a.v_int[PR.entvars.groundentity]=c.ent.num):(ED.SetVector(a,PR.entvars.origin,b),ED.SetVector(a,PR.entvars.velocity,f))}}; SV.Physics_Client=function(a){if(!0===SV.svs.clients[a.num-1].active){PR.globals_float[PR.globalvars.time]=SV.server.time;PR.globals_int[PR.globalvars.self]=a.num;PR.ExecuteProgram(PR.globals_int[PR.globalvars.PlayerPreThink]);SV.CheckVelocity(a);var b=a.v_float[PR.entvars.movetype]>>0;if(b===SV.movetype.toss||b===SV.movetype.bounce)SV.Physics_Toss(a);else{if(!0!==SV.RunThink(a))return;switch(b){case SV.movetype.none:break;case SV.movetype.walk:!0!==SV.CheckWater(a)&&0===(a.v_float[PR.entvars.flags]& SV.fl.waterjump)&&SV.AddGravity(a);SV.CheckStuck(a);SV.WalkMove(a);break;case SV.movetype.fly:SV.FlyMove(a,Host.frametime);break;case SV.movetype.noclip:a.v_float[PR.entvars.origin]+=Host.frametime*a.v_float[PR.entvars.velocity];a.v_float[PR.entvars.origin1]+=Host.frametime*a.v_float[PR.entvars.velocity1];a.v_float[PR.entvars.origin2]+=Host.frametime*a.v_float[PR.entvars.velocity2];break;default:Sys.Error("SV.Physics_Client: bad movetype "+b)}}SV.LinkEdict(a,!0);PR.globals_float[PR.globalvars.time]= SV.server.time;PR.globals_int[PR.globalvars.self]=a.num;PR.ExecuteProgram(PR.globals_int[PR.globalvars.PlayerPostThink])}}; SV.Physics_Noclip=function(a){!0===SV.RunThink(a)&&(a.v_float[PR.entvars.angles]+=Host.frametime*a.v_float[PR.entvars.avelocity],a.v_float[PR.entvars.angles1]+=Host.frametime*a.v_float[PR.entvars.avelocity1],a.v_float[PR.entvars.angles2]+=Host.frametime*a.v_float[PR.entvars.avelocity2],a.v_float[PR.entvars.origin]+=Host.frametime*a.v_float[PR.entvars.velocity],a.v_float[PR.entvars.origin1]+=Host.frametime*a.v_float[PR.entvars.velocity1],a.v_float[PR.entvars.origin2]+=Host.frametime*a.v_float[PR.entvars.velocity2], SV.LinkEdict(a))}; SV.CheckWaterTransition=function(a){var b=SV.PointContents(ED.Vector(a,PR.entvars.origin));0===a.v_float[PR.entvars.watertype]?(a.v_float[PR.entvars.watertype]=b,a.v_float[PR.entvars.waterlevel]=1):b<=Mod.contents.water?(a.v_float[PR.entvars.watertype]===Mod.contents.empty&&SV.StartSound(a,0,"misc/h2ohit1.wav",255,1),a.v_float[PR.entvars.watertype]=b,a.v_float[PR.entvars.waterlevel]=1):(a.v_float[PR.entvars.watertype]!==Mod.contents.empty&&SV.StartSound(a,0,"misc/h2ohit1.wav",255,1),a.v_float[PR.entvars.watertype]= Mod.contents.empty,a.v_float[PR.entvars.waterlevel]=b)}; SV.Physics_Toss=function(a){if(!0===SV.RunThink(a)&&0===(a.v_float[PR.entvars.flags]&SV.fl.onground)){SV.CheckVelocity(a);var b=a.v_float[PR.entvars.movetype];b!==SV.movetype.fly&&b!==SV.movetype.flymissile&&SV.AddGravity(a);a.v_float[PR.entvars.angles]+=Host.frametime*a.v_float[PR.entvars.avelocity];a.v_float[PR.entvars.angles1]+=Host.frametime*a.v_float[PR.entvars.avelocity1];a.v_float[PR.entvars.angles2]+=Host.frametime*a.v_float[PR.entvars.avelocity2];var c=SV.PushEntity(a,[a.v_float[PR.entvars.velocity]* Host.frametime,a.v_float[PR.entvars.velocity1]*Host.frametime,a.v_float[PR.entvars.velocity2]*Host.frametime]);if(!(1===c.fraction||!0===a.free)){var d=[];SV.ClipVelocity(ED.Vector(a,PR.entvars.velocity),c.plane.normal,d,b===SV.movetype.bounce?1.5:1);ED.SetVector(a,PR.entvars.velocity,d);if(0.7<c.plane.normal[2]&&(60>a.v_float[PR.entvars.velocity2]||b!==SV.movetype.bounce))a.v_float[PR.entvars.flags]|=SV.fl.onground,a.v_int[PR.entvars.groundentity]=c.ent.num,a.v_float[PR.entvars.velocity]=a.v_float[PR.entvars.velocity1]= a.v_float[PR.entvars.velocity2]=0,a.v_float[PR.entvars.avelocity]=a.v_float[PR.entvars.avelocity1]=a.v_float[PR.entvars.avelocity2]=0;SV.CheckWaterTransition(a)}}}; SV.Physics_Step=function(a){if(0===(a.v_float[PR.entvars.flags]&SV.fl.onground+SV.fl.fly+SV.fl.swim)){var b=a.v_float[PR.entvars.velocity2]<-0.1*SV.gravity.value;SV.AddGravity(a);SV.CheckVelocity(a);SV.FlyMove(a,Host.frametime);SV.LinkEdict(a,!0);0!==(a.v_float[PR.entvars.flags]&SV.fl.onground)&&!0===b&&SV.StartSound(a,0,"demon/dland2.wav",255,1)}SV.RunThink(a);SV.CheckWaterTransition(a)}; SV.Physics=function(){PR.globals_int[PR.globalvars.self]=0;PR.globals_int[PR.globalvars.other]=0;PR.globals_float[PR.globalvars.time]=SV.server.time;PR.ExecuteProgram(PR.globals_int[PR.globalvars.StartFrame]);var a,b;for(a=0;a<SV.server.num_edicts;++a)if(b=SV.server.edicts[a],!0!==b.free)if(0!==PR.globals_float[PR.globalvars.force_retouch]&&SV.LinkEdict(b,!0),0<a&&a<=SV.svs.maxclients)SV.Physics_Client(b);else{switch(b.v_float[PR.entvars.movetype]){case SV.movetype.push:SV.Physics_Pusher(b);continue; case SV.movetype.none:SV.RunThink(b);continue;case SV.movetype.noclip:SV.RunThink(b);continue;case SV.movetype.step:SV.Physics_Step(b);continue;case SV.movetype.toss:case SV.movetype.bounce:case SV.movetype.fly:case SV.movetype.flymissile:SV.Physics_Toss(b);continue}Sys.Error("SV.Physics: bad movetype "+(b.v_float[PR.entvars.movetype]>>0))}0!==PR.globals_float[PR.globalvars.force_retouch]&&--PR.globals_float[PR.globalvars.force_retouch];SV.server.time+=Host.frametime}; SV.SetIdealPitch=function(){var a=SV.player;if(0!==(a.v_float[PR.entvars.flags]&SV.fl.onground)){for(var b=a.v_float[PR.entvars.angles1]*(Math.PI/180),c=Math.sin(b),d=Math.cos(b),e=[0,0,a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.view_ofs2]],f,g=[],b=0;6>=b;++b){e[0]=a.v_float[PR.entvars.origin]+12*d*(b+3);e[1]=a.v_float[PR.entvars.origin1]+12*c*(b+3);f=SV.Move(e,Vec.origin,Vec.origin,[e[0],e[1],e[2]-160],1,a);if(!0===f.allsolid||1===f.fraction)return;g[b]=e[2]-160*f.fraction}f=d=0;for(c=1;c< b;++c)if(e=g[c]-g[c-1],!(-0.1<e&&0.1>e)){if(0!==d&&(0.1<e-d||-0.1>e-d))return;++f;d=e}0===d?a.v_float[PR.entvars.idealpitch]=0:2<=f&&(a.v_float[PR.entvars.idealpitch]=-d*SV.idealpitchscale.value)}}; SV.UserFriction=function(){var a=SV.player,b=a.v_float[PR.entvars.velocity],c=a.v_float[PR.entvars.velocity1],d=Math.sqrt(b*b+c*c);0!==d&&(b=[a.v_float[PR.entvars.origin]+16*(b/d),a.v_float[PR.entvars.origin1]+16*(c/d),a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.mins2]],c=SV.friction.value,1===SV.Move(b,Vec.origin,Vec.origin,[b[0],b[1],b[2]-34],1,a).fraction&&(c*=SV.edgefriction.value),b=d-Host.frametime*(d<SV.stopspeed.value?SV.stopspeed.value:d)*c,0>b&&(b=0),b/=d,a.v_float[PR.entvars.velocity]*= b,a.v_float[PR.entvars.velocity1]*=b,a.v_float[PR.entvars.velocity2]*=b)};SV.Accelerate=function(a,b){var c=SV.player,d=[a[0],a[1],a[2]],e=Vec.Normalize(d);!0===b&&30<e&&(e=30);var f=e-(c.v_float[PR.entvars.velocity]*d[0]+c.v_float[PR.entvars.velocity1]*d[1]+c.v_float[PR.entvars.velocity2]*d[2]);0>=f||(e*=SV.accelerate.value*Host.frametime,e>f&&(e=f),c.v_float[PR.entvars.velocity]+=e*d[0],c.v_float[PR.entvars.velocity1]+=e*d[1],c.v_float[PR.entvars.velocity2]+=e*d[2])}; SV.WaterMove=function(){var a=SV.player,b=Host.client.cmd,c=[],d=[];Vec.AngleVectors(ED.Vector(a,PR.entvars.v_angle),c,d);c=[c[0]*b.forwardmove+d[0]*b.sidemove,c[1]*b.forwardmove+d[1]*b.sidemove,c[2]*b.forwardmove+d[2]*b.sidemove];c[2]=0===b.forwardmove&&0===b.sidemove&&0===b.upmove?c[2]-60:c[2]+b.upmove;var b=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),e;b>SV.maxspeed.value&&(e=SV.maxspeed.value/b,c[0]*=e,c[1]*=e,c[2]*=e,b=SV.maxspeed.value);b*=0.7;e=Math.sqrt(a.v_float[PR.entvars.velocity]*a.v_float[PR.entvars.velocity]+ a.v_float[PR.entvars.velocity1]*a.v_float[PR.entvars.velocity1]+a.v_float[PR.entvars.velocity2]*a.v_float[PR.entvars.velocity2]);0!==e?(d=e-Host.frametime*e*SV.friction.value,0>d&&(d=0),e=d/e,a.v_float[PR.entvars.velocity]*=e,a.v_float[PR.entvars.velocity1]*=e,a.v_float[PR.entvars.velocity2]*=e):d=0;0!==b&&(d=b-d,0>=d||(e=SV.accelerate.value*b*Host.frametime,e>d&&(e=d),a.v_float[PR.entvars.velocity]+=e*(c[0]/b),a.v_float[PR.entvars.velocity1]+=e*(c[1]/b),a.v_float[PR.entvars.velocity2]+=e*(c[2]/b)))}; SV.WaterJump=function(){var a=SV.player;if(SV.server.time>a.v_float[PR.entvars.teleport_time]||0===a.v_float[PR.entvars.waterlevel])a.v_float[PR.entvars.flags]&=~SV.fl.waterjump>>>0,a.v_float[PR.entvars.teleport_time]=0;a.v_float[PR.entvars.velocity]=a.v_float[PR.entvars.movedir];a.v_float[PR.entvars.velocity1]=a.v_float[PR.entvars.movedir1]}; SV.AirMove=function(){var a=SV.player,b=Host.client.cmd,c=[],d=[];Vec.AngleVectors(ED.Vector(a,PR.entvars.angles),c,d);var e=b.forwardmove,f=b.sidemove;SV.server.time<a.v_float[PR.entvars.teleport_time]&&0>e&&(e=0);b=[c[0]*e+d[0]*f,c[1]*e+d[1]*f,a.v_float[PR.entvars.movetype]>>0!==SV.movetype.walk?b.upmove:0];c=[b[0],b[1],b[2]];Vec.Normalize(c)>SV.maxspeed.value&&(b[0]=c[0]*SV.maxspeed.value,b[1]=c[1]*SV.maxspeed.value,b[2]=c[2]*SV.maxspeed.value);a.v_float[PR.entvars.movetype]===SV.movetype.noclip? ED.SetVector(a,PR.entvars.velocity,b):0!==(a.v_float[PR.entvars.flags]&SV.fl.onground)?(SV.UserFriction(b),SV.Accelerate(b)):SV.Accelerate(b,!0)}; SV.ClientThink=function(){var a=SV.player;if(a.v_float[PR.entvars.movetype]!==SV.movetype.none){var b=ED.Vector(a,PR.entvars.punchangle),c=Vec.Normalize(b)-10*Host.frametime;0>c&&(c=0);a.v_float[PR.entvars.punchangle]=b[0]*c;a.v_float[PR.entvars.punchangle1]=b[1]*c;a.v_float[PR.entvars.punchangle2]=b[2]*c;0>=a.v_float[PR.entvars.health]||(a.v_float[PR.entvars.angles2]=4*V.CalcRoll(ED.Vector(a,PR.entvars.angles),ED.Vector(a,PR.entvars.velocity)),0===SV.player.v_float[PR.entvars.fixangle]&&(a.v_float[PR.entvars.angles]= (a.v_float[PR.entvars.v_angle]+a.v_float[PR.entvars.punchangle])/-3,a.v_float[PR.entvars.angles1]=a.v_float[PR.entvars.v_angle1]+a.v_float[PR.entvars.punchangle1]),0!==(a.v_float[PR.entvars.flags]&SV.fl.waterjump)?SV.WaterJump():2<=a.v_float[PR.entvars.waterlevel]&&a.v_float[PR.entvars.movetype]!==SV.movetype.noclip?SV.WaterMove():SV.AirMove())}}; SV.ReadClientMove=function(){var a=Host.client;a.ping_times[a.num_pings++&15]=SV.server.time-MSG.ReadFloat();a.edict.v_float[PR.entvars.v_angle]=MSG.ReadAngle();a.edict.v_float[PR.entvars.v_angle1]=MSG.ReadAngle();a.edict.v_float[PR.entvars.v_angle2]=MSG.ReadAngle();a.cmd.forwardmove=MSG.ReadShort();a.cmd.sidemove=MSG.ReadShort();a.cmd.upmove=MSG.ReadShort();var b=MSG.ReadByte();a.edict.v_float[PR.entvars.button0]=b&1;a.edict.v_float[PR.entvars.button2]=(b&2)>>1;b=MSG.ReadByte();0!==b&&(a.edict.v_float[PR.entvars.impulse]= b)}; SV.ReadClientMessage=function(){var a,b,c,d="status god notarget fly name noclip say say_team tell color kill pause spawn begin prespawn kick ping give ban".split(" ");do{a=NET.GetMessage(Host.client.netconnection);if(-1===a){Sys.Print("SV.ReadClientMessage: NET.GetMessage failed\n");break}if(0===a)return!0;for(MSG.BeginReading();;){if(!0!==Host.client.active)return;if(!0===MSG.badread){Sys.Print("SV.ReadClientMessage: badread\n");return}b=MSG.ReadChar();if(-1===b){a=1;break}if(b!==Protocol.clc.nop)if(b===Protocol.clc.stringcmd){b= MSG.ReadString();for(c=0;c<d.length;++c)if(b.substring(0,d[c].length).toLowerCase()===d[c]){Cmd.ExecuteString(b,!0);break}c===d.length&&Con.DPrint(SV.GetClientName(Host.client)+" tried to "+b)}else{if(b===Protocol.clc.disconnect)return;if(b===Protocol.clc.move)SV.ReadClientMove();else{Sys.Print("SV.ReadClientMessage: unknown command char\n");return}}}}while(1===a)}; SV.RunClients=function(){var a;for(a=0;a<SV.svs.maxclients;++a)Host.client=SV.svs.clients[a],!0===Host.client.active&&(SV.player=Host.client.edict,!0!==SV.ReadClientMessage()?Host.DropClient():!0!==Host.client.spawned?(Host.client.cmd.forwardmove=0,Host.client.cmd.sidemove=0,Host.client.cmd.upmove=0):SV.ClientThink())};SV.move={normal:0,nomonsters:1,missile:2}; SV.InitBoxHull=function(){SV.box_clipnodes=[];SV.box_planes=[];SV.box_hull={clipnodes:SV.box_clipnodes,planes:SV.box_planes,firstclipnode:0,lastclipnode:5};var a,b;for(a=0;5>=a;++a)b={},SV.box_clipnodes[a]=b,b.planenum=a,b.children=[],b.children[a&1]=Mod.contents.empty,b.children[1-(a&1)]=5!==a?a+1:Mod.contents.solid,b={},SV.box_planes[a]=b,b.type=a>>1,b.normal=[0,0,0],b.normal[a>>1]=1,b.dist=0}; SV.HullForEntity=function(a,b,c,d){if(a.v_float[PR.entvars.solid]!==SV.solid.bsp)return SV.box_planes[0].dist=a.v_float[PR.entvars.maxs]-b[0],SV.box_planes[1].dist=a.v_float[PR.entvars.mins]-c[0],SV.box_planes[2].dist=a.v_float[PR.entvars.maxs1]-b[1],SV.box_planes[3].dist=a.v_float[PR.entvars.mins1]-c[1],SV.box_planes[4].dist=a.v_float[PR.entvars.maxs2]-b[2],SV.box_planes[5].dist=a.v_float[PR.entvars.mins2]-c[2],d[0]=a.v_float[PR.entvars.origin],d[1]=a.v_float[PR.entvars.origin1],d[2]=a.v_float[PR.entvars.origin2], SV.box_hull;a.v_float[PR.entvars.movetype]!==SV.movetype.push&&Sys.Error("SOLID_BSP without MOVETYPE_PUSH");var e=SV.server.models[a.v_float[PR.entvars.modelindex]>>0];null==e&&Sys.Error("MOVETYPE_PUSH with a non bsp model");e.type!==Mod.type.brush&&Sys.Error("MOVETYPE_PUSH with a non bsp model");c=c[0]-b[0];e=3>c?e.hulls[0]:32>=c?e.hulls[1]:e.hulls[2];d[0]=e.clip_mins[0]-b[0]+a.v_float[PR.entvars.origin];d[1]=e.clip_mins[1]-b[1]+a.v_float[PR.entvars.origin1];d[2]=e.clip_mins[2]-b[2]+a.v_float[PR.entvars.origin2]; return e};SV.CreateAreaNode=function(a,b,c){var d={};SV.areanodes[SV.areanodes.length++]=d;d.trigger_edicts={};d.trigger_edicts.prev=d.trigger_edicts.next=d.trigger_edicts;d.solid_edicts={};d.solid_edicts.prev=d.solid_edicts.next=d.solid_edicts;if(4===a)return d.axis=-1,d.children=[],d;d.axis=c[0]-b[0]>c[1]-b[1]?0:1;d.dist=0.5*(c[d.axis]+b[d.axis]);var e=[c[0],c[1],c[2]],f=[b[0],b[1],b[2]];e[d.axis]=f[d.axis]=d.dist;d.children=[SV.CreateAreaNode(a+1,f,c),SV.CreateAreaNode(a+1,b,e)];return d}; SV.UnlinkEdict=function(a){null!=a.area.prev&&(a.area.prev.next=a.area.next);null!=a.area.next&&(a.area.next.prev=a.area.prev);a.area.prev=a.area.next=null}; SV.TouchLinks=function(a,b){var c,d,e,f;for(c=b.trigger_edicts.next;c!==b.trigger_edicts;c=d)if(d=c.next,c=c.ent,c!==a&&!(0===c.v_int[PR.entvars.touch]||c.v_float[PR.entvars.solid]!==SV.solid.trigger))a.v_float[PR.entvars.absmin]>c.v_float[PR.entvars.absmax]||(a.v_float[PR.entvars.absmin1]>c.v_float[PR.entvars.absmax1]||a.v_float[PR.entvars.absmin2]>c.v_float[PR.entvars.absmax2]||a.v_float[PR.entvars.absmax]<c.v_float[PR.entvars.absmin]||a.v_float[PR.entvars.absmax1]<c.v_float[PR.entvars.absmin1]|| a.v_float[PR.entvars.absmax2]<c.v_float[PR.entvars.absmin2])||(e=PR.globals_int[PR.globalvars.self],f=PR.globals_int[PR.globalvars.other],PR.globals_int[PR.globalvars.self]=c.num,PR.globals_int[PR.globalvars.other]=a.num,PR.globals_float[PR.globalvars.time]=SV.server.time,PR.ExecuteProgram(c.v_int[PR.entvars.touch]),PR.globals_int[PR.globalvars.self]=e,PR.globals_int[PR.globalvars.other]=f);-1!==b.axis&&(a.v_float[PR.entvars.absmax+b.axis]>b.dist&&SV.TouchLinks(a,b.children[0]),a.v_float[PR.entvars.absmin+ b.axis]<b.dist&&SV.TouchLinks(a,b.children[1]))};SV.FindTouchedLeafs=function(a,b){if(b.contents!==Mod.contents.solid)if(0>b.contents)16!==a.leafnums.length&&(a.leafnums[a.leafnums.length]=b.num-1);else{var c=Vec.BoxOnPlaneSide([a.v_float[PR.entvars.absmin],a.v_float[PR.entvars.absmin1],a.v_float[PR.entvars.absmin2]],[a.v_float[PR.entvars.absmax],a.v_float[PR.entvars.absmax1],a.v_float[PR.entvars.absmax2]],b.plane);0!==(c&1)&&SV.FindTouchedLeafs(a,b.children[0]);0!==(c&2)&&SV.FindTouchedLeafs(a,b.children[1])}}; SV.LinkEdict=function(a,b){if(!(a===SV.server.edicts[0]||!0===a.free))if(SV.UnlinkEdict(a),a.v_float[PR.entvars.absmin]=a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.mins]-1,a.v_float[PR.entvars.absmin1]=a.v_float[PR.entvars.origin1]+a.v_float[PR.entvars.mins1]-1,a.v_float[PR.entvars.absmin2]=a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.mins2],a.v_float[PR.entvars.absmax]=a.v_float[PR.entvars.origin]+a.v_float[PR.entvars.maxs]+1,a.v_float[PR.entvars.absmax1]=a.v_float[PR.entvars.origin1]+ a.v_float[PR.entvars.maxs1]+1,a.v_float[PR.entvars.absmax2]=a.v_float[PR.entvars.origin2]+a.v_float[PR.entvars.maxs2],0!==(a.v_float[PR.entvars.flags]&SV.fl.item)?(a.v_float[PR.entvars.absmin]-=14,a.v_float[PR.entvars.absmin1]-=14,a.v_float[PR.entvars.absmax]+=14,a.v_float[PR.entvars.absmax1]+=14):(a.v_float[PR.entvars.absmin2]-=1,a.v_float[PR.entvars.absmax2]+=1),a.leafnums=[],0!==a.v_float[PR.entvars.modelindex]&&SV.FindTouchedLeafs(a,SV.server.worldmodel.nodes[0]),a.v_float[PR.entvars.solid]!== SV.solid.not){for(var c=SV.areanodes[0];-1!==c.axis;)if(a.v_float[PR.entvars.absmin+c.axis]>c.dist)c=c.children[0];else if(a.v_float[PR.entvars.absmax+c.axis]<c.dist)c=c.children[1];else break;c=a.v_float[PR.entvars.solid]===SV.solid.trigger?c.trigger_edicts:c.solid_edicts;a.area.next=c;a.area.prev=c.prev;a.area.prev.next=a.area;a.area.next.prev=a.area;a.area.ent=a;!0===b&&SV.TouchLinks(a,SV.areanodes[0])}}; SV.HullPointContents=function(a,b,c){for(var d;0<=b;)(b<a.firstclipnode||b>a.lastclipnode)&&Sys.Error("SV.HullPointContents: bad node number"),b=a.clipnodes[b],d=a.planes[b.planenum],d=2>=d.type?c[d.type]-d.dist:d.normal[0]*c[0]+d.normal[1]*c[1]+d.normal[2]*c[2]-d.dist,b=0<=d?b.children[0]:b.children[1];return b};SV.PointContents=function(a){a=SV.HullPointContents(SV.server.worldmodel.hulls[0],0,a);return a<=Mod.contents.current_0&&a>=Mod.contents.current_down?Mod.contents.water:a}; SV.TestEntityPosition=function(a){var b=ED.Vector(a,PR.entvars.origin);return SV.Move(b,ED.Vector(a,PR.entvars.mins),ED.Vector(a,PR.entvars.maxs),b,0,a).startsolid}; SV.RecursiveHullCheck=function(a,b,c,d,e,f,g){if(0>b)return b!==Mod.contents.solid?(g.allsolid=!1,b===Mod.contents.empty?g.inopen=!0:g.inwater=!0):g.startsolid=!0,!0;(b<a.firstclipnode||b>a.lastclipnode)&&Sys.Error("SV.RecursiveHullCheck: bad node number");b=a.clipnodes[b];var h=a.planes[b.planenum],j,k;2>=h.type?(j=e[h.type]-h.dist,k=f[h.type]-h.dist):(j=h.normal[0]*e[0]+h.normal[1]*e[1]+h.normal[2]*e[2]-h.dist,k=h.normal[0]*f[0]+h.normal[1]*f[1]+h.normal[2]*f[2]-h.dist);if(0<=j&&0<=k)return SV.RecursiveHullCheck(a, b.children[0],c,d,e,f,g);if(0>j&&0>k)return SV.RecursiveHullCheck(a,b.children[1],c,d,e,f,g);k=(j+(0>j?0.03125:-0.03125))/(j-k);0>k?k=0:1<k&&(k=1);var m=c+(d-c)*k,l=[e[0]+k*(f[0]-e[0]),e[1]+k*(f[1]-e[1]),e[2]+k*(f[2]-e[2])];j=0>j?1:0;if(!0===SV.RecursiveHullCheck(a,b.children[j],c,m,e,l,g)){if(SV.HullPointContents(a,b.children[1-j],l)!==Mod.contents.solid)return SV.RecursiveHullCheck(a,b.children[1-j],m,d,l,f,g);if(!0!==g.allsolid){0===j?(g.plane.normal=[h.normal[0],h.normal[1],h.normal[2]],g.plane.dist= h.dist):(g.plane.normal=[-h.normal[0],-h.normal[1],-h.normal[2]],g.plane.dist=-h.dist);for(;SV.HullPointContents(a,a.firstclipnode,l)===Mod.contents.solid;){k-=0.1;if(0>k){g.fraction=m;g.endpos=[l[0],l[1],l[2]];Con.DPrint("backup past 0\n");return}m=c+(d-c)*k;l[0]=e[0]+k*(f[0]-e[0]);l[1]=e[1]+k*(f[1]-e[1]);l[2]=e[2]+k*(f[2]-e[2])}g.fraction=m;g.endpos=[l[0],l[1],l[2]]}}}; SV.ClipMoveToEntity=function(a,b,c,d,e){var f={fraction:1,allsolid:!0,endpos:[e[0],e[1],e[2]],plane:{normal:[0,0,0],dist:0}},g=[];c=SV.HullForEntity(a,c,d,g);SV.RecursiveHullCheck(c,c.firstclipnode,0,1,[b[0]-g[0],b[1]-g[1],b[2]-g[2]],[e[0]-g[0],e[1]-g[1],e[2]-g[2]],f);1!==f.fraction&&(f.endpos[0]+=g[0],f.endpos[1]+=g[1],f.endpos[2]+=g[2]);if(1>f.fraction||!0===f.startsolid)f.ent=a;return f}; SV.ClipToLinks=function(a,b){var c,d,e;for(c=a.solid_edicts.next;c!==a.solid_edicts;c=c.next)if(d=c.ent,e=d.v_float[PR.entvars.solid],!(e===SV.solid.not||d===b.passedict))if(e===SV.solid.trigger&&Sys.Error("Trigger in clipping list"),!(b.type===SV.move.nomonsters&&e!==SV.solid.bsp)&&!(b.boxmins[0]>d.v_float[PR.entvars.absmax]||b.boxmins[1]>d.v_float[PR.entvars.absmax1]||b.boxmins[2]>d.v_float[PR.entvars.absmax2]||b.boxmaxs[0]<d.v_float[PR.entvars.absmin]||b.boxmaxs[1]<d.v_float[PR.entvars.absmin1]|| b.boxmaxs[2]<d.v_float[PR.entvars.absmin2])&&!(null!=b.passedict&&0!==b.passedict.v_float[PR.entvars.size]&&0===d.v_float[PR.entvars.size])){if(!0===b.trace.allsolid)return;if(null!=b.passedict){if(SV.server.edicts[d.v_int[PR.entvars.owner]]===b.passedict)continue;if(SV.server.edicts[b.passedict.v_int[PR.entvars.owner]]===d)continue}e=0!==(d.v_float[PR.entvars.flags]&SV.fl.monster)?SV.ClipMoveToEntity(d,b.start,b.mins2,b.maxs2,b.end):SV.ClipMoveToEntity(d,b.start,b.mins,b.maxs,b.end);if(!0===e.allsolid|| !0===e.startsolid||e.fraction<b.trace.fraction)e.ent=d,b.trace=e,!0===e.startsolid&&(b.trace.startsolid=!0)}-1!==a.axis&&(b.boxmaxs[a.axis]>a.dist&&SV.ClipToLinks(a.children[0],b),b.boxmins[a.axis]<a.dist&&SV.ClipToLinks(a.children[1],b))}; SV.Move=function(a,b,c,d,e,f){f={trace:SV.ClipMoveToEntity(SV.server.edicts[0],a,b,c,d),start:a,end:d,mins:b,maxs:c,type:e,passedict:f,boxmins:[],boxmaxs:[]};e===SV.move.missile?(f.mins2=[-15,-15,-15],f.maxs2=[15,15,15]):(f.mins2=[b[0],b[1],b[2]],f.maxs2=[c[0],c[1],c[2]]);for(b=0;2>=b;++b)d[b]>a[b]?(f.boxmins[b]=a[b]+f.mins2[b]-1,f.boxmaxs[b]=d[b]+f.maxs2[b]+1):(f.boxmins[b]=d[b]+f.mins2[b]-1,f.boxmaxs[b]=a[b]+f.maxs2[b]+1);SV.ClipToLinks(SV.areanodes[0],f);return f.trace};
var Sys={Quit:function(){null!=Sys.frame&&clearInterval(Sys.frame);window.onbeforeunload=null;window.oncontextmenu=null;window.onfocus=null;window.onkeydown=null;window.onkeyup=null;window.onmousedown=null;window.onmouseup=null;window.onunload=null;Host.Shutdown();document.body.style.cursor="auto";VID.mainwindow.style.display="none";0!==COM.registered.value?document.getElementById("end2").style.display="inline":document.getElementById("end1").style.display="inline";throw Error();},Print:function(a){null!= window.console&&console.log(a)},Error:function(a){null!=Sys.frame&&clearInterval(Sys.frame);window.onbeforeunload=null;window.oncontextmenu=null;window.onfocus=null;window.onkeydown=null;window.onkeyup=null;window.onmousedown=null;window.onmouseup=null;window.onunload=null;!0===Host.initialized&&Host.Shutdown();document.body.style.cursor="auto";var b=Con.text.length-25;0>b&&(b=0);if(null!=window.console)for(;b<Con.text.length;++b)console.log(Con.text[b].text);alert(a);throw Error(a);},FloatTime:function(){return 0.001* Date.now()-Sys.oldtime}}; window.onload=function(){var a,b=decodeURIComponent(document.location.search);if(63===b.charCodeAt(0)){var d=[],c="",f=!1,e;for(a=1;a<b.length;++a)e=b.charCodeAt(a),32>e||127<e||(34===e?f=!f:!1===f&&32===e?0!==c.length&&(d[d.length]=c,c=""):c+=b.charAt(a));0!==c.length&&(d[d.length]=c);COM.InitArgv(d)}a=document.getElementsByTagName("html")[0];VID.width=320>=a.clientWidth?320:a.clientWidth;VID.height=200>=a.clientHeight?200:a.clientHeight;Sys.scantokey=[];Sys.scantokey[8]=Key.k.backspace;Sys.scantokey[9]= Key.k.tab;Sys.scantokey[13]=Key.k.enter;Sys.scantokey[16]=Key.k.shift;Sys.scantokey[17]=Key.k.ctrl;Sys.scantokey[18]=Key.k.alt;Sys.scantokey[19]=Key.k.pause;Sys.scantokey[27]=Key.k.escape;Sys.scantokey[32]=Key.k.space;Sys.scantokey[33]=Sys.scantokey[105]=Key.k.pgup;Sys.scantokey[34]=Sys.scantokey[99]=Key.k.pgdn;Sys.scantokey[35]=Sys.scantokey[97]=Key.k.end;Sys.scantokey[36]=Sys.scantokey[103]=Key.k.home;Sys.scantokey[37]=Sys.scantokey[100]=Key.k.leftarrow;Sys.scantokey[38]=Sys.scantokey[104]=Key.k.uparrow; Sys.scantokey[39]=Sys.scantokey[102]=Key.k.rightarrow;Sys.scantokey[40]=Sys.scantokey[98]=Key.k.downarrow;Sys.scantokey[45]=Sys.scantokey[96]=Key.k.ins;Sys.scantokey[46]=Sys.scantokey[110]=Key.k.del;for(a=48;57>=a;++a)Sys.scantokey[a]=a;Sys.scantokey[59]=Sys.scantokey[186]=59;Sys.scantokey[61]=Sys.scantokey[187]=61;for(a=65;90>=a;++a)Sys.scantokey[a]=a+32;Sys.scantokey[106]=42;Sys.scantokey[107]=43;Sys.scantokey[109]=Sys.scantokey[173]=Sys.scantokey[189]=45;Sys.scantokey[111]=Sys.scantokey[191]=47; for(a=112;123>=a;++a)Sys.scantokey[a]=a-112+Key.k.f1;Sys.scantokey[188]=44;Sys.scantokey[190]=46;Sys.scantokey[192]=96;Sys.scantokey[219]=91;Sys.scantokey[220]=92;Sys.scantokey[221]=93;Sys.scantokey[222]=39;Sys.oldtime=0.001*Date.now();Sys.Print("Host.Init\n");Host.Init();window.onbeforeunload=Sys.onbeforeunload;window.oncontextmenu=Sys.oncontextmenu;window.onfocus=Sys.onfocus;window.onkeydown=Sys.onkeydown;window.onkeyup=Sys.onkeyup;window.onmousedown=Sys.onmousedown;window.onmouseup=Sys.onmouseup; window.onunload=Sys.onunload;Sys.frame=setInterval(Host.Frame,1E3/60)};Sys.onbeforeunload=function(){return"Are you sure you want to quit?"};Sys.oncontextmenu=function(a){a.preventDefault()};Sys.onfocus=function(){var a;for(a=0;256>a;++a)Key.Event(a),Key.down[a]=!1};Sys.onkeydown=function(a){var b=Sys.scantokey[a.keyCode];null!=b&&(Key.Event(b,!0),a.preventDefault())};Sys.onkeyup=function(a){var b=Sys.scantokey[a.keyCode];null!=b&&(Key.Event(b),a.preventDefault())}; Sys.onmousedown=function(a){var b;switch(a.which){case 1:b=Key.k.mouse1;break;case 2:b=Key.k.mouse3;break;case 3:b=Key.k.mouse2;break;default:return}Key.Event(b,!0);a.preventDefault()};Sys.onmouseup=function(a){var b;switch(a.which){case 1:b=Key.k.mouse1;break;case 2:b=Key.k.mouse3;break;case 3:b=Key.k.mouse2;break;default:return}Key.Event(b);a.preventDefault()};Sys.onunload=function(){Host.Shutdown()};
var SZ={GetSpace:function(a,b){a.cursize+b>a.data.byteLength&&(!0!==a.allowoverflow&&Sys.Error("SZ.GetSpace: overflow without allowoverflow set"),b>a.byteLength&&Sys.Error("SZ.GetSpace: "+b+" is > full buffer size"),a.overflowed=!0,Con.Print("SZ.GetSpace: overflow\n"),a.cursize=0);var c=a.cursize;a.cursize+=b;return c},Write:function(a,b,c){(new Uint8Array(a.data,SZ.GetSpace(a,c),c)).set(b.subarray(0,c))},Print:function(a,b){var c=new Uint8Array(a.data),e;e=0!==a.cursize?0===c[a.cursize-1]?SZ.GetSpace(a, b.length-1)-1:SZ.GetSpace(a,b.length):SZ.GetSpace(a,b.length);var d;for(d=0;d<b.length;++d)c[e+d]=b.charCodeAt(d)}};
var V={dmg_time:0,CalcRoll:function(a,b){var d=[];Vec.AngleVectors(a,null,d);var d=b[0]*d[0]+b[1]*d[1]+b[2]*d[2],c=0>d?-1:1,d=Math.abs(d);return d<V.rollspeed.value?d*c*V.rollangle.value/V.rollspeed.value:V.rollangle.value*c},CalcBob:function(){if(0>=V.bobcycle.value||1<=V.bobcycle.value||0>=V.bobup.value||1<=V.bobup.value||0===V.bob.value)return 0;var a=(CL.state.time-Math.floor(CL.state.time/V.bobcycle.value)*V.bobcycle.value)/V.bobcycle.value,a=a<V.bobup.value?Math.PI*a/V.bobup.value:Math.PI+Math.PI* (a-V.bobup.value)/(1-V.bobup.value),b=Math.sqrt(CL.state.velocity[0]*CL.state.velocity[0]+CL.state.velocity[1]*CL.state.velocity[1])*V.bob.value,b=0.3*b+0.7*b*Math.sin(a);4<b?b=4:-7>b&&(b=-7);return b},StartPitchDrift:function(){if(CL.state.laststop!==CL.state.time&&(!0===CL.state.nodrift||0===CL.state.pitchvel))CL.state.pitchvel=V.centerspeed.value,CL.state.nodrift=!1,CL.state.driftmove=0},StopPitchDrift:function(){CL.state.laststop=CL.state.time;CL.state.nodrift=!0;CL.state.pitchvel=0},DriftPitch:function(){if(!0=== Host.noclip_anglehack||!0!==CL.state.onground||!0===CL.cls.demoplayback)CL.state.driftmove=0,CL.state.pitchvel=0;else if(!0===CL.state.nodrift)CL.state.driftmove=Math.abs(CL.state.cmd.forwardmove)<CL.forwardspeed.value?0:CL.state.driftmove+Host.frametime,CL.state.driftmove>V.centermove.value&&V.StartPitchDrift();else{var a=CL.state.idealpitch-CL.state.viewangles[0];if(0===a)CL.state.pitchvel=0;else{var b=Host.frametime*CL.state.pitchvel;CL.state.pitchvel+=Host.frametime*V.centerspeed.value;0<a?(b> a&&(CL.state.pitchvel=0,b=a),CL.state.viewangles[0]+=b):0>a&&(b>-a&&(CL.state.pitchvel=0,b=-a),CL.state.viewangles[0]-=b)}}},cshift_empty:[130,80,50,0],blend:[0,0,0,0],ParseDamage:function(){var a=MSG.ReadByte(),b=MSG.ReadByte(),d=CL.entities[CL.state.viewentity],c=[MSG.ReadCoord()-d.origin[0],MSG.ReadCoord()-d.origin[1],MSG.ReadCoord()-d.origin[2]];Vec.Normalize(c);var e=0.5*(b+a);10>e&&(e=10);CL.state.faceanimtime=CL.state.time+0.2;var f=CL.state.cshifts[CL.cshift.damage];f[3]+=3*e;0>f[3]?f[3]= 0:150<f[3]&&(f[3]=150);a>b?(f[0]=200,f[1]=f[2]=100):0!==a?(f[0]=220,f[1]=f[2]=50):(f[0]=255,f[1]=f[2]=0);a=[];b=[];Vec.AngleVectors(d.angles,a,b);V.dmg_roll=e*(c[0]*b[0]+c[1]*b[1]+c[2]*b[2])*V.kickroll.value;V.dmg_pitch=e*(c[0]*a[0]+c[1]*a[1]+c[2]*a[2])*V.kickpitch.value;V.dmg_time=V.kicktime.value},cshift_f:function(){V.cshift_empty[0]=Q.atoi(Cmd.argv[1]);V.cshift_empty[1]=Q.atoi(Cmd.argv[2]);V.cshift_empty[2]=Q.atoi(Cmd.argv[3])},BonusFlash_f:function(){CL.state.cshifts[CL.cshift.bonus]=[215,186, 69,50]},SetContentsColor:function(a){switch(a){case Mod.contents.empty:case Mod.contents.solid:CL.state.cshifts[CL.cshift.contents]=V.cshift_empty;return;case Mod.contents.lava:CL.state.cshifts[CL.cshift.contents]=[255,80,0,150];return;case Mod.contents.slime:CL.state.cshifts[CL.cshift.contents]=[0,25,5,150];return}CL.state.cshifts[CL.cshift.contents]=[130,80,50,128]},CalcBlend:function(){0!==(CL.state.items&Def.it.quad)?CL.state.cshifts[CL.cshift.powerup]=[0,0,255,30]:0!==(CL.state.items&Def.it.suit)? CL.state.cshifts[CL.cshift.powerup]=[0,255,0,20]:0!==(CL.state.items&Def.it.invisibility)?CL.state.cshifts[CL.cshift.powerup]=[100,100,100,100]:0!==(CL.state.items&Def.it.invulnerability)?CL.state.cshifts[CL.cshift.powerup]=[255,255,0,30]:CL.state.cshifts[CL.cshift.powerup][3]=0;CL.state.cshifts[CL.cshift.damage][3]-=150*Host.frametime;0>CL.state.cshifts[CL.cshift.damage][3]&&(CL.state.cshifts[CL.cshift.damage][3]=0);CL.state.cshifts[CL.cshift.bonus][3]-=100*Host.frametime;0>CL.state.cshifts[CL.cshift.bonus][3]&& (CL.state.cshifts[CL.cshift.bonus][3]=0);if(0===V.cshiftpercent.value)V.blend[0]=V.blend[1]=V.blend[2]=V.blend[3]=0;else{var a=0,b=0,d=0,c=0,e,f,g;for(f=0;3>=f;++f)g=CL.state.cshifts[f],e=g[3]*V.cshiftpercent.value/25500,0!==e&&(c+=e*(1-c),e/=c,a=a*(1-e)+g[0]*e,b=b*(1-e)+g[1]*e,d=d*(1-e)+g[2]*e);1<c?c=1:0>c&&(c=0);V.blend[0]=a;V.blend[1]=b;V.blend[2]=d;V.blend[3]=c;1<V.blend[3]?V.blend[3]=1:0>V.blend[3]&&(V.blend[3]=0)}},CalcIntermissionRefdef:function(){var a=CL.entities[CL.state.viewentity];R.refdef.vieworg= [a.origin[0],a.origin[1],a.origin[2]];R.refdef.viewangles=[a.angles[0]+Math.sin(CL.state.time*V.ipitch_cycle.value)*V.ipitch_level.value,a.angles[1]+Math.sin(CL.state.time*V.iyaw_cycle.value)*V.iyaw_level.value,a.angles[2]+Math.sin(CL.state.time*V.iroll_cycle.value)*V.iroll_level.value];CL.state.viewent.model=null},oldz:0,CalcRefdef:function(){V.DriftPitch();var a=CL.entities[CL.state.viewentity],b=V.CalcBob();R.refdef.vieworg=[a.origin[0],a.origin[1],a.origin[2]+CL.state.viewheight+b];R.refdef.vieworg[0]+= 0.03125;R.refdef.vieworg[1]+=0.03125;R.refdef.vieworg[2]+=0.03125;R.refdef.viewangles=[CL.state.viewangles[0],CL.state.viewangles[1],CL.state.viewangles[2]];R.refdef.viewangles[2]+=V.CalcRoll(CL.entities[CL.state.viewentity].angles,CL.state.velocity);0<V.dmg_time&&(0!==V.kicktime.value&&(R.refdef.viewangles[2]+=V.dmg_time/V.kicktime.value*V.dmg_roll,R.refdef.viewangles[0]+=V.dmg_time/V.kicktime.value*V.dmg_pitch),V.dmg_time-=Host.frametime);0>=CL.state.stats[Def.stat.health]&&(R.refdef.viewangles[2]= 80);R.refdef.viewangles[0]+=V.idlescale.value*Math.sin(CL.state.time*V.ipitch_cycle.value)*V.ipitch_level.value+CL.state.punchangle[0];R.refdef.viewangles[1]+=V.idlescale.value*Math.sin(CL.state.time*V.iyaw_cycle.value)*V.iyaw_level.value+CL.state.punchangle[1];R.refdef.viewangles[2]+=V.idlescale.value*Math.sin(CL.state.time*V.iroll_cycle.value)*V.iroll_level.value+CL.state.punchangle[2];var d=[],c=[],e=[];Vec.AngleVectors([-a.angles[0],a.angles[1],a.angles[2]],d,c,e);R.refdef.vieworg[0]+=V.ofsx.value* d[0]+V.ofsy.value*c[0]+V.ofsz.value*e[0];R.refdef.vieworg[1]+=V.ofsx.value*d[1]+V.ofsy.value*c[1]+V.ofsz.value*e[1];R.refdef.vieworg[2]+=V.ofsx.value*d[2]+V.ofsy.value*c[2]+V.ofsz.value*e[2];R.refdef.vieworg[0]<a.origin[0]-14?R.refdef.vieworg[0]=a.origin[0]-14:R.refdef.vieworg[0]>a.origin[0]+14&&(R.refdef.vieworg[0]=a.origin[0]+14);R.refdef.vieworg[1]<a.origin[1]-14?R.refdef.vieworg[1]=a.origin[1]-14:R.refdef.vieworg[1]>a.origin[1]+14&&(R.refdef.vieworg[1]=a.origin[1]+14);R.refdef.vieworg[2]<a.origin[2]- 30?R.refdef.vieworg[2]=a.origin[2]-30:R.refdef.vieworg[2]>a.origin[2]+30&&(R.refdef.vieworg[2]=a.origin[2]+30);c=CL.state.viewent;c.angles=[-CL.state.viewangles[0],CL.state.viewangles[1],CL.state.viewangles[2]];c.origin=[a.origin[0]+0.4*d[0]*b,a.origin[1]+0.4*d[1]*b,a.origin[2]+CL.state.viewheight+b+0.4*d[2]*b];switch(SCR.viewsize.value){case 110:case 90:c.origin[2]+=1;break;case 100:c.origin[2]+=2;break;case 80:c.origin[2]+=0.5}c.model=CL.state.model_precache[CL.state.stats[Def.stat.weapon]];c.frame= CL.state.stats[Def.stat.weaponframe];!0===CL.state.onground&&0<a.origin[2]-V.oldz?(b=CL.state.time-CL.state.oldtime,0>b&&(b=0),V.oldz+=80*b,V.oldz>a.origin[2]?V.oldz=a.origin[2]:12<a.origin[2]-V.oldz&&(V.oldz=a.origin[2]-12),R.refdef.vieworg[2]+=V.oldz-a.origin[2],c.origin[2]+=V.oldz-a.origin[2]):V.oldz=a.origin[2];0!==Chase.active.value&&Chase.Update()},RenderView:function(){!0!==Con.forcedup&&(1<CL.state.maxclients&&(Cvar.Set("scr_ofsx","0"),Cvar.Set("scr_ofsy","0"),Cvar.Set("scr_ofsz","0")),0!== CL.state.intermission?V.CalcIntermissionRefdef():!0!==CL.state.paused&&V.CalcRefdef(),R.PushDlights(),R.RenderView())},Init:function(){Cmd.AddCommand("v_cshift",V.cshift_f);Cmd.AddCommand("bf",V.BonusFlash_f);Cmd.AddCommand("centerview",V.StartPitchDrift);V.centermove=Cvar.RegisterVariable("v_centermove","0.15");V.centerspeed=Cvar.RegisterVariable("v_centerspeed","500");V.iyaw_cycle=Cvar.RegisterVariable("v_iyaw_cycle","2");V.iroll_cycle=Cvar.RegisterVariable("v_iroll_cycle","0.5");V.ipitch_cycle= Cvar.RegisterVariable("v_ipitch_cycle","1");V.iyaw_level=Cvar.RegisterVariable("v_iyaw_level","0.3");V.iroll_level=Cvar.RegisterVariable("v_iroll_level","0.1");V.ipitch_level=Cvar.RegisterVariable("v_ipitch_level","0.3");V.idlescale=Cvar.RegisterVariable("v_idlescale","0");V.crosshair=Cvar.RegisterVariable("crosshair","0",!0);V.crossx=Cvar.RegisterVariable("cl_crossx","0");V.crossy=Cvar.RegisterVariable("cl_crossy","0");V.cshiftpercent=Cvar.RegisterVariable("gl_cshiftpercent","100");V.ofsx=Cvar.RegisterVariable("scr_ofsx", "0");V.ofsy=Cvar.RegisterVariable("scr_ofsy","0");V.ofsz=Cvar.RegisterVariable("scr_ofsz","0");V.rollspeed=Cvar.RegisterVariable("cl_rollspeed","200");V.rollangle=Cvar.RegisterVariable("cl_rollangle","2.0");V.bob=Cvar.RegisterVariable("cl_bob","0.02");V.bobcycle=Cvar.RegisterVariable("cl_bobcycle","0.6");V.bobup=Cvar.RegisterVariable("cl_bobup","0.5");V.kicktime=Cvar.RegisterVariable("v_kicktime","0.5");V.kickroll=Cvar.RegisterVariable("v_kickroll","0.6");V.kickpitch=Cvar.RegisterVariable("v_kickpitch", "0.6");V.gamma=Cvar.RegisterVariable("gamma","1",!0)}};
var Vec={origin:[0,0,0],ProjectPointOnPlane:function(a,b){var c=1/Vec.DotProduct(b,b),e=Vec.DotProduct(b,a)*c;return[a[0]-e*b[0]*c,a[1]-e*b[1]*c,a[2]-e*b[2]*c]},Perpendicular:function(a){var b=0,c=1;Math.abs(a[0])<c&&(b=0,c=Math.abs(a[0]));Math.abs(a[1])<c&&(b=1,c=Math.abs(a[1]));Math.abs(a[2])<c&&(b=2,Math.abs(a[2]));c=[0,0,0];c[b]=1;a=Vec.ProjectPointOnPlane(c,a);Vec.Normalize(a);return a},RotatePointAroundVector:function(a,b,c){var e=Vec.Perpendicular(a),d=Vec.CrossProduct(e,a);a=[[e[0],d[0],a[0]], [e[1],d[1],a[1]],[e[2],d[2],a[2]]];e=[[a[0][0],a[1][0],a[2][0]],[a[0][1],a[1][1],a[2][1]],[a[0][2],a[1][2],a[2][2]]];d=Math.sin(c*Math.PI/180);c=Math.cos(c*Math.PI/180);c=Vec.ConcatRotations(Vec.ConcatRotations(a,[[c,d,0],[-d,c,0],[0,0,1]]),e);return[c[0][0]*b[0]+c[0][1]*b[1]+c[0][2]*b[2],c[1][0]*b[0]+c[1][1]*b[1]+c[1][2]*b[2],c[2][0]*b[0]+c[2][1]*b[1]+c[2][2]*b[2]]},Anglemod:function(a){return(a%360+360)%360},BoxOnPlaneSide:function(a,b,c){if(2>=c.type)return c.dist<=a[c.type]?1:c.dist>=b[c.type]? 2:3;var e,d;switch(c.signbits){case 0:e=c.normal[0]*b[0]+c.normal[1]*b[1]+c.normal[2]*b[2];d=c.normal[0]*a[0]+c.normal[1]*a[1]+c.normal[2]*a[2];break;case 1:e=c.normal[0]*a[0]+c.normal[1]*b[1]+c.normal[2]*b[2];d=c.normal[0]*b[0]+c.normal[1]*a[1]+c.normal[2]*a[2];break;case 2:e=c.normal[0]*b[0]+c.normal[1]*a[1]+c.normal[2]*b[2];d=c.normal[0]*a[0]+c.normal[1]*b[1]+c.normal[2]*a[2];break;case 3:e=c.normal[0]*a[0]+c.normal[1]*a[1]+c.normal[2]*b[2];d=c.normal[0]*b[0]+c.normal[1]*b[1]+c.normal[2]*a[2]; break;case 4:e=c.normal[0]*b[0]+c.normal[1]*b[1]+c.normal[2]*a[2];d=c.normal[0]*a[0]+c.normal[1]*a[1]+c.normal[2]*b[2];break;case 5:e=c.normal[0]*a[0]+c.normal[1]*b[1]+c.normal[2]*a[2];d=c.normal[0]*b[0]+c.normal[1]*a[1]+c.normal[2]*b[2];break;case 6:e=c.normal[0]*b[0]+c.normal[1]*a[1]+c.normal[2]*a[2];d=c.normal[0]*a[0]+c.normal[1]*b[1]+c.normal[2]*b[2];break;case 7:e=c.normal[0]*a[0]+c.normal[1]*a[1]+c.normal[2]*a[2];d=c.normal[0]*b[0]+c.normal[1]*b[1]+c.normal[2]*b[2];break;default:Sys.Error("Vec.BoxOnPlaneSide: Bad signbits")}a= 0;e>=c.dist&&(a=1);d<c.dist&&(a+=2);return a},AngleVectors:function(a,b,c,e){var d;d=a[0]*Math.PI/180;var f=Math.sin(d),j=Math.cos(d);d=a[1]*Math.PI/180;var g=Math.sin(d),h=Math.cos(d);d=a[2]*Math.PI/180;a=Math.sin(d);d=Math.cos(d);null!=b&&(b[0]=j*h,b[1]=j*g,b[2]=-f);null!=c&&(c[0]=-a*f*h+d*g,c[1]=-a*f*g-d*h,c[2]=-a*j);null!=e&&(e[0]=d*f*h+a*g,e[1]=d*f*g-a*h,e[2]=d*j)},DotProduct:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},Copy:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2]},CrossProduct:function(a, b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},Length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},Normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);if(0===b)return a[0]=a[1]=a[2]=0;a[0]/=b;a[1]/=b;a[2]/=b;return b},ConcatRotations:function(a,b){return[[a[0][0]*b[0][0]+a[0][1]*b[1][0]+a[0][2]*b[2][0],a[0][0]*b[0][1]+a[0][1]*b[1][1]+a[0][2]*b[2][1],a[0][0]*b[0][2]+a[0][1]*b[1][2]+a[0][2]*b[2][2]],[a[1][0]*b[0][0]+a[1][1]*b[1][0]+a[1][2]*b[2][0], a[1][0]*b[0][1]+a[1][1]*b[1][1]+a[1][2]*b[2][1],a[1][0]*b[0][2]+a[1][1]*b[1][2]+a[1][2]*b[2][2]],[a[2][0]*b[0][0]+a[2][1]*b[1][0]+a[2][2]*b[2][0],a[2][0]*b[0][1]+a[2][1]*b[1][1]+a[2][2]*b[2][1],a[2][0]*b[0][2]+a[2][1]*b[1][2]+a[2][2]*b[2][2]]]}};
var VID={};VID.d_8to24table=new Uint32Array(new ArrayBuffer(1024));VID.SetPalette=function(){var b=COM.LoadFile("gfx/palette.lmp");null==b&&Sys.Error("Couldn't load gfx/palette.lmp");var b=new Uint8Array(b),a;for(a=0;256>a;++a)VID.d_8to24table[a]=b[3*a]+(b[3*a+1]<<8)+(b[3*a+2]<<16)+4278190080};VID.Init=function(){document.getElementById("progress").style.display="none";GL.Init();VID.SetPalette()};
var W={lumps:[],LoadWadFile:function(a){var b=COM.LoadFile(a);null==b&&Sys.Error("W.LoadWadFile: couldn't load "+a);var c=new DataView(b);843333975!==c.getUint32(0,!0)&&Sys.Error("Wad file "+a+" doesn't have WAD2 id");a=c.getUint32(4,!0);var d=c.getUint32(8,!0),e,f,g;for(e=0;e<a;++e)f=c.getUint32(d+4,!0),g=new ArrayBuffer(f),(new Uint8Array(g)).set(new Uint8Array(b,c.getUint32(d,!0),f)),W.lumps[Q.memstr(new Uint8Array(b,d+16,16)).toLowerCase()]=g,d+=32},GetLumpName:function(a){var b=W.lumps[a];null== b&&Sys.Error("W.GetLumpName: "+a+" not found");return b}};
</script>
<script type="x-shader/x-vertex" id="vshAlias">
uniform vec3 uOrigin;
uniform mat3 uAngles;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
uniform vec3 uLightVec;
attribute vec3 aPoint;
attribute vec3 aLightNormal;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
varying float vLightDot;
void main(void)
{
	vec3 position = uViewAngles * (uAngles * aPoint.xyz + uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = aTexCoord;
	vLightDot = dot(aLightNormal, uLightVec);
}
</script>
<script type="x-shader/x-fragment" id="fshAlias">
precision mediump float;
uniform float uAmbientLight;
uniform float uShadeLight;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
varying float vLightDot;
void main(void)
{
	vec4 texture = texture2D(tTexture, vTexCoord);
	gl_FragColor = vec4(texture.rgb * mix(1.0, vLightDot * uShadeLight + uAmbientLight, texture.a), 1.0);
}
</script>
<script type="x-shader/x-vertex" id="vshBrush">
uniform vec3 uOrigin;
uniform mat3 uAngles;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
attribute vec3 aPoint;
attribute vec4 aTexCoord;
attribute vec4 aLightStyle;
varying vec4 vTexCoord;
varying vec4 vLightStyle;
void main(void)
{
	vec3 position = uViewAngles * (uAngles * aPoint + uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = aTexCoord;
	vLightStyle = aLightStyle;
}
</script>
<script type="x-shader/x-fragment" id="fshBrush">
precision mediump float;
uniform sampler2D tTexture;
uniform sampler2D tLightmap;
uniform sampler2D tDlight;
uniform sampler2D tLightStyle;
varying vec4 vTexCoord;
varying vec4 vLightStyle;
void main(void)
{
	vec4 texture = texture2D(tTexture, vTexCoord.xy);
	gl_FragColor = vec4(texture.rgb *
		mix(1.0, dot(texture2D(tLightmap, vTexCoord.zw), vec4(
			texture2D(tLightStyle, vec2(vLightStyle.x, 0.0)).a,
			texture2D(tLightStyle, vec2(vLightStyle.y, 0.0)).a,
			texture2D(tLightStyle, vec2(vLightStyle.z, 0.0)).a,
			texture2D(tLightStyle, vec2(vLightStyle.w, 0.0)).a)
		* 43.828125) + texture2D(tDlight, vTexCoord.zw).a, texture.a), 1.0);
}
</script>
<script type="x-shader/x-vertex" id="vshCharacter">
uniform vec2 uCharacter;
uniform vec2 uDest;
uniform mat4 uOrtho;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	gl_Position = uOrtho * vec4(aPoint * 8.0 + uDest, 0.0, 1.0);
	vTexCoord = (aPoint + uCharacter) * 0.0625;
}
</script>
<script type="x-shader/x-fragment" id="fshCharacter">
precision mediump float;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = texture2D(tTexture, vTexCoord);
}
</script>
<script type="x-shader/x-vertex" id="vshDlight">
uniform vec3 uOrigin;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
uniform float uRadius;
attribute vec3 aPoint;
varying float vAlpha;
void main(void)
{
	vec3 position = aPoint * 0.35 * uRadius + uViewAngles * (uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vAlpha = aPoint.y * -0.2;
}
</script>
<script type="x-shader/x-fragment" id="fshDlight">
precision mediump float;
varying float vAlpha;
void main(void)
{
	gl_FragColor = vec4(1.0, 0.5, 0.0, vAlpha);
}
</script>
<script type="x-shader/x-vertex" id="vshFill">
uniform vec4 uRect;
uniform mat4 uOrtho;
attribute vec2 aPoint;
void main(void)
{
	gl_Position = uOrtho * vec4(uRect.xy + uRect.zw * aPoint, 0.0, 1.0);
}
</script>
<script type="x-shader/x-fragment" id="fshFill">
precision mediump float;
uniform vec4 uColor;
void main(void)
{
	gl_FragColor = vec4(uColor.rgb * (1.0 / 255.0), uColor.a);
}
</script>
<script type="x-shader/x-vertex" id="vshParticle">
uniform vec3 uOrigin;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
uniform float uScale;
attribute vec2 aPoint;
varying vec2 vCoord;
void main(void)
{
	vec2 point = (aPoint - 0.5) * uScale;
	vec3 position = vec3(point.x, 0.0, point.y) + uViewAngles * (uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vCoord = vec2(aPoint.x - 0.5, 0.5 - aPoint.y) * 2.0;
}
</script>
<script type="x-shader/x-fragment" id="fshParticle">
precision mediump float;
uniform vec3 uColor;
varying vec2 vCoord;
void main(void)
{
	gl_FragColor = vec4(uColor * (1.0 / 255.0), 1.0 - smoothstep(0.75, 1.0, length(vCoord)));
}
</script>
<script type="x-shader/x-vertex" id="vshPic">
uniform vec4 uRect;
uniform mat4 uOrtho;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	gl_Position = uOrtho * vec4(uRect.xy + uRect.zw * aPoint.xy, 0.0, 1.0);
	vTexCoord = aPoint;
}
</script>
<script type="x-shader/x-fragment" id="fshPic">
precision mediump float;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = texture2D(tTexture, vTexCoord);
}
</script>
<script type="x-shader/x-vertex" id="vshPicTranslate">
uniform vec4 uRect;
uniform mat4 uOrtho;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	gl_Position = uOrtho * vec4(uRect.xy + uRect.zw * aPoint.xy, 0.0, 1.0);
	vTexCoord = aPoint;
}
</script>
<script type="x-shader/x-fragment" id="fshPicTranslate">
precision mediump float;
uniform vec3 uTop;
uniform vec3 uBottom;
uniform sampler2D tTexture;
uniform sampler2D tTrans;
varying vec2 vTexCoord;
void main(void)
{
	vec4 texture = texture2D(tTexture, vTexCoord);
	vec4 trans = texture2D(tTrans, vTexCoord);
	gl_FragColor = vec4(mix(mix(texture.rgb, uTop * (1.0 / 255.0) * trans.x, trans.y), uBottom * (1.0 / 255.0) * trans.z, trans.w), texture.a);
}
</script>
<script type="x-shader/x-vertex" id="vshPlayer">
uniform vec3 uOrigin;
uniform mat3 uAngles;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
uniform vec3 uLightVec;
attribute vec3 aPoint;
attribute vec3 aLightNormal;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
varying float vLightDot;
void main(void)
{
	vec3 position = uViewAngles * (uAngles * aPoint.xyz + uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = aTexCoord;
	vLightDot = dot(aLightNormal, uLightVec);
}
</script>
<script type="x-shader/x-fragment" id="fshPlayer">
precision mediump float;
uniform float uAmbientLight;
uniform float uShadeLight;
uniform vec3 uTop;
uniform vec3 uBottom;
uniform sampler2D tTexture;
uniform sampler2D tPlayer;
varying vec2 vTexCoord;
varying float vLightDot;
void main(void)
{
	vec4 texture = texture2D(tTexture, vTexCoord);
	vec4 player = texture2D(tPlayer, vTexCoord);
	gl_FragColor = vec4(
		mix(mix(texture.rgb, uTop * (1.0 / 255.0) * player.x, player.y), uBottom * (1.0 / 255.0) * player.z, player.w)
		* mix(1.0, vLightDot * uShadeLight + uAmbientLight, texture.a), 1.0);
}
</script>
<script type="x-shader/x-vertex" id="vshSky">
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
uniform vec3 uScale;
attribute vec3 aPoint;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
void main(void)
{
	vec3 position = uViewAngles * (aPoint * uScale);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = aTexCoord * uScale.xy;
}
</script>
<script type="x-shader/x-fragment" id="fshSky">
precision mediump float;
uniform sampler2D tSolid;
uniform sampler2D tAlpha;
uniform float uTime;
varying vec2 vTexCoord;
void main(void)
{
	vec4 alpha = texture2D(tAlpha, vTexCoord + 0.125 * uTime);
	gl_FragColor = vec4(mix(texture2D(tSolid, vTexCoord + 0.03125 * uTime).rgb, alpha.rgb, alpha.a), 1.0);
}
</script>
<script type="x-shader/x-vertex" id="vshSprite">
uniform vec4 uRect;
uniform vec3 uOrigin;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	vec2 point = uRect.xy + uRect.zw * aPoint;
	vec3 position = vec3(point.x, 0.0, point.y) + uViewAngles * (uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = vec2(aPoint.x, -aPoint.y);
}
</script>
<script type="x-shader/x-fragment" id="fshSprite">
precision mediump float;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = texture2D(tTexture, vTexCoord);
}
</script>
<script type="x-shader/x-vertex" id="vshSpriteOriented">
uniform vec4 uRect;
uniform vec3 uOrigin;
uniform mat3 uAngles;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	vec2 point = uRect.xy + uRect.zw * aPoint;
	vec3 position = uViewAngles * (uAngles * vec3(point.x, 0.0, point.y) + uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = vec2(aPoint.x, -aPoint.y);
}
</script>
<script type="x-shader/x-fragment" id="fshSpriteOriented">
precision mediump float;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = texture2D(tTexture, vTexCoord);
}
</script>
<script type="x-shader/x-vertex" id="vshTurbulent">
uniform vec3 uOrigin;
uniform mat3 uAngles;
uniform vec3 uViewOrigin;
uniform mat3 uViewAngles;
uniform mat4 uPerspective;
attribute vec3 aPoint;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
void main(void)
{
	vec3 position = uViewAngles * (uAngles * aPoint + uOrigin - uViewOrigin);
	gl_Position = uPerspective * vec4(position.xz, -position.y, 1.0);
	vTexCoord = aTexCoord;
}
</script>
<script type="x-shader/x-fragment" id="fshTurbulent">
precision mediump float;
uniform float uTime;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = vec4(texture2D(tTexture, vTexCoord + vec2(sin(vTexCoord.t * 3.141593 + uTime), sin(vTexCoord.s * 3.141593 + uTime)) * 0.125).rgb, 1.0);
}
</script>
<script type="x-shader/x-vertex" id="vshWarp">
uniform vec4 uRect;
uniform mat4 uOrtho;
attribute vec2 aPoint;
varying vec2 vTexCoord;
void main(void)
{
	gl_Position = uOrtho * vec4(uRect.x + uRect.z * aPoint.x, uRect.y + uRect.w * aPoint.y, 0.0, 1.0);
	vTexCoord = vec2(aPoint.x, 1.0 - aPoint.y);
}
</script>
<script type="x-shader/x-fragment" id="fshWarp">
precision mediump float;
uniform float uTime;
uniform sampler2D tTexture;
varying vec2 vTexCoord;
void main(void)
{
	gl_FragColor = texture2D(tTexture, vTexCoord + vec2(sin(vTexCoord.t * 15.70796 + uTime) * 0.003125, sin(vTexCoord.s * 9.817477 + uTime) * 0.005));
}
</script>
<style type="text/css">
canvas {
  position: fixed;
  left: 0;
  top: 0;
  display: none;
}
#end1, #end2 {
  background-color: maroon;
  white-space: pre;
}
</style>
</head>
<body style="cursor: none;">
<div>
<span id="progress">Starting Quake...</span>
<div id="end" style="color: white; font-family: monospace; text-align: center;">
<span id="end1" style="display: none;">                QUAKE: The Doomed Dimension <span style="color: yellow;">by <span style="background-color: navy;">id</span> Software               <span style="color: gray;">v1.09</span>  
  ----------------------------------------------------------------------------  
           CALL 1-800-IDGAMES TO ORDER OR FOR TECHNICAL SUPPORT                 
             PRICE: $45.00 (PRICES MAY VARY OUTSIDE THE US.)</span>                    
                                                                                
  Yes! You only have one fourth of this incredible epic. That is because most   
   of you have paid us nothing or at most, very little. You could steal the     
   game from a friend. But we both know you'll be punished by God if you do.    
        <span style="color: yellow;">WHY RISK ETERNAL DAMNATION? CALL 1-800-IDGAMES AND BUY NOW!</span>             
             Remember, we love you almost as much as He does.                   
                                                                                
            <span style="color: yellow;">Programming:</span> John Carmack, Michael Abrash, John Cash                
       <span style="color: yellow;">Design:</span> John Romero, Sandy Petersen, American McGee, Tim Willits         
                     <span style="color: yellow;">Art:</span> Adrian Carmack, Kevin Cloud                           
               <span style="color: yellow;">Biz:</span> Jay Wilbur, Mike Wilson, Donna Jackson                      
            <span style="color: yellow;">Projects:</span> Shawn Green   <span style="color: yellow;">Support:</span> Barrett Alexander                  
              <span style="color: yellow;">Sound Effects:</span> Trent Reznor and Nine Inch Nails                   
  For other information or details on ordering outside the US, check out the    
     files accompanying QUAKE or our website at http://www.idsoftware.com.      
    <span style="color: gray;">Quake is a trademark of Id Software, inc., (c)1996 Id Software, inc.        
     All rights reserved. NIN logo is a registered trademark licensed to        
                 Nothing Interactive, Inc. All rights reserved.</span>                 </span>
<span id="end2" style="display: none;">        QUAKE <span style="color: yellow;">by <span style="background-color: navy;">id</span> Software                                             <span style="color: white;">v1.09</span>  
 -----------------------------------------------------------------------------  </span>
        Why did you quit from the registered version of QUAKE? Did the          
        scary monsters frighten you? Or did Mr. Sandman tug at your             
        little lids? No matter! What is important is you love our               
        game, and gave us your money. Congratulations, you are probably         
        not a thief.                                                            
                                                           Thank You.           
        <span style="color: yellow;"><span style="background-color: navy;">id</span> Software is:                                                         
        PROGRAMMING:</span> John Carmack, Michael Abrash, John Cash                    
        <span style="color: yellow;">DESIGN:</span> John Romero, Sandy Petersen, American McGee, Tim Willits        
        <span style="color: yellow;">ART:</span> Adrian Carmack, Kevin Cloud                                        
        <span style="color: yellow;">BIZ:</span> Jay Wilbur, Mike Wilson     <span style="color: yellow;">PROJECTS MAN:</span> Shawn Green              
        <span style="color: yellow;">BIZ ASSIST:</span> Donna Jackson        <span style="color: yellow;">SUPPORT:</span> Barrett Alexander             
        <span style="color: yellow;">SOUND EFFECTS AND MUSIC:</span> Trent Reznor and Nine Inch Nails               
                                                                                
        If you need help running QUAKE refer to the text files in the           
        QUAKE directory, or our website at http://www.idsoftware.com.           
        If all else fails, call our technical support at 1-800-IDGAMES.         
      <span style="color: silver">Quake is a trademark of Id Software, inc., (c)1996 Id Software, inc.      
        All rights reserved. NIN logo is a registered trademark licensed        
             to Nothing Interactive, Inc. All rights reserved.</span>                  </span>
</div>
<canvas id="mainwindow"></canvas>
<img id="loading" alt="Loading" style="display: none; position: fixed;">
</div>
</body>
</html>